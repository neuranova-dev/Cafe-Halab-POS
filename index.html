<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>CafÃ© Halab POS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <meta name="theme-color" content="#0f172a" />
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Café Halab POS" />
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png" />
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top left, #fef3c7 0, #f9fafb 45%, #e5e7eb 100%);
      }
      .app-shell {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      header {
        background: linear-gradient(90deg, #0f172a, #1d3557);
        color: #f9fafb;
        padding: 14px 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.45);
      }
      header h1 {
        font-size: 20px;
        letter-spacing: 0.04em;
        margin: 0;
      }
      header span {
        font-size: 12px;
        opacity: 0.85;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .brand-logo {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        object-fit: contain;
        background: rgba(15, 23, 42, 0.8);
        padding: 4px;
      }
      main {
        display: grid;
        grid-template-columns: minmax(0, 2.2fr) minmax(0, 1fr);
        gap: 18px;
        padding: 18px 20px 24px;
      }
      @media (max-width: 900px) {
        main {
          grid-template-columns: 1fr;
        }
      }
      .panel {
        background: rgba(255, 255, 255, 0.96);
        border-radius: 18px;
        padding: 14px 16px 18px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
        border: 1px solid rgba(148, 163, 184, 0.35);
        -webkit-backdrop-filter: blur(6px);
        backdrop-filter: blur(6px);
      }
      .categories {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 12px;
      }
      .category-btn {
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        padding: 6px 14px;
        font-size: 12px;
        background: #f9fafb;
        cursor: pointer;
        transition: all 0.16s ease-out;
      }
      .category-btn.active {
        background: linear-gradient(135deg, #f97316, #facc15);
        color: #111827;
        border-color: transparent;
        box-shadow: 0 6px 14px rgba(248, 181, 0, 0.45);
      }
      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
        gap: 14px;
      }
      .product-card {
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        padding: 10px 10px 12px;
        background: linear-gradient(145deg, #f9fafb, #eef2ff);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        box-shadow: 0 14px 30px rgba(15, 23, 42, 0.16);
        overflow: hidden;
      }
      .product-image {
        width: 100%;
        height: 130px;
        object-fit: cover;
        border-radius: 14px;
        margin-bottom: 8px;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.26);
      }
      .product-name {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .product-price {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 8px;
      }
      .btn-primary {
        border: none;
        border-radius: 999px;
        padding: 7px 12px;
        font-size: 13px;
        background: linear-gradient(135deg, #16a34a, #22c55e);
        color: white;
        cursor: pointer;
        box-shadow: 0 8px 18px rgba(34, 197, 94, 0.6);
        transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;
      }
      .btn-primary:disabled {
        opacity: 0.5;
        cursor: default;
        box-shadow: none;
      }
      .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        padding: 6px 0;
        border-bottom: 1px solid #e5e7eb;
      }
      .cart-item:last-child {
        border-bottom: none;
      }
      .cart-item-main {
        display: flex;
        flex-direction: column;
      }
      .cart-item-meta {
        font-size: 11px;
        color: #6b7280;
      }
      .cart-item-controls {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .qty-btn {
        border-radius: 4px;
        border: 1px solid #d1d5db;
        background: white;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 13px;
      }
      .summary-row {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        margin-top: 4px;
      }
      .summary-row.total {
        font-weight: 700;
        margin-top: 8px;
      }
      .milk-select {
        width: 100%;
        margin-top: 4px;
        font-size: 12px;
        padding: 4px;
      }
      .status {
        font-size: 12px;
        margin-top: 8px;
      }
      .status.ok {
        color: #16a34a;
      }
      .status.err {
        color: #b91c1c;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- React from CDNs (global React / ReactDOM) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAcMZVPiMQKNqb2rcrV1WqmixIo1xFK2CE",
        authDomain: "cafe-halab.firebaseapp.com",
        projectId: "cafe-halab",
        storageBucket: "cafe-halab.firebasestorage.app",
        messagingSenderId: "915112396018",
        appId: "1:915112396018:web:4aa8dbadbc6651c3f6bc6b"
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      window.firebaseAuth = auth;
      window.firebaseDb = db;

      db.enablePersistence().catch(() => {});
    </script>

    <!-- Inline POS App (no modules, works via file://) -->
    <script>
      const e = React.createElement;

      const INITIAL_MENU_DATA = [
        {
          id: "omelette_cheese",
          name: "Omelette with Cheese",
          nameFr: "Omelette au Fromage",
          nameAr: "Ø£ÙˆÙ…Ù„ÙŠØª Ø¨Ø§Ù„Ø¬Ø¨Ù†",
          price: 26.0,
          category: "Breakfast",
          image: "Omelette au Fromage.jpg",
          modifiers: []
        },
        {
          id: "omelette_turkey",
          name: "Omelette with Turkey",
          nameFr: "Omelette Ã  la Dinde FumÃ©e",
          nameAr: "Ø£ÙˆÙ…Ù„ÙŠØª Ø¨Ø§Ù„Ø¯ÙŠÙƒ Ø§Ù„Ø±ÙˆÙ…ÙŠ Ø§Ù„Ù…Ø¯Ø®Ù†",
          price: 28.0,
          category: "Breakfast",
          image: "Omelette Ã  la Dinde FumÃ©e.jpg",
          modifiers: []
        },
        {
          id: "omelette_kashir",
          name: "Omelette with Kashir",
          nameFr: "Omelette au Kashir",
          nameAr: "Ø£ÙˆÙ…Ù„ÙŠØª Ø¨Ø§Ù„ÙƒØ§Ø´ÙŠØ±",
          price: 24.0,
          category: "Breakfast",
          image: "Omelette au Kashir.jpg",
          modifiers: []
        },
        {
          id: "breakfast_marrakchi",
          name: "Marrakchi Breakfast",
          nameFr: "Petit DÃ©jeuner Marrakchi",
          nameAr: "ÙØ·ÙˆØ± Ù…Ø±Ø§ÙƒØ´ÙŠ",
          price: 26.0,
          category: "Breakfast",
          image: "Petit DÃ©jeuner Marrakchi.jpg",
          modifiers: []
        },
        {
          id: "breakfast_catalan",
          name: "Catalan Breakfast",
          nameFr: "Petit DÃ©jeuner Catalan",
          nameAr: "ÙØ·ÙˆØ± ÙƒØ§ØªØ§Ù„Ø§Ù†",
          price: 29.0,
          category: "Breakfast",
          image: "Petit DÃ©jeuner Catalan.jpg",
          modifiers: []
        },
        {
          id: "fried_eggs",
          name: "Fried Eggs (Mirror)",
          nameFr: "Å’ufs au plat miroir",
          nameAr: "ÙØ·ÙˆØ± Ø¨ÙŠØ¶ Ø¹ÙˆÙŠÙ†Ø§Øª",
          price: 22.0,
          category: "Breakfast",
          image: "Å’ufs au plat miroir.jpg",
          modifiers: []
        },
        {
          id: "croissant_breakfast",
          name: "Croissant Breakfast",
          nameFr: "Petit-dÃ©jeuner au croissant",
          nameAr: "ÙØ·ÙˆØ± ÙƒØ±ÙˆØ§Ø³ÙˆÙ†",
          price: 20.0,
          category: "Breakfast",
          image: "Petit-dÃ©jeuner au croissant.jpg",
          modifiers: []
        },

        {
          id: "coffee",
          name: "Coffee",
          nameFr: "CafÃ©",
          nameAr: "Ù‚Ù‡ÙˆØ©",
          price: 11.0,
          category: "Hot Drinks",
          image: "CafÃ©.jpg",
          modifiers: []
        },
        {
          id: "coffee_with_milk",
          name: "Coffee with Milk",
          nameFr: "CafÃ© au lait",
          nameAr: "Ù‚Ù‡ÙˆØ© Ø¨Ø§Ù„Ø­Ù„ÙŠØ¨",
          price: 11.0,
          category: "Hot Drinks",
          image: "CafÃ© au lait.jpg",
          modifiers: []
        },
        {
          id: "machada",
          name: "Machada",
          nameFr: "Machada",
          nameAr: "Ù…Ø§Ø´Ø§Ø¯Ø§",
          price: 11.0,
          category: "Hot Drinks",
          image: "Machada.jpg",
          modifiers: []
        },
        {
          id: "nescafe",
          name: "NESCAFE",
          nameFr: "NESCAFÃ‰",
          nameAr: "Ù†Ø³ÙƒØ§ÙÙŠÙ‡",
          price: 11.0,
          category: "Hot Drinks",
          image: "NESCAFÃ‰.jpg",
          modifiers: []
        },
        {
          id: "tea_lipton",
          name: "Lipton Tea",
          nameFr: "ThÃ© Lipton",
          nameAr: "Ø´Ø§ÙŠ Ù„ÙŠØ¨ØªÙˆÙ†",
          price: 11.0,
          category: "Hot Drinks",
          image: null,
          modifiers: []
        },
        {
          id: "tea_mint",
          name: "Mint Tea",
          nameFr: "ThÃ© Ã  la Menthe",
          nameAr: "Ø´Ø§ÙŠ Ø¨Ø§Ù„Ù†Ø¹Ù†Ø§Ø¹",
          price: 7.0,
          category: "Hot Drinks",
          image: "ThÃ© Ã  la Menthe.jpg",
          modifiers: []
        },
        {
          id: "tea_berrad",
          name: "Berrad Tea (Teapot)",
          nameFr: "ThÃ© Berrad",
          nameAr: "Ø¨Ø±Ø§Ø¯ Ø´Ø§ÙŠ",
          price: 9.0,
          category: "Hot Drinks",
          image: "ThÃ© Berrad.jpg",
          modifiers: []
        },

        {
          id: "juice_orange",
          name: "Orange Juice",
          nameFr: "Jus d'orange",
          nameAr: "Ø¹ØµÙŠØ± Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„",
          price: 17.0,
          category: "Cold Drinks",
          image: "Jus d'orange.jpg",
          modifiers: []
        },
        {
          id: "juice_apple",
          name: "Apple Juice",
          nameFr: "Jus de pomme",
          nameAr: "Ø¹ØµÙŠØ± Ø§Ù„ØªÙØ§Ø­",
          price: 20.0,
          category: "Cold Drinks",
          image: null,
          modifiers: []
        },
        {
          id: "juice_lemon",
          name: "Lemon Juice",
          nameFr: "Jus de citron",
          nameAr: "Ø¹ØµÙŠØ± Ø§Ù„Ù„ÙŠÙ…ÙˆÙ†",
          price: 20.0,
          category: "Cold Drinks",
          image: null,
          modifiers: []
        },
        {
          id: "juice_banana",
          name: "Banana Juice",
          nameFr: "Jus de banane",
          nameAr: "Ø¹ØµÙŠØ± Ø§Ù„Ù…ÙˆØ²",
          price: 20.0,
          category: "Cold Drinks",
          image: "Jus de banane.jpg",
          modifiers: []
        },
        {
          id: "juice_avocado",
          name: "Avocado Juice",
          nameFr: "Jus d'avocat",
          nameAr: "Ø¹ØµÙŠØ± Ø§Ù„Ø£ÙÙˆÙƒØ§Ø¯Ùˆ",
          price: 27.0,
          category: "Cold Drinks",
          image: "Jus d'avocat.jpg",
          modifiers: []
        },

        // Sodas
        {
          id: "soda_cocacola",
          name: "Coca-Cola",
          nameFr: "Coca-Cola",
          nameAr: "ÙƒÙˆÙƒØ§ ÙƒÙˆÙ„Ø§",
          price: 12.0,
          category: "Cold Drinks",
          image: "Coca-Cola.jpg",
          modifiers: []
        },
        {
          id: "soda_hawai",
          name: "Hawai",
          nameFr: "Hawai",
          nameAr: "Ù‡Ø§ÙˆØ§ÙŠ",
          price: 12.0,
          category: "Cold Drinks",
          image: "Hawai.jpg",
          modifiers: []
        },
        {
          id: "soda_poms",
          name: "Poms",
          nameFr: "Poms",
          nameAr: "Ø¨ÙˆÙ…Ø³",
          price: 12.0,
          category: "Cold Drinks",
          image: "Poms.jpg",
          modifiers: []
        },
        {
          id: "soda_sprite",
          name: "Sprite",
          nameFr: "Sprite",
          nameAr: "Ø³Ø¨Ø±Ø§ÙŠØª",
          price: 12.0,
          category: "Cold Drinks",
          image: "Sprite.jpg",
          modifiers: []
        },
        {
          id: "soda_schweppes_citron",
          name: "Schweppes Citron",
          nameFr: "Schweppes Citron",
          nameAr: "Ø´ÙˆÙŠØ¨Ø³ Ù„ÙŠÙ…ÙˆÙ†",
          price: 12.0,
          category: "Cold Drinks",
          image: "Schweppes Citron.jpg",
          modifiers: []
        },
        {
          id: "soda_schweppes_tonic",
          name: "Schweppes Tonic",
          nameFr: "Schweppes Tonic",
          nameAr: "Ø´ÙˆÙŠØ¨Ø³ ØªÙˆÙ†ÙŠÙƒ",
          price: 12.0,
          category: "Cold Drinks",
          image: "Schweppes Tonic.jpg",
          modifiers: []
        },
        {
          id: "soda_schweppes_mojito",
          name: "Schweppes Mojito",
          nameFr: "Schweppes Mojito",
          nameAr: "Ø´ÙˆÙŠØ¨Ø³ Ù…ÙˆÙ‡ÙŠØªÙˆ",
          price: 14.0,
          category: "Cold Drinks",
          image: null,
          modifiers: []
        },
        {
          id: "water_oulmes_regular",
          name: "OulmÃ¨s",
          nameFr: "OulmÃ¨s",
          nameAr: "Ø£ÙˆÙ„Ù…Ø§Ø³",
          price: 10.0,
          category: "Cold Drinks",
          image: null,
          modifiers: []
        },
        {
          id: "water_oulmes_yellow",
          name: "OulmÃ¨s Jaune",
          nameFr: "OulmÃ¨s Jaune",
          nameAr: "Ø£ÙˆÙ„Ù…Ø§Ø³ Ø£ØµÙØ±",
          price: 10.0,
          category: "Cold Drinks",
          image: null,
          modifiers: []
        },

        // Others / Autres
        {
          id: "other_muffin",
          name: "Muffin",
          nameFr: "Muffin",
          nameAr: "Ù…ÙÙ†",
          price: 3.0,
          category: "Others",
          image: null,
          modifiers: []
        },
        {
          id: "other_raib",
          name: "Raib",
          nameFr: "Raib",
          nameAr: "Ø±Ø§ÙŠØ¨",
          price: 9.0,
          category: "Others",
          image: null,
          modifiers: []
        },
        {
          id: "other_flan",
          name: "Flan",
          nameFr: "Flan",
          nameAr: "ÙÙ„Ø§Ù†",
          price: 8.0,
          category: "Others",
          image: null,
          modifiers: []
        }
      ];

      const INITIAL_CATEGORIES = [
        "Breakfast",
        "Hot Drinks",
        "Cold Drinks",
        "Others"
      ];

      const USERS = [
        { id: "worker_med", name: "MED", role: "worker", pin: "1111" },
        { id: "worker_aya", name: "AYA", role: "worker", pin: "2222" },
        { id: "admin_nouri", name: "Nouri", role: "admin", pin: "3333" }
      ];

      const INVENTORY_INITIAL = {
        coffee_beans: {
          id: "coffee_beans",
          name: "CafÃ© (grains)",
          unit: "kg",
          currentQty: 5.0,
          minQty: 1.0
        },
        milk: {
          id: "milk",
          name: "Lait",
          unit: "L",
          currentQty: 8.0,
          minQty: 2.0
        },
        tea_leaves: {
          id: "tea_leaves",
          name: "ThÃ© (en vrac)",
          unit: "kg",
          currentQty: 2.0,
          minQty: 0.5
        },
        sugar_powder: {
          id: "sugar_powder",
          name: "Sucre (poudre)",
          unit: "kg",
          currentQty: 4.0,
          minQty: 1.0
        },
        sugar_cubes: {
          id: "sugar_cubes",
          name: "Sucre (morceaux)",
          unit: "kg",
          currentQty: 3.0,
          minQty: 1.0
        },
        eggs: {
          id: "eggs",
          name: "Å’ufs",
          unit: "pcs",
          currentQty: 120,
          minQty: 24
        },
        cheese: {
          id: "cheese",
          name: "Fromage",
          unit: "kg",
          currentQty: 2.0,
          minQty: 0.5
        },
        turkey_smoked: {
          id: "turkey_smoked",
          name: "Dinde fumÃ©e",
          unit: "kg",
          currentQty: 2.0,
          minQty: 0.5
        },
        kashir: {
          id: "kashir",
          name: "Kashir",
          unit: "kg",
          currentQty: 2.0,
          minQty: 0.5
        },
        oranges: {
          id: "oranges",
          name: "Oranges",
          unit: "pcs",
          currentQty: 80,
          minQty: 20
        },
        apples: {
          id: "apples",
          name: "Pommes",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        },
        lemons: {
          id: "lemons",
          name: "Citrons",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        },
        bananas: {
          id: "bananas",
          name: "Bananes",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        },
        avocados: {
          id: "avocados",
          name: "Avocats",
          unit: "pcs",
          currentQty: 40,
          minQty: 10
        },

        soda_cocacola: {
          id: "soda_cocacola",
          name: "Coca-Cola",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_hawai: {
          id: "soda_hawai",
          name: "Hawai",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_poms: {
          id: "soda_poms",
          name: "Poms",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_sprite: {
          id: "soda_sprite",
          name: "Sprite",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_schweppes_citron: {
          id: "soda_schweppes_citron",
          name: "Schweppes Citron",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_schweppes_tonic: {
          id: "soda_schweppes_tonic",
          name: "Schweppes Tonic",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_schweppes_mojito: {
          id: "soda_schweppes_mojito",
          name: "Schweppes Mojito",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        water_oulmes_regular: {
          id: "water_oulmes_regular",
          name: "OulmÃ¨s",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        water_oulmes_yellow: {
          id: "water_oulmes_yellow",
          name: "OulmÃ¨s Jaune",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },

        muffin: {
          id: "muffin",
          name: "Muffin",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        },
        raib: {
          id: "raib",
          name: "Raib",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        },
        flan: {
          id: "flan",
          name: "Flan",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        }
      };

      const MENU_RECIPES = {
        omelette_cheese: { eggs: 2, cheese: 0.036 },
        omelette_turkey: { eggs: 2, turkey_smoked: 0.04 },
        omelette_kashir: { eggs: 2, kashir: 0.04 },
        breakfast_marrakchi: { eggs: 2 },
        breakfast_catalan: { eggs: 2 },
        croissant_breakfast: { eggs: 2 },
        fried_eggs: { eggs: 2 },

        coffee: { coffee_beans: 0.01 },
        coffee_with_milk: { coffee_beans: 0.01, milk: 0.18 },
        machada: { coffee_beans: 0.01 },
        nescafe: { coffee_beans: 0.01 },
        tea_lipton: { tea_leaves: 0.006 },
        tea_mint: { tea_leaves: 0.006 },
        tea_berrad: { tea_leaves: 0.012 },

        juice_orange: { oranges: 3 },
        juice_apple: { apples: 2 },
        juice_lemon: { lemons: 3 },
        juice_banana: { bananas: 2, milk: 0.2 },
        juice_avocado: { avocados: 1, milk: 0.25 },

        soda_cocacola: { soda_cocacola: 1 },
        soda_hawai: { soda_hawai: 1 },
        soda_poms: { soda_poms: 1 },
        soda_sprite: { soda_sprite: 1 },
        soda_schweppes_citron: { soda_schweppes_citron: 1 },
        soda_schweppes_tonic: { soda_schweppes_tonic: 1 },
        soda_schweppes_mojito: { soda_schweppes_mojito: 1 },
        water_oulmes_regular: { water_oulmes_regular: 1 },
        water_oulmes_yellow: { water_oulmes_yellow: 1 },

        other_muffin: { muffin: 1 },
        other_raib: { raib: 1 },
        other_flan: { flan: 1 }
      };

      function buildShiftId(dateStr, period) {
        return dateStr + "_" + period;
      }

      function pad2(n) {
        return String(n).padStart(2, "0");
      }

      function pad3(n) {
        return String(n).padStart(3, "0");
      }

      function periodToShiftCode(period) {
        if (period === "afternoon") return "02";
        if (period === "morning") return "01";
        if (period === "default") return "01";
        return "01";
      }

      function makeWaiterCode(name) {
        const base = String(name || "")
          .trim()
          .replace(/\s+/g, "")
          .toUpperCase();
        const letters = base.replace(/[^A-Z]/g, "");
        const code = (letters || base).slice(0, 3);
        return code.padEnd(3, "X");
      }

      function resolveShiftIdForDatePeriod(dateStr, period, shifts) {
        const preferred = buildShiftId(dateStr, period);
        const fallback = buildShiftId(dateStr, "default");
        const hasPreferred = (shifts || []).some((s) => s && s.id === preferred);
        const hasFallback = (shifts || []).some((s) => s && s.id === fallback);
        if (hasPreferred) return preferred;
        if (period === "morning" && hasFallback) return fallback;
        return preferred;
      }

      function isCoffee(item) {
        const ids = ["coffee", "coffee_with_milk", "nescafe", "machada"];
        return ids.includes(item.id);
      }

      const DICTIONARY = {
        fr: {
          appTitle: "CafÃ© Halab POS",
          uiSubtitle: "AperÃ§u UI Â· pas encore de backend",
          all: "Tout",
          catBreakfast: "Petit DÃ©jeuner",
          catHot: "Boissons Chaudes",
          catCold: "Boissons Froides",
          catOthers: "Autres",
          currentOrder: "Commande en cours",
          cartEmpty: "Le panier est vide.",
          subtotal: "Sous-total",
          tax: "Taxe",
          total: "Total",
          mockPlaceOrder: "Simuler l'envoi de la commande",
          placingOrder: "Envoi en cours...",
          orderOk: "Commande enregistrÃ©e localement (console).",
          milkLabel: "Lait",
          milkYes: "Avec lait",
          milkNo: "Sans lait",
          sugarLabel: "Sucre",
          sugarNone: "Sans sucre",
          sugarLow: "Peu sucrÃ©",
          sugarMedium: "Moyen",
          sugarExtra: "SucrÃ©",
          drinkLabel: "Boisson chaude",
          drinkTea: "ThÃ©",
          drinkCoffeeMilk: "CafÃ© au lait",
          milkInLine: "lait",
          sugarInLine: "sucre",
          drinkInLine: "boisson",
          eggsInLine: "Å“ufs",
          drinkInLine: "boisson",
          addLabel: "Ajouter",
          langFr: "FR",
          langAr: "AR",
          ordersInProgress: "Commandes en attente de paiement",
          noOrdersInProgress: "Aucune commande en attente.",
          markPaid: "DÃ©clarer payÃ©",
          shiftOpenTitle: "Ouvrir un shift",
          shiftOpenSubtitle:
            "Saisir le code PIN du serveur pour dÃ©marrer son shift.",
          backToMenus: "Retour aux menus",
          openShiftBtn: "Ouvrir le shift",
          closeShiftBtn: "Fermer le shift",
          pauseShiftBtn: "Pause",
          resumeShiftBtn: "Reprendre",
          confirmPinBtn: "Confirmer",
          pinLabel: "PIN",
          confirmPauseTitle: "Confirmer la pause",
          confirmPauseSubtitle: "Saisir votre PIN pour mettre le shift en pause.",
          shiftPausedTitle: "Shift en pause",
          shiftPausedSubtitle: "Saisir le PIN du serveur pour reprendre.",
          autoPausedMessage: "Shift mis en pause automatiquement (inactivitÃ©).",
          pinIncorrect: "PIN incorrect",
          orderAddedPending: "Commande ajoutÃ©e aux commandes en attente.",
          shiftPausedBlocking: "Shift en pause. Reprenez pour continuer.",
          closeBtn: "Fermer",
          needWorkerLogin: "Ouvrez un shift (PIN serveur) avant de prendre une commande.",
          noShiftOpen: "Aucun shift ouvert.",
          shiftSummaryTitle: "Shift",
          shiftSummaryNone: "Aucun shift ouvert.",
          virtualTicketsTitle: "Tickets des commandes",
          paidOrdersTitle: "Commandes payÃ©es",
          unpaidOrdersTitle: "Commandes non payÃ©es",
          noPaidOrders: "Aucune commande payÃ©e.",
          noUnpaidOrders: "Aucune commande non payÃ©e.",
          orderLabel: "Commande",
          waiterLabel: "Serveur",
          createdAtLabel: "CrÃ©Ã©e",
          paidAtLabel: "PayÃ©e",
          statusPaid: "PayÃ©e",
          statusUnpaid: "Non payÃ©e",
          detailsBtn: "DÃ©tails",
          hideDetailsBtn: "Masquer",
          inventoryTitle: "Inventaire",
          inventoryItemsTitle: "Articles",
          inventoryEditTitle: "Modifier",
          inventorySelectItem: "SÃ©lectionner un article",
          inventoryCurrentQty: "QuantitÃ© actuelle",
          inventoryMinQty: "Seuil minimum",
          inventoryUnitLabel: "UnitÃ©",
          inventoryAdjustLabel: "Ajustement",
          inventoryAddBtn: "Ajouter",
          inventoryRemoveBtn: "Retirer",
          inventoryUpdateBtn: "Mettre Ã  jour",
          inventoryTableTitle: "Tableau du stock",
          inventoryTableIngredient: "IngrÃ©dient",
          inventoryTableLastShift: "Consommation (dernier shift)",
          inventoryTableTotal: "Consommation (total)",
          inventoryTableInitial: "QuantitÃ© initiale",
          inventoryTableRemaining: "QuantitÃ© restante",
          inventoryTableLastUpdate: "DerniÃ¨re mise Ã  jour",
          firebaseLoginTitle: "Connexion Cloud",
          firebaseLoginSubtitle:
            "Connectez-vous pour synchroniser les donnÃ©es du POS (commandes, shifts, stock) vers le cloud.",
          firebaseEmailLabel: "Email",
          firebasePasswordLabel: "Mot de passe",
          firebaseLoginBtn: "Se connecter",
          firebaseLoggingIn: "Connexion...",
          firebaseOfflineBtn: "Continuer hors ligne",
          firebaseCloudConnected: "Cloud: connectÃ©",
          firebaseCloudDisconnected: "Cloud: non connectÃ©",
          firebaseCloudConnectBtn: "Connexion",
          firebaseLogoutBtn: "DÃ©connexion"
        },
        ar: {
          appTitle: "Ù†Ø¸Ø§Ù… Ù…Ù‚Ù‡Ù‰ Ø­Ù„Ø¨",
          uiSubtitle: "ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø· Â· Ø¨Ø¯ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø¨Ø¹Ø¯",
          all: "Ø§Ù„ÙƒÙ„",
          catBreakfast: "ÙØ·ÙˆØ±",
          catHot: "Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø³Ø§Ø®Ù†Ø©",
          catCold: "Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø¨Ø§Ø±Ø¯Ø©",
          catOthers: "Ø£Ø®Ø±Ù‰",
          currentOrder: "Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ",
          cartEmpty: "Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©",
          subtotal: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ",
          tax: "Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©",
          total: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹",
          mockPlaceOrder: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ù„ÙŠØ§Ù‹",
          placingOrder: "Ø¬Ø§Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...",
          orderOk: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­Ù„ÙŠØ§Ù‹ (ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„)",
          milkLabel: "Ø­Ù„ÙŠØ¨",
          milkYes: "Ù…Ø¹ Ø­Ù„ÙŠØ¨",
          milkNo: "Ø¨Ø¯ÙˆÙ† Ø­Ù„ÙŠØ¨",
          sugarLabel: "Ø³ÙƒØ±",
          sugarNone: "Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ±",
          sugarLow: "Ù‚Ù„ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±",
          sugarMedium: "Ø¹Ø§Ø¯ÙŠ",
          sugarExtra: "Ø­Ù„Ùˆ",
          drinkLabel: "Ù…Ø´Ø±ÙˆØ¨ Ø³Ø§Ø®Ù†",
          drinkTea: "Ø´Ø§ÙŠ",
          drinkCoffeeMilk: "Ù‚Ù‡ÙˆØ© Ø¨Ø§Ù„Ø­Ù„ÙŠØ¨",
          milkInLine: "Ø­Ù„ÙŠØ¨",
          sugarInLine: "Ø³ÙƒØ±",
          drinkInLine: "Ù…Ø´Ø±ÙˆØ¨",
          eggsInLine: "Ø¨ÙŠØ¶",
          drinkInLine: "Ù…Ø´Ø±ÙˆØ¨",
          addLabel: "Ø¥Ø¶Ø§ÙØ©",
          langFr: "ÙØ±",
          langAr: "Ø¹Ø±",
          ordersInProgress: "Ø·Ù„Ø¨Ø§Øª ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©",
          noOrdersInProgress: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©.",
          markPaid: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹",
          shiftOpenTitle: "ÙØªØ­ Ù†ÙˆØ¨Ø© Ø¹Ù…Ù„",
          shiftOpenSubtitle: "Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù†Ø§Ø¯Ù„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù†ÙˆØ¨Ø©.",
          backToMenus: "Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…",
          openShiftBtn: "ÙØªØ­ Ø§Ù„Ù†ÙˆØ¨Ø©",
          closeShiftBtn: "Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù†ÙˆØ¨Ø©",
          pauseShiftBtn: "Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª",
          resumeShiftBtn: "Ø§Ø³ØªØ¦Ù†Ø§Ù",
          confirmPinBtn: "ØªØ£ÙƒÙŠØ¯",
          pinLabel: "Ø±Ù…Ø² PIN",
          confirmPauseTitle: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª",
          confirmPauseSubtitle: "Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² PIN Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†ÙˆØ¨Ø© Ù…Ø¤Ù‚ØªØ§Ù‹.",
          shiftPausedTitle: "Ø§Ù„Ù†ÙˆØ¨Ø© Ù…ØªÙˆÙ‚ÙØ©",
          shiftPausedSubtitle: "Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù†Ø§Ø¯Ù„ Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ø¹Ù…Ù„.",
          autoPausedMessage: "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†ÙˆØ¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø§Ù„Ù†Ø´Ø§Ø·.",
          pinIncorrect: "Ø±Ù…Ø² PIN ØºÙŠØ± ØµØ­ÙŠØ­",
          orderAddedPending: "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.",
          shiftPausedBlocking: "Ø§Ù„Ù†ÙˆØ¨Ø© Ù…ØªÙˆÙ‚ÙØ©. Ø§Ø³ØªØ£Ù†Ù Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.",
          closeBtn: "Ø¥ØºÙ„Ø§Ù‚",
          needWorkerLogin: "Ø§ÙØªØ­ Ù†ÙˆØ¨Ø© (Ø±Ù…Ø² Ø§Ù„Ù†Ø§Ø¯Ù„) Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨.",
          noShiftOpen: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ÙˆØ¨Ø© Ù…ÙØªÙˆØ­Ø©.",
          shiftSummaryTitle: "Ø§Ù„Ù†ÙˆØ¨Ø©",
          shiftSummaryNone: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ÙˆØ¨Ø© Ù…ÙØªÙˆØ­Ø©.",
          virtualTicketsTitle: "ØªØ°Ø§ÙƒØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
          paidOrdersTitle: "Ø·Ù„Ø¨Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø©",
          unpaidOrdersTitle: "Ø·Ù„Ø¨Ø§Øª ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©",
          noPaidOrders: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø©.",
          noUnpaidOrders: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©.",
          orderLabel: "Ø·Ù„Ø¨",
          waiterLabel: "Ø§Ù„Ù†Ø§Ø¯Ù„",
          createdAtLabel: "ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡",
          paidAtLabel: "ÙˆÙ‚Øª Ø§Ù„Ø¯ÙØ¹",
          statusPaid: "Ù…Ø¯ÙÙˆØ¹",
          statusUnpaid: "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",
          detailsBtn: "ØªÙØ§ØµÙŠÙ„",
          hideDetailsBtn: "Ø¥Ø®ÙØ§Ø¡",
          inventoryTitle: "Ø§Ù„Ù…Ø®Ø²ÙˆÙ†",
          inventoryItemsTitle: "Ø§Ù„Ø¹Ù†Ø§ØµØ±",
          inventoryEditTitle: "ØªØ¹Ø¯ÙŠÙ„",
          inventorySelectItem: "Ø§Ø®ØªØ± Ø¹Ù†ØµØ±Ø§Ù‹",
          inventoryCurrentQty: "Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
          inventoryMinQty: "Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰",
          inventoryUnitLabel: "Ø§Ù„ÙˆØ­Ø¯Ø©",
          inventoryAdjustLabel: "ØªØ¹Ø¯ÙŠÙ„",
          inventoryAddBtn: "Ø¥Ø¶Ø§ÙØ©",
          inventoryRemoveBtn: "Ø®ØµÙ…",
          inventoryUpdateBtn: "ØªØ­Ø¯ÙŠØ«",
          inventoryTableTitle: "Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†",
          inventoryTableIngredient: "Ø§Ù„Ù…ÙƒÙˆÙ‘Ù†",
          inventoryTableLastShift: "Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø¢Ø®Ø± Ù†ÙˆØ¨Ø©",
          inventoryTableTotal: "Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ",
          inventoryTableInitial: "Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©",
          inventoryTableRemaining: "Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©",
          inventoryTableLastUpdate: "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«",
          firebaseLoginTitle: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©",
          firebaseLoginSubtitle:
            "Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŒ Ø§Ù„Ù†ÙˆØ¨Ø§ØªØŒ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†) Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.",
          firebaseEmailLabel: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
          firebasePasswordLabel: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
          firebaseLoginBtn: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
          firebaseLoggingIn: "Ø¬Ø§Ø±Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...",
          firebaseOfflineBtn: "Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„",
          firebaseCloudConnected: "Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: Ù…ØªØµÙ„",
          firebaseCloudDisconnected: "Ø§Ù„Ø³Ø­Ø§Ø¨Ø©: ØºÙŠØ± Ù…ØªØµÙ„",
          firebaseCloudConnectBtn: "Ø§ØªØµØ§Ù„",
          firebaseLogoutBtn: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬"
        }
      };

      function LoginPanel({ currentUser, users, onLogin, onLogout }) {
        const [pin, setPin] = React.useState("");
        const [error, setError] = React.useState(null);

        function handleSubmit(ev) {
          ev.preventDefault();
          const u = users.find((user) => user.pin === pin);
          if (!u) {
            setError("PIN incorrect");
            return;
          }
          setError(null);
          setPin("");
          onLogin(u);
        }

        if (currentUser) {
          return React.createElement(
            "div",
            { style: { display: "flex", gap: 8, alignItems: "center" } },
            React.createElement(
              "span",
              null,
              currentUser.name + " (" + currentUser.role + ")"
            ),
            React.createElement(
              "button",
              { className: "category-btn", onClick: onLogout },
              "Logout"
            )
          );
        }

        return React.createElement(
          "form",
          {
            onSubmit: handleSubmit,
            style: { display: "flex", gap: 4, alignItems: "center" }
          },
          React.createElement("input", {
            type: "password",
            value: pin,
            onChange: (e) => setPin(e.target.value),
            placeholder: "PIN",
            style: { padding: 4, fontSize: 12, width: 70 }
          }),
          React.createElement(
            "button",
            { className: "category-btn", type: "submit" },
            "Login"
          ),
          error &&
            React.createElement(
              "span",
              { style: { color: "#b91c1c", fontSize: 11 } },
              error
            )
        );
      }

      function FirebaseLoginOverlay({ t, lang, onSignedIn, onDismiss }) {
        const [email, setEmail] = React.useState("");
        const [password, setPassword] = React.useState("");
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);

        async function handleSubmit(ev) {
          ev.preventDefault();
          if (!window.firebaseAuth) return;
          setLoading(true);
          setError(null);
          try {
            const res = await window.firebaseAuth.signInWithEmailAndPassword(
              String(email || "").trim(),
              String(password || "")
            );
            setPassword("");
            setLoading(false);
            if (onSignedIn) onSignedIn(res && res.user ? res.user : null);
          } catch (e) {
            const msg =
              (e && e.code ? e.code + ": " : "") +
              (e && e.message ? e.message : "");
            setError(msg || "Erreur");
            setLoading(false);
          }
        }

        return React.createElement(
          "div",
          {
            style: {
              position: "fixed",
              inset: 0,
              background: "rgba(15,23,42,0.55)",
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              padding: 16,
              zIndex: 9999
            }
          },
          React.createElement(
            "section",
            {
              className: "panel",
              style: {
                maxWidth: 460,
                width: "100%",
                textAlign: lang === "ar" ? "right" : "left"
              }
            },
            React.createElement(
              "h3",
              { style: { marginTop: 0 } },
              (t && t.firebaseLoginTitle) || "Connexion Cloud"
            ),
            React.createElement(
              "p",
              { style: { fontSize: 13, marginTop: 6, color: "#334155" } },
              (t && t.firebaseLoginSubtitle) ||
                "Connectez-vous pour synchroniser les donnÃ©es du POS vers le cloud."
            ),
            React.createElement(
              "form",
              {
                onSubmit: handleSubmit,
                style: {
                  display: "flex",
                  flexDirection: "column",
                  gap: 10,
                  marginTop: 12
                }
              },
              React.createElement("input", {
                type: "email",
                autoComplete: "email",
                value: email,
                onChange: (e) => setEmail(e.target.value),
                placeholder: (t && t.firebaseEmailLabel) || "Email",
                style: { padding: 10, fontSize: 14 }
              }),
              React.createElement("input", {
                type: "password",
                autoComplete: "current-password",
                value: password,
                onChange: (e) => setPassword(e.target.value),
                placeholder: (t && t.firebasePasswordLabel) || "Mot de passe",
                style: { padding: 10, fontSize: 14 }
              }),
              React.createElement(
                "div",
                { style: { display: "flex", gap: 8, marginTop: 4 } },
                React.createElement(
                  "button",
                  { className: "btn-primary", type: "submit", disabled: loading },
                  loading
                    ? (t && t.firebaseLoggingIn) || "Connexion..."
                    : (t && t.firebaseLoginBtn) || "Se connecter"
                ),
                React.createElement(
                  "button",
                  {
                    className: "category-btn",
                    type: "button",
                    onClick: onDismiss
                  },
                  (t && t.firebaseOfflineBtn) || "Continuer hors ligne"
                )
              ),
              error &&
                React.createElement(
                  "div",
                  { style: { fontSize: 12, color: "#b91c1c", marginTop: 6 } },
                  error
                )
            )
          )
        );
      }

      function FirebaseAuthBadge({ t, lang, firebaseUser, dismissed, onOpenLogin, onLogout }) {
        if (!window.firebaseAuth) return null;
        const label = firebaseUser
          ? (t && t.firebaseCloudConnected) || "Cloud: connectÃ©"
          : (t && t.firebaseCloudDisconnected) || "Cloud: non connectÃ©";

        return React.createElement(
          "div",
          {
            style: {
              display: "flex",
              gap: 8,
              alignItems: "center",
              marginLeft: 10,
              padding: "6px 10px",
              borderRadius: 999,
              background: "rgba(15,23,42,0.06)",
              border: "1px solid rgba(148,163,184,0.4)",
              fontSize: 12,
              whiteSpace: "nowrap"
            }
          },
          React.createElement(
            "span",
            { style: { fontWeight: 700 } },
            label
          ),
          firebaseUser &&
            React.createElement(
              "span",
              { style: { color: "#475569" } },
              firebaseUser.email
            ),
          firebaseUser
            ? React.createElement(
                "button",
                { className: "category-btn", onClick: onLogout, type: "button" },
                (t && t.firebaseLogoutBtn) || "DÃ©connexion"
              )
            : dismissed
              ? React.createElement(
                  "button",
                  {
                    className: "category-btn",
                    onClick: onOpenLogin,
                    type: "button"
                  },
                  (t && t.firebaseCloudConnectBtn) || "Connexion"
                )
              : null
        );
      }

      function AdminInventoryEditor({ inventory, t, onAdjust, onUpdate }) {
        const items = Object.values(inventory)
          .slice()
          .sort((a, b) => (a.name || a.id).localeCompare(b.name || b.id));
        const [selectedId, setSelectedId] = React.useState(items[0]?.id || null);
        const [adjustValue, setAdjustValue] = React.useState("");
        const selected = selectedId ? inventory[selectedId] : null;
        const [currentQty, setCurrentQty] = React.useState(
          selected ? String(selected.currentQty) : ""
        );
        const [minQty, setMinQty] = React.useState(
          selected ? String(selected.minQty) : ""
        );

        React.useEffect(() => {
          const s = selectedId ? inventory[selectedId] : null;
          setCurrentQty(s ? String(s.currentQty) : "");
          setMinQty(s ? String(s.minQty) : "");
        }, [selectedId, inventory]);

        function parseNum(v) {
          const n = Number(String(v).replace(",", "."));
          return Number.isFinite(n) ? n : null;
        }

        function handleAdd() {
          if (!selectedId) return;
          const n = parseNum(adjustValue);
          if (n == null || n <= 0) return;
          onAdjust(selectedId, n);
          setAdjustValue("");
        }

        function handleRemove() {
          if (!selectedId) return;
          const n = parseNum(adjustValue);
          if (n == null || n <= 0) return;
          onAdjust(selectedId, -n);
          setAdjustValue("");
        }

        function handleUpdate() {
          if (!selectedId) return;
          const c = parseNum(currentQty);
          const m = parseNum(minQty);
          if (c == null || m == null) return;
          onUpdate(selectedId, c, m);
        }

        if (!items.length) {
          return React.createElement(
            "div",
            { style: { fontSize: 12 } },
            t.inventorySelectItem || "SÃ©lectionner un article"
          );
        }

        return React.createElement(
          "div",
          {
            style: {
              display: "grid",
              gridTemplateColumns: "minmax(0, 1.4fr) minmax(0, 2fr)",
              gap: 14,
              alignItems: "flex-start"
            }
          },
          React.createElement(
            "div",
            {
              style: {
                borderRadius: 10,
                background: "linear-gradient(145deg,#eef2ff,#e0f2fe)",
                border: "1px solid rgba(129,140,248,0.6)",
                maxHeight: 260,
                overflowY: "auto"
              }
            },
            items.map((ing) =>
              React.createElement(
                "div",
                {
                  key: ing.id,
                  onClick: () => setSelectedId(ing.id),
                  style: {
                    padding: "8px 10px",
                    cursor: "pointer",
                    fontSize: 12,
                    background:
                      ing.id === selectedId
                        ? "rgba(129,140,248,0.3)"
                        : "transparent"
                  }
                },
                React.createElement(
                  "div",
                  { style: { fontWeight: 700 } },
                  ing.name || ing.id
                ),
                React.createElement(
                  "div",
                  { style: { fontSize: 11, color: "#475569" } },
                  ing.currentQty,
                  " ",
                  ing.unit,
                  ing.currentQty <= ing.minQty ? " (LOW)" : ""
                )
              )
            )
          ),
          React.createElement(
            "div",
            {
              style: {
                borderRadius: 12,
                padding: 12,
                background:
                  "linear-gradient(145deg, rgba(255,255,255,0.96), rgba(224,231,255,0.72))",
                border: "1px solid rgba(148,163,184,0.55)"
              }
            },
            React.createElement(
              "div",
              { style: { fontSize: 13, fontWeight: 800, marginBottom: 8 } },
              t.inventoryEditTitle || "Modifier"
            ),
            selected &&
              React.createElement(
                "div",
                { style: { fontSize: 12, marginBottom: 10 } },
                React.createElement(
                  "div",
                  { style: { fontWeight: 700 } },
                  selected.name || selected.id
                ),
                React.createElement(
                  "div",
                  { style: { color: "#475569", marginTop: 2 } },
                  (t.inventoryUnitLabel || "UnitÃ©") + ": ",
                  selected.unit
                )
              ),
            React.createElement(
              "div",
              { style: { display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 } },
              React.createElement(
                "label",
                { style: { fontSize: 12 } },
                React.createElement(
                  "div",
                  { style: { fontSize: 11, color: "#475569", marginBottom: 4 } },
                  t.inventoryCurrentQty || "QuantitÃ© actuelle"
                ),
                React.createElement("input", {
                  value: currentQty,
                  onChange: (e) => setCurrentQty(e.target.value),
                  style: { width: "100%", padding: 6, fontSize: 12 },
                  inputMode: "decimal"
                })
              ),
              React.createElement(
                "label",
                { style: { fontSize: 12 } },
                React.createElement(
                  "div",
                  { style: { fontSize: 11, color: "#475569", marginBottom: 4 } },
                  t.inventoryMinQty || "Seuil minimum"
                ),
                React.createElement("input", {
                  value: minQty,
                  onChange: (e) => setMinQty(e.target.value),
                  style: { width: "100%", padding: 6, fontSize: 12 },
                  inputMode: "decimal"
                })
              )
            ),
            React.createElement(
              "div",
              { style: { marginTop: 10 } },
              React.createElement(
                "div",
                { style: { fontSize: 11, color: "#475569", marginBottom: 4 } },
                t.inventoryAdjustLabel || "Ajustement"
              ),
              React.createElement(
                "div",
                { style: { display: "flex", gap: 6, alignItems: "center" } },
                React.createElement("input", {
                  value: adjustValue,
                  onChange: (e) => setAdjustValue(e.target.value),
                  style: { flex: 1, padding: 6, fontSize: 12 },
                  inputMode: "decimal"
                }),
                React.createElement(
                  "button",
                  { className: "category-btn", type: "button", onClick: handleAdd },
                  t.inventoryAddBtn || "Ajouter"
                ),
                React.createElement(
                  "button",
                  {
                    className: "category-btn",
                    type: "button",
                    onClick: handleRemove
                  },
                  t.inventoryRemoveBtn || "Retirer"
                )
              )
            ),
            React.createElement(
              "button",
              {
                className: "btn-primary",
                type: "button",
                style: { marginTop: 10 },
                onClick: handleUpdate
              },
              t.inventoryUpdateBtn || "Mettre Ã  jour"
            )
          )
        );
      }

      function AdminOrdersTickets({ orders, users, lang, t, activeShiftId, shifts }) {
        const [expanded, setExpanded] = React.useState({});

        const [selectedDate, setSelectedDate] = React.useState(() => {
          if (activeShiftId) return String(activeShiftId).split("_")[0] || "";
          return new Date().toISOString().slice(0, 10);
        });
        const [selectedPeriod, setSelectedPeriod] = React.useState(() => {
          if (!activeShiftId) return "morning";
          const p = String(activeShiftId).split("_")[1] || "morning";
          if (p === "default") return "morning";
          return p;
        });

        React.useEffect(() => {
          if (!activeShiftId) return;
          const parts = String(activeShiftId).split("_");
          const d = parts[0] || "";
          const p = parts[1] || "morning";
          if (d) setSelectedDate(d);
          setSelectedPeriod(p === "default" ? "morning" : p);
        }, [activeShiftId]);

        function formatTime(iso) {
          try {
            const d = new Date(iso);
            return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
          } catch (e) {
            return "";
          }
        }

        function formatDate(iso) {
          try {
            const d = new Date(iso);
            return d.toLocaleDateString();
          } catch (e) {
            return "";
          }
        }

        function displayOrderNumber(orderId) {
          if (!orderId) return "";
          const digits = String(orderId).replace(/\D/g, "");
          if (digits.length) return digits.slice(-4);
          return String(orderId).slice(-4);
        }

        function userNameById(userId) {
          const u = users.find((x) => x.id === userId);
          return u ? u.name : userId;
        }

        function lineLabel(line) {
          const base = lang === "ar" ? line.nameAr || line.name : line.nameFr || line.name;
          return base;
        }

        function lineModifiersLabel(line) {
          const mods = line.modifiers || {};
          const parts = [];
          if (mods.milk != null) {
            parts.push(`${t.milkInLine}: ${mods.milk ? t.milkYes : t.milkNo}`);
          }
          if (mods.sugar) {
            parts.push(`${t.sugarInLine}: ${mods.sugar}`);
          }
          if (mods.drink) {
            parts.push(`${t.drinkInLine}: ${mods.drink}`);
          }
          if (mods.eggCount) {
            parts.push(`${t.eggsInLine}: ${mods.eggCount}`);
          }
          return parts.length ? "(" + parts.join(", ") + ")" : "";
        }

        const selectedShiftId = resolveShiftIdForDatePeriod(
          selectedDate,
          selectedPeriod,
          shifts
        );

        const scopedOrders = selectedShiftId
          ? orders.filter((o) => o.shiftId === selectedShiftId)
          : orders;

        const unpaidOrders = scopedOrders
          .filter((o) => o.status !== "paid")
          .slice()
          .reverse();
        const paidOrders = scopedOrders
          .filter((o) => o.status === "paid")
          .slice()
          .reverse();

        function toggle(id) {
          setExpanded((prev) => ({ ...prev, [id]: !prev[id] }));
        }

        function TicketCard(order, statusLabel) {
          const isExpanded = !!expanded[order.id];
          const ticketLabel = order.ticketCode || displayOrderNumber(order.id);
          return React.createElement(
            "div",
            {
              key: order.id,
              style: {
                borderRadius: 14,
                border: "1px solid rgba(148,163,184,0.55)",
                background:
                  "linear-gradient(145deg, rgba(255,255,255,0.96), rgba(224,231,255,0.72))",
                boxShadow: "0 10px 22px rgba(15,23,42,0.10)",
                padding: 10,
                marginBottom: 10
              }
            },
            React.createElement(
              "div",
              {
                style: {
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "center",
                  gap: 10
                }
              },
              React.createElement(
                "div",
                { style: { fontSize: 12, fontWeight: 800 } },
                (t.orderLabel || "Commande") + " " + ticketLabel + " Â· " + statusLabel
              ),
              React.createElement(
                "button",
                {
                  className: "category-btn",
                  type: "button",
                  onClick: () => toggle(order.id)
                },
                isExpanded
                  ? t.hideDetailsBtn || "Masquer"
                  : t.detailsBtn || "DÃ©tails"
              )
            ),
            React.createElement(
              "div",
              { style: { fontSize: 11, color: "#6b7280", marginTop: 4 } },
              (t.waiterLabel || "Serveur") + ": " + userNameById(order.cashierId)
            ),
            React.createElement(
              "div",
              { style: { fontSize: 11, color: "#6b7280", marginTop: 2 } },
              (t.createdAtLabel || "CrÃ©Ã©e") +
                ": " +
                formatDate(order.createdAt) +
                " " +
                formatTime(order.createdAt)
            ),
            order.status === "paid" &&
              order.paidAt &&
              React.createElement(
                "div",
                { style: { fontSize: 11, color: "#6b7280", marginTop: 2 } },
                (t.paidAtLabel || "PayÃ©e") +
                  ": " +
                  formatDate(order.paidAt) +
                  " " +
                  formatTime(order.paidAt)
              ),
            isExpanded &&
              React.createElement(
                "div",
                { style: { marginTop: 8 } },
                order.items.map((line) =>
                  React.createElement(
                    "div",
                    {
                      key: line.key,
                      style: {
                        display: "flex",
                        justifyContent: "space-between",
                        gap: 10,
                        fontSize: 12,
                        padding: "2px 0"
                      }
                    },
                    React.createElement(
                      "div",
                      { style: { flex: 1 } },
                      `${line.qty}Ã— `,
                      lineLabel(line),
                      " ",
                      React.createElement(
                        "span",
                        { style: { fontSize: 11, color: "#6b7280" } },
                        lineModifiersLabel(line)
                      )
                    ),
                    React.createElement(
                      "div",
                      { style: { whiteSpace: "nowrap" } },
                      `${(line.price * line.qty).toFixed(2)} DHS`
                    )
                  )
                ),
                React.createElement(
                  "div",
                  {
                    style: {
                      display: "flex",
                      justifyContent: "space-between",
                      alignItems: "center",
                      marginTop: 10
                    }
                  },
                  React.createElement(
                    "div",
                    { style: { fontWeight: 800, fontSize: 12 } },
                    `${order.totals.total.toFixed(2)} DHS`
                  ),
                  React.createElement(
                    "div",
                    { style: { fontSize: 11, color: "#6b7280" } },
                    "ID: ",
                    order.id
                  )
                )
              )
          );
        }

        return React.createElement(
          "div",
          null,
          React.createElement(
            "div",
            {
              style: {
                display: "flex",
                gap: 8,
                alignItems: "center",
                marginBottom: 10,
                flexWrap: "wrap"
              }
            },
            React.createElement(
              "div",
              { style: { fontSize: 12, fontWeight: 700 } },
              "Date"
            ),
            React.createElement("input", {
              type: "date",
              value: selectedDate,
              onChange: (e) => setSelectedDate(e.target.value),
              style: { padding: 6, fontSize: 12 }
            }),
            React.createElement(
              "div",
              { style: { fontSize: 12, fontWeight: 700 } },
              "Shift"
            ),
            React.createElement(
              "select",
              {
                value: selectedPeriod,
                onChange: (e) => setSelectedPeriod(e.target.value),
                style: { padding: 6, fontSize: 12 }
              },
              React.createElement("option", { value: "morning" }, "01 Â· Matin"),
              React.createElement("option", { value: "afternoon" }, "02 Â· AprÃ¨s-midi")
            ),
            React.createElement(
              "div",
              { style: { fontSize: 11, color: "#64748b" } },
              selectedShiftId ? "(" + selectedShiftId + ")" : ""
            )
          ),
          React.createElement(
            "h3",
            { style: { marginTop: 0 } },
            t.virtualTicketsTitle || "Tickets"
          ),
          React.createElement(
            "h4",
            { style: { margin: "10px 0 8px", fontSize: 13 } },
            t.unpaidOrdersTitle || "Commandes non payÃ©es"
          ),
          unpaidOrders.length === 0
            ? React.createElement(
                "div",
                { style: { fontSize: 12, color: "#6b7280" } },
                t.noUnpaidOrders || "Aucune commande non payÃ©e."
              )
            : unpaidOrders.map((o) => TicketCard(o, t.statusUnpaid || "Non payÃ©e")),
          React.createElement(
            "h4",
            { style: { margin: "14px 0 8px", fontSize: 13 } },
            t.paidOrdersTitle || "Commandes payÃ©es"
          ),
          paidOrders.length === 0
            ? React.createElement(
                "div",
                { style: { fontSize: 12, color: "#6b7280" } },
                t.noPaidOrders || "Aucune commande payÃ©e."
              )
            : paidOrders.map((o) => TicketCard(o, t.statusPaid || "PayÃ©e"))
        );
      }

      function AdminUsersPanel({ users, onChangePin }) {
        const editableUsers = users.filter(
          (u) => u.role === "worker" || u.role === "manager"
        );
        const [selectedId, setSelectedId] = React.useState(
          editableUsers[0]?.id || null
        );
        const [newPin, setNewPin] = React.useState("");

        if (!editableUsers.length) {
          return React.createElement(
            "p",
            { style: { fontSize: 12 } },
            "Aucun utilisateur Ã  modifier."
          );
        }

        const current = editableUsers.find((u) => u.id === selectedId) ||
          editableUsers[0];

        function handleSave() {
          if (!newPin || newPin.length < 4) {
            alert("PIN minimum 4 chiffres.");
            return;
          }
          onChangePin(current.id, newPin);
          setNewPin("");
        }

        return React.createElement(
          "div",
          {
            style: {
              fontSize: 12,
              display: "grid",
              gridTemplateColumns: "minmax(0, 1.4fr) minmax(0, 2fr)",
              gap: 12
            }
          },
          React.createElement(
            "div",
            {
              style: {
                borderRadius: 10,
                background: "linear-gradient(145deg,#eef2ff,#e0f2fe)",
                border: "1px solid rgba(129,140,248,0.6)",
                maxHeight: 220,
                overflowY: "auto"
              }
            },
            editableUsers.map((u) =>
              React.createElement(
                "div",
                {
                  key: u.id,
                  onClick: () => setSelectedId(u.id),
                  style: {
                    padding: "6px 10px",
                    cursor: "pointer",
                    fontSize: 12,
                    background:
                      u.id === current.id ? "rgba(129,140,248,0.3)" : "transparent"
                  }
                },
                u.name,
                " (",
                u.role,
                ")"
              )
            )
          ),
          React.createElement(
            "div",
            {
              style: {
                borderRadius: 12,
                padding: 10,
                background: "rgba(15,23,42,0.02)",
                border: "1px solid #e5e7eb",
                boxShadow: "0 8px 18px rgba(15,23,42,0.08)"
              }
            },
            React.createElement(
              "h4",
              { style: { marginTop: 0, marginBottom: 6 } },
              "Changer PIN utilisateur"
            ),
            React.createElement(
              "div",
              { style: { marginBottom: 4 } },
              "Utilisateur: ",
              current.name,
              " (",
              current.role,
              ")"
            ),
            React.createElement(
              "div",
              { style: { marginTop: 6 } },
              React.createElement(
                "div",
                { style: { fontWeight: 600, marginBottom: 2 } },
                "Nouveau PIN"
              ),
              React.createElement("input", {
                type: "password",
                value: newPin,
                onChange: (e) => setNewPin(e.target.value),
                style: { width: "100%", padding: 4, fontSize: 12 }
              })
            ),
            React.createElement(
              "button",
              {
                type: "button",
                className: "btn-primary",
                style: { marginTop: 8 },
                onClick: handleSave
              },
              "Enregistrer le PIN"
            )
          )
        );
      }

      function ShiftPanel({
        currentUser,
        activeShift,
        shifts,
        onOpenShift,
        onCloseShift
      }) {
        const [period, setPeriod] = React.useState("morning");
        const today = new Date().toISOString().slice(0, 10);

        if (
          !currentUser ||
          (currentUser.role !== "manager" && currentUser.role !== "admin")
        ) {
          return React.createElement(
            "p",
            { style: { fontSize: 12 } },
            "Admin seulement."
          );
        }

        const lastShifts = shifts.slice(-5).reverse();

        function handleOpen() {
          onOpenShift(today, period);
        }

        function handleClose() {
          onCloseShift();
        }

        return React.createElement(
          "div",
          null,
          React.createElement(
            "h3",
            null,
            "Shift du jour: " + today
          ),
          React.createElement(
            "div",
            { style: { marginBottom: 8 } },
            activeShift
              ? "Ouvert: " + activeShift.date + " (" + activeShift.period + ")"
              : "Aucun shift ouvert"
          ),
          !activeShift &&
            React.createElement(
              "div",
              { style: { display: "flex", gap: 4, marginBottom: 8 } },
              React.createElement(
                "select",
                {
                  value: period,
                  onChange: (e) => setPeriod(e.target.value),
                  style: { padding: 4, fontSize: 12 }
                },
                React.createElement("option", { value: "morning" }, "Matin"),
                React.createElement(
                  "option",
                  { value: "afternoon" },
                  "AprÃ¨s-midi"
                )
              ),
              React.createElement(
                "button",
                {
                  className: "btn-primary",
                  type: "button",
                  onClick: handleOpen
                },
                "Ouvrir shift"
              )
            ),
          activeShift &&
            React.createElement(
              "button",
              {
                className: "btn-primary",
                type: "button",
                onClick: handleClose
              },
              "Fermer shift"
            ),
          React.createElement("hr", { style: { margin: "10px 0" } }),
          React.createElement("h4", null, "Derniers shifts"),
          lastShifts.length === 0
            ? React.createElement(
                "p",
                { style: { fontSize: 12 } },
                "Aucun shift."
              )
            : lastShifts.map((s) =>
                React.createElement(
                  "div",
                  { key: s.id, style: { fontSize: 12, marginBottom: 4 } },
                  s.date,
                  " ",
                  s.period,
                  " | statut: ",
                  s.status,
                  " | commandes: ",
                  s.orderCount,
                  " | CA: ",
                  s.revenue.toFixed(2),
                  " DHS | cash attendu: ",
                  s.expectedCash.toFixed(2),
                  " DHS"
                )
              )
        );
      }

      function ManagerStats({ shifts, orders, inventoryLogs, inventory }) {
        if (!shifts.length) {
          return React.createElement(
            "p",
            { style: { fontSize: 12 } },
            "Aucun shift."
          );
        }

        function unitForIngredient(id) {
          return inventory && inventory[id] ? inventory[id].unit : "";
        }

        function getShiftStats(shift) {
          const shiftOrders = orders.filter((o) => o.shiftId === shift.id);
          const paidOrders = shiftOrders.filter((o) => o.status === "paid");
          const revenue = paidOrders.reduce(
            (sum, o) => sum + o.totals.total,
            0
          );
          const orderCount = paidOrders.length;
          const expectedCash = revenue;

          const logs = inventoryLogs.filter(
            (log) => log.shiftId === shift.id && log.reason === "sale"
          );
          const byIngredient = {};
          logs.forEach((log) => {
            byIngredient[log.ingredientId] =
              (byIngredient[log.ingredientId] || 0) + log.delta;
          });

          return { revenue, orderCount, expectedCash, byIngredient };
        }

        return React.createElement(
          "div",
          null,
          shifts
            .slice()
            .reverse()
            .map((shift) => {
              const stats = getShiftStats(shift);
              return React.createElement(
                "div",
                {
                  key: shift.id,
                  style: {
                    borderRadius: 12,
                    padding: 10,
                    marginBottom: 10,
                    background:
                      "linear-gradient(135deg, rgba(56,189,248,0.1), rgba(59,130,246,0.16))",
                    border: "1px solid rgba(59,130,246,0.35)",
                    boxShadow: "0 10px 24px rgba(15,23,42,0.15)"
                  }
                },
                React.createElement(
                  "div",
                  { style: { fontSize: 13, fontWeight: 600 } },
                  shift.date,
                  " ",
                  shift.period,
                  " (",
                  shift.status,
                  ")"
                ),
                React.createElement(
                  "div",
                  { style: { fontSize: 12, marginTop: 4 } },
                  "Commandes payÃ©es: ",
                  stats.orderCount,
                  " | CA: ",
                  stats.revenue.toFixed(2),
                  " DHS | Cash attendu: ",
                  stats.expectedCash.toFixed(2),
                  " DHS"
                ),
                React.createElement(
                  "div",
                  { style: { marginTop: 6, fontSize: 12 } },
                  "Consommation stock:"
                ),
                Object.keys(stats.byIngredient).length === 0
                  ? React.createElement(
                      "div",
                      { style: { fontSize: 11 } },
                      "Aucun mouvement."
                    )
                  : Object.entries(stats.byIngredient).map(([ingId, delta]) =>
                      React.createElement(
                        "div",
                        { key: ingId, style: { fontSize: 11 } },
                        ingId,
                        ": ",
                        delta,
                        " ",
                        unitForIngredient(ingId)
                      )
                    )
              );
            })
        );
      }

      function AdminStats({ shifts, orders, inventoryLogs, inventory, t, lang }) {
        if (!shifts.length) {
          return React.createElement(
            "p",
            { style: { fontSize: 12 } },
            "Aucun shift pour l'instant."
          );
        }

        const confirmedOrders = (orders || []).filter(
          (o) => o && (o.status === "paid" || o.status === "unpaid")
        );
        const paidOrders = confirmedOrders.filter((o) => o.status === "paid");
        const unpaidOrders = confirmedOrders.filter((o) => o.status === "unpaid");
        const totalRevenue = confirmedOrders.reduce(
          (sum, o) => sum + ((o.totals && o.totals.total) || 0),
          0
        );
        const totalPaidOrders = paidOrders.length;
        const totalUnpaidOrders = unpaidOrders.length;
        const unpaidRevenue = unpaidOrders.reduce(
          (sum, o) => sum + ((o.totals && o.totals.total) || 0),
          0
        );

        function nameForIngredient(id) {
          return inventory[id]?.name || id;
        }

        function unitForIngredient(id) {
          return inventory[id]?.unit || "";
        }

        function formatQty(value, unit) {
          if (value == null || Number.isNaN(value)) return "";
          if (unit === "pcs") {
            const v = Math.round(value);
            return String(v);
          }
          const rounded = Math.round(value * 1000) / 1000;
          return String(rounded).replace(/\.0+$/, "").replace(/(\.\d*[1-9])0+$/, "$1");
        }

        function formatDateTime(iso) {
          if (!iso) return "";
          try {
            const d = new Date(iso);
            return d.toLocaleString(lang === "ar" ? "ar-MA" : "fr-FR", {
              year: "2-digit",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit"
            });
          } catch (e) {
            return "";
          }
        }

        function displayOrderNumber(orderId) {
          if (!orderId) return "";
          const digits = String(orderId).replace(/\D/g, "");
          if (digits.length) return digits.slice(-4);
          return String(orderId).slice(-4);
        }

        const lastShift = shifts[shifts.length - 1];
        const lastShiftId = lastShift ? lastShift.id : null;

        const totalSaleByIngredient = {};
        const lastShiftSaleByIngredient = {};
        const lastUpdateByIngredient = {};
        inventoryLogs.forEach((log) => {
          if (!log || !log.ingredientId) return;

          const prevIso = lastUpdateByIngredient[log.ingredientId];
          if (!prevIso || (log.createdAt && log.createdAt > prevIso)) {
            lastUpdateByIngredient[log.ingredientId] = log.createdAt;
          }

          if (log.reason === "sale") {
            totalSaleByIngredient[log.ingredientId] =
              (totalSaleByIngredient[log.ingredientId] || 0) + (log.delta || 0);
            if (lastShiftId && log.shiftId === lastShiftId) {
              lastShiftSaleByIngredient[log.ingredientId] =
                (lastShiftSaleByIngredient[log.ingredientId] || 0) + (log.delta || 0);
            }
          }
        });

        const ingredientIds = Object.keys(inventory || {}).sort((a, b) =>
          nameForIngredient(a).localeCompare(nameForIngredient(b))
        );

        const tableTitle =
          (t && t.inventoryTableTitle) || "Tableau du stock";
        const colIngredient =
          (t && t.inventoryTableIngredient) || "IngrÃ©dient";
        const colLastShift =
          (t && t.inventoryTableLastShift) || "Consommation (dernier shift)";
        const colTotal = (t && t.inventoryTableTotal) || "Consommation (total)";
        const colInitial = (t && t.inventoryTableInitial) || "QuantitÃ© initiale";
        const colRemaining =
          (t && t.inventoryTableRemaining) || "QuantitÃ© restante";
        const colLastUpdate =
          (t && t.inventoryTableLastUpdate) || "DerniÃ¨re mise Ã  jour";

        const thStyle = {
          textAlign: lang === "ar" ? "right" : "left",
          padding: "8px 8px",
          fontSize: 11,
          fontWeight: 700,
          color: "#0f172a",
          borderBottom: "1px solid rgba(148,163,184,0.6)",
          background: "rgba(226,232,240,0.8)",
          position: "sticky",
          top: 0
        };
        const tdStyle = {
          padding: "7px 8px",
          fontSize: 11,
          borderBottom: "1px solid rgba(148,163,184,0.25)",
          verticalAlign: "top"
        };

        return React.createElement(
          "div",
          null,
          React.createElement(
            "div",
            {
              style: {
                display: "grid",
                gridTemplateColumns: "repeat(auto-fit, minmax(140px, 1fr))",
                gap: 10,
                marginBottom: 10
              }
            },
            React.createElement(
              "div",
              {
                style: {
                  borderRadius: 12,
                  padding: 10,
                  background:
                    "linear-gradient(135deg, #22c55e, #a3e635)",
                  color: "#0f172a",
                  boxShadow: "0 10px 24px rgba(34,197,94,0.6)",
                  fontSize: 12
                }
              },
              React.createElement(
                "div",
                { style: { fontWeight: 700, marginBottom: 4 } },
                "CA total"
              ),
              React.createElement(
                "div",
                { style: { fontSize: 16 } },
                totalRevenue.toFixed(2),
                " DHS"
              )
            ),
            React.createElement(
              "div",
              {
                style: {
                  borderRadius: 12,
                  padding: 10,
                  background:
                    "linear-gradient(135deg, #38bdf8, #6366f1)",
                  color: "#f9fafb",
                  boxShadow: "0 10px 24px rgba(59,130,246,0.6)",
                  fontSize: 12
                }
              },
              React.createElement(
                "div",
                { style: { fontWeight: 700, marginBottom: 4 } },
                (t && t.paidOrdersTitle) || "Commandes payÃ©es"
              ),
              React.createElement(
                "div",
                { style: { fontSize: 16 } },
                totalPaidOrders
              )
            ),
            React.createElement(
              "div",
              {
                style: {
                  borderRadius: 12,
                  padding: 10,
                  background:
                    "linear-gradient(135deg, #f97316, #fb7185)",
                  color: "#f9fafb",
                  boxShadow: "0 10px 24px rgba(248,113,113,0.5)",
                  fontSize: 12
                }
              },
              React.createElement(
                "div",
                { style: { fontWeight: 700, marginBottom: 4 } },
                (t && t.unpaidOrdersTitle) || "Commandes non payÃ©es"
              ),
              React.createElement(
                "div",
                { style: { fontSize: 16 } },
                totalUnpaidOrders
              )
            ),
            React.createElement(
              "div",
              {
                style: {
                  borderRadius: 12,
                  padding: 10,
                  background:
                    "linear-gradient(135deg, #f97316, #fb7185)",
                  color: "#f9fafb",
                  boxShadow: "0 10px 24px rgba(248,113,113,0.5)",
                  fontSize: 12
                }
              },
              React.createElement(
                "div",
                { style: { fontWeight: 700, marginBottom: 4 } },
                "Nombre de shifts"
              ),
              React.createElement(
                "div",
                { style: { fontSize: 16 } },
                shifts.length
              )
            )
          ),
          React.createElement(
            "div",
            { style: { marginTop: 6, fontSize: 12 } },
            React.createElement(
              "div",
              { style: { fontWeight: 600, marginBottom: 4 } },
              (t && t.unpaidOrdersTitle) || "Commandes non payÃ©es"
            ),
            React.createElement(
              "div",
              { style: { fontSize: 11, color: "#475569", marginBottom: 8 } },
              ((t && t.caPendingLabel) || "CA non encaissÃ©") +
                ": " +
                unpaidRevenue.toFixed(2) +
                " DHS"
            ),
            totalUnpaidOrders === 0
              ? React.createElement(
                  "div",
                  { style: { fontSize: 12, color: "#6b7280" } },
                  (t && t.noUnpaidOrders) || "Aucune commande non payÃ©e."
                )
              : React.createElement(
                  "div",
                  {
                    style: {
                      border: "1px solid rgba(148,163,184,0.5)",
                      borderRadius: 12,
                      overflow: "auto",
                      maxHeight: 220,
                      background: "rgba(255,255,255,0.85)"
                    }
                  },
                  unpaidOrders
                    .slice()
                    .sort((a, b) => (b.createdAt || "").localeCompare(a.createdAt || ""))
                    .map((o) =>
                      React.createElement(
                        "div",
                        {
                          key: o.id,
                          style: {
                            display: "flex",
                            justifyContent: "space-between",
                            alignItems: "baseline",
                            gap: 10,
                            padding: "8px 10px",
                            borderBottom: "1px solid rgba(148,163,184,0.25)",
                            fontSize: 12
                          }
                        },
                        React.createElement(
                          "div",
                          { style: { fontWeight: 700 } },
                          ((t && t.orderLabel) || "Commande") + " #" + displayOrderNumber(o.id)
                        ),
                        React.createElement(
                          "div",
                          { style: { fontSize: 11, color: "#6b7280" } },
                          formatDateTime(o.createdAt)
                        ),
                        React.createElement(
                          "div",
                          { style: { whiteSpace: "nowrap", fontWeight: 800 } },
                          (((o.totals && o.totals.total) || 0).toFixed(2)) + " DHS"
                        )
                      )
                    )
                )
          ),
          React.createElement(
            "div",
            { style: { marginTop: 6, fontSize: 12 } },
            React.createElement(
              "div",
              { style: { fontWeight: 600, marginBottom: 4 } },
              tableTitle
            ),
            React.createElement(
              "div",
              {
                style: {
                  marginTop: 6,
                  borderRadius: 12,
                  overflow: "auto",
                  border: "1px solid rgba(148,163,184,0.5)",
                  background: "rgba(255,255,255,0.85)"
                }
              },
              React.createElement(
                "table",
                {
                  style: {
                    width: "100%",
                    borderCollapse: "collapse",
                    minWidth: 720
                  }
                },
                React.createElement(
                  "thead",
                  null,
                  React.createElement(
                    "tr",
                    null,
                    React.createElement("th", { style: thStyle }, colIngredient),
                    React.createElement("th", { style: thStyle }, colLastShift),
                    React.createElement("th", { style: thStyle }, colTotal),
                    React.createElement("th", { style: thStyle }, colInitial),
                    React.createElement("th", { style: thStyle }, colRemaining),
                    React.createElement("th", { style: thStyle }, colLastUpdate)
                  )
                ),
                React.createElement(
                  "tbody",
                  null,
                  ingredientIds.map((id) => {
                    const unit = unitForIngredient(id);
                    const initialQty =
                      (INVENTORY_INITIAL[id] && INVENTORY_INITIAL[id].currentQty) != null
                        ? INVENTORY_INITIAL[id].currentQty
                        : inventory[id]?.currentQty;
                    const remainingQty = inventory[id]?.currentQty;

                    const totalDelta = totalSaleByIngredient[id] || 0;
                    const lastShiftDelta = lastShiftSaleByIngredient[id] || 0;
                    const totalConsumed = totalDelta < 0 ? -totalDelta : 0;
                    const lastShiftConsumed = lastShiftDelta < 0 ? -lastShiftDelta : 0;
                    const lastUpdate = formatDateTime(lastUpdateByIngredient[id]);

                    return React.createElement(
                      "tr",
                      { key: id },
                      React.createElement(
                        "td",
                        { style: tdStyle },
                        nameForIngredient(id)
                      ),
                      React.createElement(
                        "td",
                        { style: tdStyle },
                        formatQty(lastShiftConsumed, unit),
                        " ",
                        unit
                      ),
                      React.createElement(
                        "td",
                        { style: tdStyle },
                        formatQty(totalConsumed, unit),
                        " ",
                        unit
                      ),
                      React.createElement(
                        "td",
                        { style: tdStyle },
                        formatQty(initialQty, unit),
                        " ",
                        unit
                      ),
                      React.createElement(
                        "td",
                        { style: tdStyle },
                        formatQty(remainingQty, unit),
                        " ",
                        unit
                      ),
                      React.createElement("td", { style: tdStyle }, lastUpdate)
                    );
                  })
                )
              )
            )
          )
        );
      }

      function AdminMenuEditor({ menu, onUpdateMenuItem, onSaveMenu }) {
        const [selectedId, setSelectedId] = React.useState(menu[0]?.id || null);

        if (!selectedId) {
          return React.createElement(
            "p",
            { style: { fontSize: 12 } },
            "Aucun article."
          );
        }

        const item = menu.find((m) => m.id === selectedId);

        function handleChange(field, value) {
          onUpdateMenuItem(selectedId, { [field]: value });
        }

        return React.createElement(
          "div",
          {
            style: {
              display: "grid",
              gridTemplateColumns: "minmax(0, 1.4fr) minmax(0, 2fr)",
              gap: 14,
              alignItems: "flex-start"
            }
          },
          React.createElement(
            "div",
            {
              style: {
                minWidth: 220,
                maxHeight: 280,
                overflowY: "auto",
                borderRadius: 10,
                background: "linear-gradient(145deg,#f9fafb,#e5e7eb)",
                border: "1px solid #e5e7eb"
              }
            },
            menu.map((m) =>
              React.createElement(
                "div",
                {
                  key: m.id,
                  onClick: () => setSelectedId(m.id),
                  style: {
                    padding: "6px 10px",
                    cursor: "pointer",
                    fontSize: 12,
                    background:
                      m.id === selectedId ? "#e5e7eb" : "transparent"
                  }
                },
                m.nameFr || m.name,
                " - ",
                m.price.toFixed(2),
                " DHS"
              )
            )
          ),
          React.createElement(
            "div",
            {
              style: {
                flex: 1,
                fontSize: 12,
                padding: 10,
                borderRadius: 12,
                background:
                  "linear-gradient(135deg, rgba(251,251,255,0.98), #e5e7eb)",
                border: "1px solid rgba(148,163,184,0.5)",
                boxShadow: "0 10px 24px rgba(15,23,42,0.12)"
              }
            },
            React.createElement(
              "div",
              { style: { display: "flex", justifyContent: "space-between" } },
              React.createElement("h4", null, "Ã‰diter l'article"),
              React.createElement(
                "button",
                {
                  type: "button",
                  className: "btn-primary",
                  style: {
                    padding: "6px 14px",
                    fontSize: 11
                  },
                  onClick: () => onSaveMenu(menu)
                },
                "Enregistrer"
              )
            ),
            React.createElement(
              "div",
              { style: { marginTop: 4, fontSize: 11, color: "#6b7280" } },
              "ID: ",
              item.id
            ),
            React.createElement(
              "div",
              { style: { marginTop: 6 } },
              React.createElement(
                "div",
                { style: { fontWeight: 600, marginBottom: 2 } },
                "Nom FR:"
              ),
              React.createElement("input", {
                value: item.nameFr || "",
                onChange: (e) => handleChange("nameFr", e.target.value),
                style: { width: "100%", padding: 4, fontSize: 12 }
              })
            ),
            React.createElement(
              "div",
              { style: { marginTop: 6 } },
              React.createElement(
                "div",
                { style: { fontWeight: 600, marginBottom: 2 } },
                "Nom AR:"
              ),
              React.createElement("input", {
                value: item.nameAr || "",
                onChange: (e) => handleChange("nameAr", e.target.value),
                style: { width: "100%", padding: 4, fontSize: 12 }
              })
            ),
            React.createElement(
              "div",
              { style: { marginTop: 6 } },
              React.createElement(
                "div",
                { style: { fontWeight: 600, marginBottom: 2 } },
                "Prix DHS:"
              ),
              React.createElement("input", {
                type: "number",
                value: item.price,
                onChange: (e) =>
                  handleChange("price", parseFloat(e.target.value) || 0),
                style: { width: "100%", padding: 4, fontSize: 12 }
              })
            )
          )
        );
      }

      function POSApp() {
        const [lang, setLang] = React.useState("fr");
        const t = DICTIONARY[lang];

        const [activeCategory, setActiveCategory] = React.useState(null);
        const [menu, setMenu] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_menu");
            const parsed = raw ? JSON.parse(raw) : null;
            if (Array.isArray(parsed) && parsed.length) return parsed;
          } catch (e) {}
          return INITIAL_MENU_DATA.slice();
        });
        const [users, setUsers] = React.useState(USERS.slice());
        const [cart, setCart] = React.useState([]);
        const [submitting, setSubmitting] = React.useState(false);
        const [status, setStatus] = React.useState(null);

        const [adminUser, setAdminUser] = React.useState(null);
        const [activeWorker, setActiveWorker] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_session");
            const sess = raw ? JSON.parse(raw) : null;
            const id = sess && sess.activeWorkerId ? sess.activeWorkerId : null;
            if (!id) return null;
            return USERS.find((u) => u.id === id) || null;
          } catch (e) {
            return null;
          }
        });
        const [view, setView] = React.useState("pos");
        const [activeShift, setActiveShift] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_session");
            const sess = raw ? JSON.parse(raw) : null;
            const s = sess && sess.activeShift ? sess.activeShift : null;
            if (!s || typeof s !== "object") return null;
            return s;
          } catch (e) {
            return null;
          }
        });
        const [shifts, setShifts] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_state");
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && Array.isArray(parsed.shifts)) return parsed.shifts;
          } catch (e) {}
          return [];
        });
        const [orders, setOrders] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_state");
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && Array.isArray(parsed.orders)) return parsed.orders;
          } catch (e) {}
          return [];
        });
        const [inventory, setInventory] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_state");
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && parsed.inventory && typeof parsed.inventory === "object") {
              return parsed.inventory;
            }
          } catch (e) {}
          return INVENTORY_INITIAL;
        });
        const [inventoryLogs, setInventoryLogs] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_state");
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && Array.isArray(parsed.inventoryLogs)) return parsed.inventoryLogs;
          } catch (e) {}
          return [];
        });

        const [firebaseUser, setFirebaseUser] = React.useState(null);
        const [firebaseAuthReady, setFirebaseAuthReady] = React.useState(false);
        const [firebaseLoginDismissed, setFirebaseLoginDismissed] = React.useState(false);

        const [shiftPin, setShiftPin] = React.useState("");
        const [waiterPeriod, setWaiterPeriod] = React.useState("morning");
        const [shiftError, setShiftError] = React.useState(null);

        const [shiftPaused, setShiftPaused] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_session");
            const sess = raw ? JSON.parse(raw) : null;
            return !!(sess && sess.shiftPaused);
          } catch (e) {
            return false;
          }
        });
        const [pinPromptMode, setPinPromptMode] = React.useState(null);
        const [pinPromptValue, setPinPromptValue] = React.useState("");
        const [pinPromptError, setPinPromptError] = React.useState(null);
        const lastActivityRef = React.useRef(Date.now());

        const CLOUD_APP_ID = "cafe-halab-pos";
        const cloudEnabled = !!(window.firebaseDb && firebaseUser);

        function makeId(prefix) {
          return (
            prefix +
            "_" +
            Date.now() +
            "_" +
            Math.random().toString(16).slice(2)
          );
        }

        const deviceIdRef = React.useRef(null);

        React.useEffect(() => {
          if (deviceIdRef.current) return;
          try {
            const existing = window.localStorage.getItem("cafe_halab_device_id");
            if (existing) {
              deviceIdRef.current = existing;
              return;
            }
          } catch (e) {}

          deviceIdRef.current = makeId("dev");
          try {
            window.localStorage.setItem("cafe_halab_device_id", deviceIdRef.current);
          } catch (e) {}
        }, []);

        function cloudAppDoc() {
          if (!window.firebaseDb) return null;
          return window.firebaseDb.collection("posApps").doc(CLOUD_APP_ID);
        }

        function cloudCol(name) {
          const root = cloudAppDoc();
          return root ? root.collection(name) : null;
        }

        React.useEffect(() => {
          try {
            window.localStorage.setItem(
              "cafe_halab_state",
              JSON.stringify({
                shifts,
                orders,
                inventory,
                inventoryLogs
              })
            );
          } catch (e) {}
        }, [shifts, orders, inventory, inventoryLogs]);

        React.useEffect(() => {
          try {
            window.localStorage.setItem(
              "cafe_halab_session",
              JSON.stringify({
                activeWorkerId: activeWorker ? activeWorker.id : null,
                activeShift: activeShift || null,
                shiftPaused: !!shiftPaused
              })
            );
          } catch (e) {}
        }, [activeWorker, activeShift, shiftPaused]);

        React.useEffect(() => {
          if (!activeShift) return;
          const found = shifts.find((s) => s && s.id === activeShift.id);
          if (!found) return;
          if (found.status && found.status !== "open") {
            setActiveShift(null);
            setActiveWorker(null);
            setShiftPaused(false);
            return;
          }
          setActiveShift(found);
        }, [shifts]);

        React.useEffect(() => {
          if (!window.firebaseAuth || !window.firebaseAuth.onAuthStateChanged) {
            setFirebaseAuthReady(true);
            return;
          }
          const unsub = window.firebaseAuth.onAuthStateChanged((u) => {
            setFirebaseUser(u || null);
            setFirebaseAuthReady(true);
          });
          return () => {
            try {
              if (typeof unsub === "function") unsub();
            } catch (e) {}
          };
        }, []);

        function openFirebaseLogin() {
          setFirebaseLoginDismissed(false);
        }

        function dismissFirebaseLogin() {
          setFirebaseLoginDismissed(true);
        }

        function handleFirebaseSignedIn(u) {
          setFirebaseUser(u || (window.firebaseAuth ? window.firebaseAuth.currentUser : null));
          setFirebaseLoginDismissed(false);
        }

        function handleFirebaseLogout() {
          if (!window.firebaseAuth) return;
          try {
            window.firebaseAuth.signOut();
          } catch (e) {}
          setFirebaseLoginDismissed(false);
        }

        React.useEffect(() => {
          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          if (!db) return;

          const shiftsCol = cloudCol("shifts");
          const ordersCol = cloudCol("orders");
          const invCol = cloudCol("inventory");
          const logsCol = cloudCol("inventoryLogs");
          if (!shiftsCol || !ordersCol || !invCol || !logsCol) return;

          let cancelled = false;

          invCol
            .limit(1)
            .get()
            .then((snap) => {
              if (cancelled) return;
              if (!snap || !snap.empty) return;
              const batch = db.batch();
              const nowIso = new Date().toISOString();
              Object.values(INVENTORY_INITIAL || {}).forEach((ing) => {
                if (!ing || !ing.id) return;
                batch.set(
                  invCol.doc(ing.id),
                  {
                    id: ing.id,
                    name: ing.name || ing.id,
                    unit: ing.unit || "",
                    currentQty: ing.currentQty,
                    minQty: ing.minQty,
                    updatedAt: nowIso
                  },
                  { merge: true }
                );
              });
              return batch.commit();
            })
            .catch(() => {});

          const unsubShifts = shiftsCol.onSnapshot(
            (snap) => {
              const next = [];
              snap.forEach((doc) => {
                const d = doc && doc.data ? doc.data() : null;
                if (!d || typeof d !== "object") return;
                next.push({ ...d, id: d.id || doc.id });
              });
              next.sort((a, b) => String(a.id || "").localeCompare(String(b.id || "")));
              setShifts(next);
            },
            (err) => {
              setStatus({ type: "err", message: String((err && err.message) || err || "Cloud error") });
            }
          );

          const unsubOrders = ordersCol.onSnapshot(
            (snap) => {
              const next = [];
              snap.forEach((doc) => {
                const d = doc && doc.data ? doc.data() : null;
                if (!d || typeof d !== "object") return;
                next.push({ ...d, id: d.id || doc.id });
              });
              next.sort((a, b) => String(a.createdAt || "").localeCompare(String(b.createdAt || "")));
              setOrders(next);
            },
            (err) => {
              setStatus({ type: "err", message: String((err && err.message) || err || "Cloud error") });
            }
          );

          const unsubInv = invCol.onSnapshot(
            (snap) => {
              const merged = { ...INVENTORY_INITIAL };
              snap.forEach((doc) => {
                const d = doc && doc.data ? doc.data() : null;
                if (!d || typeof d !== "object") return;
                const id = d.id || doc.id;
                const base = merged[id] && typeof merged[id] === "object" ? merged[id] : { id };
                merged[id] = { ...base, ...d, id };
              });
              setInventory(merged);
            },
            (err) => {
              setStatus({ type: "err", message: String((err && err.message) || err || "Cloud error") });
            }
          );

          const unsubLogs = logsCol.onSnapshot(
            (snap) => {
              const next = [];
              snap.forEach((doc) => {
                const d = doc && doc.data ? doc.data() : null;
                if (!d || typeof d !== "object") return;
                next.push({ ...d, id: d.id || doc.id });
              });
              next.sort((a, b) => String(a.createdAt || "").localeCompare(String(b.createdAt || "")));
              setInventoryLogs(next);
            },
            (err) => {
              setStatus({ type: "err", message: String((err && err.message) || err || "Cloud error") });
            }
          );

          return () => {
            cancelled = true;
            try {
              if (typeof unsubShifts === "function") unsubShifts();
            } catch (e) {}
            try {
              if (typeof unsubOrders === "function") unsubOrders();
            } catch (e) {}
            try {
              if (typeof unsubInv === "function") unsubInv();
            } catch (e) {}
            try {
              if (typeof unsubLogs === "function") unsubLogs();
            } catch (e) {}
          };
        }, [cloudEnabled]);

        const categories = React.useMemo(
          () => INITIAL_CATEGORIES.slice(),
          []
        );

        const filteredProducts = React.useMemo(() => {
          if (!activeCategory) return [];
          return menu.filter((p) => p.category === activeCategory);
        }, [activeCategory, menu]);

        const unpaidOrders = React.useMemo(() => {
          if (!activeShift) return [];
          return orders.filter(
            (o) => o.shiftId === activeShift.id && o.status !== "paid"
          );
        }, [orders, activeShift]);

        function formatTime(iso) {
          try {
            const d = new Date(iso);
            return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
          } catch (e) {
            return "";
          }
        }

        function displayOrderNumber(orderId) {
          if (!orderId) return "";
          const digits = String(orderId).replace(/\D/g, "");
          if (digits.length) return digits.slice(-4);
          return String(orderId).slice(-4);
        }

        function userNameById(userId) {
          const u = users.find((x) => x.id === userId);
          return u ? u.name : userId;
        }

        function lineLabel(line) {
          const base = lang === "ar" ? line.nameAr || line.name : line.nameFr || line.name;
          return base;
        }

        function lineModifiersLabel(line) {
          const mods = line.modifiers || {};
          const parts = [];
          if (mods.milk != null) {
            parts.push(`${t.milkInLine}: ${mods.milk ? t.milkYes : t.milkNo}`);
          }
          if (mods.sugar) {
            parts.push(`${t.sugarInLine}: ${mods.sugar}`);
          }
          if (mods.drink) {
            parts.push(`${t.drinkInLine}: ${mods.drink}`);
          }
          if (mods.eggCount) {
            parts.push(`${t.eggsInLine}: ${mods.eggCount}`);
          }
          return parts.length ? "(" + parts.join(", ") + ")" : "";
        }

        React.useEffect(() => {
          if (!activeShift || !activeWorker) return;

          function bump() {
            lastActivityRef.current = Date.now();
          }

          const events = ["click", "keydown", "touchstart", "mousemove"];
          events.forEach((ev) => window.addEventListener(ev, bump, true));
          return () => {
            events.forEach((ev) => window.removeEventListener(ev, bump, true));
          };
        }, [activeShift, activeWorker]);

        React.useEffect(() => {
          if (!activeShift || !activeWorker) return;
          if (shiftPaused) return;

          const timeoutMs = 5 * 60 * 1000;
          const interval = window.setInterval(() => {
            if (Date.now() - lastActivityRef.current >= timeoutMs) {
              setShiftPaused(true);
              setStatus({
                type: "err",
                message:
                  t.autoPausedMessage ||
                  "Shift mis en pause automatiquement (inactivitÃ©)."
              });
            }
          }, 1000);

          return () => window.clearInterval(interval);
        }, [activeShift, activeWorker, shiftPaused, t]);

        function openPinPrompt(mode) {
          setPinPromptMode(mode);
          setPinPromptValue("");
          setPinPromptError(null);
        }

        function closePinPrompt() {
          setPinPromptMode(null);
          setPinPromptValue("");
          setPinPromptError(null);
        }

        function confirmPinPrompt(ev) {
          ev.preventDefault();
          if (!activeWorker) return;

          if (pinPromptValue !== activeWorker.pin) {
            setPinPromptError(t.pinIncorrect || "PIN incorrect");
            return;
          }

          if (pinPromptMode === "pause") {
            setShiftPaused(true);
          } else if (pinPromptMode === "resume") {
            setShiftPaused(false);
            lastActivityRef.current = Date.now();
            setStatus(null);
          }

          closePinPrompt();
        }

        function handleAddToCart(product, modifiers) {
          if (shiftPaused) {
            setStatus({
              type: "err",
              message: t.shiftPausedBlocking || "Shift en pause."
            });
            return;
          }
          setCart((prev) => {
            const key =
              product.id +
              (modifiers &&
              (modifiers.milk != null ||
                modifiers.sugar ||
                modifiers.drink ||
                modifiers.eggCount)
                ? `_${JSON.stringify(modifiers)}`
                : "");
            const existing = prev.find((line) => line.key === key);
            if (existing) {
              return prev.map((line) =>
                line.key === key ? { ...line, qty: line.qty + 1 } : line
              );
            }
            return [
              ...prev,
              {
                key,
                id: product.id,
                name: product.name,
                price: product.price,
                qty: 1,
                modifiers: modifiers || {}
              }
            ];
          });
        }

        function updateQty(key, delta) {
          if (shiftPaused) {
            setStatus({
              type: "err",
              message: t.shiftPausedBlocking || "Shift en pause."
            });
            return;
          }
          setCart((prev) =>
            prev
              .map((line) =>
                line.key === key ? { ...line, qty: line.qty + delta } : line
              )
              .filter((line) => line.qty > 0)
          );
        }

        const totals = React.useMemo(() => {
          const subtotal = cart.reduce((sum, line) => sum + line.price * line.qty, 0);
          const taxRate = 0.0;
          const tax = subtotal * taxRate;
          const total = subtotal + tax;
          return { subtotal, tax, total };
        }, [cart]);

        function accumulateIngredientsForOrder(orderItems) {
          const result = {};
          const COFFEE_IDS = new Set(["coffee", "coffee_with_milk", "nescafe", "machada"]);

          function add(ingredientId, amountPerUnit, qty) {
            if (!ingredientId || !amountPerUnit) return;
            const delta = -amountPerUnit * qty;
            result[ingredientId] = (result[ingredientId] || 0) + delta;
          }

          function addRecipe(recipe, qty) {
            if (!recipe) return;
            Object.entries(recipe).forEach(([ingredientId, perUnit]) => {
              add(ingredientId, perUnit, qty);
            });
          }

          function addSugarFor(type, sugarLevel, qty) {
            if (!sugarLevel || sugarLevel === "none") return;

            if (type === "coffee") {
              const KG_PER_CUBE = 1 / 180;
              const cubes = sugarLevel === "low" ? 1 : sugarLevel === "medium" ? 2 : 3;
              add("sugar_cubes", KG_PER_CUBE * cubes, qty);
              return;
            }

            if (type === "tea") {
              const grams = sugarLevel === "low" ? 5 : sugarLevel === "medium" ? 10 : 15;
              add("sugar_powder", grams / 1000, qty);
              return;
            }
          }

          orderItems.forEach((line) => {
            const qty = line.qty || 1;
            const mods = line.modifiers || {};
            const baseRecipe = MENU_RECIPES[line.id];

            addRecipe(baseRecipe, qty);

            if (line.id === "fried_eggs" && mods.eggCount) {
              const baseEggs = (baseRecipe && baseRecipe.eggs) || 0;
              const desired = Number(mods.eggCount) || 0;
              const extra = desired - baseEggs;
              if (extra !== 0) {
                result.eggs = (result.eggs || 0) + -extra * qty;
              }
            }

            if (mods.drink === "tea") {
              add("tea_leaves", 0.006, qty);
              addSugarFor("tea", mods.sugar, qty);
            } else if (mods.drink === "coffee_milk") {
              add("coffee_beans", 0.01, qty);
              add("milk", 0.18, qty);
              addSugarFor("coffee", mods.sugar, qty);
            }

            if (COFFEE_IDS.has(line.id)) {
              if (mods.milk === true && (!baseRecipe || baseRecipe.milk == null)) {
                add("milk", 0.18, qty);
              }
              if (mods.milk === false && baseRecipe && baseRecipe.milk != null) {
                result.milk = (result.milk || 0) + baseRecipe.milk * qty;
              }
              addSugarFor("coffee", mods.sugar, qty);
            }

            if (line.id === "tea_lipton" || line.id === "tea_mint" || line.id === "tea_berrad") {
              addSugarFor("tea", mods.sugar, qty);
            }
          });

          return result;
        }

        function applyInventoryConsumption(
          ingredientDeltas,
          shiftId,
          orderId,
          userId
        ) {
          const nowIso = new Date().toISOString();
          const logEntries = Object.entries(ingredientDeltas).map(([ingId, delta]) => ({
            id: makeId("log"),
            ingredientId: ingId,
            delta,
            reason: "sale",
            orderId,
            shiftId,
            userId,
            createdAt: nowIso
          }));

          setInventory((prev) => {
            const copy = { ...prev };
            Object.entries(ingredientDeltas).forEach(([ingId, delta]) => {
              if (!copy[ingId]) return;
              copy[ingId] = {
                ...copy[ingId],
                currentQty: copy[ingId].currentQty + delta
              };
            });
            return copy;
          });
          setInventoryLogs((prev) => [...prev, ...logEntries]);

          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          const invCol = cloudCol("inventory");
          const logsCol = cloudCol("inventoryLogs");
          if (!db || !invCol || !logsCol) return;

          try {
            const batch = db.batch();
            const inc = firebase.firestore.FieldValue.increment;
            Object.entries(ingredientDeltas).forEach(([ingId, delta]) => {
              if (!ingId || !delta) return;
              batch.set(
                invCol.doc(ingId),
                {
                  id: ingId,
                  currentQty: inc(delta),
                  updatedAt: nowIso
                },
                { merge: true }
              );
            });

            logEntries.forEach((entry) => {
              if (!entry || !entry.id) return;
              batch.set(
                logsCol.doc(entry.id),
                {
                  ...entry,
                  appId: CLOUD_APP_ID,
                  deviceId: deviceIdRef.current
                },
                { merge: true }
              );
            });
            batch.commit().catch(() => {});
          } catch (e) {}
        }

        function handleInventoryAdjust(ingredientId, delta) {
          if (!ingredientId || !delta) return;
          const nowIso = new Date().toISOString();
          const logId = makeId("log");
          setInventory((prev) => {
            if (!prev[ingredientId]) return prev;
            return {
              ...prev,
              [ingredientId]: {
                ...prev[ingredientId],
                currentQty: prev[ingredientId].currentQty + delta
              }
            };
          });
          setInventoryLogs((prev) => [
            ...prev,
            {
              id: logId,
              ingredientId,
              delta,
              reason: "adjust",
              orderId: null,
              shiftId: activeShift ? activeShift.id : null,
              userId: adminUser ? adminUser.id : null,
              createdAt: nowIso
            }
          ]);

          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          const invCol = cloudCol("inventory");
          const logsCol = cloudCol("inventoryLogs");
          if (!db || !invCol || !logsCol) return;

          try {
            const batch = db.batch();
            const inc = firebase.firestore.FieldValue.increment;
            batch.set(
              invCol.doc(ingredientId),
              {
                id: ingredientId,
                currentQty: inc(delta),
                updatedAt: nowIso
              },
              { merge: true }
            );
            batch.set(
              logsCol.doc(logId),
              {
                id: logId,
                ingredientId,
                delta,
                reason: "adjust",
                orderId: null,
                shiftId: activeShift ? activeShift.id : null,
                userId: adminUser ? adminUser.id : null,
                appId: CLOUD_APP_ID,
                deviceId: deviceIdRef.current,
                createdAt: nowIso
              },
              { merge: true }
            );
            batch.commit().catch(() => {});
          } catch (e) {}
        }

        function handleInventoryUpdate(ingredientId, currentQty, minQty) {
          if (!ingredientId) return;
          const nowIso = new Date().toISOString();
          const logId = makeId("log");
          setInventory((prev) => {
            const ing = prev[ingredientId];
            if (!ing) return prev;
            return {
              ...prev,
              [ingredientId]: {
                ...ing,
                currentQty,
                minQty
              }
            };
          });
          setInventoryLogs((prev) => {
            const ing = inventory[ingredientId];
            const oldQty = ing ? ing.currentQty : null;
            const diff = oldQty == null ? 0 : currentQty - oldQty;
            if (!diff) return prev;
            return [
              ...prev,
              {
                id: logId,
                ingredientId,
                delta: diff,
                reason: "adjust",
                orderId: null,
                shiftId: activeShift ? activeShift.id : null,
                userId: adminUser ? adminUser.id : null,
                createdAt: nowIso
              }
            ];
          });

          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          const invCol = cloudCol("inventory");
          const logsCol = cloudCol("inventoryLogs");
          if (!db || !invCol || !logsCol) return;

          try {
            db
              .runTransaction((tx) => {
                const invRef = invCol.doc(ingredientId);
                return tx.get(invRef).then((snap) => {
                  const data = snap && snap.data ? snap.data() : null;
                  const prevQty = data && typeof data.currentQty === "number" ? data.currentQty : null;
                  const delta = prevQty == null ? 0 : currentQty - prevQty;
                  tx.set(
                    invRef,
                    { id: ingredientId, currentQty, minQty, updatedAt: nowIso },
                    { merge: true }
                  );
                  if (delta) {
                    tx.set(
                      logsCol.doc(logId),
                      {
                        id: logId,
                        ingredientId,
                        delta,
                        reason: "adjust",
                        orderId: null,
                        shiftId: activeShift ? activeShift.id : null,
                        userId: adminUser ? adminUser.id : null,
                        appId: CLOUD_APP_ID,
                        deviceId: deviceIdRef.current,
                        createdAt: nowIso
                      },
                      { merge: true }
                    );
                  }
                });
              })
              .catch(() => {});
          } catch (e) {}
        }

        function handleAdminLogin(user) {
          setAdminUser(user);
        }

        function handleAdminLogout() {
          setAdminUser(null);
        }

        function handleChangeUserPin(userId, newPin) {
          setUsers((prev) =>
            prev.map((u) => (u.id === userId ? { ...u, pin: newPin } : u))
          );
        }

        function handleOpenShift(dateStr, period) {
          const id = buildShiftId(dateStr, period);
          const newShift = {
            id,
            date: dateStr,
            period,
            status: "open",
            openedAt: new Date().toISOString(),
            closedAt: null,
            openedBy: adminUser ? adminUser.id : null,
            closedBy: null,
            revenue: 0,
            orderCount: 0,
            expectedCash: 0
          };
          setActiveShift(newShift);
          setShifts((prev) => {
            const exists = prev.some((s) => s && s.id === newShift.id);
            if (!exists) return [...prev, newShift];
            return prev.map((s) => (s && s.id === newShift.id ? { ...s, ...newShift } : s));
          });

          if (cloudEnabled) {
            const shiftsCol = cloudCol("shifts");
            if (shiftsCol) {
              const nowIso = newShift.openedAt;
              shiftsCol
                .doc(id)
                .set(
                  {
                    ...newShift,
                    appId: CLOUD_APP_ID,
                    deviceId: deviceIdRef.current,
                    updatedAt: nowIso
                  },
                  { merge: true }
                )
                .catch(() => {});
            }
          }
        }

        function handleCloseShift() {
          if (!activeShift) return;
          const closedAt = new Date().toISOString();
          setShifts((prev) =>
            prev.map((s) =>
              s.id === activeShift.id
                ? { ...s, status: "closed", closedAt }
                : s
            )
          );

          if (cloudEnabled) {
            const shiftsCol = cloudCol("shifts");
            if (shiftsCol) {
              shiftsCol
                .doc(activeShift.id)
                .set(
                  {
                    id: activeShift.id,
                    status: "closed",
                    closedAt,
                    closedBy: adminUser ? adminUser.id : null,
                    updatedAt: closedAt
                  },
                  { merge: true }
                )
                .catch(() => {});
            }
          }
          setActiveShift(null);
        }

        function updateShiftStats(shiftId, amount) {
          setShifts((prev) =>
            prev.map((s) =>
              s.id === shiftId
                ? {
                    ...s,
                    revenue: (s.revenue || 0) + amount,
                    orderCount: (s.orderCount || 0) + 1,
                    expectedCash: (s.expectedCash || 0) + amount
                  }
                : s
            )
          );
        }

        async function handleSubmitOrder() {
          if (!cart.length) return;
          if (!activeWorker) {
            setStatus({
              type: "err",
              message:
                t.needWorkerLogin ||
                "Ouvrez un shift (PIN serveur) avant de prendre une commande."
            });
            return;
          }
          if (shiftPaused) {
            setStatus({
              type: "err",
              message: t.shiftPausedBlocking || "Shift en pause."
            });
            return;
          }
          if (!activeShift) {
            setStatus({
              type: "err",
              message: t.noShiftOpen || "Aucun shift ouvert."
            });
            return;
          }

          setSubmitting(true);
          setStatus(null);

          const now = new Date();
          const orderId = makeId("ord");
          const ticketDay = pad2(now.getDate());
          const ticketMonth = pad2(now.getMonth() + 1);
          const shiftCode = periodToShiftCode(activeShift.period);
          const waiterCode = makeWaiterCode(activeWorker.name);
          const ticketPrefix = `${ticketDay}${ticketMonth}${shiftCode}${waiterCode}`;
          const maxExistingSeq = (orders || []).reduce((max, o) => {
            const code = o && o.ticketCode ? String(o.ticketCode) : "";
            if (!code || !code.startsWith(ticketPrefix)) return max;
            const tail = code.slice(-3);
            const parsed = parseInt(tail, 10);
            if (!Number.isFinite(parsed)) return max;
            return Math.max(max, parsed);
          }, 0);
          const ticketSeq = pad3(maxExistingSeq + 1);
          const ticketCode = ticketPrefix + ticketSeq;

          const order = {
            id: orderId,
            appId: "cafe-halab-pos",
            items: cart.map((line) => {
              const p = menu.find((m) => m.id === line.id);
              return {
                ...line,
                nameFr: p?.nameFr || line.name,
                nameAr: p?.nameAr || line.name
              };
            }),
            totals,
            currency: "DHS",
            status: "unpaid",
            createdAt: now.toISOString(),
            shiftId: activeShift.id,
            cashierId: activeWorker.id,
            ticketCode,
            ticketPrefix,
            ticketSeq
          };

          const ingredientDeltas = accumulateIngredientsForOrder(cart);
          applyInventoryConsumption(
            ingredientDeltas,
            activeShift.id,
            orderId,
            activeWorker.id
          );

          setOrders((prev) => [...prev, order]);

          if (cloudEnabled) {
            const ordersCol = cloudCol("orders");
            if (ordersCol) {
              const nowIso = order.createdAt;
              ordersCol
                .doc(orderId)
                .set(
                  {
                    ...order,
                    appId: CLOUD_APP_ID,
                    deviceId: deviceIdRef.current,
                    updatedAt: nowIso
                  },
                  { merge: true }
                )
                .catch(() => {});
            }
          }

          await new Promise((resolve) => setTimeout(resolve, 300));
          setStatus({
            type: "ok",
            message: t.orderAddedPending || "Commande ajoutÃ©e aux commandes en attente."
          });
          setCart([]);
          setSubmitting(false);
        }

        function handleMarkOrderPaid(orderId) {
          const order = orders.find((o) => o && o.id === orderId);
          if (!order || order.status === "paid") return;
          const paidAt = new Date().toISOString();

          setOrders((prev) =>
            prev.map((o) =>
              o && o.id === orderId ? { ...o, status: "paid", paidAt } : o
            )
          );
          updateShiftStats(order.shiftId, order.totals.total);

          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          const ordersCol = cloudCol("orders");
          const shiftsCol = cloudCol("shifts");
          if (!db || !ordersCol || !shiftsCol) return;

          try {
            const orderRef = ordersCol.doc(orderId);
            const shiftRef = shiftsCol.doc(order.shiftId);
            const inc = firebase.firestore.FieldValue.increment;
            db
              .runTransaction((tx) =>
                tx.get(orderRef).then((snap) => {
                  const data = snap && snap.data ? snap.data() : null;
                  if (data && data.status === "paid") return;
                  tx.set(
                    orderRef,
                    { status: "paid", paidAt, updatedAt: paidAt },
                    { merge: true }
                  );
                  tx.set(
                    shiftRef,
                    {
                      id: order.shiftId,
                      revenue: inc(order.totals.total),
                      orderCount: inc(1),
                      expectedCash: inc(order.totals.total),
                      updatedAt: paidAt
                    },
                    { merge: true }
                  );
                })
              )
              .catch(() => {});
          } catch (e) {}
        }

        function handleUpdateMenuItem(id, partial) {
          setMenu((prev) => {
            const next = prev.map((m) =>
              m.id === id ? { ...m, ...partial } : m
            );
            return next;
          });
          const idx = INITIAL_MENU_DATA.findIndex((m) => m.id === id);
          if (idx !== -1) {
            INITIAL_MENU_DATA[idx] = { ...INITIAL_MENU_DATA[idx], ...partial };
          }
        }

        function handleSaveMenu(currentMenu) {
          try {
            window.localStorage.setItem(
              "cafe_halab_menu",
              JSON.stringify(currentMenu)
            );
            setStatus({ type: "ok", message: "Menu enregistrÃ©." });
          } catch (e) {
            setStatus({ type: "err", message: "Erreur lors de l'enregistrement." });
          }
        }

        function canSeeManager() {
          return adminUser && adminUser.role === "admin";
        }

        function canSeeAdmin() {
          return adminUser && adminUser.role === "admin";
        }

        function handleOpenWaiterShift(ev) {
          ev.preventDefault();
          const worker = users.find(
            (u) => u.role === "worker" && u.pin === shiftPin
          );
          if (!worker) {
            setShiftError(t.pinIncorrect || "PIN incorrect");
            return;
          }
          const today = new Date().toISOString().slice(0, 10);
          const shiftId = buildShiftId(today, waiterPeriod);
          const newShift = {
            id: shiftId,
            date: today,
            period: waiterPeriod,
            status: "open",
            openedAt: new Date().toISOString(),
            closedAt: null,
            orderCount: 0,
            revenue: 0,
            expectedCash: 0,
            openedBy: worker.id
          };
          setActiveShift(newShift);
          setShifts((prev) => {
            const exists = prev.some((s) => s && s.id === newShift.id);
            if (!exists) return [...prev, newShift];
            return prev.map((s) => (s && s.id === newShift.id ? { ...s, ...newShift } : s));
          });

          if (cloudEnabled) {
            const shiftsCol = cloudCol("shifts");
            if (shiftsCol) {
              const nowIso = newShift.openedAt;
              shiftsCol
                .doc(shiftId)
                .set(
                  {
                    ...newShift,
                    appId: CLOUD_APP_ID,
                    deviceId: deviceIdRef.current,
                    updatedAt: nowIso
                  },
                  { merge: true }
                )
                .catch(() => {});
            }
          }
          setActiveWorker(worker);
          setShiftPaused(false);
          lastActivityRef.current = Date.now();
          setShiftPin("");
          setShiftError(null);
          setActiveCategory(null);
          setView("pos");
        }

        function handleCloseWaiterShift() {
          if (activeShift) {
            const closedAt = new Date().toISOString();
            const closedBy = activeWorker ? activeWorker.id : null;
            setShifts((prev) =>
              prev.map((s) =>
                s && s.id === activeShift.id
                  ? { ...s, status: "closed", closedAt, closedBy }
                  : s
              )
            );

            if (cloudEnabled) {
              const shiftsCol = cloudCol("shifts");
              if (shiftsCol) {
                shiftsCol
                  .doc(activeShift.id)
                  .set(
                    {
                      id: activeShift.id,
                      status: "closed",
                      closedAt,
                      closedBy,
                      updatedAt: closedAt
                    },
                    { merge: true }
                  )
                  .catch(() => {});
              }
            }
          }

          setActiveShift(null);
          setActiveWorker(null);
          setCart([]);
          setActiveCategory(null);
          setShiftPaused(false);
          closePinPrompt();
        }

        return e(
          "div",
          { className: "app-shell" },
          window.firebaseAuth &&
            firebaseAuthReady &&
            !firebaseUser &&
            !firebaseLoginDismissed &&
            e(FirebaseLoginOverlay, {
              t,
              lang,
              onSignedIn: handleFirebaseSignedIn,
              onDismiss: dismissFirebaseLogin
            }),
          e(
            "header",
            null,
            e(
              "div",
              { className: "brand" },
              e("img", {
                src: "./cafe-halab-logo.png",
                alt: t.appTitle,
                className: "brand-logo"
              }),
              e(
                "div",
                null,
                e("h1", null, t.appTitle),
                e("span", null, t.uiSubtitle)
              )
            ),
            // Admin login only
            e(LoginPanel, {
              currentUser: adminUser,
              users: users.filter((u) => u.role === "admin"),
              onLogin: handleAdminLogin,
              onLogout: handleAdminLogout
            }),
            e(FirebaseAuthBadge, {
              t,
              lang,
              firebaseUser,
              dismissed: firebaseLoginDismissed,
              onOpenLogin: openFirebaseLogin,
              onLogout: handleFirebaseLogout
            }),
            e(
              "div",
              { style: { marginLeft: "auto", display: "flex", gap: 4 } },
              e(
                "button",
                {
                  className: "category-btn" + (view === "pos" ? " active" : ""),
                  onClick: () => setView("pos")
                },
                "POS"
              ),
              e(
                "button",
                {
                  className:
                    "category-btn" + (view === "manager" ? " active" : ""),
                  onClick: () => setView("manager"),
                  disabled: !canSeeManager()
                },
                "Manager"
              ),
              e(
                "button",
                {
                  className: "category-btn" + (view === "admin" ? " active" : ""),
                  onClick: () => setView("admin"),
                  disabled: !canSeeAdmin()
                },
                "Admin"
              ),
              activeShift &&
                activeWorker &&
                e(
                  "button",
                  {
                    className: "category-btn",
                    onClick: handleCloseWaiterShift
                  },
                  t.closeShiftBtn || "Close Shift"
                ),
              activeShift &&
                activeWorker &&
                !shiftPaused &&
                e(
                  "button",
                  {
                    className: "category-btn",
                    onClick: () => openPinPrompt("pause")
                  },
                  t.pauseShiftBtn || "Pause"
                ),
              activeShift &&
                activeWorker &&
                shiftPaused &&
                e(
                  "button",
                  {
                    className: "category-btn",
                    onClick: () => openPinPrompt("resume")
                  },
                  t.resumeShiftBtn || "Resume"
                ),
              e(
                "button",
                {
                  className: "category-btn" + (lang === "fr" ? " active" : ""),
                  onClick: () => setLang("fr")
                },
                t.langFr
              ),
              e(
                "button",
                {
                  className: "category-btn" + (lang === "ar" ? " active" : ""),
                  onClick: () => setLang("ar")
                },
                t.langAr
              )
            )
          ),
          pinPromptMode &&
            e(
              "div",
              {
                style: {
                  position: "fixed",
                  inset: 0,
                  background: "rgba(15,23,42,0.55)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  padding: 16,
                  zIndex: 50
                }
              },
              e(
                "section",
                { className: "panel", style: { maxWidth: 420, width: "100%" } },
                e(
                  "h3",
                  { style: { marginTop: 0 } },
                  pinPromptMode === "pause"
                    ? t.confirmPauseTitle || "Confirmer la pause"
                    : t.shiftPausedTitle || "Shift en pause"
                ),
                e(
                  "p",
                  { style: { fontSize: 13, marginTop: 6 } },
                  pinPromptMode === "pause"
                    ? t.confirmPauseSubtitle ||
                      "Saisir votre PIN pour mettre le shift en pause."
                    : t.shiftPausedSubtitle ||
                      "Saisir le PIN du serveur pour reprendre."
                ),
                e(
                  "form",
                  {
                    onSubmit: confirmPinPrompt,
                    style: {
                      display: "flex",
                      flexDirection: "column",
                      gap: 10,
                      marginTop: 10
                    }
                  },
                  e("input", {
                    type: "password",
                    value: pinPromptValue,
                    onChange: (ev) => setPinPromptValue(ev.target.value),
                    placeholder: t.pinLabel || "PIN",
                    style: {
                      padding: 10,
                      fontSize: 18,
                      textAlign: "center"
                    }
                  }),
                  e(
                    "button",
                    { className: "btn-primary", type: "submit" },
                    t.confirmPinBtn || "Confirmer"
                  ),
                  e(
                    "button",
                    {
                      className: "category-btn",
                      type: "button",
                      onClick: closePinPrompt
                    },
                    t.closeBtn || "Fermer"
                  ),
                  pinPromptError &&
                    e(
                      "div",
                      { style: { fontSize: 12, color: "#b91c1c" } },
                      pinPromptError
                    )
                )
              )
            ),
          view === "pos" &&
            !activeShift &&
            e(
              "main",
              {
                style: {
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center"
                }
              },
              e(
                "section",
                {
                  className: "panel",
                  style: { maxWidth: 420, textAlign: "center" }
                },
                e(
                  "h2",
                  { style: { marginTop: 0, marginBottom: 12 } },
                  t.shiftOpenTitle || "Open Shift"
                ),
                e(
                  "p",
                  { style: { fontSize: 13, marginBottom: 16 } },
                  t.shiftOpenSubtitle ||
                    "Enter waiter PIN to start a shift."
                ),
                e(
                  "form",
                  {
                    onSubmit: handleOpenWaiterShift,
                    style: {
                      display: "flex",
                      flexDirection: "column",
                      gap: 10,
                      alignItems: "center"
                    }
                  },
                  e(
                    "select",
                    {
                      value: waiterPeriod,
                      onChange: (ev) => setWaiterPeriod(ev.target.value),
                      style: {
                        padding: 8,
                        fontSize: 16,
                        width: 160,
                        textAlign: "center"
                      }
                    },
                    e("option", { value: "morning" }, "Matin"),
                    e("option", { value: "afternoon" }, "AprÃ¨s-midi")
                  ),
                  e("input", {
                    type: "password",
                    value: shiftPin,
                    onChange: (ev) => setShiftPin(ev.target.value),
                    placeholder: t.pinLabel || "PIN",
                    style: {
                      padding: 8,
                      fontSize: 16,
                      width: 160,
                      textAlign: "center"
                    }
                  }),
                  e(
                    "button",
                    {
                      className: "btn-primary",
                      type: "submit",
                      style: {
                        padding: "12px 24px",
                        fontSize: 18,
                        fontWeight: 600,
                        width: "100%",
                        maxWidth: 260
                      }
                    },
                    t.openShiftBtn || "OPEN SHIFT"
                  ),
                  shiftError &&
                    e(
                      "span",
                      { style: { color: "#b91c1c", fontSize: 11 } },
                      shiftError
                    )
                )
              )
            ),
          view === "pos" &&
            activeShift &&
            e(
              "main",
              null,
              e(
                "section",
                { className: "panel" },
                !activeCategory &&
                  e(
                    "div",
                    null,
                    e(
                      "h3",
                      { style: { marginTop: 0, marginBottom: 12 } },
                      "Menu"
                    ),
                    e(
                      "div",
                      {
                        style: {
                          display: "grid",
                          gridTemplateColumns:
                            "repeat(auto-fit, minmax(160px, 1fr))",
                          gap: 12
                        }
                      },
                      categories.map((cat) => {
                        let label = cat;
                        if (cat === "Breakfast") label = t.catBreakfast;
                        else if (cat === "Hot Drinks") label = t.catHot;
                        else if (cat === "Cold Drinks") label = t.catCold;
                        else if (cat === "Others") label = t.catOthers;
                        return e(
                          "button",
                          {
                            key: cat,
                            className: "category-btn",
                            style: {
                              padding: "18px 12px",
                              fontSize: 16,
                              fontWeight: 600,
                              width: "100%"
                            },
                            onClick: () =>
                              shiftPaused
                                ? setStatus({
                                    type: "err",
                                    message:
                                      t.shiftPausedBlocking ||
                                      "Shift en pause."
                                  })
                                : setActiveCategory(cat)
                          },
                          label
                        );
                      })
                    )
                  ),
                activeCategory &&
                  e(
                    "div",
                    null,
                    e(
                      "div",
                      {
                        style: {
                          display: "flex",
                          justifyContent: "space-between",
                          alignItems: "center",
                          marginBottom: 10
                        }
                      },
                      e(
                        "button",
                        {
                          className: "category-btn",
                          onClick: () =>
                            shiftPaused
                              ? setStatus({
                                  type: "err",
                                  message:
                                    t.shiftPausedBlocking ||
                                    "Shift en pause."
                                })
                              : setActiveCategory(null)
                        },
                        t.backToMenus || "Retour menus"
                      ),
                      e(
                        "h3",
                        { style: { margin: 0 } },
                        activeCategory === "Breakfast"
                          ? t.catBreakfast
                          : activeCategory === "Hot Drinks"
                          ? t.catHot
                          : activeCategory === "Cold Drinks"
                          ? t.catCold
                          : t.catOthers
                      )
                    ),
                    e(
                      "div",
                      { className: "products-grid" },
                      filteredProducts.map((product) =>
                        e(ProductCard, {
                          key: product.id,
                          product,
                          onAdd: handleAddToCart,
                          lang,
                          t
                        })
                      )
                    )
                  )
              ),
              e(
                "section",
                { className: "panel" },
                e("h3", null, t.currentOrder),
                cart.length === 0
                  ? e("p", { style: { fontSize: 12 } }, t.cartEmpty)
                  : cart.map((line) =>
                      e(
                        "div",
                        { className: "cart-item", key: line.key },
                        e(
                          "div",
                          { className: "cart-item-main" },
                          e(
                            "span",
                            null,
                            line.name,
                            line.modifiers &&
                            (line.modifiers.milk != null ||
                              line.modifiers.sugar ||
                              line.modifiers.drink ||
                              line.modifiers.eggCount)
                              ?
                                " (" +
                                [
                                  line.modifiers.milk != null
                                    ? `${t.milkInLine}: ${
                                        line.modifiers.milk ? t.milkYes : t.milkNo
                                      }`
                                    : null,
                                  line.modifiers.sugar
                                    ? `${t.sugarInLine}: ${line.modifiers.sugar}`
                                    : null,
                                  line.modifiers.drink
                                    ? `${t.drinkInLine}: ${line.modifiers.drink}`
                                    : null,
                                  line.modifiers.eggCount
                                    ? `${t.eggsInLine}: ${line.modifiers.eggCount}`
                                    : null
                                ]
                                  .filter(Boolean)
                                  .join(", ") +
                                ")"
                              : ""
                          ),
                          e(
                            "span",
                            { className: "cart-item-meta" },
                            `${line.qty} x ${line.price.toFixed(2)} DHS`
                          )
                        ),
                        e(
                          "div",
                          { className: "cart-item-controls" },
                          e(
                            "button",
                            {
                              className: "qty-btn",
                              onClick: () => updateQty(line.key, -1)
                            },
                            "-"
                          ),
                          e("span", null, line.qty),
                          e(
                            "button",
                            {
                              className: "qty-btn",
                              onClick: () => updateQty(line.key, 1)
                            },
                            "+"
                          )
                        )
                      )
                    ),
                e(
                  "div",
                  { style: { marginTop: 8 } },
                  e(
                    "div",
                    { className: "summary-row" },
                    e("span", null, t.subtotal),
                    e("span", null, `${totals.subtotal.toFixed(2)} DHS`)
                  ),
                  e(
                    "div",
                    { className: "summary-row" },
                    e("span", null, t.tax),
                    e("span", null, `${totals.tax.toFixed(2)} DHS`)
                  ),
                  e(
                    "div",
                    { className: "summary-row total" },
                    e("span", null, t.total),
                    e("span", null, `${totals.total.toFixed(2)} DHS`)
                  )
                ),
                e(
                  "button",
                  {
                    className: "btn-primary",
                    style: { marginTop: 10, width: "100%" },
                    disabled: submitting || !cart.length,
                    onClick: handleSubmitOrder
                  },
                  submitting ? t.placingOrder : "Encaisser (cash)"
                ),
                status &&
                  e(
                    "div",
                    {
                      className:
                        "status " + (status.type === "ok" ? "ok" : "err")
                    },
                    status.message
                  ),
                e(
                  "div",
                  { style: { marginTop: 12 } },
                  e(
                    "h4",
                    { style: { margin: "0 0 8px", fontSize: 13 } },
                    t.ordersInProgress || "Commandes en attente"
                  ),
                  unpaidOrders.length === 0
                    ? e(
                        "div",
                        { style: { fontSize: 12, color: "#6b7280" } },
                        t.noOrdersInProgress || "Aucune commande en attente."
                      )
                    : unpaidOrders
                        .slice()
                        .reverse()
                        .map((o) =>
                          e(
                            "div",
                            {
                              key: o.id,
                              style: {
                                borderRadius: 14,
                                border: "1px solid rgba(148,163,184,0.55)",
                                background:
                                  "linear-gradient(145deg, rgba(255,255,255,0.96), rgba(224,231,255,0.72))",
                                boxShadow: "0 10px 22px rgba(15,23,42,0.10)",
                                padding: 10,
                                marginBottom: 10
                              }
                            },
                            e(
                              "div",
                              {
                                style: {
                                  display: "flex",
                                  justifyContent: "space-between",
                                  alignItems: "baseline",
                                  gap: 10
                                }
                              },
                              e(
                                "div",
                                { style: { fontSize: 12, fontWeight: 700 } },
                                (t.orderLabel || "Commande") +
                                  " " +
                                  (o.ticketCode || ("#" + displayOrderNumber(o.id)))
                              ),
                              e(
                                "div",
                                { style: { fontSize: 12, color: "#374151" } },
                                formatTime(o.createdAt)
                              )
                            ),
                            e(
                              "div",
                              { style: { fontSize: 11, color: "#6b7280", marginTop: 4 } },
                              (t.waiterLabel || "Serveur") +
                                ": " +
                                userNameById(o.cashierId)
                            ),
                            e(
                              "div",
                              { style: { marginTop: 8 } },
                              o.items.map((line) =>
                                e(
                                  "div",
                                  {
                                    key: line.key,
                                    style: {
                                      display: "flex",
                                      justifyContent: "space-between",
                                      gap: 10,
                                      fontSize: 12,
                                      padding: "2px 0"
                                    }
                                  },
                                  e(
                                    "div",
                                    { style: { flex: 1 } },
                                    `${line.qty}Ã— `,
                                    lineLabel(line),
                                    " ",
                                    e(
                                      "span",
                                      { style: { fontSize: 11, color: "#6b7280" } },
                                      lineModifiersLabel(line)
                                    )
                                  ),
                                  e(
                                    "div",
                                    { style: { whiteSpace: "nowrap" } },
                                    `${(line.price * line.qty).toFixed(2)} DHS`
                                  )
                                )
                              )
                            ),
                            e(
                              "div",
                              {
                                style: {
                                  display: "flex",
                                  justifyContent: "space-between",
                                  alignItems: "center",
                                  marginTop: 10
                                }
                              },
                              e(
                                "div",
                                { style: { fontWeight: 700, fontSize: 12 } },
                                `${o.totals.total.toFixed(2)} DHS`
                              ),
                              e(
                                "button",
                                {
                                  className: "category-btn",
                                  onClick: () => handleMarkOrderPaid(o.id)
                                },
                                t.markPaid || "DÃ©clarer payÃ©"
                              )
                            )
                          )
                        )
                )
              )
            ),
          view === "manager" &&
            e(
              "main",
              null,
              e(
                "section",
                { className: "panel" },
                e(
                  "div",
                  null,
                  e(
                    "h3",
                    { style: { marginTop: 0 } },
                    t.shiftSummaryTitle || "Shift"
                  ),
                  activeShift
                    ? e(
                        "div",
                        { style: { fontSize: 12 } },
                        "ID: ",
                        activeShift.id,
                        " | statut: ",
                        shiftPaused ? "paused" : "active",
                        activeWorker ? " | serveur: " + activeWorker.name : ""
                      )
                    : e(
                        "div",
                        { style: { fontSize: 12 } },
                        t.shiftSummaryNone || "Aucun shift ouvert."
                      )
                )
              ),
              e(
                "section",
                { className: "panel" },
                e("h3", null, "Vue Manager / Shifts"),
                e(ManagerStats, { shifts, orders, inventoryLogs, inventory })
              )
            ),
          view === "admin" &&
            e(
              "main",
              null,
              e(
                "section",
                { className: "panel" },
                e("h3", null, "Menu (Admin)"),
                canSeeAdmin()
                  ? e(AdminMenuEditor, {
                      menu: menu,
                      onUpdateMenuItem: handleUpdateMenuItem,
                      onSaveMenu: handleSaveMenu
                    })
                  : e(
                      "p",
                      { style: { fontSize: 12 } },
                      "Admin seulement."
                    )
              ),
              e(
                "section",
                { className: "panel" },
                e("h3", null, "Stats & Inventaire"),
                e(AdminStats, { shifts, orders, inventoryLogs, inventory, t, lang }),
                e(AdminInventoryEditor, {
                  inventory,
                  t,
                  onAdjust: handleInventoryAdjust,
                  onUpdate: handleInventoryUpdate
                }),
                e("hr", { style: { margin: "10px 0" } }),
                e("h4", null, "Utilisateurs / PIN"),
                canSeeAdmin()
                  ? e(AdminUsersPanel, {
                      users,
                      onChangePin: handleChangeUserPin
                    })
                  : null
              ),
              e(
                "section",
                { className: "panel" },
                canSeeAdmin()
                  ? e(AdminOrdersTickets, {
                      orders,
                      users,
                      lang,
                      t,
                      activeShiftId: activeShift ? activeShift.id : null,
                      shifts
                    })
                  : e(
                      "p",
                      { style: { fontSize: 12 } },
                      "Admin seulement."
                    )
              )
            )
        );
      }

      function ProductCard({ product, onAdd, lang, t }) {
        const [milk, setMilk] = React.useState(true); // yes/no for coffee
        const [sugar, setSugar] = React.useState("medium");
        const [drink, setDrink] = React.useState("coffee_milk"); // for breakfast combos
        const [eggCount, setEggCount] = React.useState(2); // for fried eggs
        const hasMilkModifier = isCoffee(product);
        const isBreakfast = product.category === "Breakfast";
        const isFriedEggs = product.id === "fried_eggs";

        function handleClick() {
          const effectiveProduct = isFriedEggs
            ? { ...product, price: eggCount === 1 ? 22.0 : 24.0 }
            : product;

          onAdd(effectiveProduct, {
            milk: hasMilkModifier ? milk : null,
            sugar,
            drink: isBreakfast ? drink : null,
            eggCount: isFriedEggs ? eggCount : null
          });
        }

        return React.createElement(
          "div",
          { className: "product-card" },
          React.createElement(
            "div",
            null,
            product.image
              ? (() => {
                  console.log("Loading image:", product.image);
                  return React.createElement("img", {
                      src: product.image,
                      alt:
                        lang === "ar"
                          ? product.nameAr || product.name
                          : product.nameFr || product.name,
                      className: "product-image",
                      onLoad: () => console.log("Image loaded:", product.image),
                      onError: () => console.error("Image failed to load:", product.image)
                    });
                })()
              : (console.log("No image for:", product.nameFr), null),
            React.createElement(
              "div",
              { className: "product-name" },
              lang === "ar"
                ? product.nameAr || product.name
                : product.nameFr || product.name
            ),
            React.createElement(
              "div",
              { className: "product-price" },
              `${product.price.toFixed(2)} DHS`
            ),
            hasMilkModifier &&
              React.createElement(
                "div",
                { style: { marginTop: 6, fontSize: 12 } },
                React.createElement("span", null, t.milkLabel + ": "),
                React.createElement(
                  "select",
                  {
                    className: "milk-select",
                    value: milk ? "yes" : "no",
                    onChange: (ev) => setMilk(ev.target.value === "yes")
                  },
                  React.createElement(
                    "option",
                    { value: "yes" },
                    t.milkYes
                  ),
                  React.createElement(
                    "option",
                    { value: "no" },
                    t.milkNo
                  )
                )
              ),
            React.createElement(
              "div",
              { style: { marginTop: 6, fontSize: 12 } },
              React.createElement("span", null, t.sugarLabel + ": "),
              React.createElement(
                "select",
                {
                  className: "milk-select",
                  value: sugar,
                  onChange: (ev) => setSugar(ev.target.value)
                },
                React.createElement(
                  "option",
                  { value: "none" },
                  t.sugarNone
                ),
                React.createElement(
                  "option",
                  { value: "low" },
                  t.sugarLow
                ),
                React.createElement(
                  "option",
                  { value: "medium" },
                  t.sugarMedium
                ),
                React.createElement(
                  "option",
                  { value: "extra" },
                  t.sugarExtra
                )
              )
            ),
            isBreakfast &&
              React.createElement(
                "div",
                { style: { marginTop: 6, fontSize: 12 } },
                React.createElement("span", null, t.drinkLabel + ": "),
                React.createElement(
                  "select",
                  {
                    className: "milk-select",
                    value: drink,
                    onChange: (ev) => setDrink(ev.target.value)
                  },
                  React.createElement(
                    "option",
                    { value: "tea" },
                    t.drinkTea
                  ),
                  React.createElement(
                    "option",
                    { value: "coffee_milk" },
                    t.drinkCoffeeMilk
                  )
                )
              ),
            isFriedEggs &&
              React.createElement(
                "div",
                { style: { marginTop: 6, fontSize: 12 } },
                React.createElement("span", null, "Eggs: "),
                React.createElement(
                  "select",
                  {
                    className: "milk-select",
                    value: String(eggCount),
                    onChange: (ev) => setEggCount(Number(ev.target.value))
                  },
                  React.createElement(
                    "option",
                    { value: "1" },
                    "1"
                  ),
                  React.createElement(
                    "option",
                    { value: "2" },
                    "2"
                  )
                )
              )
          ),
          React.createElement(
            "button",
            {
              className: "btn-primary",
              style: { marginTop: 8 },
              onClick: handleClick
            },
            t.addLabel
          )
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(React.createElement(POSApp));

      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("./sw.js").catch(() => {});
        });
      }
    </script>
  </body>
</html>
