<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Café Halab POS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top left, #fef3c7 0, #f9fafb 45%, #e5e7eb 100%);
      }
      .app-shell {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      header {
        background: linear-gradient(90deg, #0f172a, #1d3557);
        color: #f9fafb;
        padding: 14px 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.45);
      }
      header h1 {
        font-size: 20px;
        letter-spacing: 0.04em;
        margin: 0;
      }
      header span {
        font-size: 12px;
        opacity: 0.85;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .brand-logo {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        object-fit: contain;
        background: rgba(15, 23, 42, 0.8);
        padding: 4px;
      }
      main {
        display: grid;
        grid-template-columns: minmax(0, 2.2fr) minmax(0, 1fr);
        gap: 18px;
        padding: 18px 20px 24px;
      }
      @media (max-width: 900px) {
        main {
          grid-template-columns: 1fr;
        }
      }
      .panel {
        background: rgba(255, 255, 255, 0.96);
        border-radius: 18px;
        padding: 14px 16px 18px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
        border: 1px solid rgba(148, 163, 184, 0.35);
        -webkit-backdrop-filter: blur(6px);
        backdrop-filter: blur(6px);
      }
      .categories {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 12px;
      }
      .category-btn {
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        padding: 6px 14px;
        font-size: 12px;
        background: #f9fafb;
        cursor: pointer;
        transition: all 0.16s ease-out;
      }
      .category-btn.active {
        background: linear-gradient(135deg, #f97316, #facc15);
        color: #111827;
        border-color: transparent;
        box-shadow: 0 6px 14px rgba(248, 181, 0, 0.45);
      }
      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
        gap: 14px;
      }
      .product-card {
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        padding: 10px 10px 12px;
        background: linear-gradient(145deg, #f9fafb, #eef2ff);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        box-shadow: 0 14px 30px rgba(15, 23, 42, 0.16);
        overflow: hidden;
      }
      .product-image {
        width: 100%;
        height: 130px;
        object-fit: cover;
        border-radius: 14px;
        margin-bottom: 8px;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.26);
      }
      .product-name {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .product-price {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 8px;
      }
      .btn-primary {
        border: none;
        border-radius: 999px;
        padding: 7px 12px;
        font-size: 13px;
        background: linear-gradient(135deg, #16a34a, #22c55e);
        color: white;
        cursor: pointer;
        box-shadow: 0 8px 18px rgba(34, 197, 94, 0.6);
        transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;
      }
      .btn-primary:disabled {
        opacity: 0.5;
        cursor: default;
        box-shadow: none;
      }
      .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        padding: 6px 0;
        border-bottom: 1px solid #e5e7eb;
      }
      .cart-item:last-child {
        border-bottom: none;
      }
      .cart-item-main {
        display: flex;
        flex-direction: column;
      }
      .cart-item-meta {
        font-size: 11px;
        color: #6b7280;
      }
      .cart-item-controls {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .qty-btn {
        border-radius: 4px;
        border: 1px solid #d1d5db;
        background: white;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 13px;
      }
      .summary-row {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        margin-top: 4px;
      }
      .summary-row.total {
        font-weight: 700;
        margin-top: 8px;
      }
      .milk-select {
        width: 100%;
        margin-top: 4px;
        font-size: 12px;
        padding: 4px;
      }
      .status {
        font-size: 12px;
        margin-top: 8px;
      }
      .status.ok {
        color: #16a34a;
      }
      .status.err {
        color: #b91c1c;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- React from CDNs (global React / ReactDOM) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAcMZVPiMQKNqb2rcrV1WqmixIo1xFK2CE",
        authDomain: "cafe-halab.firebaseapp.com",
        projectId: "cafe-halab",
        storageBucket: "cafe-halab.firebasestorage.app",
        messagingSenderId: "915112396018",
        appId: "1:915112396018:web:4aa8dbadbc6651c3f6bc6b"
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      window.firebaseAuth = auth;
      window.firebaseDb = db;

      db.enablePersistence().catch(() => {});
    </script>

    <!-- Inline POS App (no modules, works via file://) -->
    <script>
      const e = React.createElement;

      const INITIAL_MENU_DATA = [
        {
          id: "omelette_cheese",
          name: "Omelette with Cheese",
          nameFr: "Omelette au Fromage",
          nameAr: "أومليت بالجبن",
          price: 26.0,
          category: "Breakfast",
          image: "Omelette au Fromage.jpg",
          modifiers: []
        },
        {
          id: "omelette_turkey",
          name: "Omelette with Turkey",
          nameFr: "Omelette à la Dinde Fumée",
          nameAr: "أومليت بالديك الرومي المدخن",
          price: 28.0,
          category: "Breakfast",
          image: "Omelette à la Dinde Fumée.jpg",
          modifiers: []
        },
        {
          id: "omelette_kashir",
          name: "Omelette with Kashir",
          nameFr: "Omelette au Kashir",
          nameAr: "أومليت بالكاشير",
          price: 24.0,
          category: "Breakfast",
          image: "Omelette au Kashir.jpg",
          modifiers: []
        },
        {
          id: "breakfast_marrakchi",
          name: "Marrakchi Breakfast",
          nameFr: "Petit Déjeuner Marrakchi",
          nameAr: "فطور مراكشي",
          price: 26.0,
          category: "Breakfast",
          image: "Petit Déjeuner Marrakchi.jpg",
          modifiers: []
        },
        {
          id: "breakfast_catalan",
          name: "Catalan Breakfast",
          nameFr: "Petit Déjeuner Catalan",
          nameAr: "فطور كاتالان",
          price: 29.0,
          category: "Breakfast",
          image: "Petit Déjeuner Catalan.jpg",
          modifiers: []
        },
        {
          id: "fried_eggs",
          name: "Fried Eggs (Mirror)",
          nameFr: "Œufs au plat miroir",
          nameAr: "فطور بيض عوينات",
          price: 22.0,
          category: "Breakfast",
          image: "Œufs au plat miroir.jpg",
          modifiers: []
        },
        {
          id: "croissant_breakfast",
          name: "Croissant Breakfast",
          nameFr: "Petit-déjeuner au croissant",
          nameAr: "فطور كرواسون",
          price: 20.0,
          category: "Breakfast",
          image: "Petit-déjeuner au croissant.jpg",
          modifiers: []
        },

        {
          id: "coffee",
          name: "Coffee",
          nameFr: "Café",
          nameAr: "قهوة",
          price: 11.0,
          category: "Hot Drinks",
          image: "Café.jpg",
          modifiers: []
        },
        {
          id: "coffee_with_milk",
          name: "Coffee with Milk",
          nameFr: "Café au lait",
          nameAr: "قهوة بالحليب",
          price: 11.0,
          category: "Hot Drinks",
          image: "Café au lait.jpg",
          modifiers: []
        },
        {
          id: "machada",
          name: "Machada",
          nameFr: "Machada",
          nameAr: "ماشادا",
          price: 11.0,
          category: "Hot Drinks",
          image: "Machada.jpg",
          modifiers: []
        },
        {
          id: "nescafe",
          name: "NESCAFE",
          nameFr: "NESCAFÉ",
          nameAr: "نسكافيه",
          price: 11.0,
          category: "Hot Drinks",
          image: "NESCAFÉ.jpg",
          modifiers: []
        },
        {
          id: "tea_lipton",
          name: "Lipton Tea",
          nameFr: "Thé Lipton",
          nameAr: "شاي ليبتون",
          price: 11.0,
          category: "Hot Drinks",
          image: null,
          modifiers: []
        },
        {
          id: "tea_mint",
          name: "Mint Tea",
          nameFr: "Thé à la Menthe",
          nameAr: "شاي بالنعناع",
          price: 7.0,
          category: "Hot Drinks",
          image: "Thé à la Menthe.jpg",
          modifiers: []
        },
        {
          id: "tea_berrad",
          name: "Berrad Tea (Teapot)",
          nameFr: "Thé Berrad",
          nameAr: "براد شاي",
          price: 9.0,
          category: "Hot Drinks",
          image: "Thé Berrad.jpg",
          modifiers: []
        },

        {
          id: "juice_orange",
          name: "Orange Juice",
          nameFr: "Jus d'orange",
          nameAr: "عصير البرتقال",
          price: 17.0,
          category: "Cold Drinks",
          image: "Jus d'orange.jpg",
          modifiers: []
        },
        {
          id: "juice_apple",
          name: "Apple Juice",
          nameFr: "Jus de pomme",
          nameAr: "عصير التفاح",
          price: 20.0,
          category: "Cold Drinks",
          image: null,
          modifiers: []
        },
        {
          id: "juice_lemon",
          name: "Lemon Juice",
          nameFr: "Jus de citron",
          nameAr: "عصير الليمون",
          price: 20.0,
          category: "Cold Drinks",
          image: null,
          modifiers: []
        },
        {
          id: "juice_banana",
          name: "Banana Juice",
          nameFr: "Jus de banane",
          nameAr: "عصير الموز",
          price: 20.0,
          category: "Cold Drinks",
          image: "Jus de banane.jpg",
          modifiers: []
        },
        {
          id: "juice_avocado",
          name: "Avocado Juice",
          nameFr: "Jus d'avocat",
          nameAr: "عصير الأفوكادو",
          price: 27.0,
          category: "Cold Drinks",
          image: "Jus d'avocat.jpg",
          modifiers: []
        },

        // Sodas
        {
          id: "soda_cocacola",
          name: "Coca-Cola",
          nameFr: "Coca-Cola",
          nameAr: "كوكا كولا",
          price: 12.0,
          category: "Cold Drinks",
          image: "Coca-Cola.jpg",
          modifiers: []
        },
        {
          id: "soda_hawai",
          name: "Hawai",
          nameFr: "Hawai",
          nameAr: "هاواي",
          price: 12.0,
          category: "Cold Drinks",
          image: "Hawai.jpg",
          modifiers: []
        },
        {
          id: "soda_poms",
          name: "Poms",
          nameFr: "Poms",
          nameAr: "بومس",
          price: 12.0,
          category: "Cold Drinks",
          image: "Poms.jpg",
          modifiers: []
        },
        {
          id: "soda_sprite",
          name: "Sprite",
          nameFr: "Sprite",
          nameAr: "سبرايت",
          price: 12.0,
          category: "Cold Drinks",
          image: "Sprite.jpg",
          modifiers: []
        },
        {
          id: "soda_schweppes_citron",
          name: "Schweppes Citron",
          nameFr: "Schweppes Citron",
          nameAr: "شويبس ليمون",
          price: 12.0,
          category: "Cold Drinks",
          image: "Schweppes Citron.jpg",
          modifiers: []
        },
        {
          id: "soda_schweppes_tonic",
          name: "Schweppes Tonic",
          nameFr: "Schweppes Tonic",
          nameAr: "شويبس تونيك",
          price: 12.0,
          category: "Cold Drinks",
          image: "Schweppes Tonic.jpg",
          modifiers: []
        },
        {
          id: "soda_schweppes_mojito",
          name: "Schweppes Mojito",
          nameFr: "Schweppes Mojito",
          nameAr: "شويبس موهيتو",
          price: 14.0,
          category: "Cold Drinks",
          image: null,
          modifiers: []
        },
        {
          id: "water_oulmes_regular",
          name: "Oulmès",
          nameFr: "Oulmès",
          nameAr: "أولماس",
          price: 10.0,
          category: "Cold Drinks",
          image: null,
          modifiers: []
        },
        {
          id: "water_oulmes_yellow",
          name: "Oulmès Jaune",
          nameFr: "Oulmès Jaune",
          nameAr: "أولماس أصفر",
          price: 10.0,
          category: "Cold Drinks",
          image: null,
          modifiers: []
        },

        // Others / Autres
        {
          id: "other_muffin",
          name: "Muffin",
          nameFr: "Muffin",
          nameAr: "مفن",
          price: 3.0,
          category: "Others",
          image: null,
          modifiers: []
        },
        {
          id: "other_raib",
          name: "Raib",
          nameFr: "Raib",
          nameAr: "رايب",
          price: 9.0,
          category: "Others",
          image: null,
          modifiers: []
        },
        {
          id: "other_flan",
          name: "Flan",
          nameFr: "Flan",
          nameAr: "فلان",
          price: 8.0,
          category: "Others",
          image: null,
          modifiers: []
        }
      ];

      const INITIAL_CATEGORIES = [
        "Breakfast",
        "Hot Drinks",
        "Cold Drinks",
        "Others"
      ];

      const USERS = [
        { id: "worker_med", name: "MED", role: "worker", pin: "1111" },
        { id: "worker_aya", name: "AYA", role: "worker", pin: "2222" },
        { id: "admin_nouri", name: "Nouri", role: "admin", pin: "3333" }
      ];

      const INVENTORY_INITIAL = {
        coffee_beans: {
          id: "coffee_beans",
          name: "Café (grains)",
          unit: "kg",
          currentQty: 5.0,
          minQty: 1.0
        },
        milk: {
          id: "milk",
          name: "Lait",
          unit: "L",
          currentQty: 8.0,
          minQty: 2.0
        },
        tea_leaves: {
          id: "tea_leaves",
          name: "Thé (en vrac)",
          unit: "kg",
          currentQty: 2.0,
          minQty: 0.5
        },
        sugar_powder: {
          id: "sugar_powder",
          name: "Sucre (poudre)",
          unit: "kg",
          currentQty: 4.0,
          minQty: 1.0
        },
        sugar_cubes: {
          id: "sugar_cubes",
          name: "Sucre (morceaux)",
          unit: "kg",
          currentQty: 3.0,
          minQty: 1.0
        },
        eggs: {
          id: "eggs",
          name: "Œufs",
          unit: "pcs",
          currentQty: 120,
          minQty: 24
        },
        cheese: {
          id: "cheese",
          name: "Fromage",
          unit: "kg",
          currentQty: 2.0,
          minQty: 0.5
        },
        turkey_smoked: {
          id: "turkey_smoked",
          name: "Dinde fumée",
          unit: "kg",
          currentQty: 2.0,
          minQty: 0.5
        },
        kashir: {
          id: "kashir",
          name: "Kashir",
          unit: "kg",
          currentQty: 2.0,
          minQty: 0.5
        },
        oranges: {
          id: "oranges",
          name: "Oranges",
          unit: "pcs",
          currentQty: 80,
          minQty: 20
        },
        apples: {
          id: "apples",
          name: "Pommes",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        },
        lemons: {
          id: "lemons",
          name: "Citrons",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        },
        bananas: {
          id: "bananas",
          name: "Bananes",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        },
        avocados: {
          id: "avocados",
          name: "Avocats",
          unit: "pcs",
          currentQty: 40,
          minQty: 10
        },

        soda_cocacola: {
          id: "soda_cocacola",
          name: "Coca-Cola",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_hawai: {
          id: "soda_hawai",
          name: "Hawai",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_poms: {
          id: "soda_poms",
          name: "Poms",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_sprite: {
          id: "soda_sprite",
          name: "Sprite",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_schweppes_citron: {
          id: "soda_schweppes_citron",
          name: "Schweppes Citron",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_schweppes_tonic: {
          id: "soda_schweppes_tonic",
          name: "Schweppes Tonic",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_schweppes_mojito: {
          id: "soda_schweppes_mojito",
          name: "Schweppes Mojito",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        water_oulmes_regular: {
          id: "water_oulmes_regular",
          name: "Oulmès",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        water_oulmes_yellow: {
          id: "water_oulmes_yellow",
          name: "Oulmès Jaune",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },

        muffin: {
          id: "muffin",
          name: "Muffin",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        },
        raib: {
          id: "raib",
          name: "Raib",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        },
        flan: {
          id: "flan",
          name: "Flan",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        }
      };

      const MENU_RECIPES = {
        omelette_cheese: { eggs: 2, cheese: 0.036 },
        omelette_turkey: { eggs: 2, turkey_smoked: 0.04 },
        omelette_kashir: { eggs: 2, kashir: 0.04 },
        breakfast_marrakchi: { eggs: 2 },
        breakfast_catalan: { eggs: 2 },
        croissant_breakfast: { eggs: 2 },
        fried_eggs: { eggs: 2 },

        coffee: { coffee_beans: 0.01 },
        coffee_with_milk: { coffee_beans: 0.01, milk: 0.18 },
        machada: { coffee_beans: 0.01 },
        nescafe: { coffee_beans: 0.01 },
        tea_lipton: { tea_leaves: 0.006 },
        tea_mint: { tea_leaves: 0.006 },
        tea_berrad: { tea_leaves: 0.012 },

        juice_orange: { oranges: 3 },
        juice_apple: { apples: 2 },
        juice_lemon: { lemons: 3 },
        juice_banana: { bananas: 2, milk: 0.2 },
        juice_avocado: { avocados: 1, milk: 0.25 },

        soda_cocacola: { soda_cocacola: 1 },
        soda_hawai: { soda_hawai: 1 },
        soda_poms: { soda_poms: 1 },
        soda_sprite: { soda_sprite: 1 },
        soda_schweppes_citron: { soda_schweppes_citron: 1 },
        soda_schweppes_tonic: { soda_schweppes_tonic: 1 },
        soda_schweppes_mojito: { soda_schweppes_mojito: 1 },
        water_oulmes_regular: { water_oulmes_regular: 1 },
        water_oulmes_yellow: { water_oulmes_yellow: 1 },

        other_muffin: { muffin: 1 },
        other_raib: { raib: 1 },
        other_flan: { flan: 1 }
      };

      function buildShiftId(dateStr, period) {
        return dateStr + "_" + period;
      }

      function isCoffee(item) {
        const ids = ["coffee", "coffee_with_milk", "nescafe", "machada"];
        return ids.includes(item.id);
      }

      const DICTIONARY = {
        fr: {
          appTitle: "Café Halab POS",
          uiSubtitle: "Aperçu UI · pas encore de backend",
          all: "Tout",
          catBreakfast: "Petit Déjeuner",
          catHot: "Boissons Chaudes",
          catCold: "Boissons Froides",
          catOthers: "Autres",
          currentOrder: "Commande en cours",
          cartEmpty: "Le panier est vide.",
          subtotal: "Sous-total",
          tax: "Taxe",
          total: "Total",
          mockPlaceOrder: "Simuler l'envoi de la commande",
          placingOrder: "Envoi en cours...",
          orderOk: "Commande enregistrée localement (console).",
          milkLabel: "Lait",
          milkYes: "Avec lait",
          milkNo: "Sans lait",
          sugarLabel: "Sucre",
          sugarNone: "Sans sucre",
          sugarLow: "Peu sucré",
          sugarMedium: "Moyen",
          sugarExtra: "Sucré",
          drinkLabel: "Boisson chaude",
          drinkTea: "Thé",
          drinkCoffeeMilk: "Café au lait",
          milkInLine: "lait",
          sugarInLine: "sucre",
          drinkInLine: "boisson",
          eggsInLine: "œufs",
          drinkInLine: "boisson",
          addLabel: "Ajouter",
          langFr: "FR",
          langAr: "AR",
          ordersInProgress: "Commandes en attente de paiement",
          noOrdersInProgress: "Aucune commande en attente.",
          markPaid: "Déclarer payé",
          shiftOpenTitle: "Ouvrir un shift",
          shiftOpenSubtitle:
            "Saisir le code PIN du serveur pour démarrer son shift.",
          backToMenus: "Retour aux menus",
          openShiftBtn: "Ouvrir le shift",
          closeShiftBtn: "Fermer le shift",
          pauseShiftBtn: "Pause",
          resumeShiftBtn: "Reprendre",
          confirmPinBtn: "Confirmer",
          pinLabel: "PIN",
          confirmPauseTitle: "Confirmer la pause",
          confirmPauseSubtitle: "Saisir votre PIN pour mettre le shift en pause.",
          shiftPausedTitle: "Shift en pause",
          shiftPausedSubtitle: "Saisir le PIN du serveur pour reprendre.",
          autoPausedMessage: "Shift mis en pause automatiquement (inactivité).",
          pinIncorrect: "PIN incorrect",
          orderAddedPending: "Commande ajoutée aux commandes en attente.",
          shiftPausedBlocking: "Shift en pause. Reprenez pour continuer.",
          closeBtn: "Fermer",
          needWorkerLogin: "Ouvrez un shift (PIN serveur) avant de prendre une commande.",
          noShiftOpen: "Aucun shift ouvert.",
          shiftSummaryTitle: "Shift",
          shiftSummaryNone: "Aucun shift ouvert.",
          virtualTicketsTitle: "Tickets des commandes",
          paidOrdersTitle: "Commandes payées",
          unpaidOrdersTitle: "Commandes non payées",
          noPaidOrders: "Aucune commande payée.",
          noUnpaidOrders: "Aucune commande non payée.",
          orderLabel: "Commande",
          waiterLabel: "Serveur",
          createdAtLabel: "Créée",
          paidAtLabel: "Payée",
          statusPaid: "Payée",
          statusUnpaid: "Non payée",
          detailsBtn: "Détails",
          hideDetailsBtn: "Masquer",
          inventoryTitle: "Inventaire",
          inventoryItemsTitle: "Articles",
          inventoryEditTitle: "Modifier",
          inventorySelectItem: "Sélectionner un article",
          inventoryCurrentQty: "Quantité actuelle",
          inventoryMinQty: "Seuil minimum",
          inventoryUnitLabel: "Unité",
          inventoryAdjustLabel: "Ajustement",
          inventoryAddBtn: "Ajouter",
          inventoryRemoveBtn: "Retirer",
          inventoryUpdateBtn: "Mettre à jour",
          inventoryTableTitle: "Tableau du stock",
          inventoryTableIngredient: "Ingrédient",
          inventoryTableLastShift: "Consommation (dernier shift)",
          inventoryTableTotal: "Consommation (total)",
          inventoryTableInitial: "Quantité initiale",
          inventoryTableRemaining: "Quantité restante",
          inventoryTableLastUpdate: "Dernière mise à jour",
          firebaseLoginTitle: "Connexion Cloud",
          firebaseLoginSubtitle:
            "Connectez-vous pour synchroniser les données du POS (commandes, shifts, stock) vers le cloud.",
          firebaseEmailLabel: "Email",
          firebasePasswordLabel: "Mot de passe",
          firebaseLoginBtn: "Se connecter",
          firebaseLoggingIn: "Connexion...",
          firebaseOfflineBtn: "Continuer hors ligne",
          firebaseCloudConnected: "Cloud: connecté",
          firebaseCloudDisconnected: "Cloud: non connecté",
          firebaseCloudConnectBtn: "Connexion",
          firebaseLogoutBtn: "Déconnexion"
        },
        ar: {
          appTitle: "نظام مقهى حلب",
          uiSubtitle: "واجهة فقط · بدون خلفية بعد",
          all: "الكل",
          catBreakfast: "فطور",
          catHot: "مشروبات ساخنة",
          catCold: "مشروبات باردة",
          catOthers: "أخرى",
          currentOrder: "الطلب الحالي",
          cartEmpty: "السلة فارغة",
          subtotal: "المجموع الفرعي",
          tax: "الضريبة",
          total: "المجموع",
          mockPlaceOrder: "تسجيل الطلب محلياً",
          placingOrder: "جار إرسال الطلب...",
          orderOk: "تم تسجيل الطلب محلياً (في الكونسول)",
          milkLabel: "حليب",
          milkYes: "مع حليب",
          milkNo: "بدون حليب",
          sugarLabel: "سكر",
          sugarNone: "بدون سكر",
          sugarLow: "قليل السكر",
          sugarMedium: "عادي",
          sugarExtra: "حلو",
          drinkLabel: "مشروب ساخن",
          drinkTea: "شاي",
          drinkCoffeeMilk: "قهوة بالحليب",
          milkInLine: "حليب",
          sugarInLine: "سكر",
          drinkInLine: "مشروب",
          eggsInLine: "بيض",
          drinkInLine: "مشروب",
          addLabel: "إضافة",
          langFr: "فر",
          langAr: "عر",
          ordersInProgress: "طلبات غير مدفوعة",
          noOrdersInProgress: "لا توجد طلبات غير مدفوعة.",
          markPaid: "تأكيد الدفع",
          shiftOpenTitle: "فتح نوبة عمل",
          shiftOpenSubtitle: "أدخل رمز النادل لبدء النوبة.",
          backToMenus: "الرجوع إلى القوائم",
          openShiftBtn: "فتح النوبة",
          closeShiftBtn: "إنهاء النوبة",
          pauseShiftBtn: "إيقاف مؤقت",
          resumeShiftBtn: "استئناف",
          confirmPinBtn: "تأكيد",
          pinLabel: "رمز PIN",
          confirmPauseTitle: "تأكيد الإيقاف المؤقت",
          confirmPauseSubtitle: "أدخل رمز PIN لإيقاف النوبة مؤقتاً.",
          shiftPausedTitle: "النوبة متوقفة",
          shiftPausedSubtitle: "أدخل رمز النادل لاستئناف العمل.",
          autoPausedMessage: "تم إيقاف النوبة تلقائياً بسبب عدم النشاط.",
          pinIncorrect: "رمز PIN غير صحيح",
          orderAddedPending: "تمت إضافة الطلب إلى قائمة الانتظار.",
          shiftPausedBlocking: "النوبة متوقفة. استأنف للمتابعة.",
          closeBtn: "إغلاق",
          needWorkerLogin: "افتح نوبة (رمز النادل) قبل تسجيل طلب.",
          noShiftOpen: "لا توجد نوبة مفتوحة.",
          shiftSummaryTitle: "النوبة",
          shiftSummaryNone: "لا توجد نوبة مفتوحة.",
          virtualTicketsTitle: "تذاكر الطلبات",
          paidOrdersTitle: "طلبات مدفوعة",
          unpaidOrdersTitle: "طلبات غير مدفوعة",
          noPaidOrders: "لا توجد طلبات مدفوعة.",
          noUnpaidOrders: "لا توجد طلبات غير مدفوعة.",
          orderLabel: "طلب",
          waiterLabel: "النادل",
          createdAtLabel: "وقت الإنشاء",
          paidAtLabel: "وقت الدفع",
          statusPaid: "مدفوع",
          statusUnpaid: "غير مدفوع",
          detailsBtn: "تفاصيل",
          hideDetailsBtn: "إخفاء",
          inventoryTitle: "المخزون",
          inventoryItemsTitle: "العناصر",
          inventoryEditTitle: "تعديل",
          inventorySelectItem: "اختر عنصراً",
          inventoryCurrentQty: "الكمية الحالية",
          inventoryMinQty: "الحد الأدنى",
          inventoryUnitLabel: "الوحدة",
          inventoryAdjustLabel: "تعديل",
          inventoryAddBtn: "إضافة",
          inventoryRemoveBtn: "خصم",
          inventoryUpdateBtn: "تحديث",
          inventoryTableTitle: "جدول المخزون",
          inventoryTableIngredient: "المكوّن",
          inventoryTableLastShift: "استهلاك آخر نوبة",
          inventoryTableTotal: "الاستهلاك الإجمالي",
          inventoryTableInitial: "الكمية الابتدائية",
          inventoryTableRemaining: "الكمية المتبقية",
          inventoryTableLastUpdate: "آخر تحديث",
          firebaseLoginTitle: "تسجيل الدخول إلى السحابة",
          firebaseLoginSubtitle:
            "سجّل الدخول لمزامنة بيانات النظام (الطلبات، النوبات، المخزون) إلى السحابة.",
          firebaseEmailLabel: "البريد الإلكتروني",
          firebasePasswordLabel: "كلمة المرور",
          firebaseLoginBtn: "تسجيل الدخول",
          firebaseLoggingIn: "جارٍ تسجيل الدخول...",
          firebaseOfflineBtn: "متابعة بدون اتصال",
          firebaseCloudConnected: "السحابة: متصل",
          firebaseCloudDisconnected: "السحابة: غير متصل",
          firebaseCloudConnectBtn: "اتصال",
          firebaseLogoutBtn: "تسجيل الخروج"
        }
      };

      function LoginPanel({ currentUser, users, onLogin, onLogout }) {
        const [pin, setPin] = React.useState("");
        const [error, setError] = React.useState(null);

        function handleSubmit(ev) {
          ev.preventDefault();
          const u = users.find((user) => user.pin === pin);
          if (!u) {
            setError("PIN incorrect");
            return;
          }
          setError(null);
          setPin("");
          onLogin(u);
        }

        if (currentUser) {
          return React.createElement(
            "div",
            { style: { display: "flex", gap: 8, alignItems: "center" } },
            React.createElement(
              "span",
              null,
              currentUser.name + " (" + currentUser.role + ")"
            ),
            React.createElement(
              "button",
              { className: "category-btn", onClick: onLogout },
              "Logout"
            )
          );
        }

        return React.createElement(
          "form",
          {
            onSubmit: handleSubmit,
            style: { display: "flex", gap: 4, alignItems: "center" }
          },
          React.createElement("input", {
            type: "password",
            value: pin,
            onChange: (e) => setPin(e.target.value),
            placeholder: "PIN",
            style: { padding: 4, fontSize: 12, width: 70 }
          }),
          React.createElement(
            "button",
            { className: "category-btn", type: "submit" },
            "Login"
          ),
          error &&
            React.createElement(
              "span",
              { style: { color: "#b91c1c", fontSize: 11 } },
              error
            )
        );
      }

      function FirebaseLoginOverlay({ t, lang, onSignedIn, onDismiss }) {
        const [email, setEmail] = React.useState("");
        const [password, setPassword] = React.useState("");
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);

        async function handleSubmit(ev) {
          ev.preventDefault();
          if (!window.firebaseAuth) return;
          setLoading(true);
          setError(null);
          try {
            const res = await window.firebaseAuth.signInWithEmailAndPassword(
              String(email || "").trim(),
              String(password || "")
            );
            setPassword("");
            setLoading(false);
            if (onSignedIn) onSignedIn(res && res.user ? res.user : null);
          } catch (e) {
            const msg =
              (e && e.code ? e.code + ": " : "") +
              (e && e.message ? e.message : "");
            setError(msg || "Erreur");
            setLoading(false);
          }
        }

        return React.createElement(
          "div",
          {
            style: {
              position: "fixed",
              inset: 0,
              background: "rgba(15,23,42,0.55)",
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              padding: 16,
              zIndex: 9999
            }
          },
          React.createElement(
            "section",
            {
              className: "panel",
              style: {
                maxWidth: 460,
                width: "100%",
                textAlign: lang === "ar" ? "right" : "left"
              }
            },
            React.createElement(
              "h3",
              { style: { marginTop: 0 } },
              (t && t.firebaseLoginTitle) || "Connexion Cloud"
            ),
            React.createElement(
              "p",
              { style: { fontSize: 13, marginTop: 6, color: "#334155" } },
              (t && t.firebaseLoginSubtitle) ||
                "Connectez-vous pour synchroniser les données du POS vers le cloud."
            ),
            React.createElement(
              "form",
              {
                onSubmit: handleSubmit,
                style: {
                  display: "flex",
                  flexDirection: "column",
                  gap: 10,
                  marginTop: 12
                }
              },
              React.createElement("input", {
                type: "email",
                autoComplete: "email",
                value: email,
                onChange: (e) => setEmail(e.target.value),
                placeholder: (t && t.firebaseEmailLabel) || "Email",
                style: { padding: 10, fontSize: 14 }
              }),
              React.createElement("input", {
                type: "password",
                autoComplete: "current-password",
                value: password,
                onChange: (e) => setPassword(e.target.value),
                placeholder: (t && t.firebasePasswordLabel) || "Mot de passe",
                style: { padding: 10, fontSize: 14 }
              }),
              React.createElement(
                "div",
                { style: { display: "flex", gap: 8, marginTop: 4 } },
                React.createElement(
                  "button",
                  { className: "btn-primary", type: "submit", disabled: loading },
                  loading
                    ? (t && t.firebaseLoggingIn) || "Connexion..."
                    : (t && t.firebaseLoginBtn) || "Se connecter"
                ),
                React.createElement(
                  "button",
                  {
                    className: "category-btn",
                    type: "button",
                    onClick: onDismiss
                  },
                  (t && t.firebaseOfflineBtn) || "Continuer hors ligne"
                )
              ),
              error &&
                React.createElement(
                  "div",
                  { style: { fontSize: 12, color: "#b91c1c", marginTop: 6 } },
                  error
                )
            )
          )
        );
      }

      function FirebaseAuthBadge({ t, lang, firebaseUser, dismissed, onOpenLogin, onLogout }) {
        if (!window.firebaseAuth) return null;
        const label = firebaseUser
          ? (t && t.firebaseCloudConnected) || "Cloud: connecté"
          : (t && t.firebaseCloudDisconnected) || "Cloud: non connecté";

        return React.createElement(
          "div",
          {
            style: {
              display: "flex",
              gap: 8,
              alignItems: "center",
              marginLeft: 10,
              padding: "6px 10px",
              borderRadius: 999,
              background: "rgba(15,23,42,0.06)",
              border: "1px solid rgba(148,163,184,0.4)",
              fontSize: 12,
              whiteSpace: "nowrap"
            }
          },
          React.createElement(
            "span",
            { style: { fontWeight: 700 } },
            label
          ),
          firebaseUser &&
            React.createElement(
              "span",
              { style: { color: "#475569" } },
              firebaseUser.email
            ),
          firebaseUser
            ? React.createElement(
                "button",
                { className: "category-btn", onClick: onLogout, type: "button" },
                (t && t.firebaseLogoutBtn) || "Déconnexion"
              )
            : dismissed
              ? React.createElement(
                  "button",
                  {
                    className: "category-btn",
                    onClick: onOpenLogin,
                    type: "button"
                  },
                  (t && t.firebaseCloudConnectBtn) || "Connexion"
                )
              : null
        );
      }

      function AdminInventoryEditor({ inventory, t, onAdjust, onUpdate }) {
        const items = Object.values(inventory)
          .slice()
          .sort((a, b) => (a.name || a.id).localeCompare(b.name || b.id));
        const [selectedId, setSelectedId] = React.useState(items[0]?.id || null);
        const [adjustValue, setAdjustValue] = React.useState("");
        const selected = selectedId ? inventory[selectedId] : null;
        const [currentQty, setCurrentQty] = React.useState(
          selected ? String(selected.currentQty) : ""
        );
        const [minQty, setMinQty] = React.useState(
          selected ? String(selected.minQty) : ""
        );

        React.useEffect(() => {
          const s = selectedId ? inventory[selectedId] : null;
          setCurrentQty(s ? String(s.currentQty) : "");
          setMinQty(s ? String(s.minQty) : "");
        }, [selectedId, inventory]);

        function parseNum(v) {
          const n = Number(String(v).replace(",", "."));
          return Number.isFinite(n) ? n : null;
        }

        function handleAdd() {
          if (!selectedId) return;
          const n = parseNum(adjustValue);
          if (n == null || n <= 0) return;
          onAdjust(selectedId, n);
          setAdjustValue("");
        }

        function handleRemove() {
          if (!selectedId) return;
          const n = parseNum(adjustValue);
          if (n == null || n <= 0) return;
          onAdjust(selectedId, -n);
          setAdjustValue("");
        }

        function handleUpdate() {
          if (!selectedId) return;
          const c = parseNum(currentQty);
          const m = parseNum(minQty);
          if (c == null || m == null) return;
          onUpdate(selectedId, c, m);
        }

        if (!items.length) {
          return React.createElement(
            "div",
            { style: { fontSize: 12 } },
            t.inventorySelectItem || "Sélectionner un article"
          );
        }

        return React.createElement(
          "div",
          {
            style: {
              display: "grid",
              gridTemplateColumns: "minmax(0, 1.4fr) minmax(0, 2fr)",
              gap: 14,
              alignItems: "flex-start"
            }
          },
          React.createElement(
            "div",
            {
              style: {
                borderRadius: 10,
                background: "linear-gradient(145deg,#eef2ff,#e0f2fe)",
                border: "1px solid rgba(129,140,248,0.6)",
                maxHeight: 260,
                overflowY: "auto"
              }
            },
            items.map((ing) =>
              React.createElement(
                "div",
                {
                  key: ing.id,
                  onClick: () => setSelectedId(ing.id),
                  style: {
                    padding: "8px 10px",
                    cursor: "pointer",
                    fontSize: 12,
                    background:
                      ing.id === selectedId
                        ? "rgba(129,140,248,0.3)"
                        : "transparent"
                  }
                },
                React.createElement(
                  "div",
                  { style: { fontWeight: 700 } },
                  ing.name || ing.id
                ),
                React.createElement(
                  "div",
                  { style: { fontSize: 11, color: "#475569" } },
                  ing.currentQty,
                  " ",
                  ing.unit,
                  ing.currentQty <= ing.minQty ? " (LOW)" : ""
                )
              )
            )
          ),
          React.createElement(
            "div",
            {
              style: {
                borderRadius: 12,
                padding: 12,
                background:
                  "linear-gradient(145deg, rgba(255,255,255,0.96), rgba(224,231,255,0.72))",
                border: "1px solid rgba(148,163,184,0.55)"
              }
            },
            React.createElement(
              "div",
              { style: { fontSize: 13, fontWeight: 800, marginBottom: 8 } },
              t.inventoryEditTitle || "Modifier"
            ),
            selected &&
              React.createElement(
                "div",
                { style: { fontSize: 12, marginBottom: 10 } },
                React.createElement(
                  "div",
                  { style: { fontWeight: 700 } },
                  selected.name || selected.id
                ),
                React.createElement(
                  "div",
                  { style: { color: "#475569", marginTop: 2 } },
                  (t.inventoryUnitLabel || "Unité") + ": ",
                  selected.unit
                )
              ),
            React.createElement(
              "div",
              { style: { display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 } },
              React.createElement(
                "label",
                { style: { fontSize: 12 } },
                React.createElement(
                  "div",
                  { style: { fontSize: 11, color: "#475569", marginBottom: 4 } },
                  t.inventoryCurrentQty || "Quantité actuelle"
                ),
                React.createElement("input", {
                  value: currentQty,
                  onChange: (e) => setCurrentQty(e.target.value),
                  style: { width: "100%", padding: 6, fontSize: 12 },
                  inputMode: "decimal"
                })
              ),
              React.createElement(
                "label",
                { style: { fontSize: 12 } },
                React.createElement(
                  "div",
                  { style: { fontSize: 11, color: "#475569", marginBottom: 4 } },
                  t.inventoryMinQty || "Seuil minimum"
                ),
                React.createElement("input", {
                  value: minQty,
                  onChange: (e) => setMinQty(e.target.value),
                  style: { width: "100%", padding: 6, fontSize: 12 },
                  inputMode: "decimal"
                })
              )
            ),
            React.createElement(
              "div",
              { style: { marginTop: 10 } },
              React.createElement(
                "div",
                { style: { fontSize: 11, color: "#475569", marginBottom: 4 } },
                t.inventoryAdjustLabel || "Ajustement"
              ),
              React.createElement(
                "div",
                { style: { display: "flex", gap: 6, alignItems: "center" } },
                React.createElement("input", {
                  value: adjustValue,
                  onChange: (e) => setAdjustValue(e.target.value),
                  style: { flex: 1, padding: 6, fontSize: 12 },
                  inputMode: "decimal"
                }),
                React.createElement(
                  "button",
                  { className: "category-btn", type: "button", onClick: handleAdd },
                  t.inventoryAddBtn || "Ajouter"
                ),
                React.createElement(
                  "button",
                  {
                    className: "category-btn",
                    type: "button",
                    onClick: handleRemove
                  },
                  t.inventoryRemoveBtn || "Retirer"
                )
              )
            ),
            React.createElement(
              "button",
              {
                className: "btn-primary",
                type: "button",
                style: { marginTop: 10 },
                onClick: handleUpdate
              },
              t.inventoryUpdateBtn || "Mettre à jour"
            )
          )
        );
      }

      function AdminOrdersTickets({ orders, users, lang, t, activeShiftId }) {
        const [expanded, setExpanded] = React.useState({});

        function formatTime(iso) {
          try {
            const d = new Date(iso);
            return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
          } catch (e) {
            return "";
          }
        }

        function formatDate(iso) {
          try {
            const d = new Date(iso);
            return d.toLocaleDateString();
          } catch (e) {
            return "";
          }
        }

        function displayOrderNumber(orderId) {
          if (!orderId) return "";
          const digits = String(orderId).replace(/\D/g, "");
          if (digits.length) return digits.slice(-4);
          return String(orderId).slice(-4);
        }

        function userNameById(userId) {
          const u = users.find((x) => x.id === userId);
          return u ? u.name : userId;
        }

        function lineLabel(line) {
          const base = lang === "ar" ? line.nameAr || line.name : line.nameFr || line.name;
          return base;
        }

        function lineModifiersLabel(line) {
          const mods = line.modifiers || {};
          const parts = [];
          if (mods.milk != null) {
            parts.push(`${t.milkInLine}: ${mods.milk ? t.milkYes : t.milkNo}`);
          }
          if (mods.sugar) {
            parts.push(`${t.sugarInLine}: ${mods.sugar}`);
          }
          if (mods.drink) {
            parts.push(`${t.drinkInLine}: ${mods.drink}`);
          }
          if (mods.eggCount) {
            parts.push(`${t.eggsInLine}: ${mods.eggCount}`);
          }
          return parts.length ? "(" + parts.join(", ") + ")" : "";
        }

        const scopedOrders = activeShiftId
          ? orders.filter((o) => o.shiftId === activeShiftId)
          : orders;

        const unpaidOrders = scopedOrders
          .filter((o) => o.status !== "paid")
          .slice()
          .reverse();
        const paidOrders = scopedOrders
          .filter((o) => o.status === "paid")
          .slice()
          .reverse();

        function toggle(id) {
          setExpanded((prev) => ({ ...prev, [id]: !prev[id] }));
        }

        function TicketCard(order, statusLabel) {
          const isExpanded = !!expanded[order.id];
          return React.createElement(
            "div",
            {
              key: order.id,
              style: {
                borderRadius: 14,
                border: "1px solid rgba(148,163,184,0.55)",
                background:
                  "linear-gradient(145deg, rgba(255,255,255,0.96), rgba(224,231,255,0.72))",
                boxShadow: "0 10px 22px rgba(15,23,42,0.10)",
                padding: 10,
                marginBottom: 10
              }
            },
            React.createElement(
              "div",
              {
                style: {
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "center",
                  gap: 10
                }
              },
              React.createElement(
                "div",
                { style: { fontSize: 12, fontWeight: 800 } },
                (t.orderLabel || "Commande") +
                  " #" +
                  displayOrderNumber(order.id) +
                  " · " +
                  statusLabel
              ),
              React.createElement(
                "button",
                {
                  className: "category-btn",
                  type: "button",
                  onClick: () => toggle(order.id)
                },
                isExpanded
                  ? t.hideDetailsBtn || "Masquer"
                  : t.detailsBtn || "Détails"
              )
            ),
            React.createElement(
              "div",
              { style: { fontSize: 11, color: "#6b7280", marginTop: 4 } },
              (t.waiterLabel || "Serveur") + ": " + userNameById(order.cashierId)
            ),
            React.createElement(
              "div",
              { style: { fontSize: 11, color: "#6b7280", marginTop: 2 } },
              (t.createdAtLabel || "Créée") +
                ": " +
                formatDate(order.createdAt) +
                " " +
                formatTime(order.createdAt)
            ),
            order.status === "paid" &&
              order.paidAt &&
              React.createElement(
                "div",
                { style: { fontSize: 11, color: "#6b7280", marginTop: 2 } },
                (t.paidAtLabel || "Payée") +
                  ": " +
                  formatDate(order.paidAt) +
                  " " +
                  formatTime(order.paidAt)
              ),
            isExpanded &&
              React.createElement(
                "div",
                { style: { marginTop: 8 } },
                order.items.map((line) =>
                  React.createElement(
                    "div",
                    {
                      key: line.key,
                      style: {
                        display: "flex",
                        justifyContent: "space-between",
                        gap: 10,
                        fontSize: 12,
                        padding: "2px 0"
                      }
                    },
                    React.createElement(
                      "div",
                      { style: { flex: 1 } },
                      `${line.qty}× `,
                      lineLabel(line),
                      " ",
                      React.createElement(
                        "span",
                        { style: { fontSize: 11, color: "#6b7280" } },
                        lineModifiersLabel(line)
                      )
                    ),
                    React.createElement(
                      "div",
                      { style: { whiteSpace: "nowrap" } },
                      `${(line.price * line.qty).toFixed(2)} DHS`
                    )
                  )
                ),
                React.createElement(
                  "div",
                  {
                    style: {
                      display: "flex",
                      justifyContent: "space-between",
                      alignItems: "center",
                      marginTop: 10
                    }
                  },
                  React.createElement(
                    "div",
                    { style: { fontWeight: 800, fontSize: 12 } },
                    `${order.totals.total.toFixed(2)} DHS`
                  ),
                  React.createElement(
                    "div",
                    { style: { fontSize: 11, color: "#6b7280" } },
                    "ID: ",
                    order.id
                  )
                )
              )
          );
        }

        return React.createElement(
          "div",
          null,
          React.createElement(
            "h3",
            { style: { marginTop: 0 } },
            t.virtualTicketsTitle || "Tickets"
          ),
          React.createElement(
            "h4",
            { style: { margin: "10px 0 8px", fontSize: 13 } },
            t.unpaidOrdersTitle || "Commandes non payées"
          ),
          unpaidOrders.length === 0
            ? React.createElement(
                "div",
                { style: { fontSize: 12, color: "#6b7280" } },
                t.noUnpaidOrders || "Aucune commande non payée."
              )
            : unpaidOrders.map((o) => TicketCard(o, t.statusUnpaid || "Non payée")),
          React.createElement(
            "h4",
            { style: { margin: "14px 0 8px", fontSize: 13 } },
            t.paidOrdersTitle || "Commandes payées"
          ),
          paidOrders.length === 0
            ? React.createElement(
                "div",
                { style: { fontSize: 12, color: "#6b7280" } },
                t.noPaidOrders || "Aucune commande payée."
              )
            : paidOrders.map((o) => TicketCard(o, t.statusPaid || "Payée"))
        );
      }

      function AdminUsersPanel({ users, onChangePin }) {
        const editableUsers = users.filter(
          (u) => u.role === "worker" || u.role === "manager"
        );
        const [selectedId, setSelectedId] = React.useState(
          editableUsers[0]?.id || null
        );
        const [newPin, setNewPin] = React.useState("");

        if (!editableUsers.length) {
          return React.createElement(
            "p",
            { style: { fontSize: 12 } },
            "Aucun utilisateur à modifier."
          );
        }

        const current = editableUsers.find((u) => u.id === selectedId) ||
          editableUsers[0];

        function handleSave() {
          if (!newPin || newPin.length < 4) {
            alert("PIN minimum 4 chiffres.");
            return;
          }
          onChangePin(current.id, newPin);
          setNewPin("");
        }

        return React.createElement(
          "div",
          {
            style: {
              fontSize: 12,
              display: "grid",
              gridTemplateColumns: "minmax(0, 1.4fr) minmax(0, 2fr)",
              gap: 12
            }
          },
          React.createElement(
            "div",
            {
              style: {
                borderRadius: 10,
                background: "linear-gradient(145deg,#eef2ff,#e0f2fe)",
                border: "1px solid rgba(129,140,248,0.6)",
                maxHeight: 220,
                overflowY: "auto"
              }
            },
            editableUsers.map((u) =>
              React.createElement(
                "div",
                {
                  key: u.id,
                  onClick: () => setSelectedId(u.id),
                  style: {
                    padding: "6px 10px",
                    cursor: "pointer",
                    fontSize: 12,
                    background:
                      u.id === current.id ? "rgba(129,140,248,0.3)" : "transparent"
                  }
                },
                u.name,
                " (",
                u.role,
                ")"
              )
            )
          ),
          React.createElement(
            "div",
            {
              style: {
                borderRadius: 12,
                padding: 10,
                background: "rgba(15,23,42,0.02)",
                border: "1px solid #e5e7eb",
                boxShadow: "0 8px 18px rgba(15,23,42,0.08)"
              }
            },
            React.createElement(
              "h4",
              { style: { marginTop: 0, marginBottom: 6 } },
              "Changer PIN utilisateur"
            ),
            React.createElement(
              "div",
              { style: { marginBottom: 4 } },
              "Utilisateur: ",
              current.name,
              " (",
              current.role,
              ")"
            ),
            React.createElement(
              "div",
              { style: { marginTop: 6 } },
              React.createElement(
                "div",
                { style: { fontWeight: 600, marginBottom: 2 } },
                "Nouveau PIN"
              ),
              React.createElement("input", {
                type: "password",
                value: newPin,
                onChange: (e) => setNewPin(e.target.value),
                style: { width: "100%", padding: 4, fontSize: 12 }
              })
            ),
            React.createElement(
              "button",
              {
                type: "button",
                className: "btn-primary",
                style: { marginTop: 8 },
                onClick: handleSave
              },
              "Enregistrer le PIN"
            )
          )
        );
      }

      function ShiftPanel({
        currentUser,
        activeShift,
        shifts,
        onOpenShift,
        onCloseShift
      }) {
        const [period, setPeriod] = React.useState("morning");
        const today = new Date().toISOString().slice(0, 10);

        if (
          !currentUser ||
          (currentUser.role !== "manager" && currentUser.role !== "admin")
        ) {
          return React.createElement(
            "p",
            { style: { fontSize: 12 } },
            "Admin seulement."
          );
        }

        const lastShifts = shifts.slice(-5).reverse();

        function handleOpen() {
          onOpenShift(today, period);
        }

        function handleClose() {
          onCloseShift();
        }

        return React.createElement(
          "div",
          null,
          React.createElement(
            "h3",
            null,
            "Shift du jour: " + today
          ),
          React.createElement(
            "div",
            { style: { marginBottom: 8 } },
            activeShift
              ? "Ouvert: " + activeShift.date + " (" + activeShift.period + ")"
              : "Aucun shift ouvert"
          ),
          !activeShift &&
            React.createElement(
              "div",
              { style: { display: "flex", gap: 4, marginBottom: 8 } },
              React.createElement(
                "select",
                {
                  value: period,
                  onChange: (e) => setPeriod(e.target.value),
                  style: { padding: 4, fontSize: 12 }
                },
                React.createElement("option", { value: "morning" }, "Matin"),
                React.createElement(
                  "option",
                  { value: "afternoon" },
                  "Après-midi"
                )
              ),
              React.createElement(
                "button",
                {
                  className: "btn-primary",
                  type: "button",
                  onClick: handleOpen
                },
                "Ouvrir shift"
              )
            ),
          activeShift &&
            React.createElement(
              "button",
              {
                className: "btn-primary",
                type: "button",
                onClick: handleClose
              },
              "Fermer shift"
            ),
          React.createElement("hr", { style: { margin: "10px 0" } }),
          React.createElement("h4", null, "Derniers shifts"),
          lastShifts.length === 0
            ? React.createElement(
                "p",
                { style: { fontSize: 12 } },
                "Aucun shift."
              )
            : lastShifts.map((s) =>
                React.createElement(
                  "div",
                  { key: s.id, style: { fontSize: 12, marginBottom: 4 } },
                  s.date,
                  " ",
                  s.period,
                  " | statut: ",
                  s.status,
                  " | commandes: ",
                  s.orderCount,
                  " | CA: ",
                  s.revenue.toFixed(2),
                  " DHS | cash attendu: ",
                  s.expectedCash.toFixed(2),
                  " DHS"
                )
              )
        );
      }

      function ManagerStats({ shifts, orders, inventoryLogs, inventory }) {
        if (!shifts.length) {
          return React.createElement(
            "p",
            { style: { fontSize: 12 } },
            "Aucun shift."
          );
        }

        function unitForIngredient(id) {
          return inventory && inventory[id] ? inventory[id].unit : "";
        }

        function getShiftStats(shift) {
          const shiftOrders = orders.filter((o) => o.shiftId === shift.id);
          const paidOrders = shiftOrders.filter((o) => o.status === "paid");
          const revenue = paidOrders.reduce(
            (sum, o) => sum + o.totals.total,
            0
          );
          const orderCount = paidOrders.length;
          const expectedCash = revenue;

          const logs = inventoryLogs.filter(
            (log) => log.shiftId === shift.id && log.reason === "sale"
          );
          const byIngredient = {};
          logs.forEach((log) => {
            byIngredient[log.ingredientId] =
              (byIngredient[log.ingredientId] || 0) + log.delta;
          });

          return { revenue, orderCount, expectedCash, byIngredient };
        }

        return React.createElement(
          "div",
          null,
          shifts
            .slice()
            .reverse()
            .map((shift) => {
              const stats = getShiftStats(shift);
              return React.createElement(
                "div",
                {
                  key: shift.id,
                  style: {
                    borderRadius: 12,
                    padding: 10,
                    marginBottom: 10,
                    background:
                      "linear-gradient(135deg, rgba(56,189,248,0.1), rgba(59,130,246,0.16))",
                    border: "1px solid rgba(59,130,246,0.35)",
                    boxShadow: "0 10px 24px rgba(15,23,42,0.15)"
                  }
                },
                React.createElement(
                  "div",
                  { style: { fontSize: 13, fontWeight: 600 } },
                  shift.date,
                  " ",
                  shift.period,
                  " (",
                  shift.status,
                  ")"
                ),
                React.createElement(
                  "div",
                  { style: { fontSize: 12, marginTop: 4 } },
                  "Commandes payées: ",
                  stats.orderCount,
                  " | CA: ",
                  stats.revenue.toFixed(2),
                  " DHS | Cash attendu: ",
                  stats.expectedCash.toFixed(2),
                  " DHS"
                ),
                React.createElement(
                  "div",
                  { style: { marginTop: 6, fontSize: 12 } },
                  "Consommation stock:"
                ),
                Object.keys(stats.byIngredient).length === 0
                  ? React.createElement(
                      "div",
                      { style: { fontSize: 11 } },
                      "Aucun mouvement."
                    )
                  : Object.entries(stats.byIngredient).map(([ingId, delta]) =>
                      React.createElement(
                        "div",
                        { key: ingId, style: { fontSize: 11 } },
                        ingId,
                        ": ",
                        delta,
                        " ",
                        unitForIngredient(ingId)
                      )
                    )
              );
            })
        );
      }

      function AdminStats({ shifts, orders, inventoryLogs, inventory, t, lang }) {
        if (!shifts.length) {
          return React.createElement(
            "p",
            { style: { fontSize: 12 } },
            "Aucun shift pour l'instant."
          );
        }

        const paidOrders = orders.filter((o) => o.status === "paid");
        const totalRevenue = paidOrders.reduce(
          (sum, o) => sum + o.totals.total,
          0
        );
        const totalOrders = paidOrders.length;

        function nameForIngredient(id) {
          return inventory[id]?.name || id;
        }

        function unitForIngredient(id) {
          return inventory[id]?.unit || "";
        }

        function formatQty(value, unit) {
          if (value == null || Number.isNaN(value)) return "";
          if (unit === "pcs") {
            const v = Math.round(value);
            return String(v);
          }
          const rounded = Math.round(value * 1000) / 1000;
          return String(rounded).replace(/\.0+$/, "").replace(/(\.\d*[1-9])0+$/, "$1");
        }

        function formatDateTime(iso) {
          if (!iso) return "";
          try {
            const d = new Date(iso);
            return d.toLocaleString(lang === "ar" ? "ar-MA" : "fr-FR", {
              year: "2-digit",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit"
            });
          } catch (e) {
            return "";
          }
        }

        const lastShift = shifts[shifts.length - 1];
        const lastShiftId = lastShift ? lastShift.id : null;

        const totalSaleByIngredient = {};
        const lastShiftSaleByIngredient = {};
        const lastUpdateByIngredient = {};
        inventoryLogs.forEach((log) => {
          if (!log || !log.ingredientId) return;

          const prevIso = lastUpdateByIngredient[log.ingredientId];
          if (!prevIso || (log.createdAt && log.createdAt > prevIso)) {
            lastUpdateByIngredient[log.ingredientId] = log.createdAt;
          }

          if (log.reason === "sale") {
            totalSaleByIngredient[log.ingredientId] =
              (totalSaleByIngredient[log.ingredientId] || 0) + (log.delta || 0);
            if (lastShiftId && log.shiftId === lastShiftId) {
              lastShiftSaleByIngredient[log.ingredientId] =
                (lastShiftSaleByIngredient[log.ingredientId] || 0) + (log.delta || 0);
            }
          }
        });

        const ingredientIds = Object.keys(inventory || {}).sort((a, b) =>
          nameForIngredient(a).localeCompare(nameForIngredient(b))
        );

        const tableTitle =
          (t && t.inventoryTableTitle) || "Tableau du stock";
        const colIngredient =
          (t && t.inventoryTableIngredient) || "Ingrédient";
        const colLastShift =
          (t && t.inventoryTableLastShift) || "Consommation (dernier shift)";
        const colTotal = (t && t.inventoryTableTotal) || "Consommation (total)";
        const colInitial = (t && t.inventoryTableInitial) || "Quantité initiale";
        const colRemaining =
          (t && t.inventoryTableRemaining) || "Quantité restante";
        const colLastUpdate =
          (t && t.inventoryTableLastUpdate) || "Dernière mise à jour";

        const thStyle = {
          textAlign: lang === "ar" ? "right" : "left",
          padding: "8px 8px",
          fontSize: 11,
          fontWeight: 700,
          color: "#0f172a",
          borderBottom: "1px solid rgba(148,163,184,0.6)",
          background: "rgba(226,232,240,0.8)",
          position: "sticky",
          top: 0
        };
        const tdStyle = {
          padding: "7px 8px",
          fontSize: 11,
          borderBottom: "1px solid rgba(148,163,184,0.25)",
          verticalAlign: "top"
        };

        return React.createElement(
          "div",
          null,
          React.createElement(
            "div",
            {
              style: {
                display: "grid",
                gridTemplateColumns: "repeat(auto-fit, minmax(140px, 1fr))",
                gap: 10,
                marginBottom: 10
              }
            },
            React.createElement(
              "div",
              {
                style: {
                  borderRadius: 12,
                  padding: 10,
                  background:
                    "linear-gradient(135deg, #22c55e, #a3e635)",
                  color: "#0f172a",
                  boxShadow: "0 10px 24px rgba(34,197,94,0.6)",
                  fontSize: 12
                }
              },
              React.createElement(
                "div",
                { style: { fontWeight: 700, marginBottom: 4 } },
                "CA total"
              ),
              React.createElement(
                "div",
                { style: { fontSize: 16 } },
                totalRevenue.toFixed(2),
                " DHS"
              )
            ),
            React.createElement(
              "div",
              {
                style: {
                  borderRadius: 12,
                  padding: 10,
                  background:
                    "linear-gradient(135deg, #38bdf8, #6366f1)",
                  color: "#f9fafb",
                  boxShadow: "0 10px 24px rgba(59,130,246,0.6)",
                  fontSize: 12
                }
              },
              React.createElement(
                "div",
                { style: { fontWeight: 700, marginBottom: 4 } },
                "Commandes payées"
              ),
              React.createElement(
                "div",
                { style: { fontSize: 16 } },
                totalOrders
              )
            ),
            React.createElement(
              "div",
              {
                style: {
                  borderRadius: 12,
                  padding: 10,
                  background:
                    "linear-gradient(135deg, #f97316, #fb7185)",
                  color: "#f9fafb",
                  boxShadow: "0 10px 24px rgba(248,113,113,0.5)",
                  fontSize: 12
                }
              },
              React.createElement(
                "div",
                { style: { fontWeight: 700, marginBottom: 4 } },
                "Nombre de shifts"
              ),
              React.createElement(
                "div",
                { style: { fontSize: 16 } },
                shifts.length
              )
            )
          ),
          React.createElement(
            "div",
            { style: { marginTop: 6, fontSize: 12 } },
            React.createElement(
              "div",
              { style: { fontWeight: 600, marginBottom: 4 } },
              tableTitle
            ),
            React.createElement(
              "div",
              {
                style: {
                  marginTop: 6,
                  borderRadius: 12,
                  overflow: "auto",
                  border: "1px solid rgba(148,163,184,0.5)",
                  background: "rgba(255,255,255,0.85)"
                }
              },
              React.createElement(
                "table",
                {
                  style: {
                    width: "100%",
                    borderCollapse: "collapse",
                    minWidth: 720
                  }
                },
                React.createElement(
                  "thead",
                  null,
                  React.createElement(
                    "tr",
                    null,
                    React.createElement("th", { style: thStyle }, colIngredient),
                    React.createElement("th", { style: thStyle }, colLastShift),
                    React.createElement("th", { style: thStyle }, colTotal),
                    React.createElement("th", { style: thStyle }, colInitial),
                    React.createElement("th", { style: thStyle }, colRemaining),
                    React.createElement("th", { style: thStyle }, colLastUpdate)
                  )
                ),
                React.createElement(
                  "tbody",
                  null,
                  ingredientIds.map((id) => {
                    const unit = unitForIngredient(id);
                    const initialQty =
                      (INVENTORY_INITIAL[id] && INVENTORY_INITIAL[id].currentQty) != null
                        ? INVENTORY_INITIAL[id].currentQty
                        : inventory[id]?.currentQty;
                    const remainingQty = inventory[id]?.currentQty;

                    const totalDelta = totalSaleByIngredient[id] || 0;
                    const lastShiftDelta = lastShiftSaleByIngredient[id] || 0;
                    const totalConsumed = totalDelta < 0 ? -totalDelta : 0;
                    const lastShiftConsumed = lastShiftDelta < 0 ? -lastShiftDelta : 0;
                    const lastUpdate = formatDateTime(lastUpdateByIngredient[id]);

                    return React.createElement(
                      "tr",
                      { key: id },
                      React.createElement(
                        "td",
                        { style: tdStyle },
                        nameForIngredient(id)
                      ),
                      React.createElement(
                        "td",
                        { style: tdStyle },
                        formatQty(lastShiftConsumed, unit),
                        " ",
                        unit
                      ),
                      React.createElement(
                        "td",
                        { style: tdStyle },
                        formatQty(totalConsumed, unit),
                        " ",
                        unit
                      ),
                      React.createElement(
                        "td",
                        { style: tdStyle },
                        formatQty(initialQty, unit),
                        " ",
                        unit
                      ),
                      React.createElement(
                        "td",
                        { style: tdStyle },
                        formatQty(remainingQty, unit),
                        " ",
                        unit
                      ),
                      React.createElement("td", { style: tdStyle }, lastUpdate)
                    );
                  })
                )
              )
            )
          )
        );
      }

      function AdminMenuEditor({ menu, onUpdateMenuItem, onSaveMenu }) {
        const [selectedId, setSelectedId] = React.useState(menu[0]?.id || null);

        if (!selectedId) {
          return React.createElement(
            "p",
            { style: { fontSize: 12 } },
            "Aucun article."
          );
        }

        const item = menu.find((m) => m.id === selectedId);

        function handleChange(field, value) {
          onUpdateMenuItem(selectedId, { [field]: value });
        }

        return React.createElement(
          "div",
          {
            style: {
              display: "grid",
              gridTemplateColumns: "minmax(0, 1.4fr) minmax(0, 2fr)",
              gap: 14,
              alignItems: "flex-start"
            }
          },
          React.createElement(
            "div",
            {
              style: {
                minWidth: 220,
                maxHeight: 280,
                overflowY: "auto",
                borderRadius: 10,
                background: "linear-gradient(145deg,#f9fafb,#e5e7eb)",
                border: "1px solid #e5e7eb"
              }
            },
            menu.map((m) =>
              React.createElement(
                "div",
                {
                  key: m.id,
                  onClick: () => setSelectedId(m.id),
                  style: {
                    padding: "6px 10px",
                    cursor: "pointer",
                    fontSize: 12,
                    background:
                      m.id === selectedId ? "#e5e7eb" : "transparent"
                  }
                },
                m.nameFr || m.name,
                " - ",
                m.price.toFixed(2),
                " DHS"
              )
            )
          ),
          React.createElement(
            "div",
            {
              style: {
                flex: 1,
                fontSize: 12,
                padding: 10,
                borderRadius: 12,
                background:
                  "linear-gradient(135deg, rgba(251,251,255,0.98), #e5e7eb)",
                border: "1px solid rgba(148,163,184,0.5)",
                boxShadow: "0 10px 24px rgba(15,23,42,0.12)"
              }
            },
            React.createElement(
              "div",
              { style: { display: "flex", justifyContent: "space-between" } },
              React.createElement("h4", null, "Éditer l'article"),
              React.createElement(
                "button",
                {
                  type: "button",
                  className: "btn-primary",
                  style: {
                    padding: "6px 14px",
                    fontSize: 11
                  },
                  onClick: () => onSaveMenu(menu)
                },
                "Enregistrer"
              )
            ),
            React.createElement(
              "div",
              { style: { marginTop: 4, fontSize: 11, color: "#6b7280" } },
              "ID: ",
              item.id
            ),
            React.createElement(
              "div",
              { style: { marginTop: 6 } },
              React.createElement(
                "div",
                { style: { fontWeight: 600, marginBottom: 2 } },
                "Nom FR:"
              ),
              React.createElement("input", {
                value: item.nameFr || "",
                onChange: (e) => handleChange("nameFr", e.target.value),
                style: { width: "100%", padding: 4, fontSize: 12 }
              })
            ),
            React.createElement(
              "div",
              { style: { marginTop: 6 } },
              React.createElement(
                "div",
                { style: { fontWeight: 600, marginBottom: 2 } },
                "Nom AR:"
              ),
              React.createElement("input", {
                value: item.nameAr || "",
                onChange: (e) => handleChange("nameAr", e.target.value),
                style: { width: "100%", padding: 4, fontSize: 12 }
              })
            ),
            React.createElement(
              "div",
              { style: { marginTop: 6 } },
              React.createElement(
                "div",
                { style: { fontWeight: 600, marginBottom: 2 } },
                "Prix DHS:"
              ),
              React.createElement("input", {
                type: "number",
                value: item.price,
                onChange: (e) =>
                  handleChange("price", parseFloat(e.target.value) || 0),
                style: { width: "100%", padding: 4, fontSize: 12 }
              })
            )
          )
        );
      }

      function POSApp() {
        const [lang, setLang] = React.useState("fr");
        const t = DICTIONARY[lang];

        const [activeCategory, setActiveCategory] = React.useState(null);
        const [menu, setMenu] = React.useState(() => INITIAL_MENU_DATA.slice());
        const [users, setUsers] = React.useState(USERS.slice());
        const [cart, setCart] = React.useState([]);
        const [submitting, setSubmitting] = React.useState(false);
        const [status, setStatus] = React.useState(null);

        const [adminUser, setAdminUser] = React.useState(null);
        const [activeWorker, setActiveWorker] = React.useState(null);
        const [view, setView] = React.useState("pos");
        const [activeShift, setActiveShift] = React.useState(null);
        const [shifts, setShifts] = React.useState([]);
        const [orders, setOrders] = React.useState([]);
        const [inventory, setInventory] = React.useState(INVENTORY_INITIAL);
        const [inventoryLogs, setInventoryLogs] = React.useState([]);

        const [firebaseUser, setFirebaseUser] = React.useState(null);
        const [firebaseAuthReady, setFirebaseAuthReady] = React.useState(false);
        const [firebaseLoginDismissed, setFirebaseLoginDismissed] = React.useState(false);

        const [shiftPin, setShiftPin] = React.useState("");
        const [shiftError, setShiftError] = React.useState(null);

        const [shiftPaused, setShiftPaused] = React.useState(false);
        const [pinPromptMode, setPinPromptMode] = React.useState(null);
        const [pinPromptValue, setPinPromptValue] = React.useState("");
        const [pinPromptError, setPinPromptError] = React.useState(null);
        const lastActivityRef = React.useRef(Date.now());

        React.useEffect(() => {
          if (!window.firebaseAuth || !window.firebaseAuth.onAuthStateChanged) {
            setFirebaseAuthReady(true);
            return;
          }
          const unsub = window.firebaseAuth.onAuthStateChanged((u) => {
            setFirebaseUser(u || null);
            setFirebaseAuthReady(true);
          });
          return () => {
            try {
              if (typeof unsub === "function") unsub();
            } catch (e) {}
          };
        }, []);

        function openFirebaseLogin() {
          setFirebaseLoginDismissed(false);
        }

        function dismissFirebaseLogin() {
          setFirebaseLoginDismissed(true);
        }

        function handleFirebaseSignedIn(u) {
          setFirebaseUser(u || (window.firebaseAuth ? window.firebaseAuth.currentUser : null));
          setFirebaseLoginDismissed(false);
        }

        function handleFirebaseLogout() {
          if (!window.firebaseAuth) return;
          try {
            window.firebaseAuth.signOut();
          } catch (e) {}
          setFirebaseLoginDismissed(false);
        }

        const categories = React.useMemo(
          () => INITIAL_CATEGORIES.slice(),
          []
        );

        const filteredProducts = React.useMemo(() => {
          if (!activeCategory) return [];
          return menu.filter((p) => p.category === activeCategory);
        }, [activeCategory, menu]);

        const unpaidOrders = React.useMemo(() => {
          if (!activeShift) return [];
          return orders.filter(
            (o) => o.shiftId === activeShift.id && o.status !== "paid"
          );
        }, [orders, activeShift]);

        function formatTime(iso) {
          try {
            const d = new Date(iso);
            return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
          } catch (e) {
            return "";
          }
        }

        function displayOrderNumber(orderId) {
          if (!orderId) return "";
          const digits = String(orderId).replace(/\D/g, "");
          if (digits.length) return digits.slice(-4);
          return String(orderId).slice(-4);
        }

        function userNameById(userId) {
          const u = users.find((x) => x.id === userId);
          return u ? u.name : userId;
        }

        function lineLabel(line) {
          const base = lang === "ar" ? line.nameAr || line.name : line.nameFr || line.name;
          return base;
        }

        function lineModifiersLabel(line) {
          const mods = line.modifiers || {};
          const parts = [];
          if (mods.milk != null) {
            parts.push(`${t.milkInLine}: ${mods.milk ? t.milkYes : t.milkNo}`);
          }
          if (mods.sugar) {
            parts.push(`${t.sugarInLine}: ${mods.sugar}`);
          }
          if (mods.drink) {
            parts.push(`${t.drinkInLine}: ${mods.drink}`);
          }
          if (mods.eggCount) {
            parts.push(`${t.eggsInLine}: ${mods.eggCount}`);
          }
          return parts.length ? "(" + parts.join(", ") + ")" : "";
        }

        React.useEffect(() => {
          if (!activeShift || !activeWorker) return;

          function bump() {
            lastActivityRef.current = Date.now();
          }

          const events = ["click", "keydown", "touchstart", "mousemove"];
          events.forEach((ev) => window.addEventListener(ev, bump, true));
          return () => {
            events.forEach((ev) => window.removeEventListener(ev, bump, true));
          };
        }, [activeShift, activeWorker]);

        React.useEffect(() => {
          if (!activeShift || !activeWorker) return;
          if (shiftPaused) return;

          const timeoutMs = 5 * 60 * 1000;
          const interval = window.setInterval(() => {
            if (Date.now() - lastActivityRef.current >= timeoutMs) {
              setShiftPaused(true);
              setStatus({
                type: "err",
                message:
                  t.autoPausedMessage ||
                  "Shift mis en pause automatiquement (inactivité)."
              });
            }
          }, 1000);

          return () => window.clearInterval(interval);
        }, [activeShift, activeWorker, shiftPaused, t]);

        function openPinPrompt(mode) {
          setPinPromptMode(mode);
          setPinPromptValue("");
          setPinPromptError(null);
        }

        function closePinPrompt() {
          setPinPromptMode(null);
          setPinPromptValue("");
          setPinPromptError(null);
        }

        function confirmPinPrompt(ev) {
          ev.preventDefault();
          if (!activeWorker) return;

          if (pinPromptValue !== activeWorker.pin) {
            setPinPromptError(t.pinIncorrect || "PIN incorrect");
            return;
          }

          if (pinPromptMode === "pause") {
            setShiftPaused(true);
          } else if (pinPromptMode === "resume") {
            setShiftPaused(false);
            lastActivityRef.current = Date.now();
            setStatus(null);
          }

          closePinPrompt();
        }

        function handleAddToCart(product, modifiers) {
          if (shiftPaused) {
            setStatus({
              type: "err",
              message: t.shiftPausedBlocking || "Shift en pause."
            });
            return;
          }
          setCart((prev) => {
            const key =
              product.id +
              (modifiers &&
              (modifiers.milk != null ||
                modifiers.sugar ||
                modifiers.drink ||
                modifiers.eggCount)
                ? `_${JSON.stringify(modifiers)}`
                : "");
            const existing = prev.find((line) => line.key === key);
            if (existing) {
              return prev.map((line) =>
                line.key === key ? { ...line, qty: line.qty + 1 } : line
              );
            }
            return [
              ...prev,
              {
                key,
                id: product.id,
                name: product.name,
                price: product.price,
                qty: 1,
                modifiers: modifiers || {}
              }
            ];
          });
        }

        function updateQty(key, delta) {
          if (shiftPaused) {
            setStatus({
              type: "err",
              message: t.shiftPausedBlocking || "Shift en pause."
            });
            return;
          }
          setCart((prev) =>
            prev
              .map((line) =>
                line.key === key ? { ...line, qty: line.qty + delta } : line
              )
              .filter((line) => line.qty > 0)
          );
        }

        const totals = React.useMemo(() => {
          const subtotal = cart.reduce((sum, line) => sum + line.price * line.qty, 0);
          const taxRate = 0.0;
          const tax = subtotal * taxRate;
          const total = subtotal + tax;
          return { subtotal, tax, total };
        }, [cart]);

        function accumulateIngredientsForOrder(orderItems) {
          const result = {};
          const COFFEE_IDS = new Set(["coffee", "coffee_with_milk", "nescafe", "machada"]);

          function add(ingredientId, amountPerUnit, qty) {
            if (!ingredientId || !amountPerUnit) return;
            const delta = -amountPerUnit * qty;
            result[ingredientId] = (result[ingredientId] || 0) + delta;
          }

          function addRecipe(recipe, qty) {
            if (!recipe) return;
            Object.entries(recipe).forEach(([ingredientId, perUnit]) => {
              add(ingredientId, perUnit, qty);
            });
          }

          function addSugarFor(type, sugarLevel, qty) {
            if (!sugarLevel || sugarLevel === "none") return;

            if (type === "coffee") {
              const KG_PER_CUBE = 1 / 180;
              const cubes = sugarLevel === "low" ? 1 : sugarLevel === "medium" ? 2 : 3;
              add("sugar_cubes", KG_PER_CUBE * cubes, qty);
              return;
            }

            if (type === "tea") {
              const grams = sugarLevel === "low" ? 5 : sugarLevel === "medium" ? 10 : 15;
              add("sugar_powder", grams / 1000, qty);
              return;
            }
          }

          orderItems.forEach((line) => {
            const qty = line.qty || 1;
            const mods = line.modifiers || {};
            const baseRecipe = MENU_RECIPES[line.id];

            addRecipe(baseRecipe, qty);

            if (line.id === "fried_eggs" && mods.eggCount) {
              const baseEggs = (baseRecipe && baseRecipe.eggs) || 0;
              const desired = Number(mods.eggCount) || 0;
              const extra = desired - baseEggs;
              if (extra !== 0) {
                result.eggs = (result.eggs || 0) + -extra * qty;
              }
            }

            if (mods.drink === "tea") {
              add("tea_leaves", 0.006, qty);
              addSugarFor("tea", mods.sugar, qty);
            } else if (mods.drink === "coffee_milk") {
              add("coffee_beans", 0.01, qty);
              add("milk", 0.18, qty);
              addSugarFor("coffee", mods.sugar, qty);
            }

            if (COFFEE_IDS.has(line.id)) {
              if (mods.milk === true && (!baseRecipe || baseRecipe.milk == null)) {
                add("milk", 0.18, qty);
              }
              if (mods.milk === false && baseRecipe && baseRecipe.milk != null) {
                result.milk = (result.milk || 0) + baseRecipe.milk * qty;
              }
              addSugarFor("coffee", mods.sugar, qty);
            }

            if (line.id === "tea_lipton" || line.id === "tea_mint" || line.id === "tea_berrad") {
              addSugarFor("tea", mods.sugar, qty);
            }
          });

          return result;
        }

        function applyInventoryConsumption(
          ingredientDeltas,
          shiftId,
          orderId,
          userId
        ) {
          setInventory((prev) => {
            const copy = { ...prev };
            Object.entries(ingredientDeltas).forEach(([ingId, delta]) => {
              if (!copy[ingId]) return;
              copy[ingId] = {
                ...copy[ingId],
                currentQty: copy[ingId].currentQty + delta
              };
            });
            return copy;
          });
          setInventoryLogs((prev) => [
            ...prev,
            ...Object.entries(ingredientDeltas).map(([ingId, delta]) => ({
              id: "log_" + Date.now() + "_" + Math.random().toString(16).slice(2),
              ingredientId: ingId,
              delta,
              reason: "sale",
              orderId,
              shiftId,
              userId,
              createdAt: new Date().toISOString()
            }))
          ]);
        }

        function handleInventoryAdjust(ingredientId, delta) {
          if (!ingredientId || !delta) return;
          setInventory((prev) => {
            if (!prev[ingredientId]) return prev;
            return {
              ...prev,
              [ingredientId]: {
                ...prev[ingredientId],
                currentQty: prev[ingredientId].currentQty + delta
              }
            };
          });
          setInventoryLogs((prev) => [
            ...prev,
            {
              id: "log_" + Date.now() + "_" + Math.random().toString(16).slice(2),
              ingredientId,
              delta,
              reason: "adjust",
              orderId: null,
              shiftId: activeShift ? activeShift.id : null,
              userId: adminUser ? adminUser.id : null,
              createdAt: new Date().toISOString()
            }
          ]);
        }

        function handleInventoryUpdate(ingredientId, currentQty, minQty) {
          if (!ingredientId) return;
          setInventory((prev) => {
            const ing = prev[ingredientId];
            if (!ing) return prev;
            return {
              ...prev,
              [ingredientId]: {
                ...ing,
                currentQty,
                minQty
              }
            };
          });
          setInventoryLogs((prev) => {
            const ing = inventory[ingredientId];
            const oldQty = ing ? ing.currentQty : null;
            const diff = oldQty == null ? 0 : currentQty - oldQty;
            if (!diff) return prev;
            return [
              ...prev,
              {
                id: "log_" + Date.now() + "_" + Math.random().toString(16).slice(2),
                ingredientId,
                delta: diff,
                reason: "adjust",
                orderId: null,
                shiftId: activeShift ? activeShift.id : null,
                userId: adminUser ? adminUser.id : null,
                createdAt: new Date().toISOString()
              }
            ];
          });
        }

        function handleAdminLogin(user) {
          setAdminUser(user);
        }

        function handleAdminLogout() {
          setAdminUser(null);
        }

        function handleChangeUserPin(userId, newPin) {
          setUsers((prev) =>
            prev.map((u) => (u.id === userId ? { ...u, pin: newPin } : u))
          );
        }

        function handleOpenShift(dateStr, period) {
          const id = buildShiftId(dateStr, period);
          const newShift = {
            id,
            date: dateStr,
            period,
            status: "open",
            openedAt: new Date().toISOString(),
            closedAt: null,
            openedBy: adminUser ? adminUser.id : null,
            closedBy: null,
            revenue: 0,
            orderCount: 0,
            expectedCash: 0
          };
          setActiveShift(newShift);
          setShifts((prev) => [...prev, newShift]);
        }

        function handleCloseShift() {
          if (!activeShift) return;
          setShifts((prev) =>
            prev.map((s) =>
              s.id === activeShift.id
                ? { ...s, status: "closed", closedAt: new Date().toISOString() }
                : s
            )
          );
          setActiveShift(null);
        }

        function updateShiftStats(shiftId, amount) {
          setShifts((prev) =>
            prev.map((s) =>
              s.id === shiftId
                ? {
                    ...s,
                    revenue: (s.revenue || 0) + amount,
                    orderCount: (s.orderCount || 0) + 1,
                    expectedCash: (s.expectedCash || 0) + amount
                  }
                : s
            )
          );
        }

        async function handleSubmitOrder() {
          if (!cart.length) return;
          if (!activeWorker) {
            setStatus({
              type: "err",
              message:
                t.needWorkerLogin ||
                "Ouvrez un shift (PIN serveur) avant de prendre une commande."
            });
            return;
          }
          if (shiftPaused) {
            setStatus({
              type: "err",
              message: t.shiftPausedBlocking || "Shift en pause."
            });
            return;
          }
          if (!activeShift) {
            setStatus({
              type: "err",
              message: t.noShiftOpen || "Aucun shift ouvert."
            });
            return;
          }

          setSubmitting(true);
          setStatus(null);

          const orderId = "local_" + Date.now();
          const order = {
            id: orderId,
            appId: "cafe-halab-pos",
            items: cart.map((line) => {
              const p = menu.find((m) => m.id === line.id);
              return {
                ...line,
                nameFr: p?.nameFr || line.name,
                nameAr: p?.nameAr || line.name
              };
            }),
            totals,
            currency: "DHS",
            status: "unpaid",
            createdAt: new Date().toISOString(),
            shiftId: activeShift.id,
            cashierId: activeWorker.id
          };

          const ingredientDeltas = accumulateIngredientsForOrder(cart);
          applyInventoryConsumption(
            ingredientDeltas,
            activeShift.id,
            orderId,
            activeWorker.id
          );

          setOrders((prev) => [...prev, order]);

          await new Promise((resolve) => setTimeout(resolve, 300));
          setStatus({
            type: "ok",
            message: t.orderAddedPending || "Commande ajoutée aux commandes en attente."
          });
          setCart([]);
          setSubmitting(false);
        }

        function handleMarkOrderPaid(orderId) {
          setOrders((prev) => {
            const order = prev.find((o) => o.id === orderId);
            if (!order || order.status === "paid") {
              return prev;
            }
            const next = prev.map((o) =>
              o.id === orderId
                ? { ...o, status: "paid", paidAt: new Date().toISOString() }
                : o
            );
            updateShiftStats(order.shiftId, order.totals.total);
            return next;
          });
        }

        function handleUpdateMenuItem(id, partial) {
          setMenu((prev) => {
            const next = prev.map((m) =>
              m.id === id ? { ...m, ...partial } : m
            );
            return next;
          });
          const idx = INITIAL_MENU_DATA.findIndex((m) => m.id === id);
          if (idx !== -1) {
            INITIAL_MENU_DATA[idx] = { ...INITIAL_MENU_DATA[idx], ...partial };
          }
        }

        function handleSaveMenu(currentMenu) {
          try {
            window.localStorage.setItem(
              "cafe_halab_menu",
              JSON.stringify(currentMenu)
            );
            setStatus({ type: "ok", message: "Menu enregistré." });
          } catch (e) {
            setStatus({ type: "err", message: "Erreur lors de l'enregistrement." });
          }
        }

        function canSeeManager() {
          return adminUser && adminUser.role === "admin";
        }

        function canSeeAdmin() {
          return adminUser && adminUser.role === "admin";
        }

        function handleOpenWaiterShift(ev) {
          ev.preventDefault();
          const worker = users.find(
            (u) => u.role === "worker" && u.pin === shiftPin
          );
          if (!worker) {
            setShiftError(t.pinIncorrect || "PIN incorrect");
            return;
          }
          const today = new Date().toISOString().slice(0, 10);
          const shiftId = buildShiftId(today, "default");
          const newShift = {
            id: shiftId,
            date: today,
            period: "default",
            status: "open",
            orderCount: 0,
            revenue: 0,
            expectedCash: 0,
            openedBy: worker.id
          };
          setActiveShift(newShift);
          setShifts((prev) => [...prev, newShift]);
          setActiveWorker(worker);
          setShiftPaused(false);
          lastActivityRef.current = Date.now();
          setShiftPin("");
          setShiftError(null);
          setActiveCategory(null);
          setView("pos");
        }

        function handleCloseWaiterShift() {
          setActiveShift(null);
          setActiveWorker(null);
          setCart([]);
          setActiveCategory(null);
          setShiftPaused(false);
          closePinPrompt();
        }

        return e(
          "div",
          { className: "app-shell" },
          window.firebaseAuth &&
            firebaseAuthReady &&
            !firebaseUser &&
            !firebaseLoginDismissed &&
            e(FirebaseLoginOverlay, {
              t,
              lang,
              onSignedIn: handleFirebaseSignedIn,
              onDismiss: dismissFirebaseLogin
            }),
          e(
            "header",
            null,
            e(
              "div",
              { className: "brand" },
              e("img", {
                src: "./cafe-halab-logo.png",
                alt: t.appTitle,
                className: "brand-logo"
              }),
              e(
                "div",
                null,
                e("h1", null, t.appTitle),
                e("span", null, t.uiSubtitle)
              )
            ),
            // Admin login only
            e(LoginPanel, {
              currentUser: adminUser,
              users: users.filter((u) => u.role === "admin"),
              onLogin: handleAdminLogin,
              onLogout: handleAdminLogout
            }),
            e(FirebaseAuthBadge, {
              t,
              lang,
              firebaseUser,
              dismissed: firebaseLoginDismissed,
              onOpenLogin: openFirebaseLogin,
              onLogout: handleFirebaseLogout
            }),
            e(
              "div",
              { style: { marginLeft: "auto", display: "flex", gap: 4 } },
              e(
                "button",
                {
                  className: "category-btn" + (view === "pos" ? " active" : ""),
                  onClick: () => setView("pos")
                },
                "POS"
              ),
              e(
                "button",
                {
                  className:
                    "category-btn" + (view === "manager" ? " active" : ""),
                  onClick: () => setView("manager"),
                  disabled: !canSeeManager()
                },
                "Manager"
              ),
              e(
                "button",
                {
                  className: "category-btn" + (view === "admin" ? " active" : ""),
                  onClick: () => setView("admin"),
                  disabled: !canSeeAdmin()
                },
                "Admin"
              ),
              activeShift &&
                activeWorker &&
                e(
                  "button",
                  {
                    className: "category-btn",
                    onClick: handleCloseWaiterShift
                  },
                  t.closeShiftBtn || "Close Shift"
                ),
              activeShift &&
                activeWorker &&
                !shiftPaused &&
                e(
                  "button",
                  {
                    className: "category-btn",
                    onClick: () => openPinPrompt("pause")
                  },
                  t.pauseShiftBtn || "Pause"
                ),
              activeShift &&
                activeWorker &&
                shiftPaused &&
                e(
                  "button",
                  {
                    className: "category-btn",
                    onClick: () => openPinPrompt("resume")
                  },
                  t.resumeShiftBtn || "Resume"
                ),
              e(
                "button",
                {
                  className: "category-btn" + (lang === "fr" ? " active" : ""),
                  onClick: () => setLang("fr")
                },
                t.langFr
              ),
              e(
                "button",
                {
                  className: "category-btn" + (lang === "ar" ? " active" : ""),
                  onClick: () => setLang("ar")
                },
                t.langAr
              )
            )
          ),
          pinPromptMode &&
            e(
              "div",
              {
                style: {
                  position: "fixed",
                  inset: 0,
                  background: "rgba(15,23,42,0.55)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  padding: 16,
                  zIndex: 50
                }
              },
              e(
                "section",
                { className: "panel", style: { maxWidth: 420, width: "100%" } },
                e(
                  "h3",
                  { style: { marginTop: 0 } },
                  pinPromptMode === "pause"
                    ? t.confirmPauseTitle || "Confirmer la pause"
                    : t.shiftPausedTitle || "Shift en pause"
                ),
                e(
                  "p",
                  { style: { fontSize: 13, marginTop: 6 } },
                  pinPromptMode === "pause"
                    ? t.confirmPauseSubtitle ||
                      "Saisir votre PIN pour mettre le shift en pause."
                    : t.shiftPausedSubtitle ||
                      "Saisir le PIN du serveur pour reprendre."
                ),
                e(
                  "form",
                  {
                    onSubmit: confirmPinPrompt,
                    style: {
                      display: "flex",
                      flexDirection: "column",
                      gap: 10,
                      marginTop: 10
                    }
                  },
                  e("input", {
                    type: "password",
                    value: pinPromptValue,
                    onChange: (ev) => setPinPromptValue(ev.target.value),
                    placeholder: t.pinLabel || "PIN",
                    style: {
                      padding: 10,
                      fontSize: 18,
                      textAlign: "center"
                    }
                  }),
                  e(
                    "button",
                    { className: "btn-primary", type: "submit" },
                    t.confirmPinBtn || "Confirmer"
                  ),
                  e(
                    "button",
                    {
                      className: "category-btn",
                      type: "button",
                      onClick: closePinPrompt
                    },
                    t.closeBtn || "Fermer"
                  ),
                  pinPromptError &&
                    e(
                      "div",
                      { style: { fontSize: 12, color: "#b91c1c" } },
                      pinPromptError
                    )
                )
              )
            ),
          view === "pos" &&
            !activeShift &&
            e(
              "main",
              {
                style: {
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center"
                }
              },
              e(
                "section",
                {
                  className: "panel",
                  style: { maxWidth: 420, textAlign: "center" }
                },
                e(
                  "h2",
                  { style: { marginTop: 0, marginBottom: 12 } },
                  t.shiftOpenTitle || "Open Shift"
                ),
                e(
                  "p",
                  { style: { fontSize: 13, marginBottom: 16 } },
                  t.shiftOpenSubtitle ||
                    "Enter waiter PIN to start a shift."
                ),
                e(
                  "form",
                  {
                    onSubmit: handleOpenWaiterShift,
                    style: {
                      display: "flex",
                      flexDirection: "column",
                      gap: 10,
                      alignItems: "center"
                    }
                  },
                  e("input", {
                    type: "password",
                    value: shiftPin,
                    onChange: (ev) => setShiftPin(ev.target.value),
                    placeholder: t.pinLabel || "PIN",
                    style: {
                      padding: 8,
                      fontSize: 16,
                      width: 160,
                      textAlign: "center"
                    }
                  }),
                  e(
                    "button",
                    {
                      className: "btn-primary",
                      type: "submit",
                      style: {
                        padding: "12px 24px",
                        fontSize: 18,
                        fontWeight: 600,
                        width: "100%",
                        maxWidth: 260
                      }
                    },
                    t.openShiftBtn || "OPEN SHIFT"
                  ),
                  shiftError &&
                    e(
                      "span",
                      { style: { color: "#b91c1c", fontSize: 11 } },
                      shiftError
                    )
                )
              )
            ),
          view === "pos" &&
            activeShift &&
            e(
              "main",
              null,
              e(
                "section",
                { className: "panel" },
                !activeCategory &&
                  e(
                    "div",
                    null,
                    e(
                      "h3",
                      { style: { marginTop: 0, marginBottom: 12 } },
                      "Menu"
                    ),
                    e(
                      "div",
                      {
                        style: {
                          display: "grid",
                          gridTemplateColumns:
                            "repeat(auto-fit, minmax(160px, 1fr))",
                          gap: 12
                        }
                      },
                      categories.map((cat) => {
                        let label = cat;
                        if (cat === "Breakfast") label = t.catBreakfast;
                        else if (cat === "Hot Drinks") label = t.catHot;
                        else if (cat === "Cold Drinks") label = t.catCold;
                        else if (cat === "Others") label = t.catOthers;
                        return e(
                          "button",
                          {
                            key: cat,
                            className: "category-btn",
                            style: {
                              padding: "18px 12px",
                              fontSize: 16,
                              fontWeight: 600,
                              width: "100%"
                            },
                            onClick: () =>
                              shiftPaused
                                ? setStatus({
                                    type: "err",
                                    message:
                                      t.shiftPausedBlocking ||
                                      "Shift en pause."
                                  })
                                : setActiveCategory(cat)
                          },
                          label
                        );
                      })
                    )
                  ),
                activeCategory &&
                  e(
                    "div",
                    null,
                    e(
                      "div",
                      {
                        style: {
                          display: "flex",
                          justifyContent: "space-between",
                          alignItems: "center",
                          marginBottom: 10
                        }
                      },
                      e(
                        "button",
                        {
                          className: "category-btn",
                          onClick: () =>
                            shiftPaused
                              ? setStatus({
                                  type: "err",
                                  message:
                                    t.shiftPausedBlocking ||
                                    "Shift en pause."
                                })
                              : setActiveCategory(null)
                        },
                        t.backToMenus || "Retour menus"
                      ),
                      e(
                        "h3",
                        { style: { margin: 0 } },
                        activeCategory === "Breakfast"
                          ? t.catBreakfast
                          : activeCategory === "Hot Drinks"
                          ? t.catHot
                          : activeCategory === "Cold Drinks"
                          ? t.catCold
                          : t.catOthers
                      )
                    ),
                    e(
                      "div",
                      { className: "products-grid" },
                      filteredProducts.map((product) =>
                        e(ProductCard, {
                          key: product.id,
                          product,
                          onAdd: handleAddToCart,
                          lang,
                          t
                        })
                      )
                    )
                  )
              ),
              e(
                "section",
                { className: "panel" },
                e("h3", null, t.currentOrder),
                cart.length === 0
                  ? e("p", { style: { fontSize: 12 } }, t.cartEmpty)
                  : cart.map((line) =>
                      e(
                        "div",
                        { className: "cart-item", key: line.key },
                        e(
                          "div",
                          { className: "cart-item-main" },
                          e(
                            "span",
                            null,
                            line.name,
                            line.modifiers &&
                            (line.modifiers.milk != null ||
                              line.modifiers.sugar ||
                              line.modifiers.drink ||
                              line.modifiers.eggCount)
                              ?
                                " (" +
                                [
                                  line.modifiers.milk != null
                                    ? `${t.milkInLine}: ${
                                        line.modifiers.milk ? t.milkYes : t.milkNo
                                      }`
                                    : null,
                                  line.modifiers.sugar
                                    ? `${t.sugarInLine}: ${line.modifiers.sugar}`
                                    : null,
                                  line.modifiers.drink
                                    ? `${t.drinkInLine}: ${line.modifiers.drink}`
                                    : null,
                                  line.modifiers.eggCount
                                    ? `${t.eggsInLine}: ${line.modifiers.eggCount}`
                                    : null
                                ]
                                  .filter(Boolean)
                                  .join(", ") +
                                ")"
                              : ""
                          ),
                          e(
                            "span",
                            { className: "cart-item-meta" },
                            `${line.qty} x ${line.price.toFixed(2)} DHS`
                          )
                        ),
                        e(
                          "div",
                          { className: "cart-item-controls" },
                          e(
                            "button",
                            {
                              className: "qty-btn",
                              onClick: () => updateQty(line.key, -1)
                            },
                            "-"
                          ),
                          e("span", null, line.qty),
                          e(
                            "button",
                            {
                              className: "qty-btn",
                              onClick: () => updateQty(line.key, 1)
                            },
                            "+"
                          )
                        )
                      )
                    ),
                e(
                  "div",
                  { style: { marginTop: 8 } },
                  e(
                    "div",
                    { className: "summary-row" },
                    e("span", null, t.subtotal),
                    e("span", null, `${totals.subtotal.toFixed(2)} DHS`)
                  ),
                  e(
                    "div",
                    { className: "summary-row" },
                    e("span", null, t.tax),
                    e("span", null, `${totals.tax.toFixed(2)} DHS`)
                  ),
                  e(
                    "div",
                    { className: "summary-row total" },
                    e("span", null, t.total),
                    e("span", null, `${totals.total.toFixed(2)} DHS`)
                  )
                ),
                e(
                  "button",
                  {
                    className: "btn-primary",
                    style: { marginTop: 10, width: "100%" },
                    disabled: submitting || !cart.length,
                    onClick: handleSubmitOrder
                  },
                  submitting ? t.placingOrder : "Encaisser (cash)"
                ),
                status &&
                  e(
                    "div",
                    {
                      className:
                        "status " + (status.type === "ok" ? "ok" : "err")
                    },
                    status.message
                  ),
                e(
                  "div",
                  { style: { marginTop: 12 } },
                  e(
                    "h4",
                    { style: { margin: "0 0 8px", fontSize: 13 } },
                    t.ordersInProgress || "Commandes en attente"
                  ),
                  unpaidOrders.length === 0
                    ? e(
                        "div",
                        { style: { fontSize: 12, color: "#6b7280" } },
                        t.noOrdersInProgress || "Aucune commande en attente."
                      )
                    : unpaidOrders
                        .slice()
                        .reverse()
                        .map((o) =>
                          e(
                            "div",
                            {
                              key: o.id,
                              style: {
                                borderRadius: 14,
                                border: "1px solid rgba(148,163,184,0.55)",
                                background:
                                  "linear-gradient(145deg, rgba(255,255,255,0.96), rgba(224,231,255,0.72))",
                                boxShadow: "0 10px 22px rgba(15,23,42,0.10)",
                                padding: 10,
                                marginBottom: 10
                              }
                            },
                            e(
                              "div",
                              {
                                style: {
                                  display: "flex",
                                  justifyContent: "space-between",
                                  alignItems: "baseline",
                                  gap: 10
                                }
                              },
                              e(
                                "div",
                                { style: { fontSize: 12, fontWeight: 700 } },
                                (t.orderLabel || "Commande") +
                                  " #" +
                                  displayOrderNumber(o.id)
                              ),
                              e(
                                "div",
                                { style: { fontSize: 12, color: "#374151" } },
                                formatTime(o.createdAt)
                              )
                            ),
                            e(
                              "div",
                              { style: { fontSize: 11, color: "#6b7280", marginTop: 4 } },
                              (t.waiterLabel || "Serveur") +
                                ": " +
                                userNameById(o.cashierId)
                            ),
                            e(
                              "div",
                              { style: { marginTop: 8 } },
                              o.items.map((line) =>
                                e(
                                  "div",
                                  {
                                    key: line.key,
                                    style: {
                                      display: "flex",
                                      justifyContent: "space-between",
                                      gap: 10,
                                      fontSize: 12,
                                      padding: "2px 0"
                                    }
                                  },
                                  e(
                                    "div",
                                    { style: { flex: 1 } },
                                    `${line.qty}× `,
                                    lineLabel(line),
                                    " ",
                                    e(
                                      "span",
                                      { style: { fontSize: 11, color: "#6b7280" } },
                                      lineModifiersLabel(line)
                                    )
                                  ),
                                  e(
                                    "div",
                                    { style: { whiteSpace: "nowrap" } },
                                    `${(line.price * line.qty).toFixed(2)} DHS`
                                  )
                                )
                              )
                            ),
                            e(
                              "div",
                              {
                                style: {
                                  display: "flex",
                                  justifyContent: "space-between",
                                  alignItems: "center",
                                  marginTop: 10
                                }
                              },
                              e(
                                "div",
                                { style: { fontWeight: 700, fontSize: 12 } },
                                `${o.totals.total.toFixed(2)} DHS`
                              ),
                              e(
                                "button",
                                {
                                  className: "category-btn",
                                  onClick: () => handleMarkOrderPaid(o.id)
                                },
                                t.markPaid || "Déclarer payé"
                              )
                            )
                          )
                        )
                )
              )
            ),
          view === "manager" &&
            e(
              "main",
              null,
              e(
                "section",
                { className: "panel" },
                e(
                  "div",
                  null,
                  e(
                    "h3",
                    { style: { marginTop: 0 } },
                    t.shiftSummaryTitle || "Shift"
                  ),
                  activeShift
                    ? e(
                        "div",
                        { style: { fontSize: 12 } },
                        "ID: ",
                        activeShift.id,
                        " | statut: ",
                        shiftPaused ? "paused" : "active",
                        activeWorker ? " | serveur: " + activeWorker.name : ""
                      )
                    : e(
                        "div",
                        { style: { fontSize: 12 } },
                        t.shiftSummaryNone || "Aucun shift ouvert."
                      )
                )
              ),
              e(
                "section",
                { className: "panel" },
                e("h3", null, "Vue Manager / Shifts"),
                e(ManagerStats, { shifts, orders, inventoryLogs, inventory })
              )
            ),
          view === "admin" &&
            e(
              "main",
              null,
              e(
                "section",
                { className: "panel" },
                e("h3", null, "Menu (Admin)"),
                canSeeAdmin()
                  ? e(AdminMenuEditor, {
                      menu: menu,
                      onUpdateMenuItem: handleUpdateMenuItem,
                      onSaveMenu: handleSaveMenu
                    })
                  : e(
                      "p",
                      { style: { fontSize: 12 } },
                      "Admin seulement."
                    )
              ),
              e(
                "section",
                { className: "panel" },
                e("h3", null, "Stats & Inventaire"),
                e(AdminStats, { shifts, orders, inventoryLogs, inventory, t, lang }),
                e(AdminInventoryEditor, {
                  inventory,
                  t,
                  onAdjust: handleInventoryAdjust,
                  onUpdate: handleInventoryUpdate
                }),
                e("hr", { style: { margin: "10px 0" } }),
                e("h4", null, "Utilisateurs / PIN"),
                canSeeAdmin()
                  ? e(AdminUsersPanel, {
                      users,
                      onChangePin: handleChangeUserPin
                    })
                  : null
              ),
              e(
                "section",
                { className: "panel" },
                canSeeAdmin()
                  ? e(AdminOrdersTickets, {
                      orders,
                      users,
                      lang,
                      t,
                      activeShiftId: activeShift ? activeShift.id : null
                    })
                  : e(
                      "p",
                      { style: { fontSize: 12 } },
                      "Admin seulement."
                    )
              )
            )
        );
      }

      function ProductCard({ product, onAdd, lang, t }) {
        const [milk, setMilk] = React.useState(true); // yes/no for coffee
        const [sugar, setSugar] = React.useState("medium");
        const [drink, setDrink] = React.useState("coffee_milk"); // for breakfast combos
        const [eggCount, setEggCount] = React.useState(2); // for fried eggs
        const hasMilkModifier = isCoffee(product);
        const isBreakfast = product.category === "Breakfast";
        const isFriedEggs = product.id === "fried_eggs";

        function handleClick() {
          const effectiveProduct = isFriedEggs
            ? { ...product, price: eggCount === 1 ? 22.0 : 24.0 }
            : product;

          onAdd(effectiveProduct, {
            milk: hasMilkModifier ? milk : null,
            sugar,
            drink: isBreakfast ? drink : null,
            eggCount: isFriedEggs ? eggCount : null
          });
        }

        return React.createElement(
          "div",
          { className: "product-card" },
          React.createElement(
            "div",
            null,
            product.image
              ? (() => {
                  console.log("Loading image:", product.image);
                  return React.createElement("img", {
                      src: product.image,
                      alt:
                        lang === "ar"
                          ? product.nameAr || product.name
                          : product.nameFr || product.name,
                      className: "product-image",
                      onLoad: () => console.log("Image loaded:", product.image),
                      onError: () => console.error("Image failed to load:", product.image)
                    });
                })()
              : (console.log("No image for:", product.nameFr), null),
            React.createElement(
              "div",
              { className: "product-name" },
              lang === "ar"
                ? product.nameAr || product.name
                : product.nameFr || product.name
            ),
            React.createElement(
              "div",
              { className: "product-price" },
              `${product.price.toFixed(2)} DHS`
            ),
            hasMilkModifier &&
              React.createElement(
                "div",
                { style: { marginTop: 6, fontSize: 12 } },
                React.createElement("span", null, t.milkLabel + ": "),
                React.createElement(
                  "select",
                  {
                    className: "milk-select",
                    value: milk ? "yes" : "no",
                    onChange: (ev) => setMilk(ev.target.value === "yes")
                  },
                  React.createElement(
                    "option",
                    { value: "yes" },
                    t.milkYes
                  ),
                  React.createElement(
                    "option",
                    { value: "no" },
                    t.milkNo
                  )
                )
              ),
            React.createElement(
              "div",
              { style: { marginTop: 6, fontSize: 12 } },
              React.createElement("span", null, t.sugarLabel + ": "),
              React.createElement(
                "select",
                {
                  className: "milk-select",
                  value: sugar,
                  onChange: (ev) => setSugar(ev.target.value)
                },
                React.createElement(
                  "option",
                  { value: "none" },
                  t.sugarNone
                ),
                React.createElement(
                  "option",
                  { value: "low" },
                  t.sugarLow
                ),
                React.createElement(
                  "option",
                  { value: "medium" },
                  t.sugarMedium
                ),
                React.createElement(
                  "option",
                  { value: "extra" },
                  t.sugarExtra
                )
              )
            ),
            isBreakfast &&
              React.createElement(
                "div",
                { style: { marginTop: 6, fontSize: 12 } },
                React.createElement("span", null, t.drinkLabel + ": "),
                React.createElement(
                  "select",
                  {
                    className: "milk-select",
                    value: drink,
                    onChange: (ev) => setDrink(ev.target.value)
                  },
                  React.createElement(
                    "option",
                    { value: "tea" },
                    t.drinkTea
                  ),
                  React.createElement(
                    "option",
                    { value: "coffee_milk" },
                    t.drinkCoffeeMilk
                  )
                )
              ),
            isFriedEggs &&
              React.createElement(
                "div",
                { style: { marginTop: 6, fontSize: 12 } },
                React.createElement("span", null, "Eggs: "),
                React.createElement(
                  "select",
                  {
                    className: "milk-select",
                    value: String(eggCount),
                    onChange: (ev) => setEggCount(Number(ev.target.value))
                  },
                  React.createElement(
                    "option",
                    { value: "1" },
                    "1"
                  ),
                  React.createElement(
                    "option",
                    { value: "2" },
                    "2"
                  )
                )
              )
          ),
          React.createElement(
            "button",
            {
              className: "btn-primary",
              style: { marginTop: 8 },
              onClick: handleClick
            },
            t.addLabel
          )
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(React.createElement(POSApp));
    </script>
  </body>
</html>
