<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Café Halab POS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <link rel="manifest" href="./manifest.webmanifest" />
    <meta name="theme-color" content="#1e4d48" />
    <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Café Halab POS" />
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png" /><style>
      :root {
        --bg: #1e4d48;
        --sidebar: #163832;
        --surface: rgba(255, 255, 255, 0.96);
        --surface-solid: #ffffff;
        --surface-muted: #f3f4f6;
        --text: #1e4d48;
        --text-muted: #6b7280;
        --border: rgba(148, 163, 184, 0.35);
        --accent: #f97316;
        --accent-2: #fbbf24;
        --accent-green: #86efac;
        --accent-purple: #c4b5fd;
        --radius-lg: 24px;
        --radius-md: 18px;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg);
        overflow-x: hidden;
        position: relative;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background:
          radial-gradient(circle at 12% 22%, rgba(249, 115, 22, 0.38) 0, transparent 46%),
          radial-gradient(circle at 76% 26%, rgba(134, 239, 172, 0.32) 0, transparent 52%),
          radial-gradient(circle at 58% 108%, rgba(251, 191, 36, 0.30) 0, transparent 55%),
          radial-gradient(circle at 74% 60%, rgba(196, 181, 253, 0.22) 0, transparent 48%);
        filter: blur(10px);
        opacity: 1;
        z-index: 0;
      }

      .app-shell {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        position: relative;
        z-index: 1;
      }

      header {
        background: var(--sidebar);
        color: rgba(255, 255, 255, 0.92);
        padding: 18px 24px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.28);
      }
      header h1 {
        font-size: 20px;
        letter-spacing: 0.04em;
        margin: 0;
      }
      header span {
        font-size: 12px;
        opacity: 0.85;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .brand-logo {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        object-fit: contain;
        background: rgba(249, 115, 22, 0.92);
        padding: 4px;
      }
      main {
        display: grid;
        grid-template-columns: minmax(0, 2.2fr) minmax(0, 1fr);
        gap: 18px;
        padding: 24px;
      }
      @media (max-width: 900px) {
        main {
          grid-template-columns: 1fr;
        }
      }
      .panel {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: 18px 18px 20px;
        box-shadow: 0 24px 50px rgba(0, 0, 0, 0.22);
        border: 1px solid var(--border);
        -webkit-backdrop-filter: blur(6px);
        backdrop-filter: blur(6px);
      }
      .categories {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 12px;
      }
      .category-btn {
        border-radius: 999px;
        border: 1px solid rgba(30, 77, 72, 0.16);
        padding: 6px 14px;
        font-size: 12px;
        background: var(--surface-muted);
        color: var(--text);
        cursor: pointer;
        transition: all 0.16s ease-out;
      }

      .category-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.12);
      }

      .category-btn.active {
        background: var(--accent);
        color: #ffffff;
        border-color: transparent;
        box-shadow: 0 14px 30px rgba(249, 115, 22, 0.42);
      }
      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
        gap: 14px;
      }
      .product-card {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(148, 163, 184, 0.55);
        padding: 10px 10px 12px;
        background: var(--surface-solid);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.14);
        overflow: hidden;
        transition: transform 140ms ease, box-shadow 140ms ease;
      }

      .product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 22px 55px rgba(0, 0, 0, 0.20);
      }

      .product-image {
        width: 100%;
        height: 130px;
        object-fit: cover;
        border-radius: 18px;
        margin-bottom: 8px;
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.22);
      }
      .product-name {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
      }
      .product-price {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 8px;
      }
      .btn-primary {
        border: none;
        border-radius: 999px;
        padding: 7px 12px;
        font-size: 13px;
        background: var(--accent);
        color: #ffffff;
        cursor: pointer;
        box-shadow: 0 14px 30px rgba(249, 115, 22, 0.42);
        transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 18px 40px rgba(249, 115, 22, 0.50);
      }

      .btn-primary:disabled {
        opacity: 0.5;
        cursor: default;
        box-shadow: none;
      }
      .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        padding: 6px 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.35);
      }
      .cart-item:last-child {
        border-bottom: none;
      }
      .cart-item-main {
        display: flex;
        flex-direction: column;
      }
      .cart-item-meta {
        font-size: 11px;
        color: var(--text-muted);
      }
      .cart-item-controls {
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .cart-item--enter {
        will-change: transform, opacity;
        animation: cafeCartIn 140ms cubic-bezier(0.2, 0.95, 0.2, 1) both;
      }

      @keyframes cafeCartIn {
        from {
          opacity: 0;
          transform: translateX(10px) scale(0.985);
        }
        to {
          opacity: 1;
          transform: translateX(0) scale(1);
        }
      }

      .ticket-card {
        will-change: transform, opacity, filter;
      }

      .ticket-card--exit {
        will-change: transform, opacity, filter;
        animation: cafeTicketOut 280ms cubic-bezier(0.22, 1, 0.36, 1) both;
      }

      @keyframes cafeTicketOut {
        0% {
          opacity: 1;
          transform: translateX(0) rotate(0deg) scale(1);
          filter: blur(0px);
        }
        55% {
          opacity: 0.75;
          transform: translateX(10px) rotate(0.8deg) scale(0.995);
        }
        100% {
          opacity: 0;
          transform: translateX(36px) translateY(-8px) rotate(2.5deg) scale(0.97);
          filter: blur(0.7px);
        }
      }

      @media (prefers-reduced-motion: reduce) {
        .cart-item--enter,
        .ticket-card--exit {
          animation: none;
        }
      }

      .qty-btn {
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.55);
        background: var(--surface-solid);
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 13px;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        margin-top: 4px;
      }
      .summary-row.total {
        font-weight: 700;
        margin-top: 8px;
      }
      .milk-select {
        width: 100%;
        margin-top: 4px;
        font-size: 12px;
        padding: 4px;
      }
      .status {
        font-size: 12px;
        margin-top: 8px;
      }
      .status.ok {
        color: #15803d;
      }
      .status.err {
        color: #b91c1c;
      }

      .btn-warning {
        border: 1px solid rgba(30, 77, 72, 0.16);
        border-radius: 999px;
        padding: 7px 12px;
        font-size: 13px;
        background: rgba(251, 191, 36, 0.20);
        color: var(--text);
        cursor: pointer;
        transition: transform 0.12s ease-out, box-shadow 0.12s ease-out;
      }

      .btn-warning:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 28px rgba(251, 191, 36, 0.35);
      }

      .pos-main {
        grid-template-columns: auto minmax(0, 1fr) minmax(0, 360px);
        align-items: stretch;
      }

      @media (max-width: 980px) {
        .pos-main {
          grid-template-columns: auto minmax(0, 1fr);
        }
        .pos-cart-panel {
          grid-column: 1 / -1;
        }
      }

      .pos-sidebar {
        width: clamp(150px, 18vw, 210px);
        min-width: 150px;
        max-width: 210px;
        align-self: start;
        border-radius: var(--radius-lg);
        padding: 18px 14px;
        background: var(--sidebar);
        color: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 24px 50px rgba(0, 0, 0, 0.28);
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .pos-sidebar-brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .pos-sidebar-title {
        font-weight: 800;
        letter-spacing: 0.02em;
        line-height: 1.05;
      }

      .pos-sidebar-sub {
        font-size: 12px;
        opacity: 0.9;
        margin-top: 2px;
      }

      .pos-sidebar-block {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .pos-sidebar-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .pos-sidebar-pill {
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 700;
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.92);
        cursor: pointer;
        text-align: start;
        white-space: normal;
        word-break: break-word;
        transition: transform 0.16s ease-out, box-shadow 0.16s ease-out;
      }

      .pos-sidebar-pill:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.22);
      }

      .pos-sidebar-pill.active {
        background: var(--accent);
        border-color: transparent;
        box-shadow: 0 16px 34px rgba(249, 115, 22, 0.42);
      }

      .pos-sidebar-muted {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.78);
      }

      .pos-category-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 18px;
      }

      @media (max-width: 900px) {
        .pos-category-grid {
          grid-template-columns: 1fr;
        }
      }

      .pos-category-card {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(255, 255, 255, 0.68);
        background: rgba(255, 255, 255, 0.96);
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.22);
        cursor: pointer;
        padding: 22px 18px;
        min-height: 190px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 16px;
        transition: transform 160ms ease, box-shadow 160ms ease;
      }

      .pos-category-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 34px 80px rgba(0, 0, 0, 0.28);
      }

      .pos-category-icon {
        width: 86px;
        height: 86px;
        border-radius: 18px;
        background: rgba(251, 191, 36, 0.25);
        display: grid;
        place-items: center;
      }

      .pos-category-label {
        font-size: 18px;
        font-weight: 800;
        color: var(--text);
        text-align: center;
        line-height: 1.15;
      }

      .pos-top-alert {
        grid-column: 1 / -1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 16px;
        border: 1px solid rgba(249, 115, 22, 0.30);
        background: linear-gradient(145deg, rgba(255,247,237,0.98), rgba(255,237,213,0.78));
        box-shadow: 0 18px 40px rgba(15,23,42,0.14);
        cursor: pointer;
        color: #7c2d12;
        font-weight: 800;
        text-align: start;
      }

      .pos-top-alert:hover {
        box-shadow: 0 22px 52px rgba(15,23,42,0.20);
        transform: translateY(-1px);
      }

      .pos-cart-panel {
        display: flex;
        flex-direction: column;
      }

      .panel.pos-cart-panel {
        padding: 14px 14px 16px;
      }

      .pos-cart-empty {
        margin: 6px 0 2px;
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(148, 163, 184, 0.10);
        color: #6b7280;
        font-size: 13px;
        text-align: center;
      }

      .pos-cart-footer {
        margin-top: auto;
      }

      .admin-main {
        grid-template-columns: auto minmax(0, 1fr);
        align-items: stretch;
      }

      .admin-sidebar {
        width: max-content;
        min-width: 210px;
        max-width: 260px;
        align-self: start;
        border-radius: var(--radius-lg);
        padding: 18px 14px;
        background: var(--sidebar);
        color: rgba(255, 255, 255, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 24px 50px rgba(0, 0, 0, 0.28);
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .admin-nav {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .admin-nav-item {
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        padding: 10px 14px;
        font-size: 13px;
        font-weight: 700;
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.92);
        cursor: pointer;
        text-align: left;
        transition: transform 0.16s ease-out, box-shadow 0.16s ease-out;
      }

      .admin-nav-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.22);
      }

      .admin-nav-item.active {
        background: var(--accent);
        border-color: transparent;
        box-shadow: 0 16px 34px rgba(249, 115, 22, 0.42);
      }

      .admin-dashboard-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 18px;
      }

      @media (max-width: 1100px) {
        .admin-dashboard-grid {
          grid-template-columns: 1fr;
        }
      }

      .admin-kpi-card {
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.96);
        border: 1px solid rgba(255, 255, 255, 0.68);
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.20);
        padding: 18px;
      }

      .admin-kpi-card.hero {
        padding: 22px;
        border: 1px solid rgba(255, 255, 255, 0.22);
        box-shadow: 0 26px 70px rgba(0, 0, 0, 0.28);
      }

      .admin-kpi-card.hero .admin-kpi-title {
        color: rgba(255, 255, 255, 0.92);
      }

      .admin-kpi-card.hero .admin-kpi-value {
        color: rgba(255, 255, 255, 0.98);
        font-size: 34px;
      }

      .admin-kpi-card.hero-start {
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.92), rgba(14, 165, 233, 0.88));
      }

      .admin-kpi-card.hero-paid {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.92), rgba(34, 197, 94, 0.86));
      }

      .admin-kpi-card.hero-expected {
        background: linear-gradient(135deg, rgba(249, 115, 22, 0.94), rgba(245, 158, 11, 0.88));
      }

      .admin-kpi-title {
        font-size: 13px;
        color: #6b7280;
        font-weight: 700;
      }

      .admin-kpi-value {
        margin-top: 10px;
        font-size: 30px;
        font-weight: 900;
        color: var(--text);
      }

      .admin-kpi-sub {
        margin-top: 10px;
        font-size: 12px;
        color: #16a34a;
        font-weight: 700;
      }

      .admin-chart {
        margin-top: 18px;
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.96);
        border: 1px solid rgba(255, 255, 255, 0.68);
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.20);
        padding: 18px;
        min-height: 360px;
        display: flex;
        flex-direction: column;
      }

      .admin-chart-bars {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 10px;
        align-items: end;
        padding-top: 26px;
      }

      .admin-bar {
        border-radius: 16px 16px 0 0;
        background: rgba(134, 239, 172, 0.85);
        min-height: 22px;
      }

      .admin-bar.today {
        background: rgba(249, 115, 22, 0.95);
      }

      @media (max-width: 600px) {
        header {
          padding: calc(12px + env(safe-area-inset-top)) 12px 12px;
          flex-wrap: wrap;
          gap: 10px;
        }
        main {
          padding: 12px;
          gap: 12px;
        }

        .brand-logo {
          width: 36px;
          height: 36px;
        }

        .products-grid {
          grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
          gap: 10px;
        }
        .product-image {
          height: 110px;
        }

        .pos-main {
          grid-template-columns: 1fr;
        }
        .pos-sidebar {
          width: auto;
          min-width: 0;
          max-width: none;
          padding: 12px;
          gap: 10px;
        }
        .pos-sidebar-actions {
          flex-direction: row;
          flex-wrap: wrap;
          gap: 8px;
        }
        .pos-sidebar-pill {
          text-align: center;
        }

        .admin-main {
          grid-template-columns: 1fr;
        }
        .admin-sidebar {
          width: auto;
          min-width: 0;
          max-width: none;
          padding: 12px;
        }
        .admin-nav {
          flex-direction: row;
          flex-wrap: wrap;
        }
        .admin-nav-item {
          text-align: center;
        }

        input,
        select,
        textarea {
          font-size: 16px !important;
        }
      }
    </style>
  </head>
  <body>
    
    <script>
      (function () {
        if (window.__errorOverlayInstalled__) return;
        window.__errorOverlayInstalled__ = true;
        window.__CAFE_HALAB_BUILD__ = "2025-12-27-admin-fix-1";
        function show(msg) {
          try {
            var el = document.getElementById('pwa-error-overlay');
            if (!el) {
              el = document.createElement('pre');
              el.id = 'pwa-error-overlay';
              el.style.position = 'fixed';
              el.style.left = '0';
              el.style.top = '0';
              el.style.right = '0';
              el.style.maxHeight = '50vh';
              el.style.overflow = 'auto';
              el.style.zIndex = '999999';
              el.style.margin = '0';
              el.style.padding = '10px';
              el.style.background = 'rgba(0,0,0,0.85)';
              el.style.color = '#fff';
              el.style.fontSize = '12px';
              el.style.whiteSpace = 'pre-wrap';
              document.body.appendChild(el);
            }
            var header = '';
            try {
              header =
                'Build: ' +
                (window.__CAFE_HALAB_BUILD__ || '') +
                '\nURL: ' +
                (window.location && window.location.href ? window.location.href : '') +
                '\n\n';
            } catch (e) {}
            el.textContent = header + msg;
          } catch (e) {}
        }
        window.addEventListener('error', function (e) {
          var message = (e && e.message) ? e.message : (e && e.error && e.error.message ? e.error.message : '');
          var msg = 'JS Error: ' + message + '\n' + (e && e.filename ? e.filename : '') + ':' + (e && e.lineno ? e.lineno : '') + ':' + (e && e.colno ? e.colno : '');
          if (e && e.error && e.error.stack) msg += '\n' + e.error.stack;
          show(msg);
        });
        window.addEventListener('unhandledrejection', function (e) {
          var reason = e && e.reason ? e.reason : e;
          var msg = 'Unhandled Promise Rejection: ' + (reason && reason.message ? reason.message : String(reason));
          if (reason && reason.stack) msg += '\n' + reason.stack;
          show(msg);
        });
      })();
    </script><div id="root"></div>

    <!-- React from CDNs (global React / ReactDOM) -->
    <script crossorigin="anonymous" src="https://unpkg.com/react@18/umd/react.production.min.js" onerror="var s=document.createElement('script');s.crossOrigin='anonymous';s.src='https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js';document.head.appendChild(s);"></script>
    <script crossorigin="anonymous" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" onerror="var s=document.createElement('script');s.crossOrigin='anonymous';s.src='https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js';document.head.appendChild(s);"></script>

    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
    <script crossorigin="anonymous" src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAcMZVPiMQKNqb2rcrV1WqmixIo1xFK2CE",
        authDomain: "cafe-halab.firebaseapp.com",
        projectId: "cafe-halab",
        storageBucket: "cafe-halab.firebasestorage.app",
        messagingSenderId: "915112396018",
        appId: "1:915112396018:web:4aa8dbadbc6651c3f6bc6b"
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      window.firebaseAuth = auth;
      window.firebaseDb = db;

      db.enablePersistence().catch(() => {});
    </script>

    <!-- Inline POS App (no modules, works via file://) -->
    <script>
      const e = React.createElement;

      const INITIAL_MENU_DATA = [
        {
          id: "omelette_cheese",
          name: "Omelette with Cheese",
          nameFr: "Omelette au Fromage",
          nameAr: "أومليت بالجبن",
          price: 26.0,
          category: "Breakfast",
          image: "Omelette au Fromage.jpg",
          modifiers: []
        },
        {
          id: "omelette_turkey",
          name: "Omelette with Turkey",
          nameFr: "Omelette à la Dinde Fumée",
          nameAr: "أومليت بالديك الرومي المدخن",
          price: 28.0,
          category: "Breakfast",
          image: "Omelette à la Dinde Fumée.jpg",
          modifiers: []
        },
        {
          id: "omelette_kashir",
          name: "Omelette with Kashir",
          nameFr: "Omelette au Kashir",
          nameAr: "أومليت بالكاشير",
          price: 24.0,
          category: "Breakfast",
          image: "Omelette au Kashir.jpg",
          modifiers: []
        },
        {
          id: "breakfast_marrakchi",
          name: "Marrakchi Breakfast",
          nameFr: "Petit Déjeuner Marrakchi",
          nameAr: "فطور مراكشي",
          price: 26.0,
          category: "Breakfast",
          image: "Petit Déjeuner Marrakchi.jpg",
          modifiers: []
        },
        {
          id: "breakfast_catalan",
          name: "Catalan Breakfast",
          nameFr: "Petit Déjeuner Catalan",
          nameAr: "فطور كاتالان",
          price: 29.0,
          category: "Breakfast",
          image: "Petit Déjeuner Catalan.jpg",
          modifiers: []
        },
        {
          id: "fried_eggs",
          name: "Fried Eggs (Mirror)",
          nameFr: "Œufs au plat miroir",
          nameAr: "فطور بيض عوينات",
          price: 22.0,
          category: "Breakfast",
          image: "Œufs au plat miroir.jpg",
          modifiers: []
        },
        {
          id: "croissant_breakfast",
          name: "Croissant Breakfast",
          nameFr: "Petit-déjeuner au croissant",
          nameAr: "فطور كرواسون",
          price: 20.0,
          category: "Breakfast",
          image: "Petit-déjeuner au croissant.jpg",
          modifiers: []
        },
        {
          id: "breakfast_special_set",
          name: "Special Breakfast Set",
          nameFr: "Petit déjeuner spécial",
          nameAr: "فطور خاص",
          price: 0.0,
          category: "Breakfast",
          image: "petit déjeuner spécial.png",
          modifiers: []
        },

        {
          id: "coffee",
          name: "Coffee",
          nameFr: "Café",
          nameAr: "قهوة",
          price: 11.0,
          category: "Hot Drinks",
          image: "Café.jpg",
          modifiers: []
        },
        {
          id: "coffee_with_milk",
          name: "Coffee with Milk",
          nameFr: "Café au lait",
          nameAr: "قهوة بالحليب",
          price: 11.0,
          category: "Hot Drinks",
          image: "Café au lait.jpg",
          modifiers: []
        },
        {
          id: "machada",
          name: "Machada",
          nameFr: "Machada",
          nameAr: "ماشادا",
          price: 11.0,
          category: "Hot Drinks",
          image: "Machada.jpg",
          modifiers: []
        },
        {
          id: "nescafe",
          name: "NESCAFE",
          nameFr: "NESCAFÉ",
          nameAr: "نسكافيه",
          price: 11.0,
          category: "Hot Drinks",
          image: "NESCAFÉ.jpg",
          modifiers: []
        },
        {
          id: "tea_lipton",
          name: "Lipton Tea",
          nameFr: "Thé Lipton",
          nameAr: "شاي ليبتون",
          price: 11.0,
          category: "Hot Drinks",
          image: "Thé Lipton.jpg",
          modifiers: []
        },
        {
          id: "tea_mint",
          name: "Mint Tea",
          nameFr: "Thé à la Menthe",
          nameAr: "شاي بالنعناع",
          price: 7.0,
          category: "Hot Drinks",
          image: "Thé à la Menthe.jpg",
          modifiers: []
        },
        {
          id: "tea_berrad",
          name: "Berrad Tea (Teapot)",
          nameFr: "Thé Berrad",
          nameAr: "براد شاي",
          price: 9.0,
          category: "Hot Drinks",
          image: "Thé Berrad.jpg",
          modifiers: []
        },

        {
          id: "juice_orange",
          name: "Orange Juice",
          nameFr: "Jus d'orange",
          nameAr: "عصير البرتقال",
          price: 17.0,
          category: "Cold Drinks",
          image: "Jus d'orange.jpg",
          modifiers: []
        },
        {
          id: "juice_apple",
          name: "Apple Juice",
          nameFr: "Jus de pomme",
          nameAr: "عصير التفاح",
          price: 20.0,
          category: "Cold Drinks",
          image: "jus de pomme.jpg",
          modifiers: []
        },
        {
          id: "juice_lemon",
          name: "Lemon Juice",
          nameFr: "Jus de citron",
          nameAr: "عصير الليمون",
          price: 20.0,
          category: "Cold Drinks",
          image: "jus de citron .jpg",
          modifiers: []
        },
        {
          id: "juice_banana",
          name: "Banana Juice",
          nameFr: "Jus de banane",
          nameAr: "عصير الموز",
          price: 20.0,
          category: "Cold Drinks",
          image: "Jus de banane.jpg",
          modifiers: []
        },
        {
          id: "juice_avocado",
          name: "Avocado Juice",
          nameFr: "Jus d'avocat",
          nameAr: "عصير الأفوكادو",
          price: 27.0,
          category: "Cold Drinks",
          image: "Jus d'avocat.jpg",
          modifiers: []
        },

        // Sodas
        {
          id: "soda_cocacola",
          name: "Coca-Cola",
          nameFr: "Coca-Cola",
          nameAr: "كوكا كولا",
          price: 12.0,
          category: "Cold Drinks",
          image: "Coca-Cola.jpg",
          modifiers: []
        },
        {
          id: "soda_hawai",
          name: "Hawai",
          nameFr: "Hawai",
          nameAr: "هاواي",
          price: 12.0,
          category: "Cold Drinks",
          image: "Hawai.jpg",
          modifiers: []
        },
        {
          id: "soda_poms",
          name: "Poms",
          nameFr: "Poms",
          nameAr: "بومس",
          price: 12.0,
          category: "Cold Drinks",
          image: "Poms.jpg",
          modifiers: []
        },
        {
          id: "soda_sprite",
          name: "Sprite",
          nameFr: "Sprite",
          nameAr: "سبرايت",
          price: 12.0,
          category: "Cold Drinks",
          image: "Sprite.jpg",
          modifiers: []
        },
        {
          id: "soda_schweppes_citron",
          name: "Schweppes Citron",
          nameFr: "Schweppes Citron",
          nameAr: "شويبس ليمون",
          price: 12.0,
          category: "Cold Drinks",
          image: "Schweppes Citron.jpg",
          modifiers: []
        },
        {
          id: "soda_schweppes_tonic",
          name: "Schweppes Tonic",
          nameFr: "Schweppes Tonic",
          nameAr: "شويبس تونيك",
          price: 12.0,
          category: "Cold Drinks",
          image: "Schweppes Tonic.jpg",
          modifiers: []
        },
        {
          id: "soda_schweppes_mojito",
          name: "Schweppes Mojito",
          nameFr: "Schweppes Mojito",
          nameAr: "شويبس موهيتو",
          price: 14.0,
          category: "Cold Drinks",
          image: "Schweppes Mojito.jpg",
          modifiers: []
        },
        {
          id: "water_oulmes_regular",
          name: "Oulmès",
          nameFr: "Oulmès",
          nameAr: "أولماس",
          price: 10.0,
          category: "Cold Drinks",
          image: "Oulmès.jpg",
          modifiers: []
        },
        {
          id: "water_oulmes_yellow",
          name: "Oulmès Aromé",
          nameFr: "Oulmès Aromé",
          nameAr: "أولماس أصفر",
          price: 10.0,
          category: "Cold Drinks",
          image: "Oulmès Aromé.jpg",
          modifiers: []
        },

        // Others / Autres
        {
          id: "other_muffin",
          name: "Muffin",
          nameFr: "Muffin",
          nameAr: "مفن",
          price: 3.0,
          category: "Others",
          image: "Muffen.jpg",
          modifiers: []
        },
        {
          id: "other_raib",
          name: "Raib",
          nameFr: "Raib",
          nameAr: "رايب",
          price: 9.0,
          category: "Others",
          image: "raib.jpg",
          modifiers: []
        },
        {
          id: "other_flan",
          name: "Flan",
          nameFr: "Flan",
          nameAr: "فلان",
          price: 8.0,
          category: "Others",
          image: "flan.jpg",
          modifiers: []
        },
        {
          id: "other_water",
          name: "Water",
          nameFr: "Eau",
          nameAr: "ماء",
          price: 3.0,
          category: "Others",
          image: "Eau.jpg",
          modifiers: []
        }
      ];

      const INITIAL_MENU_BY_ID = (() => {
        const m = {};
        for (let i = 0; i < INITIAL_MENU_DATA.length; i++) {
          const it = INITIAL_MENU_DATA[i];
          if (it && it.id) m[it.id] = it;
        }
        return m;
      })();

      function migrateMenuArray(arr) {
        if (!Array.isArray(arr) || !arr.length) return arr;
        let changed = false;
        const next = arr.map((item) => {
          const id = item && item.id;
          const base = id ? INITIAL_MENU_BY_ID[id] : null;
          if (!base || !item || typeof item !== "object") return item;
          let patch = null;
          if ((!item.image || item.image === "") && base.image) {
            patch = patch || {};
            patch.image = base.image;
          }
          if (id === "breakfast_special_set") {
            if (base.image && item.image !== base.image) {
              patch = patch || {};
              patch.image = base.image;
            }
          }
          if (id === "water_oulmes_yellow") {
            if (item.name !== base.name) {
              patch = patch || {};
              patch.name = base.name;
            }
            if (item.nameFr !== base.nameFr) {
              patch = patch || {};
              patch.nameFr = base.nameFr;
            }
            if (item.nameAr !== base.nameAr) {
              patch = patch || {};
              patch.nameAr = base.nameAr;
            }
            if (base.image && item.image !== base.image) {
              patch = patch || {};
              patch.image = base.image;
            }
          }
          if (!patch) return item;
          changed = true;
          return Object.assign({}, item, patch);
        });
        try {
          const have = new Set(next.map((x) => (x && x.id ? x.id : null)).filter(Boolean));
          for (let i = 0; i < INITIAL_MENU_DATA.length; i++) {
            const base = INITIAL_MENU_DATA[i];
            if (!base || !base.id) continue;
            if (have.has(base.id)) continue;
            next.push(base);
            have.add(base.id);
            changed = true;
          }
        } catch (e) {}
        if (!changed) return arr;
        try {
          window.localStorage.setItem("cafe_halab_menu", JSON.stringify(next));
        } catch (e) {}
        return next;
      }

      function resolveImageSrc(src) {
        const s = String(src == null ? "" : src).trim();
        if (!s) return "";
        if (/^data:image\//i.test(s)) return s;
        if (/^https?:\/\//i.test(s)) return s;
        if (s.startsWith("./") || s.startsWith("../")) return encodeURI(s);
        if (s.startsWith("/")) return encodeURI(s);
        return encodeURI("./" + s);
      }

      const INITIAL_CATEGORIES = [
        "Favorites",
        "Breakfast",
        "Hot Drinks",
        "Cold Drinks",
        "Others"
      ];

      const USERS = [
        { id: "worker_med", name: "MED", role: "worker", pin: "1111" },
        { id: "worker_aya", name: "AYA", role: "worker", pin: "2222" },
        { id: "manager_halab", name: "Manager", role: "manager", pin: "4444" },
        { id: "admin_nouri", name: "Nouri", role: "admin", pin: "3333" }
      ];

      function ensureDefaultUsers(list) {
        const arr = Array.isArray(list) ? list.slice() : [];
        const byId = {};
        for (let i = 0; i < arr.length; i++) {
          const u = arr[i];
          if (!u || !u.id) continue;
          byId[String(u.id)] = { u, i };
        }

        let changed = false;
        for (let i = 0; i < (USERS || []).length; i++) {
          const base = USERS[i];
          if (!base || !base.id) continue;
          const id = String(base.id);
          const hit = byId[id] || null;
          if (!hit) {
            arr.push({ ...base });
            changed = true;
            continue;
          }

          const cur = hit.u;
          let patch = null;
          const isCore = id === "manager_halab" || id === "admin_nouri";
          if (isCore && base.role && cur.role !== base.role) {
            patch = patch || {};
            patch.role = base.role;
          }
          const pin = cur && cur.pin != null ? String(cur.pin) : "";
          if (isCore && (!pin || !pin.trim()) && base.pin) {
            patch = patch || {};
            patch.pin = base.pin;
          }
          const nm = cur && cur.name != null ? String(cur.name) : "";
          if ((!nm || !nm.trim()) && base.name) {
            patch = patch || {};
            patch.name = base.name;
          }

          if (patch) {
            arr[hit.i] = { ...cur, ...patch };
            changed = true;
          }
        }

        return changed ? arr : list;
      }

      const INVENTORY_AR_MAP = {
        coffee_beans: "قهوة (حبوب)",
        milk: "حليب",
        tea_leaves: "شاي (سائب)",
        sugar_powder: "سكر (بودرة)",
        sugar_cubes: "سكر (قطع)",
        eggs: "بيض",
        cheese: "جبن",
        turkey_smoked: "ديك رومي مدخن",
        kashir: "كاشير",
        oranges: "برتقال",
        apples: "تفاح",
        lemons: "ليمون",
        bananas: "موز",
        avocados: "أفوكادو",
        soda_cocacola: "كوكاكولا",
        soda_hawai: "هاواي",
        soda_poms: "بومس",
        soda_sprite: "سبرايت",
        soda_schweppes_citron: "شويبس ليمون",
        soda_schweppes_tonic: "شويبس تونيك",
        soda_schweppes_mojito: "شويبس موهيتو",
        water_oulmes_regular: "أولمس",
        water_oulmes_yellow: "أولمس صفراء",
        water_bottle_small: "قنينة ماء صغيرة",
        water_bottle_half: "قنينة ماء نصف لتر",
        muffin: "مافن",
        raib: "رايب",
        flan: "فلان",
        cup_disposable_small: "كأس بلاستيك صغير",
        cup_disposable_large: "كأس بلاستيك كبير",
        cup_glass_small: "كأس زجاج صغير",
        cup_glass_large: "كأس زجاج كبير"
      };

      const INVENTORY_INITIAL = {
        coffee_beans: {
          id: "coffee_beans",
          name: "Café (grains)",
          unit: "kg",
          currentQty: 5.0,
          minQty: 1.0
        },
        milk: {
          id: "milk",
          name: "Lait",
          unit: "L",
          currentQty: 8.0,
          minQty: 2.0
        },
        tea_leaves: {
          id: "tea_leaves",
          name: "Thé (en vrac)",
          unit: "kg",
          currentQty: 2.0,
          minQty: 0.5
        },
        sugar_powder: {
          id: "sugar_powder",
          name: "Sucre (poudre)",
          unit: "kg",
          currentQty: 4.0,
          minQty: 1.0
        },
        sugar_cubes: {
          id: "sugar_cubes",
          name: "Sucre (morceaux)",
          unit: "kg",
          currentQty: 3.0,
          minQty: 1.0
        },
        eggs: {
          id: "eggs",
          name: "Œufs",
          unit: "pcs",
          currentQty: 120,
          minQty: 24
        },
        cheese: {
          id: "cheese",
          name: "Fromage",
          unit: "kg",
          currentQty: 2.0,
          minQty: 0.5
        },
        turkey_smoked: {
          id: "turkey_smoked",
          name: "Dinde fumée",
          unit: "kg",
          currentQty: 2.0,
          minQty: 0.5
        },
        kashir: {
          id: "kashir",
          name: "Kashir",
          unit: "kg",
          currentQty: 2.0,
          minQty: 0.5
        },
        oranges: {
          id: "oranges",
          name: "Oranges",
          unit: "pcs",
          currentQty: 80,
          minQty: 20
        },
        apples: {
          id: "apples",
          name: "Pommes",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        },
        lemons: {
          id: "lemons",
          name: "Citrons",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        },
        bananas: {
          id: "bananas",
          name: "Bananes",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        },
        avocados: {
          id: "avocados",
          name: "Avocats",
          unit: "pcs",
          currentQty: 40,
          minQty: 10
        },

        soda_cocacola: {
          id: "soda_cocacola",
          name: "Coca-Cola",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_hawai: {
          id: "soda_hawai",
          name: "Hawai",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_poms: {
          id: "soda_poms",
          name: "Poms",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_sprite: {
          id: "soda_sprite",
          name: "Sprite",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_schweppes_citron: {
          id: "soda_schweppes_citron",
          name: "Schweppes Citron",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_schweppes_tonic: {
          id: "soda_schweppes_tonic",
          name: "Schweppes Tonic",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        soda_schweppes_mojito: {
          id: "soda_schweppes_mojito",
          name: "Schweppes Mojito",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        water_oulmes_regular: {
          id: "water_oulmes_regular",
          name: "Oulmès",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },
        water_oulmes_yellow: {
          id: "water_oulmes_yellow",
          name: "Oulmès Aromé",
          unit: "pcs",
          currentQty: 48,
          minQty: 12
        },

        water_bottle_small: {
          id: "water_bottle_small",
          name: "Eau (petite bouteille)",
          unit: "pcs",
          packSize: 12,
          currentQty: 0,
          minQty: 12
        },
        water_bottle_half: {
          id: "water_bottle_half",
          name: "Eau (1/2L)",
          unit: "pcs",
          packSize: 12,
          currentQty: 0,
          minQty: 12
        },

        cup_disposable_small: {
          id: "cup_disposable_small",
          name: "Gobelet jetable (petit)",
          unit: "pcs",
          currentQty: 0,
          minQty: 50
        },
        cup_disposable_large: {
          id: "cup_disposable_large",
          name: "Gobelet jetable (grand)",
          unit: "pcs",
          currentQty: 0,
          minQty: 50
        },
        cup_glass_small: {
          id: "cup_glass_small",
          name: "Verre (petit)",
          unit: "pcs",
          currentQty: 0,
          minQty: 10
        },
        cup_glass_large: {
          id: "cup_glass_large",
          name: "Verre (grand)",
          unit: "pcs",
          currentQty: 0,
          minQty: 10
        },

        muffin: {
          id: "muffin",
          name: "Muffin",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        },
        raib: {
          id: "raib",
          name: "Raib",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        },
        flan: {
          id: "flan",
          name: "Flan",
          unit: "pcs",
          currentQty: 60,
          minQty: 15
        }
      };

      const MENU_RECIPES = {
        omelette_cheese: { eggs: 2, cheese: 0.036 },
        omelette_turkey: { eggs: 2, turkey_smoked: 0.04 },
        omelette_kashir: { eggs: 2, kashir: 0.04 },
        breakfast_marrakchi: { eggs: 2 },
        breakfast_catalan: { eggs: 2 },
        croissant_breakfast: { eggs: 2 },
        fried_eggs: { eggs: 2 },

        coffee: { coffee_beans: 0.01 },
        coffee_with_milk: { coffee_beans: 0.01, milk: 0.18 },
        machada: { coffee_beans: 0.01 },
        nescafe: { coffee_beans: 0.01 },
        tea_lipton: { tea_leaves: 0.006 },
        tea_mint: { tea_leaves: 0.006 },
        tea_berrad: { tea_leaves: 0.012 },

        juice_orange: { oranges: 3 },
        juice_apple: { apples: 2 },
        juice_lemon: { lemons: 3 },
        juice_banana: { bananas: 2, milk: 0.2 },
        juice_avocado: { avocados: 1, milk: 0.25 },

        soda_cocacola: { soda_cocacola: 1 },
        soda_hawai: { soda_hawai: 1 },
        soda_poms: { soda_poms: 1 },
        soda_sprite: { soda_sprite: 1 },
        soda_schweppes_citron: { soda_schweppes_citron: 1 },
        soda_schweppes_tonic: { soda_schweppes_tonic: 1 },
        soda_schweppes_mojito: { soda_schweppes_mojito: 1 },
        water_oulmes_regular: { water_oulmes_regular: 1 },
        water_oulmes_yellow: { water_oulmes_yellow: 1 },

        other_muffin: { muffin: 1 },
        other_raib: { raib: 1 },
        other_flan: { flan: 1 }
      };

      function buildShiftId(dateStr, period) {
        return dateStr + "_" + period;
      }

      function parseCash(v) {
        const n = Number(String(v == null ? "" : v).replace(",", "."));
        return Number.isFinite(n) ? n : null;
      }

      function isoToYmd(iso) {
        return String(iso || "").slice(0, 10);
      }

      function parseYmdParts(v) {
        const m = /^\s*(\d{4})-(\d{2})-(\d{2})\s*$/.exec(String(v || ""));
        if (!m) return null;
        const y = Number(m[1]);
        const mo = Number(m[2]);
        const d = Number(m[3]);
        if (!Number.isFinite(y) || !Number.isFinite(mo) || !Number.isFinite(d)) return null;
        return { y, mo, d };
      }

      function ymdFromParts(y, mo, d) {
        return String(y).padStart(4, "0") + "-" + pad2(mo) + "-" + pad2(d);
      }

      function daysInMonthUTC(y, mo) {
        return new Date(Date.UTC(y, mo, 0)).getUTCDate();
      }

      function addMonthsUTC(y, mo, deltaMonths) {
        let yy = y;
        let mm = mo + deltaMonths;
        while (mm > 12) {
          mm -= 12;
          yy += 1;
        }
        while (mm < 1) {
          mm += 12;
          yy -= 1;
        }
        return { y: yy, mo: mm };
      }

      function salaryPeriodRangeForUser(user, atIso) {
        const atYmd = isoToYmd(atIso) || new Date().toISOString().slice(0, 10);
        const atParts = parseYmdParts(atYmd);
        if (!atParts) {
          const now = new Date();
          const cur = { y: now.getUTCFullYear(), mo: now.getUTCMonth() + 1, d: now.getUTCDate() };
          return { from: ymdFromParts(cur.y, cur.mo, 1), to: ymdFromParts(cur.y, cur.mo, daysInMonthUTC(cur.y, cur.mo)), anchorDay: 1 };
        }

        const startParts = parseYmdParts(user && user.cycleStartDate ? user.cycleStartDate : null);
        const anchorDay = startParts && startParts.d ? startParts.d : 1;

        function clampDay(y, mo) {
          return Math.min(anchorDay, daysInMonthUTC(y, mo));
        }

        const clampedThis = clampDay(atParts.y, atParts.mo);
        let from;
        if (atParts.d >= clampedThis) {
          from = ymdFromParts(atParts.y, atParts.mo, clampedThis);
        } else {
          const prev = addMonthsUTC(atParts.y, atParts.mo, -1);
          from = ymdFromParts(prev.y, prev.mo, clampDay(prev.y, prev.mo));
        }

        const fromParts = parseYmdParts(from);
        const next = addMonthsUTC(fromParts.y, fromParts.mo, 1);
        const nextFrom = ymdFromParts(next.y, next.mo, clampDay(next.y, next.mo));
        const nextParts = parseYmdParts(nextFrom);
        const nextDate = new Date(Date.UTC(nextParts.y, nextParts.mo - 1, nextParts.d));
        nextDate.setUTCDate(nextDate.getUTCDate() - 1);
        const to = isoToYmd(nextDate.toISOString());

        return { from, to, anchorDay };
      }

      function previousShiftKeyFor(dateStr, period) {
        const prevPeriod = period === "morning" ? "afternoon" : "morning";
        if (period === "afternoon") return buildShiftId(dateStr, prevPeriod);
        const y = addLocalDaysYmd(dateStr, -1);
        return buildShiftId(y, prevPeriod);
      }

      function shiftTimeMs(s) {
        try {
          if (!s) return 0;
          const iso =
            s.openedAt ||
            s.closedAt ||
            (s.date ? String(s.date) + "T00:00:00" : "");
          const ms = new Date(iso).getTime();
          return Number.isFinite(ms) ? ms : 0;
        } catch (e) {
          return 0;
        }
      }

      function localYmd(date) {
        try {
          const d = date || new Date();
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, "0");
          const dd = String(d.getDate()).padStart(2, "0");
          return String(y).padStart(4, "0") + "-" + m + "-" + dd;
        } catch (e) {
          return new Date().toISOString().slice(0, 10);
        }
      }

      function addLocalDaysYmd(ymd, deltaDays) {
        try {
          const d = new Date(String(ymd || "") + "T12:00:00");
          d.setDate(d.getDate() + (Number(deltaDays || 0) || 0));
          return localYmd(d);
        } catch (e) {
          return localYmd(new Date());
        }
      }

      function autoShiftContextNow() {
        const now = new Date();
        const mins = now.getHours() * 60 + now.getMinutes();
        const morningStart = 6 * 60 + 30;
        const afternoonStart = 14 * 60;

        if (mins >= morningStart && mins < afternoonStart) {
          return { dateStr: localYmd(now), period: "morning" };
        }

        if (mins < morningStart) {
          const todayYmd = localYmd(now);
          return { dateStr: addLocalDaysYmd(todayYmd, -1), period: "afternoon" };
        }

        return { dateStr: localYmd(now), period: "afternoon" };
      }

      function findMostRecentClosedShiftWithFloat(shifts, excludeShiftId) {
        const arr = (shifts || []).filter(
          (s) =>
            s &&
            s.id !== excludeShiftId &&
            typeof s.closingFloatCash === "number" &&
            Number.isFinite(s.closingFloatCash) &&
            (s.status === "closed" || s.closedAt || s.closingFloatSetAt)
        );
        if (!arr.length) return null;
        arr.sort((a, b) => shiftTimeMs(b) - shiftTimeMs(a));
        return arr[0] || null;
      }

      function ingredientLabel(ing, lang) {
        if (!ing) return "";
        const id = String(ing.id || "");
        if (lang === "ar") {
          return String(ing.nameAr || INVENTORY_AR_MAP[id] || ing.name || ing.nameFr || id || "");
        }
        return String(ing.nameFr || ing.name || ing.nameAr || id || "");
      }

      function pad2(n) {
        return String(n).padStart(2, "0");
      }

      function pad3(n) {
        return String(n).padStart(3, "0");
      }

      function periodToShiftCode(period) {
        if (period === "afternoon") return "02";
        if (period === "morning") return "01";
        if (period === "default") return "01";
        return "01";
      }

      function makeWaiterCode(name) {
        const base = String(name || "")
          .trim()
          .replace(/\s+/g, "")
          .toUpperCase();
        const letters = base.replace(/[^A-Z]/g, "");
        const code = (letters || base).slice(0, 3);
        return code.padEnd(3, "X");
      }

      function resolveShiftIdForDatePeriod(dateStr, period, shifts) {
        const preferred = buildShiftId(dateStr, period);
        const fallback = buildShiftId(dateStr, "default");
        const hasPreferred = (shifts || []).some((s) => s && s.id === preferred);
        const hasFallback = (shifts || []).some((s) => s && s.id === fallback);
        if (hasPreferred) return preferred;
        if (period === "morning" && hasFallback) return fallback;
        return preferred;
      }

      function isCoffee(item) {
        const ids = ["coffee", "coffee_with_milk", "nescafe", "machada"];
        return ids.includes(item.id);
      }

      function isSoda(item) {
        const id = item && item.id;
        return !!(id && String(id).indexOf("soda_") === 0);
      }

      function isWaterItem(item) {
        const id = item && item.id;
        if (!id) return false;
        if (id === "other_water") return true;
        return String(id).indexOf("water_") === 0;
      }

      function isHerbalTea(item) {
        const ids = ["tea_mint", "tea_berrad"];
        return item && ids.includes(item.id);
      }

      function herbValueLabel(value, t) {
        if (value === "mint") return (t && t.herbMint) || "Menthe";
        if (value === "absinthe") return (t && t.herbAbsinthe) || "Absinthe";
        if (value === "lemon") return (t && t.herbLemon) || "Feuilles de citron";
        return value || "";
      }

      function initCafeHalabFeedback() {
        if (window.__CAFE_HALAB_FEEDBACK__) return window.__CAFE_HALAB_FEEDBACK__;
        const STORAGE_KEY = "cafe_halab_feedback";
        const defaults = { sfx: true, haptics: true, volume: 0.14 };
        let settings = defaults;
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) settings = Object.assign({}, defaults, JSON.parse(raw));
        } catch (e) {}
        let ctx = null;
        let master = null;
        let noiseBuf = null;
        function save() {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
          } catch (e) {}
        }
        function ensureAudio() {
          if (!settings.sfx) return null;
          const AC = window.AudioContext || window.webkitAudioContext;
          if (!AC) return null;
          if (!ctx) {
            ctx = new AC();
            master = ctx.createGain();
            master.gain.value = settings.volume;
            master.connect(ctx.destination);
          }
          if (ctx.state === "suspended") {
            try {
              ctx.resume();
            } catch (e) {}
          }
          if (!noiseBuf) {
            try {
              const len = Math.max(1, Math.floor(ctx.sampleRate * 0.25));
              const b = ctx.createBuffer(1, len, ctx.sampleRate);
              const d = b.getChannelData(0);
              for (let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1) * 0.6;
              noiseBuf = b;
            } catch (e) {}
          }
          return ctx;
        }
        function vib(pattern) {
          if (!settings.haptics) return;
          try {
            if (navigator && navigator.vibrate) navigator.vibrate(pattern);
          } catch (e) {}
        }
        function playOscAt(t0, f0, f1, dur, type, amp) {
          const c = ensureAudio();
          if (!c || !master) return;
          try {
            const o = c.createOscillator();
            const g = c.createGain();
            o.type = type || "sine";
            o.frequency.setValueAtTime(Math.max(1, f0 || 440), t0);
            if (f1 && f1 > 0) o.frequency.exponentialRampToValueAtTime(f1, t0 + dur);
            g.gain.setValueAtTime(0.0001, t0);
            g.gain.exponentialRampToValueAtTime(Math.max(0.0001, amp || 0.3), t0 + 0.006);
            g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
            o.connect(g);
            g.connect(master);
            o.start(t0);
            o.stop(t0 + dur + 0.02);
          } catch (e) {}
        }
        function playNoiseAt(t0, dur, amp) {
          const c = ensureAudio();
          if (!c || !master || !noiseBuf) return;
          try {
            const s = c.createBufferSource();
            const g = c.createGain();
            s.buffer = noiseBuf;
            g.gain.setValueAtTime(0.0001, t0);
            g.gain.exponentialRampToValueAtTime(Math.max(0.0001, amp || 0.2), t0 + 0.01);
            g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
            s.connect(g);
            g.connect(master);
            s.start(t0);
            s.stop(t0 + dur + 0.02);
          } catch (e) {}
        }
        function inferKind(btn) {
          const cls = (btn && (btn.getAttribute("class") || "")) || "";
          const txt = ((btn && btn.textContent) || "").trim().toLowerCase();
          if (cls.indexOf("pin-backspace") >= 0) return "backspace";
          if (cls.indexOf("btn-danger") >= 0) return "danger";
          if (/(payer|pay|paid|encaisser|cash)/.test(txt)) return "pay";
          if (/(imprimer|print|ticket|reçu|recu|receipt)/.test(txt)) return "print";
          if (/(pause|resume|reprise|shift|service|clot|clôt|fermer)/.test(txt)) return "shift";
          if (/(ajouter|add|\+$)/.test(txt)) return "add";
          if (cls.indexOf("btn-success") >= 0) return "confirm";
          if (cls.indexOf("btn-warning") >= 0) return "warn";
          if (cls.indexOf("category-btn") >= 0) return "category";
          if (cls.indexOf("btn-primary") >= 0) return "primary";
          return "tap";
        }
        function play(kind) {
          const c = ensureAudio();
          const t = c ? c.currentTime + 0.0001 : 0;
          if (kind === "tap") {
            playOscAt(t, 1250, 800, 0.03, "square", 0.22);
            vib(8);
            return;
          }
          if (kind === "primary") {
            playOscAt(t, 980, 680, 0.035, "square", 0.24);
            vib(10);
            return;
          }
          if (kind === "category") {
            playOscAt(t, 760, 520, 0.045, "triangle", 0.22);
            vib(10);
            return;
          }
          if (kind === "add") {
            playOscAt(t, 1250, 800, 0.03, "square", 0.2);
            playOscAt(t + 0.05, 1450, 920, 0.03, "square", 0.2);
            vib([8, 20, 8]);
            return;
          }
          if (kind === "confirm") {
            playOscAt(t, 520, 820, 0.09, "sine", 0.32);
            vib(14);
            return;
          }
          if (kind === "backspace") {
            playOscAt(t, 420, 180, 0.065, "sawtooth", 0.28);
            vib([6, 14, 6]);
            return;
          }
          if (kind === "warn") {
            playOscAt(t, 420, 300, 0.1, "sawtooth", 0.26);
            vib([10, 20, 10]);
            return;
          }
          if (kind === "danger") {
            playOscAt(t, 180, 90, 0.13, "triangle", 0.42);
            vib(22);
            return;
          }
          if (kind === "shift") {
            playOscAt(t, 520, 520, 0.045, "sine", 0.22);
            playOscAt(t + 0.055, 330, 330, 0.055, "sine", 0.22);
            vib([8, 25, 8]);
            return;
          }
          if (kind === "pay") {
            playOscAt(t, 880, 1450, 0.14, "triangle", 0.45);
            playOscAt(t + 0.02, 1760, 2300, 0.11, "sine", 0.16);
            vib([12, 30, 12]);
            return;
          }
          if (kind === "print") {
            playNoiseAt(t, 0.05, 0.25);
            playNoiseAt(t + 0.06, 0.05, 0.25);
            playNoiseAt(t + 0.12, 0.05, 0.25);
            vib([6, 30, 6, 30, 6]);
            return;
          }
          playOscAt(t, 1250, 800, 0.03, "square", 0.22);
          vib(8);
        }
        const api = {
          play,
          getSettings: () => Object.assign({}, settings),
          setSettings: (patch) => {
            settings = Object.assign({}, settings, patch || {});
            if (master) master.gain.value = settings.volume;
            save();
          }
        };
        if (!window.__CAFE_HALAB_FEEDBACK_LISTENER__) {
          window.__CAFE_HALAB_FEEDBACK_LISTENER__ = true;
          document.addEventListener(
            "pointerdown",
            (ev) => {
              try {
                let el = ev && ev.target;
                while (el && el.nodeType === 1 && el.tagName !== "BUTTON") el = el.parentElement;
                const btn = el && el.tagName === "BUTTON" ? el : null;
                if (!btn) return;
                if (btn.disabled || btn.getAttribute("aria-disabled") === "true") return;
                api.play(inferKind(btn));
              } catch (e) {}
            },
            true
          );
        }
        window.__CAFE_HALAB_FEEDBACK__ = api;
        return api;
      }
      initCafeHalabFeedback();

const DICTIONARY = {
        fr: {
          appTitle: "Café Halab POS",
          uiSubtitle: "Aperçu UI · pas encore de backend",
          all: "Tout",
          catFavorites: "Favoris",
          catBreakfast: "Petit Déjeuner",
          catHot: "Boissons Chaudes",
          catCold: "Boissons Froides",
          catOthers: "Autres",
          posSlogan: "Pause marocaine, café d'exception.",
          currentOrder: "Commande en cours",
          cartEmpty: "Le panier est vide.",
          subtotal: "Sous-total",
          tax: "Taxe",
          total: "Total",
          mockPlaceOrder: "Simuler l'envoi de la commande",
          placingOrder: "Envoi en cours...",
          orderOk: "Commande enregistrée localement (console).",
          milkLabel: "Lait",
          milkYes: "Avec lait",
          milkNo: "Sans lait",
          sugarLabel: "Sucre",
          sugarNone: "Sans sucre",
          sugarLow: "Peu sucré",
          sugarMedium: "Moyen",
          sugarExtra: "Sucré",
          siropLabel: "Sirop",
          siropWith: "Avec",
          siropWithout: "Sans",
          waterLabel: "Eau 1/4L",
          waterWith: "Avec",
          waterWithout: "Sans",
          waterInLine: "eau",
          siropInLine: "sirop",
          waterSizeLabel: "Eau",
          waterQuarter: "1/4L",
          waterHalf: "1/2L",
          herbLabel: "Herbes",
          herbMint: "Menthe",
          herbAbsinthe: "Absinthe",
          herbLemon: "Feuilles de citron",
          drinkLabel: "Boisson chaude",
          drinkTea: "Thé",
          drinkCoffeeMilk: "Café au lait",
          milkInLine: "lait",
          sugarInLine: "sucre",
          herbInLine: "herbes",
          drinkInLine: "boisson",
          eggsInLine: "œufs",
          drinkInLine: "boisson",
          addLabel: "Ajouter",
          langFr: "FR",
          langAr: "AR",
          ordersInProgress: "Commandes en attente de paiement",
          noOrdersInProgress: "Aucune commande en attente.",
          markPaid: "Déclarer payé",
          debtsToCollectTitle: "Dettes à encaisser (shifts précédents)",
          markDebtPaid: "Déclarer dette payée",
          debtCustomerNameLabel: "Nom du client",
          debtCustomerNamePlaceholder: "Nom du client",
          declareDebtBtn: "Déclarer dette",
          shiftCloseBlockedTitle: "Shift: commandes non payées",
          shiftCloseBlockedSubtitle:
            "Vous devez déclarer chaque commande comme payée ou dette (avec nom du client) avant de fermer le shift.",
          closeShiftNowBtn: "Fermer le shift",
          cancelBtn: "Annuler",
          clientUnpaidDebtLabel: "Client unpaid debt",
          shiftOpenTitle: "Ouvrir un shift",
          shiftOpenSubtitle:
            "Saisir le code PIN du serveur pour démarrer son shift.",
          backToMenus: "Retour aux menus",
          openShiftBtn: "Ouvrir le shift",
          closeShiftBtn: "Fermer le shift",
          pauseShiftBtn: "Pause",
          resumeShiftBtn: "Reprendre",
          confirmPinBtn: "Confirmer",
          pinLabel: "PIN",
          confirmPauseTitle: "Confirmer la pause",
          confirmPauseSubtitle: "Saisir votre PIN pour mettre le shift en pause.",
          shiftPausedTitle: "Shift en pause",
          shiftPausedSubtitle: "Saisir le PIN du serveur pour reprendre.",
          autoPausedMessage: "Shift mis en pause automatiquement (inactivité).",
          pinIncorrect: "PIN incorrect",
          orderAddedPending: "Commande ajoutée aux commandes en attente.",
          shiftPausedBlocking: "Shift en pause. Reprenez pour continuer.",
          closeBtn: "Fermer",
          needWorkerLogin: "Ouvrez un shift (PIN serveur) avant de prendre une commande.",
          noShiftOpen: "Aucun shift ouvert.",
          shiftSummaryTitle: "Shift",
          shiftSummaryNone: "Aucun shift ouvert.",
          virtualTicketsTitle: "Tickets des commandes",
          paidOrdersTitle: "Commandes payées",
          unpaidOrdersTitle: "Commandes non payées",
          noPaidOrders: "Aucune commande payée.",
          noUnpaidOrders: "Aucune commande non payée.",
          orderLabel: "Commande",
          waiterLabel: "Serveur",
          createdAtLabel: "Créée",
          paidAtLabel: "Payée",
          statusPaid: "Payée",
          statusUnpaid: "Non payée",
          detailsBtn: "Détails",
          hideDetailsBtn: "Masquer",
          salesBtn: "Ventes",
          purchasesBtn: "Achats",
          purchaseTitle: "Achats (stock)",
          purchaseSelectIngredient: "Sélectionner un ingrédient",
          purchaseQtyLabel: "Quantité",
          purchaseUnitPriceLabel: "Prix unitaire (DHS)",
          purchaseTotalCostLabel: "Prix total (DHS)",
          purchaseAddBtn: "Ajouter achat",
          purchaseExpectedCashLabel: "Cash attendu",
          purchasesLogTitle: "Historique des achats",
          noPurchases: "Aucun achat enregistré.",
          inventoryTitle: "Inventaire",
          inventoryItemsTitle: "Articles",
          inventoryEditTitle: "Modifier",
          inventorySelectItem: "Sélectionner un article",
          inventoryCurrentQty: "Quantité actuelle",
          inventoryMinQty: "Seuil minimum",
          inventoryUnitLabel: "Unité",
          inventoryAdjustLabel: "Ajustement",
          inventoryAddBtn: "Ajouter",
          inventoryRemoveBtn: "Retirer",
          inventoryUpdateBtn: "Mettre à jour",
          inventoryTableTitle: "Tableau du stock",
          inventoryTableIngredient: "Ingrédient",
          inventoryTableLastShift: "Consommation (dernier shift)",
          inventoryTableTotal: "Consommation (total)",
          inventoryTableInitial: "Quantité initiale",
          inventoryTableRemaining: "Quantité restante",
          inventoryTableLastUpdate: "Dernière mise à jour",
          firebaseLoginTitle: "Connexion Cloud",
          firebaseLoginSubtitle:
            "Connectez-vous pour synchroniser les données du POS (commandes, shifts, stock) vers le cloud.",
          firebaseEmailLabel: "Email",
          firebasePasswordLabel: "Mot de passe",
          firebaseLoginBtn: "Se connecter",
          firebaseLoggingIn: "Connexion...",
          firebaseOfflineBtn: "Continuer hors ligne",
          firebaseCloudConnected: "Cloud: connecté",
          firebaseCloudDisconnected: "Cloud: non connecté",
          firebaseCloudConnectBtn: "Connexion",
          firebaseLogoutBtn: "Déconnexion",
          glassCupCustomerNameLabel: "Nom du client (verre)",
          glassCupCustomerNamePlaceholder: "Nom du client",
          glassCupCustomerNameRequired: "Nom du client requis pour verre à emporter.",
          cupLoansBannerPrefix: "Vous avez",
          cupLoansBannerSmall: "petits verres",
          cupLoansBannerLarge: "grands verres",
          cupLoansBannerSuffix: "dehors · Cliquez pour détails",
          cupLoansTitle: "Verres à récupérer",
          cupLoansEmpty: "Aucun verre à récupérer.",
          cupLoansCustomerLabel: "Client",
          cupLoansSinceLabel: "Depuis",
          cupLoansRefundableYes: "Remboursable",
          cupLoansRefundableNo: "Non remboursable",
          cupLoansMarkReturned: "Marquer retourné",
          cupLoansReturnAndRefund: "Retour + remboursement"
        },
        ar: {
          appTitle: "نظام مقهى حلب",
          uiSubtitle: "واجهة فقط · بدون خلفية بعد",
          all: "الكل",
          catFavorites: "المفضلة",
          catBreakfast: "فطور",
          catHot: "مشروبات ساخنة",
          catCold: "مشروبات باردة",
          catOthers: "أخرى",
          posSlogan: "استراحة مغربية... قهوة أصيلة.",
          currentOrder: "الطلب الحالي",
          cartEmpty: "السلة فارغة",
          subtotal: "المجموع الفرعي",
          tax: "الضريبة",
          total: "المجموع",
          mockPlaceOrder: "تسجيل الطلب محلياً",
          placingOrder: "جار إرسال الطلب...",
          orderOk: "تم تسجيل الطلب محلياً (في الكونسول)",
          milkLabel: "حليب",
          milkYes: "مع حليب",
          milkNo: "بدون حليب",
          sugarLabel: "سكر",
          sugarNone: "بدون سكر",
          sugarLow: "قليل السكر",
          sugarMedium: "عادي",
          sugarExtra: "حلو",
          siropLabel: "سيروب",
          siropWith: "مع",
          siropWithout: "بدون",
          waterLabel: "ماء ربع لتر",
          waterWith: "مع",
          waterWithout: "بدون",
          waterInLine: "ماء",
          siropInLine: "سيروب",
          waterSizeLabel: "الماء",
          waterQuarter: "ربع لتر",
          waterHalf: "نصف لتر",
          herbLabel: "أعشاب",
          herbMint: "نعناع",
          herbAbsinthe: "الشيبة",
          herbLemon: "أوراق الليمون",
          drinkLabel: "مشروب ساخن",
          drinkTea: "شاي",
          drinkCoffeeMilk: "قهوة بالحليب",
          milkInLine: "حليب",
          sugarInLine: "سكر",
          herbInLine: "أعشاب",
          drinkInLine: "مشروب",
          eggsInLine: "بيض",
          drinkInLine: "مشروب",
          addLabel: "إضافة",
          langFr: "فر",
          langAr: "عر",
          ordersInProgress: "طلبات غير مدفوعة",
          noOrdersInProgress: "لا توجد طلبات غير مدفوعة.",
          markPaid: "إعلان مدفوع",
          debtsToCollectTitle: "ديون يجب تحصيلها (نوبات سابقة)",
          markDebtPaid: "إعلان سداد الدين",
          debtCustomerNameLabel: "اسم الزبون",
          debtCustomerNamePlaceholder: "اسم الزبون",
          declareDebtBtn: "إعلان دين",
          shiftCloseBlockedTitle: "النوبة: طلبات غير مدفوعة",
          shiftCloseBlockedSubtitle:
            "يجب إعلان كل طلب كمدفوع أو كدين (مع اسم الزبون) قبل إغلاق النوبة.",
          closeShiftNowBtn: "إغلاق النوبة",
          cancelBtn: "إلغاء",
          clientUnpaidDebtLabel: "ديون الزبائن غير المدفوعة",
          shiftOpenTitle: "فتح نوبة",
          shiftOpenSubtitle: "أدخل رقم PIN للنادل لبدء النوبة.",
          backToMenus: "العودة للقائمة",
          openShiftBtn: "فتح النوبة",
          closeShiftBtn: "إنهاء النوبة",
          pauseShiftBtn: "إيقاف مؤقت",
          resumeShiftBtn: "استئناف",
          confirmPinBtn: "تأكيد",
          pinLabel: "رمز PIN",
          confirmPauseTitle: "تأكيد الإيقاف المؤقت",
          confirmPauseSubtitle: "أدخل رمز PIN لإيقاف النوبة مؤقتاً.",
          shiftPausedTitle: "النوبة متوقفة",
          shiftPausedSubtitle: "أدخل رمز النادل لاستئناف العمل.",
          autoPausedMessage: "تم إيقاف النوبة تلقائياً بسبب عدم النشاط.",
          pinIncorrect: "رمز PIN غير صحيح",
          orderAddedPending: "تمت إضافة الطلب إلى قائمة الانتظار.",
          shiftPausedBlocking: "النوبة متوقفة. استأنف للمتابعة.",
          closeBtn: "إغلاق",
          needWorkerLogin: "افتح نوبة (رمز النادل) قبل تسجيل طلب.",
          noShiftOpen: "لا توجد نوبة مفتوحة.",
          shiftSummaryTitle: "النوبة",
          shiftSummaryNone: "لا توجد نوبة مفتوحة.",
          virtualTicketsTitle: "تذاكر الطلبات",
          paidOrdersTitle: "طلبات مدفوعة",
          unpaidOrdersTitle: "طلبات غير مدفوعة",
          noPaidOrders: "لا توجد طلبات مدفوعة.",
          noUnpaidOrders: "لا توجد طلبات غير مدفوعة.",
          orderLabel: "طلب",
          waiterLabel: "النادل",
          createdAtLabel: "وقت الإنشاء",
          paidAtLabel: "وقت الدفع",
          statusPaid: "مدفوع",
          statusUnpaid: "غير مدفوع",
          detailsBtn: "تفاصيل",
          hideDetailsBtn: "إخفاء",
          salesBtn: "المبيعات",
          purchasesBtn: "المشتريات",
          purchaseTitle: "مشتريات (المخزون)",
          purchaseSelectIngredient: "اختر مكوّناً",
          purchaseQtyLabel: "الكمية",
          purchaseUnitPriceLabel: "سعر الوحدة (درهم)",
          purchaseTotalCostLabel: "السعر الإجمالي (درهم)",
          purchaseAddBtn: "إضافة شراء",
          purchaseExpectedCashLabel: "النقد المتوقع",
          purchasesLogTitle: "سجل المشتريات",
          noPurchases: "لا توجد مشتريات مسجلة.",
          inventoryTitle: "المخزون",
          inventoryItemsTitle: "العناصر",
          inventoryEditTitle: "تعديل",
          inventorySelectItem: "اختر عنصراً",
          inventoryCurrentQty: "الكمية الحالية",
          inventoryMinQty: "الحد الأدنى",
          inventoryUnitLabel: "الوحدة",
          inventoryAdjustLabel: "تعديل",
          inventoryAddBtn: "إضافة",
          inventoryRemoveBtn: "خصم",
          inventoryUpdateBtn: "تحديث",
          inventoryTableTitle: "جدول المخزون",
          inventoryTableIngredient: "المكوّن",
          inventoryTableLastShift: "استهلاك آخر نوبة",
          inventoryTableTotal: "الاستهلاك الإجمالي",
          inventoryTableInitial: "الكمية الابتدائية",
          inventoryTableRemaining: "الكمية المتبقية",
          inventoryTableLastUpdate: "آخر تحديث",
          firebaseLoginTitle: "تسجيل الدخول إلى السحابة",
          firebaseLoginSubtitle:
            "سجّل الدخول لمزامنة بيانات النظام (الطلبات، النوبات، المخزون) إلى السحابة.",
          firebaseEmailLabel: "البريد الإلكتروني",
          firebasePasswordLabel: "كلمة المرور",
          firebaseLoginBtn: "تسجيل الدخول",
          firebaseLoggingIn: "جارٍ تسجيل الدخول...",
          firebaseOfflineBtn: "متابعة بدون اتصال",
          firebaseCloudConnected: "السحابة: متصل",
          firebaseCloudDisconnected: "السحابة: غير متصل",
          firebaseCloudConnectBtn: "اتصال",
          firebaseLogoutBtn: "تسجيل الخروج",
          glassCupCustomerNameLabel: "اسم الزبون (كأس زجاج)",
          glassCupCustomerNamePlaceholder: "اسم الزبون",
          glassCupCustomerNameRequired: "اسم الزبون مطلوب للكأس الزجاجي في الطلب الخارجي.",
          cupLoansBannerPrefix: "لديك",
          cupLoansBannerSmall: "كؤوس صغيرة",
          cupLoansBannerLarge: "كؤوس كبيرة",
          cupLoansBannerSuffix: "خارجية · اضغط للتفاصيل",
          cupLoansTitle: "كؤوس يجب إرجاعها",
          cupLoansEmpty: "لا توجد كؤوس يجب إرجاعها.",
          cupLoansCustomerLabel: "الزبون",
          cupLoansSinceLabel: "منذ",
          cupLoansRefundableYes: "قابلة للاسترجاع",
          cupLoansRefundableNo: "غير قابلة للاسترجاع",
          cupLoansMarkReturned: "تم الإرجاع",
          cupLoansReturnAndRefund: "إرجاع + استرجاع"
        }
      };

      function LoginPanel({ currentUser, users, onLogin, onLogout }) {
        const [pin, setPin] = React.useState("");
        const [error, setError] = React.useState(null);

        function handleSubmit(ev) {
          ev.preventDefault();
          const u = users.find((user) => user.pin === pin);
          if (!u) {
            setError("PIN incorrect");
            return;
          }
          setError(null);
          setPin("");
          onLogin(u);
        }

        if (currentUser) {
          return React.createElement(
            "div",
            { style: { display: "flex", gap: 8, alignItems: "center" } },
            React.createElement(
              "span",
              null,
              currentUser.name + " (" + currentUser.role + ")"
            ),
            React.createElement(
              "button",
              { className: "category-btn", onClick: onLogout },
              "Logout"
            )
          );
        }

        return React.createElement(
          "form",
          {
            onSubmit: handleSubmit,
            style: { display: "flex", gap: 4, alignItems: "center" }
          },
          React.createElement("input", {
            type: "password",
            value: pin,
            onChange: (e) => setPin(e.target.value),
            placeholder: "PIN",
            style: { padding: 4, fontSize: 12, width: 70 }
          }),
          React.createElement(
            "button",
            { className: "category-btn", type: "submit" },
            "Login"
          ),
          error &&
            React.createElement(
              "span",
              { style: { color: "#b91c1c", fontSize: 11 } },
              error
            )
        );
      }

      function WaiterPurchasesPanel({
        inventory,
        t,
        lang,
        activeShift,
        activeWorker,
        adminUser,
        shifts,
        onPurchase,
        canPurchase
      }) {
        function parseNum(v) {
          const n = Number(String(v).replace(",", "."));
          return Number.isFinite(n) ? n : null;
        }

        const ids = Object.keys(inventory || {}).sort((a, b) => {
          const na = ingredientLabel(inventory && inventory[a], lang) || String(a);
          const nb = ingredientLabel(inventory && inventory[b], lang) || String(b);
          return na.localeCompare(nb);
        });
        const [selectedId, setSelectedId] = React.useState(ids[0] || "");
        const [qty, setQty] = React.useState("");
        const [totalCost, setTotalCost] = React.useState("");

        const isAdmin =
          !!(adminUser && (adminUser.role === "admin" || adminUser.role === "manager"));
        const canChooseActor = !!(isAdmin && activeWorker && activeShift);
        const [purchaseActor, setPurchaseActor] = React.useState(() =>
          canChooseActor ? "worker" : isAdmin ? "admin" : "worker"
        );

        const [deductFromExpectedCash, setDeductFromExpectedCash] = React.useState(() => {
          const defaultActor = canChooseActor ? "worker" : isAdmin ? "admin" : "worker";
          return !!activeShift && defaultActor === "worker";
        });
        const [deductFromExpectedCashTouched, setDeductFromExpectedCashTouched] = React.useState(false);

        React.useEffect(() => {
          if (canChooseActor) return;
          setPurchaseActor(isAdmin ? "admin" : "worker");
        }, [canChooseActor, isAdmin]);

        React.useEffect(() => {
          if (deductFromExpectedCashTouched) return;
          if (!activeShift) {
            setDeductFromExpectedCash(false);
            return;
          }
          setDeductFromExpectedCash(purchaseActor === "worker");
        }, [purchaseActor, !!activeShift, deductFromExpectedCashTouched]);

        React.useEffect(() => {
          if (selectedId) return;
          if (ids[0]) setSelectedId(ids[0]);
        }, [selectedId, ids.length]);

        const ing = selectedId && inventory ? inventory[selectedId] : null;
        const unit = ing && ing.unit ? ing.unit : "";
        const packSize =
          ing && typeof ing.packSize === "number" && Number.isFinite(ing.packSize) && ing.packSize > 0
            ? ing.packSize
            : null;
        const shiftRec =
          activeShift && Array.isArray(shifts)
            ? shifts.find((s) => s && s.id === activeShift.id)
            : null;
        const expectedCash = shiftRec
          ? shiftRec.expectedCash
          : activeShift
          ? activeShift.expectedCash
          : 0;

        const title = (t && t.purchaseTitle) || "Achats (stock)";
        const labelSelect = (t && t.purchaseSelectIngredient) || "Sélectionner un ingrédient";
        const labelQty = (t && t.purchaseQtyLabel) || "Quantité";
        const labelUnitPrice = (t && t.purchaseUnitPriceLabel) || "Prix unitaire (DHS)";
        const labelCost = (t && t.purchaseTotalCostLabel) || "Prix total (DHS)";
        const labelExpected = (t && t.purchaseExpectedCashLabel) || "Cash attendu";
        const btn = (t && t.purchaseAddBtn) || "Ajouter achat";

        const qPreview = parseNum(qty);
        const costPreview = parseNum(totalCost);
        const effectiveQtyPreview =
          qPreview != null ? qPreview * (packSize ? packSize : 1) : null;
        const unitPricePreview =
          effectiveQtyPreview != null && effectiveQtyPreview > 0 && costPreview != null
            ? costPreview / effectiveQtyPreview
            : null;

        function handleSubmit(ev) {
          ev.preventDefault();
          if (!selectedId) return;
          const q = parseNum(qty);
          const cost = parseNum(totalCost);
          if (q == null || q <= 0) return;
          if (cost == null || cost < 0) return;
          const actorOverride = purchaseActor === "admin" ? adminUser : activeWorker;
          onPurchase(selectedId, q, cost, actorOverride, deductFromExpectedCash);
          setQty("");
          setTotalCost("");
        }

        return React.createElement(
          "div",
          { style: { maxWidth: 520 } },
          React.createElement(
            "div",
            { style: { fontWeight: 900, fontSize: 18, marginBottom: 10 } },
            title
          ),
          React.createElement(
            "div",
            {
              style: {
                fontSize: 12,
                color: "#64748b",
                marginBottom: 10,
                display: "flex",
                justifyContent: "space-between",
                gap: 10
              }
            },
            React.createElement(
              "div",
              null,
              labelExpected,
              ": ",
              Number(expectedCash || 0).toFixed(2),
              " DHS"
            ),
            activeShift
              ? React.createElement(
                  "div",
                  { style: { whiteSpace: "nowrap" } },
                  "Shift: ",
                  activeShift.id
                )
              : null
          ),
          canChooseActor
            ? React.createElement(
                "div",
                {
                  style: {
                    fontSize: 12,
                    color: "#334155",
                    marginBottom: 10,
                    display: "flex",
                    justifyContent: "space-between",
                    gap: 10,
                    alignItems: "center"
                  }
                },
                React.createElement(
                  "div",
                  { style: { fontWeight: 800 } },
                  lang === "ar" ? "الشراء بواسطة" : "Achat par"
                ),
                React.createElement(
                  "select",
                  {
                    value: purchaseActor,
                    onChange: (ev) => {
                      setDeductFromExpectedCashTouched(false);
                      setPurchaseActor(ev.target.value);
                    },
                    style: {
                      padding: 6,
                      borderRadius: 10,
                      border: "1px solid rgba(148,163,184,0.55)",
                      fontSize: 12,
                      direction: lang === "ar" ? "rtl" : "ltr"
                    }
                  },
                  React.createElement(
                    "option",
                    { value: "worker" },
                    String((activeWorker && activeWorker.name) || (lang === "ar" ? "النادل" : "Serveur"))
                  ),
                  React.createElement(
                    "option",
                    { value: "admin" },
                    String((adminUser && adminUser.name) || (lang === "ar" ? "مدير" : "Admin"))
                  )
                )
              )
            : null,
          !canPurchase
            ? React.createElement(
                "div",
                { style: { fontSize: 12, color: "#b91c1c" } },
                lang === "ar" ? "غير مسموح" : "Accès refusé."
              )
            : React.createElement(
                "form",
                {
                  onSubmit: handleSubmit,
                  style: {
                    display: "grid",
                    gap: 10,
                    padding: 12,
                    borderRadius: 14,
                    border: "1px solid rgba(148,163,184,0.45)",
                    background: "rgba(255,255,255,0.92)"
                  }
                },
                React.createElement(
                  "div",
                  { style: { display: "grid", gap: 6 } },
                  React.createElement(
                    "div",
                    { style: { fontSize: 12, fontWeight: 800 } },
                    labelSelect
                  ),
                  React.createElement(
                    "select",
                    {
                      value: selectedId,
                      onChange: (ev) => setSelectedId(ev.target.value),
                      style: {
                        padding: 10,
                        borderRadius: 12,
                        border: "1px solid rgba(148,163,184,0.55)",
                        fontSize: 14,
                        direction: lang === "ar" ? "rtl" : "ltr"
                      }
                    },
                    ids.map((id) =>
                      React.createElement(
                        "option",
                        { key: id, value: id },
                        ingredientLabel(inventory && inventory[id], lang) || id
                      )
                    )
                  ),
                  ing
                    ? React.createElement(
                        "div",
                        { style: { fontSize: 11, color: "#64748b" } },
                        "Stock: ",
                        String(ing.currentQty || 0),
                        " ",
                        unit,
                        packSize
                          ? " (" + Number((ing.currentQty || 0) / packSize).toFixed(2) + " packs)"
                          : ""
                      )
                    : null
                ),
                React.createElement(
                  "div",
                  { style: { display: "grid", gap: 6 } },
                  React.createElement(
                    "div",
                    { style: { fontSize: 12, fontWeight: 800 } },
                    packSize
                      ? labelQty + (lang === "ar" ? " (علب ×12)" : " (packs ×12)")
                      : labelQty
                  ),
                  React.createElement("input", {
                    type: "number",
                    step: packSize ? "1" : "any",
                    value: qty,
                    onChange: (ev) => setQty(ev.target.value),
                    placeholder: packSize ? (lang === "ar" ? "0 (علب)" : "0 (packs)") : unit ? "0 (" + unit + ")" : "0",
                    style: {
                      padding: 10,
                      borderRadius: 12,
                      border: "1px solid rgba(148,163,184,0.55)",
                      fontSize: 14
                    }
                  })
                ),
                React.createElement(
                  "div",
                  { style: { display: "grid", gap: 6 } },
                  React.createElement(
                    "div",
                    { style: { fontSize: 12, fontWeight: 800 } },
                    labelCost
                  ),
                  React.createElement("input", {
                    type: "number",
                    step: "any",
                    value: totalCost,
                    onChange: (ev) => setTotalCost(ev.target.value),
                    placeholder: "0",
                    style: {
                      padding: 10,
                      borderRadius: 12,
                      border: "1px solid rgba(148,163,184,0.55)",
                      fontSize: 14
                    }
                  })
                ),
                React.createElement(
                  "label",
                  {
                    style: {
                      display: "flex",
                      gap: 8,
                      alignItems: "center",
                      fontSize: 12,
                      fontWeight: 800,
                      color: "#334155"
                    }
                  },
                  React.createElement("input", {
                    type: "checkbox",
                    checked: !!deductFromExpectedCash,
                    disabled: !activeShift,
                    onChange: (ev) => {
                      setDeductFromExpectedCashTouched(true);
                      setDeductFromExpectedCash(!!(ev && ev.target && ev.target.checked));
                    }
                  }),
                  lang === "ar" ? "خصم من النقد المتوقع (النوبة)" : "Déduire du cash attendu (shift)"
                ),
                unitPricePreview != null &&
                  React.createElement(
                    "div",
                    { style: { fontSize: 12, color: "#334155", fontWeight: 700 } },
                    labelUnitPrice,
                    ": ",
                    unitPricePreview.toFixed(2),
                    " DHS"
                  ),
                React.createElement(
                  "button",
                  { className: "btn-primary", type: "submit", style: { width: "100%" } },
                  btn
                )
              )
        );
      }

      function WaiterPurchaseInvoicesPanel({
        inventory,
        t,
        lang,
        activeShift,
        activeWorker,
        adminUser,
        shifts,
        onPurchaseInvoice,
        canPurchase
      }) {
        function parseNum(v) {
          const n = Number(String(v).replace(",", "."));
          return Number.isFinite(n) ? n : null;
        }

        const ids = Object.keys(inventory || {}).sort((a, b) => {
          const na = ingredientLabel(inventory && inventory[a], lang) || String(a);
          const nb = ingredientLabel(inventory && inventory[b], lang) || String(b);
          return na.localeCompare(nb);
        });

        const isAdmin =
          !!(adminUser && (adminUser.role === "admin" || adminUser.role === "manager"));
        const canChooseActor = !!(isAdmin && activeWorker && activeShift);
        const [purchaseActor, setPurchaseActor] = React.useState(() =>
          canChooseActor ? "worker" : isAdmin ? "admin" : "worker"
        );

        React.useEffect(() => {
          if (canChooseActor) return;
          setPurchaseActor(isAdmin ? "admin" : "worker");
        }, [canChooseActor, isAdmin]);

        const [deductFromExpectedCash, setDeductFromExpectedCash] = React.useState(() => {
          const defaultActor = canChooseActor ? "worker" : isAdmin ? "admin" : "worker";
          return !!activeShift && defaultActor === "worker";
        });
        const [deductFromExpectedCashTouched, setDeductFromExpectedCashTouched] = React.useState(false);

        React.useEffect(() => {
          if (deductFromExpectedCashTouched) return;
          if (!activeShift) {
            setDeductFromExpectedCash(false);
            return;
          }
          setDeductFromExpectedCash(purchaseActor === "worker");
        }, [purchaseActor, !!activeShift, deductFromExpectedCashTouched]);

        const [supplierName, setSupplierName] = React.useState("");
        const [invoiceNumber, setInvoiceNumber] = React.useState("");
        const [note, setNote] = React.useState("");

        const [lineIngredientId, setLineIngredientId] = React.useState(ids[0] || "");
        const [lineQty, setLineQty] = React.useState("");
        const [lineTotalCost, setLineTotalCost] = React.useState("");
        const [lines, setLines] = React.useState([]);

        React.useEffect(() => {
          if (lineIngredientId) return;
          if (ids[0]) setLineIngredientId(ids[0]);
        }, [lineIngredientId, ids.length]);

        const ing = lineIngredientId && inventory ? inventory[lineIngredientId] : null;
        const unit = ing && ing.unit ? ing.unit : "";
        const packSize =
          ing && typeof ing.packSize === "number" && Number.isFinite(ing.packSize) && ing.packSize > 0
            ? ing.packSize
            : null;

        const qPreview = parseNum(lineQty);
        const costPreview = parseNum(lineTotalCost);
        const effectiveQtyPreview =
          qPreview != null ? qPreview * (packSize ? packSize : 1) : null;
        const unitPricePreview =
          effectiveQtyPreview != null && effectiveQtyPreview > 0 && costPreview != null
            ? costPreview / effectiveQtyPreview
            : null;

        const totalInvoiceCost = React.useMemo(
          () => (lines || []).reduce((s, l) => s + (Number(l && l.totalCost) || 0), 0),
          [lines]
        );

        function addLine(ev) {
          if (ev && ev.preventDefault) ev.preventDefault();
          if (!lineIngredientId) return;
          const q = parseNum(lineQty);
          const cost = parseNum(lineTotalCost);
          if (q == null || q <= 0) return;
          if (cost == null || cost < 0) return;
          setLines((prev) => [
            ...((prev || []).filter(Boolean)),
            {
              ingredientId: lineIngredientId,
              qty: q,
              totalCost: cost
            }
          ]);
          setLineQty("");
          setLineTotalCost("");
        }

        function removeLine(idx) {
          setLines((prev) => (prev || []).filter((_, i) => i !== idx));
        }

        function submitInvoice() {
          if (!onPurchaseInvoice) return;
          if (!lines.length) return;
          const actorOverride = purchaseActor === "admin" ? adminUser : activeWorker;
          onPurchaseInvoice(
            {
              supplierName,
              invoiceNumber,
              note,
              lines
            },
            actorOverride,
            deductFromExpectedCash
          );
          setSupplierName("");
          setInvoiceNumber("");
          setNote("");
          setLines([]);
          setLineQty("");
          setLineTotalCost("");
        }

        const title = lang === "ar" ? "فاتورة مشتريات" : "Facture d'achat";
        const labelSelect = (t && t.purchaseSelectIngredient) || "Sélectionner un ingrédient";

        return React.createElement(
          "div",
          { style: { maxWidth: 620 } },
          React.createElement(
            "div",
            { style: { fontWeight: 900, fontSize: 18, marginBottom: 10 } },
            title
          ),
          canChooseActor
            ? React.createElement(
                "div",
                {
                  style: {
                    fontSize: 12,
                    color: "#334155",
                    marginBottom: 10,
                    display: "flex",
                    justifyContent: "space-between",
                    gap: 10,
                    alignItems: "center"
                  }
                },
                React.createElement(
                  "div",
                  { style: { fontWeight: 800 } },
                  lang === "ar" ? "الشراء بواسطة" : "Achat par"
                ),
                React.createElement(
                  "select",
                  {
                    value: purchaseActor,
                    onChange: (ev) => {
                      setDeductFromExpectedCashTouched(false);
                      setPurchaseActor(ev.target.value);
                    },
                    style: {
                      padding: 6,
                      borderRadius: 10,
                      border: "1px solid rgba(148,163,184,0.55)",
                      fontSize: 12,
                      direction: lang === "ar" ? "rtl" : "ltr"
                    }
                  },
                  React.createElement(
                    "option",
                    { value: "worker" },
                    String((activeWorker && activeWorker.name) || (lang === "ar" ? "النادل" : "Serveur"))
                  ),
                  React.createElement(
                    "option",
                    { value: "admin" },
                    String((adminUser && adminUser.name) || (lang === "ar" ? "مدير" : "Admin"))
                  )
                )
              )
            : null,
          !canPurchase
            ? React.createElement(
                "div",
                { style: { fontSize: 12, color: "#b91c1c" } },
                lang === "ar" ? "غير مسموح" : "Accès refusé."
              )
            : React.createElement(
                React.Fragment,
                null,
                React.createElement(
                  "div",
                  {
                    style: {
                      display: "grid",
                      gap: 10,
                      padding: 12,
                      borderRadius: 14,
                      border: "1px solid rgba(148,163,184,0.45)",
                      background: "rgba(255,255,255,0.92)"
                    }
                  },
                  React.createElement("input", {
                    value: supplierName,
                    onChange: (e) => setSupplierName(e.target.value),
                    placeholder: lang === "ar" ? "المورد" : "Fournisseur",
                    style: { padding: 10, borderRadius: 12, border: "1px solid rgba(148,163,184,0.55)", fontSize: 14 }
                  }),
                  React.createElement("input", {
                    value: invoiceNumber,
                    onChange: (e) => setInvoiceNumber(e.target.value),
                    placeholder: lang === "ar" ? "رقم الفاتورة" : "N° facture",
                    style: { padding: 10, borderRadius: 12, border: "1px solid rgba(148,163,184,0.55)", fontSize: 14 }
                  }),
                  React.createElement("input", {
                    value: note,
                    onChange: (e) => setNote(e.target.value),
                    placeholder: lang === "ar" ? "ملاحظة" : "Note",
                    style: { padding: 10, borderRadius: 12, border: "1px solid rgba(148,163,184,0.55)", fontSize: 14 }
                  }),
                  React.createElement(
                    "label",
                    {
                      style: {
                        display: "flex",
                        gap: 8,
                        alignItems: "center",
                        fontSize: 12,
                        fontWeight: 800,
                        color: "#334155"
                      }
                    },
                    React.createElement("input", {
                      type: "checkbox",
                      checked: !!deductFromExpectedCash,
                      disabled: !activeShift,
                      onChange: (ev) => {
                        setDeductFromExpectedCashTouched(true);
                        setDeductFromExpectedCash(!!(ev && ev.target && ev.target.checked));
                      }
                    }),
                    lang === "ar" ? "خصم من النقد المتوقع (النوبة)" : "Déduire du cash attendu (shift)"
                  ),
                  React.createElement(
                    "div",
                    { style: { borderTop: "1px solid rgba(148,163,184,0.25)", paddingTop: 10, display: "grid", gap: 10 } },
                    React.createElement(
                      "div",
                      { style: { fontSize: 12, fontWeight: 900 } },
                      lang === "ar" ? "إضافة عنصر" : "Ajouter ligne"
                    ),
                    React.createElement(
                      "div",
                      { style: { display: "grid", gridTemplateColumns: "minmax(0, 1.6fr) minmax(0, 0.8fr) minmax(0, 0.8fr)", gap: 8 } },
                      React.createElement(
                        "select",
                        {
                          value: lineIngredientId,
                          onChange: (ev) => setLineIngredientId(ev.target.value),
                          style: {
                            padding: 10,
                            borderRadius: 12,
                            border: "1px solid rgba(148,163,184,0.55)",
                            fontSize: 14,
                            direction: lang === "ar" ? "rtl" : "ltr"
                          }
                        },
                        ids.map((id) =>
                          React.createElement(
                            "option",
                            { key: id, value: id },
                            ingredientLabel(inventory && inventory[id], lang) || id
                          )
                        )
                      ),
                      React.createElement("input", {
                        type: "number",
                        step: packSize ? "1" : "any",
                        value: lineQty,
                        onChange: (ev) => setLineQty(ev.target.value),
                        placeholder: packSize ? (lang === "ar" ? "علب" : "packs") : unit || "0",
                        style: {
                          padding: 10,
                          borderRadius: 12,
                          border: "1px solid rgba(148,163,184,0.55)",
                          fontSize: 14
                        }
                      }),
                      React.createElement("input", {
                        type: "number",
                        step: "any",
                        value: lineTotalCost,
                        onChange: (ev) => setLineTotalCost(ev.target.value),
                        placeholder: "0",
                        style: {
                          padding: 10,
                          borderRadius: 12,
                          border: "1px solid rgba(148,163,184,0.55)",
                          fontSize: 14
                        }
                      })
                    ),
                    unitPricePreview != null &&
                      React.createElement(
                        "div",
                        { style: { fontSize: 12, color: "#334155", fontWeight: 700 } },
                        ((t && t.purchaseUnitPriceLabel) || "Prix unitaire (DHS)"),
                        ": ",
                        unitPricePreview.toFixed(2),
                        " DHS"
                      ),
                    React.createElement(
                      "button",
                      { className: "category-btn", type: "button", onClick: addLine },
                      lang === "ar" ? "إضافة" : "Ajouter"
                    )
                  )
                ),
                React.createElement(
                  "div",
                  { style: { marginTop: 10 } },
                  (lines || []).length
                    ? React.createElement(
                        "div",
                        { style: { display: "grid", gap: 8 } },
                        lines.map((l, idx) =>
                          React.createElement(
                            "div",
                            {
                              key: String(idx),
                              style: {
                                display: "flex",
                                justifyContent: "space-between",
                                alignItems: "center",
                                gap: 10,
                                padding: "8px 10px",
                                borderRadius: 12,
                                border: "1px solid rgba(148,163,184,0.35)",
                                background: "rgba(255,255,255,0.75)"
                              }
                            },
                            React.createElement(
                              "div",
                              { style: { fontSize: 12, fontWeight: 800 } },
                              ingredientLabel(inventory && inventory[l.ingredientId], lang) || String(l.ingredientId || "")
                            ),
                            React.createElement(
                              "div",
                              { style: { display: "flex", gap: 10, alignItems: "center" } },
                              React.createElement(
                                "div",
                                { style: { fontSize: 12, fontWeight: 900, whiteSpace: "nowrap" } },
                                Number(l.totalCost || 0).toFixed(2),
                                " DHS"
                              ),
                              React.createElement(
                                "button",
                                { className: "category-btn", type: "button", onClick: () => removeLine(idx) },
                                "✕"
                              )
                            )
                          )
                        )
                      )
                    : React.createElement(
                        "div",
                        { style: { fontSize: 12, color: "#64748b" } },
                        lang === "ar" ? "لا توجد خطوط." : "Aucune ligne."
                      )
                ),
                React.createElement(
                  "div",
                  { style: { marginTop: 10, display: "flex", justifyContent: "space-between", alignItems: "center", gap: 10 } },
                  React.createElement(
                    "div",
                    { style: { fontSize: 12, fontWeight: 900 } },
                    (lang === "ar" ? "الإجمالي" : "Total") + ": " + Number(totalInvoiceCost || 0).toFixed(2) + " DHS"
                  ),
                  React.createElement(
                    "button",
                    { className: "btn-primary", type: "button", disabled: !(lines || []).length, onClick: submitInvoice },
                    lang === "ar" ? "تسجيل الفاتورة" : "Enregistrer"
                  )
                )
              )
        );
      }

      function WaiterStockCountPanel({ inventory, stockCountRequests, activeWorker, t, lang, onSubmit }) {
        const [values, setValues] = React.useState({});
        const mine = (stockCountRequests || [])
          .filter((r) => r && r.status === "open" && activeWorker && r.assignedToId === activeWorker.id)
          .slice()
          .sort((a, b) => String(b.requestedAt || "").localeCompare(String(a.requestedAt || "")));

        function submit(id) {
          const v = values && values[id] != null ? values[id] : "";
          if (onSubmit) onSubmit(id, v);
          setValues((p) => ({ ...(p || {}), [id]: "" }));
        }

        return React.createElement(
          "div",
          { style: { maxWidth: 520 } },
          React.createElement(
            "div",
            { style: { fontWeight: 900, fontSize: 18, marginBottom: 10 } },
            lang === "ar" ? "جرد (تفتيش)" : "Comptage (inspection)"
          ),
          !activeWorker
            ? React.createElement(
                "div",
                { style: { fontSize: 12, color: "#64748b" } },
                lang === "ar" ? "غير متصل" : "Non connecté"
              )
            : mine.length
              ? React.createElement(
                  "div",
                  { style: { display: "grid", gap: 10 } },
                  mine.map((r) =>
                    React.createElement(
                      "div",
                      {
                        key: r.id,
                        style: {
                          padding: 12,
                          borderRadius: 14,
                          border: "1px solid rgba(148,163,184,0.45)",
                          background: "rgba(255,255,255,0.92)",
                          display: "grid",
                          gap: 8
                        }
                      },
                      React.createElement(
                        "div",
                        { style: { fontSize: 12, fontWeight: 900 } },
                        ingredientLabel(inventory && inventory[r.ingredientId], lang) || String(r.ingredientId || "")
                      ),
                      r.note
                        ? React.createElement(
                            "div",
                            { style: { fontSize: 12, color: "#64748b" } },
                            String(r.note)
                          )
                        : null,
                      React.createElement(
                        "div",
                        { style: { display: "flex", gap: 8, alignItems: "center" } },
                        React.createElement("input", {
                          type: "number",
                          value: (values && values[r.id]) || "",
                          onChange: (ev) =>
                            setValues((p) => ({ ...(p || {}), [r.id]: ev.target.value })),
                          placeholder: lang === "ar" ? "العدد" : "Quantité comptée",
                          style: { flex: 1, padding: 10, fontSize: 14, borderRadius: 12, border: "1px solid rgba(148,163,184,0.55)" }
                        }),
                        React.createElement(
                          "button",
                          { className: "btn-primary", type: "button", onClick: () => submit(r.id) },
                          (t && t.confirmPinBtn) || (lang === "ar" ? "تأكيد" : "Confirmer")
                        )
                      )
                    )
                  )
                )
              : React.createElement(
                  "div",
                  { style: { fontSize: 12, color: "#64748b" } },
                  lang === "ar" ? "لا توجد طلبات تفتيش." : "Aucune demande."
                )
        );
      }

      function WaiterPurchasesHub(props) {
        const lang = props && props.lang;
        const t = props && props.t;
        const [mode, setMode] = React.useState("single");
        const tabBtnStyle = (active) => ({
          flex: 1,
          padding: "10px 10px",
          borderRadius: 12,
          border: "1px solid rgba(148,163,184,0.45)",
          background: active ? "rgba(249,115,22,0.18)" : "rgba(255,255,255,0.85)",
          fontWeight: 900,
          fontSize: 12
        });
        return React.createElement(
          "div",
          null,
          React.createElement(
            "div",
            { style: { display: "flex", gap: 8, marginBottom: 12 } },
            React.createElement(
              "button",
              { type: "button", className: "category-btn", style: tabBtnStyle(mode === "single"), onClick: () => setMode("single") },
              (lang === "ar" ? "شراء" : "Achat")
            ),
            React.createElement(
              "button",
              { type: "button", className: "category-btn", style: tabBtnStyle(mode === "invoice"), onClick: () => setMode("invoice") },
              (lang === "ar" ? "فاتورة" : "Facture")
            ),
            React.createElement(
              "button",
              { type: "button", className: "category-btn", style: tabBtnStyle(mode === "count"), onClick: () => setMode("count") },
              (lang === "ar" ? "تفتيش" : "Inspection")
            )
          ),
          mode === "single"
            ? React.createElement(WaiterPurchasesPanel, props)
            : mode === "invoice"
              ? React.createElement(WaiterPurchaseInvoicesPanel, props)
              : React.createElement(WaiterStockCountPanel, {
                  inventory: props.inventory,
                  stockCountRequests: props.stockCountRequests,
                  activeWorker: props.activeWorker,
                  t,
                  lang,
                  onSubmit: props.onSubmitStockCountRequest
                })
        );
      }

      function AdminPurchaseInvoicesLog({ purchaseInvoices, inventory, users, lang, isPhone }) {
        function userNameById(id) {
          const u = (users || []).find((x) => x && x.id === id);
          return u ? u.name : id || "";
        }

        function formatDateTime(iso) {
          if (!iso) return "";
          try {
            const d = new Date(iso);
            return d.toLocaleString(lang === "ar" ? "ar-MA" : "fr-FR", {
              year: "2-digit",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit"
            });
          } catch (e) {
            return String(iso || "");
          }
        }

        const rows = (purchaseInvoices || [])
          .slice()
          .sort((a, b) => String(b.createdAt || "").localeCompare(String(a.createdAt || "")));

        const title = lang === "ar" ? "فواتير المشتريات" : "Factures d'achat";
        const empty = lang === "ar" ? "لا توجد فواتير." : "Aucune facture.";

        return React.createElement(
          "div",
          null,
          React.createElement(
            "div",
            { style: { fontWeight: 700, marginBottom: 8, fontSize: 13 } },
            title
          ),
          rows.length
            ? React.createElement(
                "div",
                { style: { display: "grid", gap: 10 } },
                rows.slice(0, 20).map((inv) =>
                  React.createElement(
                    "div",
                    {
                      key: inv.id,
                      style: {
                        borderRadius: 14,
                        border: "1px solid rgba(148,163,184,0.45)",
                        background: "rgba(255,255,255,0.92)",
                        padding: 12,
                        display: "grid",
                        gap: 8
                      }
                    },
                    React.createElement(
                      "div",
                      { style: { display: "flex", justifyContent: "space-between", gap: 10, alignItems: "baseline", flexWrap: isPhone ? "wrap" : "nowrap" } },
                      React.createElement(
                        "div",
                        { style: { fontWeight: 900, fontSize: 12 } },
                        (inv.invoiceNumber ? String(inv.invoiceNumber) : (lang === "ar" ? "فاتورة" : "Facture")) +
                          (inv.supplierName ? " · " + String(inv.supplierName) : "")
                      ),
                      React.createElement(
                        "div",
                        { style: { fontWeight: 900, fontSize: 12, whiteSpace: "nowrap" } },
                        Number(inv.totalCost || 0).toFixed(2) + " DHS"
                      )
                    ),
                    React.createElement(
                      "div",
                      { style: { fontSize: 11, color: "#64748b", display: "flex", justifyContent: "space-between", gap: 10 } },
                      React.createElement(
                        "div",
                        null,
                        formatDateTime(inv.createdAt) +
                          (inv.userId ? " · " + userNameById(inv.userId) : "") +
                          (inv.shiftId ? " · " + String(inv.shiftId) : "")
                      ),
                      React.createElement(
                        "div",
                        { style: { whiteSpace: "nowrap" } },
                        (lang === "ar" ? "أسطر" : "Lignes") + ": " + String(inv.lineCount || ((inv.lines || []).length || 0))
                      )
                    ),
                    inv.note
                      ? React.createElement(
                          "div",
                          { style: { fontSize: 11, color: "#475569", fontWeight: 700 } },
                          String(inv.note)
                        )
                      : null,
                    (inv.lines || []).length
                      ? React.createElement(
                          "div",
                          { style: { display: "grid", gap: 6 } },
                          (inv.lines || []).map((ln) =>
                            React.createElement(
                              "div",
                              {
                                key: ln.id || Math.random(),
                                style: {
                                  display: "flex",
                                  justifyContent: "space-between",
                                  gap: 10,
                                  padding: "6px 8px",
                                  borderRadius: 10,
                                  border: "1px solid rgba(148,163,184,0.25)",
                                  background: "rgba(248,250,252,0.85)",
                                  fontSize: 12
                                }
                              },
                              React.createElement(
                                "div",
                                { style: { fontWeight: 800 } },
                                ingredientLabel(inventory && inventory[ln.ingredientId], lang) || String(ln.ingredientId || "")
                              ),
                              React.createElement(
                                "div",
                                { style: { whiteSpace: "nowrap", fontWeight: 900 } },
                                Number(ln.totalCost || 0).toFixed(2) + " DHS"
                              )
                            )
                          )
                        )
                      : null
                  )
                )
              )
            : React.createElement(
                "div",
                { style: { fontSize: 12, color: "#64748b" } },
                empty
              )
        );
      }

      function AdminStockCountRequestsPanel({ stockCountRequests, inventory, users, lang, cloudEnabled, onCreateRequest, isPhone }) {
        const ids = Object.keys(inventory || {}).sort((a, b) => {
          const na = ingredientLabel(inventory && inventory[a], lang) || String(a);
          const nb = ingredientLabel(inventory && inventory[b], lang) || String(b);
          return na.localeCompare(nb);
        });
        const workers = (users || []).filter((u) => u && u.role === "worker" && u.posAccess !== false);

        const [ingredientId, setIngredientId] = React.useState(ids[0] || "");
        const [assignedToId, setAssignedToId] = React.useState((workers[0] && workers[0].id) || "");
        const [note, setNote] = React.useState("");

        React.useEffect(() => {
          if (!ingredientId && ids[0]) setIngredientId(ids[0]);
        }, [ingredientId, ids.length]);

        React.useEffect(() => {
          if (!assignedToId && workers[0] && workers[0].id) setAssignedToId(workers[0].id);
        }, [assignedToId, workers.length]);

        function userNameById(id) {
          const u = (users || []).find((x) => x && x.id === id);
          return u ? u.name : id || "";
        }

        function formatDateTime(iso) {
          if (!iso) return "";
          try {
            const d = new Date(iso);
            return d.toLocaleString(lang === "ar" ? "ar-MA" : "fr-FR", {
              year: "2-digit",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit"
            });
          } catch (e) {
            return String(iso || "");
          }
        }

        const rows = (stockCountRequests || [])
          .slice()
          .sort((a, b) => String(b.requestedAt || "").localeCompare(String(a.requestedAt || "")));

        function create() {
          if (!ingredientId || !assignedToId) return;
          if (onCreateRequest) onCreateRequest(ingredientId, assignedToId, note);
          setNote("");
        }

        const title = lang === "ar" ? "طلبات التفتيش" : "Demandes d'inspection";

        return React.createElement(
          "div",
          null,
          React.createElement(
            "div",
            { style: { fontWeight: 700, marginBottom: 8, fontSize: 13 } },
            title
          ),
          React.createElement(
            "div",
            {
              style: {
                display: "grid",
                gap: 10,
                padding: 12,
                borderRadius: 14,
                border: "1px solid rgba(148,163,184,0.45)",
                background: "rgba(255,255,255,0.92)"
              }
            },
            React.createElement(
              "div",
              { style: { fontSize: 12, fontWeight: 900 } },
              lang === "ar" ? "إنشاء طلب" : "Créer une demande"
            ),
            React.createElement(
              "div",
              {
                style: {
                  display: "grid",
                  gridTemplateColumns: isPhone ? "1fr" : "minmax(0, 1.3fr) minmax(0, 1fr)",
                  gap: 8
                }
              },
              React.createElement(
                "select",
                {
                  value: ingredientId,
                  onChange: (e) => setIngredientId(e.target.value),
                  style: { padding: 10, borderRadius: 12, border: "1px solid rgba(148,163,184,0.55)", fontSize: 14 }
                },
                ids.map((id) =>
                  React.createElement(
                    "option",
                    { key: id, value: id },
                    ingredientLabel(inventory && inventory[id], lang) || id
                  )
                )
              ),
              React.createElement(
                "select",
                {
                  value: assignedToId,
                  onChange: (e) => setAssignedToId(e.target.value),
                  style: { padding: 10, borderRadius: 12, border: "1px solid rgba(148,163,184,0.55)", fontSize: 14 }
                },
                workers.map((u) =>
                  React.createElement(
                    "option",
                    { key: u.id, value: u.id },
                    String(u.name || u.id)
                  )
                )
              )
            ),
            React.createElement("input", {
              value: note,
              onChange: (e) => setNote(e.target.value),
              placeholder: lang === "ar" ? "ملاحظة" : "Note",
              style: { padding: 10, borderRadius: 12, border: "1px solid rgba(148,163,184,0.55)", fontSize: 14 }
            }),
            React.createElement(
              "button",
              { className: "btn-primary", type: "button", onClick: create },
              lang === "ar" ? "إرسال" : "Envoyer"
            )
          ),
          React.createElement(
            "div",
            { style: { marginTop: 10, display: "grid", gap: 10 } },
            rows.slice(0, 25).map((r) => {
              const status = r.status === "submitted" ? (lang === "ar" ? "مُرسل" : "Soumis") : (lang === "ar" ? "مفتوح" : "Ouvert");
              const variance = typeof r.variance === "number" ? r.variance : null;
              const varianceColor = variance == null ? "#64748b" : Math.abs(variance) > 0.0001 ? "#b91c1c" : "#065f46";
              return React.createElement(
                "div",
                {
                  key: r.id,
                  style: {
                    borderRadius: 14,
                    border: "1px solid rgba(148,163,184,0.45)",
                    background: "rgba(255,255,255,0.92)",
                    padding: 12,
                    display: "grid",
                    gap: 6
                  }
                },
                React.createElement(
                  "div",
                  { style: { display: "flex", justifyContent: "space-between", gap: 10 } },
                  React.createElement(
                    "div",
                    { style: { fontWeight: 900, fontSize: 12 } },
                    ingredientLabel(inventory && inventory[r.ingredientId], lang) || String(r.ingredientId || "")
                  ),
                  React.createElement(
                    "div",
                    { style: { fontSize: 12, fontWeight: 900, whiteSpace: "nowrap" } },
                    status
                  )
                ),
                React.createElement(
                  "div",
                  { style: { fontSize: 11, color: "#64748b" } },
                  (lang === "ar" ? "إلى" : "À") + ": " + userNameById(r.assignedToId) +
                    " · " + formatDateTime(r.requestedAt)
                ),
                r.note
                  ? React.createElement(
                      "div",
                      { style: { fontSize: 11, color: "#475569", fontWeight: 700 } },
                      String(r.note)
                    )
                  : null,
                r.status === "submitted"
                  ? React.createElement(
                      "div",
                      { style: { fontSize: 12, fontWeight: 900, color: varianceColor } },
                      (lang === "ar" ? "الفرق" : "Diff") + ": " +
                        Number(variance || 0).toFixed(3) +
                        " (" +
                        (lang === "ar" ? "متوقع" : "exp") + ": " + Number(r.expectedQty || 0).toFixed(3) +
                        ", " +
                        (lang === "ar" ? "معدود" : "count") + ": " + Number(r.countedQty || 0).toFixed(3) +
                        ")"
                    )
                  : null
              );
            })
          )
        );
      }

      function AdminInventoryPurchasesLog({ inventory, inventoryLogs, users, t, lang, isPhone }) {
        function nameForIngredient(id) {
          return ingredientLabel(inventory && inventory[id], lang) || id;
        }

        function unitForIngredient(id) {
          return (inventory && inventory[id] && inventory[id].unit) || "";
        }

        function userNameById(id) {
          const u = (users || []).find((x) => x && x.id === id);
          return u ? u.name : id || "";
        }

        function formatDateTime(iso) {
          if (!iso) return "";
          try {
            const d = new Date(iso);
            return d.toLocaleString(lang === "ar" ? "ar-MA" : "fr-FR", {
              year: "2-digit",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit"
            });
          } catch (e) {
            return String(iso || "");
          }
        }

        const rows = (inventoryLogs || [])
          .filter((l) => l && l.reason === "purchase")
          .slice()
          .sort((a, b) => String(b.createdAt || "").localeCompare(String(a.createdAt || "")));

        const title = (t && t.purchasesLogTitle) || "Historique des achats";
        const empty = (t && t.noPurchases) || "Aucun achat enregistré.";

        const thStyle = {
          textAlign: lang === "ar" ? "right" : "left",
          padding: "8px 8px",
          fontSize: 11,
          fontWeight: 700,
          color: "#0f172a",
          borderBottom: "1px solid rgba(148,163,184,0.6)",
          background: "rgba(226,232,240,0.8)",
          position: "sticky",
          top: 0
        };
        const tdStyle = {
          padding: "7px 8px",
          fontSize: 11,
          borderBottom: "1px solid rgba(148,163,184,0.25)",
          verticalAlign: "top"
        };

        return React.createElement(
          "div",
          null,
          React.createElement(
            "div",
            { style: { fontWeight: 700, marginBottom: 8, fontSize: 13 } },
            title
          ),
          rows.length
            ? React.createElement(
                "div",
                {
                  style: {
                    border: "1px solid rgba(148,163,184,0.5)",
                    borderRadius: 12,
                    overflow: "auto",
                    background: "rgba(255,255,255,0.92)"
                  }
                },
                React.createElement(
                  "table",
                  {
                    style: {
                      width: "100%",
                      borderCollapse: "collapse",
                      minWidth: isPhone ? 640 : 760
                    }
                  },
                  React.createElement(
                    "thead",
                    null,
                    React.createElement(
                      "tr",
                      null,
                      React.createElement("th", { style: thStyle }, "Date"),
                      React.createElement("th", { style: thStyle }, "Shift"),
                      React.createElement("th", { style: thStyle }, (t && t.waiterLabel) || "Serveur"),
                      React.createElement("th", { style: thStyle }, (t && t.inventoryTableIngredient) || "Ingrédient"),
                      React.createElement("th", { style: thStyle }, (t && t.purchaseQtyLabel) || "Quantité"),
                      React.createElement("th", { style: thStyle }, (t && t.purchaseTotalCostLabel) || "Prix total (DHS)")
                    )
                  ),
                  React.createElement(
                    "tbody",
                    null,
                    rows.map((r) => {
                      const unit = unitForIngredient(r.ingredientId);
                      const packSize =
                        inventory &&
                        inventory[r.ingredientId] &&
                        typeof inventory[r.ingredientId].packSize === "number" &&
                        Number.isFinite(inventory[r.ingredientId].packSize) &&
                        inventory[r.ingredientId].packSize > 0
                          ? inventory[r.ingredientId].packSize
                          : null;
                      return React.createElement(
                        "tr",
                        { key: r.id },
                        React.createElement("td", { style: tdStyle }, formatDateTime(r.createdAt)),
                        React.createElement("td", { style: tdStyle }, r.shiftId || ""),
                        React.createElement("td", { style: tdStyle }, userNameById(r.userId)),
                        React.createElement("td", { style: tdStyle }, nameForIngredient(r.ingredientId)),
                        React.createElement(
                          "td",
                          { style: tdStyle },
                          String(r.delta || 0),
                          " ",
                          unit,
                          packSize && unit === "pcs" && typeof r.delta === "number"
                            ? " (" + Number(r.delta / packSize).toFixed(2) + " packs)"
                            : ""
                        ),
                        React.createElement(
                          "td",
                          { style: tdStyle },
                          Number(r.totalCost || 0).toFixed(2)
                        )
                      );
                    })
                  )
                )
              )
            : React.createElement(
                "div",
                { style: { fontSize: 12, color: "#64748b" } },
                empty
              )
        );
      }

      function AdminInventoryStockDetails({ inventory, inventoryLogs, shifts, t, lang, isPhone }) {
        function nameForIngredient(id) {
          return ingredientLabel(inventory && inventory[id], lang) || id;
        }

        function unitForIngredient(id) {
          return (inventory && inventory[id] && inventory[id].unit) || "";
        }

        function formatQty(value, unit) {
          if (value == null || Number.isNaN(value)) return "";
          if (unit === "pcs") {
            const v = Math.round(value);
            return String(v);
          }
          const rounded = Math.round(value * 1000) / 1000;
          return String(rounded).replace(/\.0+$/, "").replace(/(\.\d*[1-9])0+$/, "$1");
        }

        function formatDateTime(iso) {
          if (!iso) return "";
          try {
            const d = new Date(iso);
            return d.toLocaleString(lang === "ar" ? "ar-MA" : "fr-FR", {
              year: "2-digit",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit"
            });
          } catch (e) {
            return "";
          }
        }

        const lastShift = (shifts || []).length ? shifts[shifts.length - 1] : null;
        const lastShiftId = lastShift ? lastShift.id : null;

        const totalSaleByIngredient = {};
        const lastShiftSaleByIngredient = {};
        const lastUpdateByIngredient = {};
        (inventoryLogs || []).forEach((log) => {
          if (!log || !log.ingredientId) return;

          const prevIso = lastUpdateByIngredient[log.ingredientId];
          if (!prevIso || (log.createdAt && log.createdAt > prevIso)) {
            lastUpdateByIngredient[log.ingredientId] = log.createdAt;
          }

          if (log.reason === "sale") {
            totalSaleByIngredient[log.ingredientId] =
              (totalSaleByIngredient[log.ingredientId] || 0) + (log.delta || 0);
            if (lastShiftId && log.shiftId === lastShiftId) {
              lastShiftSaleByIngredient[log.ingredientId] =
                (lastShiftSaleByIngredient[log.ingredientId] || 0) + (log.delta || 0);
            }
          }
        });

        const ingredientIds = Object.keys(inventory || {}).sort((a, b) =>
          nameForIngredient(a).localeCompare(nameForIngredient(b))
        );

        const thStyle = {
          textAlign: lang === "ar" ? "right" : "left",
          padding: "8px 8px",
          fontSize: 11,
          fontWeight: 700,
          color: "#0f172a",
          borderBottom: "1px solid rgba(148,163,184,0.6)",
          background: "rgba(226,232,240,0.8)",
          position: "sticky",
          top: 0
        };
        const tdStyle = {
          padding: "7px 8px",
          fontSize: 11,
          borderBottom: "1px solid rgba(148,163,184,0.25)",
          verticalAlign: "top"
        };

        const title = (t && t.inventoryTableTitle) || "Tableau du stock";
        const colIngredient = (t && t.inventoryTableIngredient) || "Ingrédient";
        const colRemaining = (t && t.inventoryTableRemaining) || "Quantité restante";
        const colMin = (t && t.inventoryMinQty) || "Seuil minimum";
        const colLastShift = (t && t.inventoryTableLastShift) || "Consommation (dernier shift)";
        const colTotal = (t && t.inventoryTableTotal) || "Consommation (total)";
        const colLastUpdate = (t && t.inventoryTableLastUpdate) || "Dernière mise à jour";

        return React.createElement(
          "div",
          null,
          React.createElement(
            "div",
            { style: { fontWeight: 700, marginBottom: 8, fontSize: 13 } },
            title
          ),
          React.createElement(
            "div",
            {
              style: {
                border: "1px solid rgba(148,163,184,0.5)",
                borderRadius: 12,
                overflow: "auto",
                background: "rgba(255,255,255,0.92)"
              }
            },
            React.createElement(
              "table",
              {
                style: {
                  width: "100%",
                  borderCollapse: "collapse",
                  minWidth: isPhone ? 680 : 860
                }
              },
              React.createElement(
                "thead",
                null,
                React.createElement(
                  "tr",
                  null,
                  React.createElement("th", { style: thStyle }, colIngredient),
                  React.createElement("th", { style: thStyle }, colRemaining),
                  React.createElement("th", { style: thStyle }, colMin),
                  React.createElement("th", { style: thStyle }, colLastShift),
                  React.createElement("th", { style: thStyle }, colTotal),
                  React.createElement("th", { style: thStyle }, colLastUpdate)
                )
              ),
              React.createElement(
                "tbody",
                null,
                ingredientIds.map((id) => {
                  const unit = unitForIngredient(id);
                  const packSize =
                    inventory &&
                    inventory[id] &&
                    typeof inventory[id].packSize === "number" &&
                    Number.isFinite(inventory[id].packSize) &&
                    inventory[id].packSize > 0
                      ? inventory[id].packSize
                      : null;
                  const remainingQty = inventory && inventory[id] ? inventory[id].currentQty : null;
                  const minQty = inventory && inventory[id] ? inventory[id].minQty : null;

                  const totalDelta = totalSaleByIngredient[id] || 0;
                  const lastShiftDelta = lastShiftSaleByIngredient[id] || 0;
                  const totalConsumed = totalDelta < 0 ? -totalDelta : 0;
                  const lastShiftConsumed = lastShiftDelta < 0 ? -lastShiftDelta : 0;

                  const lastUpdate = formatDateTime(lastUpdateByIngredient[id]);
                  const low =
                    typeof remainingQty === "number" &&
                    typeof minQty === "number" &&
                    remainingQty <= minQty;

                  return React.createElement(
                    "tr",
                    { key: id, style: low ? { background: "rgba(254, 226, 226, 0.55)" } : null },
                    React.createElement("td", { style: tdStyle }, nameForIngredient(id)),
                    React.createElement(
                      "td",
                      { style: tdStyle },
                      formatQty(remainingQty, unit),
                      " ",
                      unit,
                      packSize && unit === "pcs" && typeof remainingQty === "number"
                        ? " (" + Number(remainingQty / packSize).toFixed(2) + " packs)"
                        : ""
                    ),
                    React.createElement(
                      "td",
                      { style: tdStyle },
                      formatQty(minQty, unit),
                      " ",
                      unit,
                      packSize && unit === "pcs" && typeof minQty === "number"
                        ? " (" + Number(minQty / packSize).toFixed(2) + " packs)"
                        : ""
                    ),
                    React.createElement(
                      "td",
                      { style: tdStyle },
                      formatQty(lastShiftConsumed, unit),
                      " ",
                      unit
                    ),
                    React.createElement(
                      "td",
                      { style: tdStyle },
                      formatQty(totalConsumed, unit),
                      " ",
                      unit
                    ),
                    React.createElement("td", { style: tdStyle }, lastUpdate)
                  );
                })
              )
            )
          )
        );
      }

      function AdminInventoryAlertsReport({ inventory, t, lang, isPhone }) {
        const items = Object.values(inventory || {})
          .filter(Boolean)
          .slice()
          .sort((a, b) => ingredientLabel(a, lang).localeCompare(ingredientLabel(b, lang)));

        const lowStock = items.filter(
          (ing) =>
            ing &&
            typeof ing.currentQty === "number" &&
            typeof ing.minQty === "number" &&
            ing.currentQty <= ing.minQty
        );

        const now = new Date();
        now.setHours(0, 0, 0, 0);
        const MS_DAY = 24 * 60 * 60 * 1000;

        function parseExpiry(ing) {
          const raw = ing && (ing.expiryDate || ing.expiresAt || ing.expireAt);
          if (!raw) return null;
          try {
            const d = new Date(String(raw).slice(0, 10));
            if (!Number.isFinite(d.getTime())) return null;
            d.setHours(0, 0, 0, 0);
            return d;
          } catch (e) {
            return null;
          }
        }

        const expiringSoon = items
          .map((ing) => {
            const d = parseExpiry(ing);
            if (!d) return null;
            const daysLeft = Math.round((d.getTime() - now.getTime()) / MS_DAY);
            return { ing, date: d, daysLeft };
          })
          .filter(Boolean)
          .filter((x) => x.daysLeft <= 7)
          .sort((a, b) => a.daysLeft - b.daysLeft);

        const title = (t && t.inventoryAlertsTitle) || "Rapport stock";
        const lowTitle = (t && t.inventoryLowStockTitle) || "Stock faible";
        const expTitle = (t && t.inventoryExpiringTitle) || "Expire bientôt";
        const noneExpiry = (t && t.inventoryNoExpiryInfo) || "Aucune date d'expiration définie.";

        function fmtQty(v, unit) {
          if (v == null || Number.isNaN(v)) return "";
          if (unit === "pcs") return String(Math.round(v));
          const rounded = Math.round(v * 1000) / 1000;
          return String(rounded).replace(/\.0+$/, "").replace(/(\.\d*[1-9])0+$/, "$1");
        }

        return React.createElement(
          "div",
          { style: { display: "grid", gap: 12 } },
          React.createElement(
            "div",
            { style: { fontWeight: 800, fontSize: 16, color: "#0f172a" } },
            title
          ),
          React.createElement(
            "div",
            { style: { display: "grid", gap: 8 } },
            React.createElement(
              "div",
              { style: { fontWeight: 700 } },
              lowTitle,
              " (",
              String(lowStock.length),
              ")"
            ),
            lowStock.length
              ? React.createElement(
                  "div",
                  {
                    style: {
                      border: "1px solid rgba(148,163,184,0.5)",
                      borderRadius: 12,
                      overflow: "auto",
                      background: "rgba(255,255,255,0.92)"
                    }
                  },
                  React.createElement(
                    "table",
                    { style: { width: "100%", borderCollapse: "collapse", minWidth: isPhone ? 360 : 520 } },
                    React.createElement(
                      "thead",
                      null,
                      React.createElement(
                        "tr",
                        null,
                        React.createElement(
                          "th",
                          {
                            style: {
                              textAlign: lang === "ar" ? "right" : "left",
                              padding: "8px 8px",
                              fontSize: 11,
                              fontWeight: 700,
                              borderBottom: "1px solid rgba(148,163,184,0.6)",
                              background: "rgba(226,232,240,0.8)"
                            }
                          },
                          (t && t.inventoryTableIngredient) || "Ingrédient"
                        ),
                        React.createElement(
                          "th",
                          {
                            style: {
                              textAlign: lang === "ar" ? "right" : "left",
                              padding: "8px 8px",
                              fontSize: 11,
                              fontWeight: 700,
                              borderBottom: "1px solid rgba(148,163,184,0.6)",
                              background: "rgba(226,232,240,0.8)"
                            }
                          },
                          (t && t.inventoryCurrentQty) || "Quantité actuelle"
                        ),
                        React.createElement(
                          "th",
                          {
                            style: {
                              textAlign: lang === "ar" ? "right" : "left",
                              padding: "8px 8px",
                              fontSize: 11,
                              fontWeight: 700,
                              borderBottom: "1px solid rgba(148,163,184,0.6)",
                              background: "rgba(226,232,240,0.8)"
                            }
                          },
                          (t && t.inventoryMinQty) || "Seuil minimum"
                        )
                      )
                    ),
                    React.createElement(
                      "tbody",
                      null,
                      lowStock.map((ing) =>
                        React.createElement(
                          "tr",
                          { key: ing.id },
                          React.createElement(
                            "td",
                            {
                              style: {
                                padding: "7px 8px",
                                fontSize: 11,
                                borderBottom: "1px solid rgba(148,163,184,0.25)"
                              }
                            },
                            ingredientLabel(ing, lang) || ing.id
                          ),
                          React.createElement(
                            "td",
                            {
                              style: {
                                padding: "7px 8px",
                                fontSize: 11,
                                borderBottom: "1px solid rgba(148,163,184,0.25)"
                              }
                            },
                            fmtQty(ing.currentQty, ing.unit),
                            " ",
                            ing.unit
                          ),
                          React.createElement(
                            "td",
                            {
                              style: {
                                padding: "7px 8px",
                                fontSize: 11,
                                borderBottom: "1px solid rgba(148,163,184,0.25)"
                              }
                            },
                            fmtQty(ing.minQty, ing.unit),
                            " ",
                            ing.unit
                          )
                        )
                      )
                    )
                  )
                )
              : React.createElement(
                  "div",
                  { style: { fontSize: 12, color: "#6b7280" } },
                  (t && t.inventoryNoLowStock) || "Aucun article en stock faible."
                )
          ),
          React.createElement(
            "div",
            { style: { display: "grid", gap: 8 } },
            React.createElement(
              "div",
              { style: { fontWeight: 700 } },
              expTitle,
              " (",
              String(expiringSoon.length),
              ")"
            ),
            expiringSoon.length
              ? React.createElement(
                  "div",
                  {
                    style: {
                      border: "1px solid rgba(148,163,184,0.5)",
                      borderRadius: 12,
                      overflow: "auto",
                      background: "rgba(255,255,255,0.92)"
                    }
                  },
                  React.createElement(
                    "table",
                    { style: { width: "100%", borderCollapse: "collapse", minWidth: isPhone ? 420 : 620 } },
                    React.createElement(
                      "thead",
                      null,
                      React.createElement(
                        "tr",
                        null,
                        React.createElement(
                          "th",
                          {
                            style: {
                              textAlign: lang === "ar" ? "right" : "left",
                              padding: "8px 8px",
                              fontSize: 11,
                              fontWeight: 700,
                              borderBottom: "1px solid rgba(148,163,184,0.6)",
                              background: "rgba(226,232,240,0.8)"
                            }
                          },
                          (t && t.inventoryTableIngredient) || "Ingrédient"
                        ),
                        React.createElement(
                          "th",
                          {
                            style: {
                              textAlign: lang === "ar" ? "right" : "left",
                              padding: "8px 8px",
                              fontSize: 11,
                              fontWeight: 700,
                              borderBottom: "1px solid rgba(148,163,184,0.6)",
                              background: "rgba(226,232,240,0.8)"
                            }
                          },
                          (t && t.inventoryExpiryLabel) || "Expiration"
                        ),
                        React.createElement(
                          "th",
                          {
                            style: {
                              textAlign: lang === "ar" ? "right" : "left",
                              padding: "8px 8px",
                              fontSize: 11,
                              fontWeight: 700,
                              borderBottom: "1px solid rgba(148,163,184,0.6)",
                              background: "rgba(226,232,240,0.8)"
                            }
                          },
                          (t && t.inventoryDaysLeft) || "Jours"
                        )
                      )
                    ),
                    React.createElement(
                      "tbody",
                      null,
                      expiringSoon.map((x) => {
                        const ymd = x.date.toISOString().slice(0, 10);
                        const expired = x.daysLeft < 0;
                        const soonStyle = expired
                          ? { background: "rgba(254, 226, 226, 0.65)" }
                          : x.daysLeft <= 3
                          ? { background: "rgba(254, 249, 195, 0.75)" }
                          : null;
                        return React.createElement(
                          "tr",
                          { key: x.ing.id, style: soonStyle },
                          React.createElement(
                            "td",
                            {
                              style: {
                                padding: "7px 8px",
                                fontSize: 11,
                                borderBottom: "1px solid rgba(148,163,184,0.25)"
                              }
                            },
                            ingredientLabel(x.ing, lang) || x.ing.id
                          ),
                          React.createElement(
                            "td",
                            {
                              style: {
                                padding: "7px 8px",
                                fontSize: 11,
                                borderBottom: "1px solid rgba(148,163,184,0.25)"
                              }
                            },
                            ymd
                          ),
                          React.createElement(
                            "td",
                            {
                              style: {
                                padding: "7px 8px",
                                fontSize: 11,
                                borderBottom: "1px solid rgba(148,163,184,0.25)"
                              }
                            },
                            expired ? "EXPIRED" : String(x.daysLeft)
                          )
                        );
                      })
                    )
                  )
                )
              : React.createElement(
                  "div",
                  { style: { fontSize: 12, color: "#6b7280" } },
                  noneExpiry
                )
          )
        );
      }

      function AdminReportsPage({ shifts, orders, inventoryLogs, clientDebts, inventory, t, lang, isPhone }) {
        const [reportMode, setReportMode] = React.useState("shift");
        const [reportShiftId, setReportShiftId] = React.useState(() => {
          const last = (shifts || [])[shifts.length - 1];
          return last && last.id ? last.id : "";
        });
        const [reportFrom, setReportFrom] = React.useState(() =>
          new Date().toISOString().slice(0, 10)
        );
        const [reportTo, setReportTo] = React.useState(() =>
          new Date().toISOString().slice(0, 10)
        );

        const reportCutoff = Date.now() - 72 * 60 * 60 * 1000;
        const recentShiftOptions = (shifts || [])
          .filter((s) => s && shiftTimeMs(s) >= reportCutoff)
          .slice()
          .sort((a, b) => shiftTimeMs(a) - shiftTimeMs(b));
        const recentShiftIds = new Set(recentShiftOptions.map((s) => s && s.id).filter(Boolean));
        const defaultRecentShiftId =
          (recentShiftOptions.length && recentShiftOptions[recentShiftOptions.length - 1] && recentShiftOptions[recentShiftOptions.length - 1].id) ||
          ((shifts || [])[shifts.length - 1] && (shifts || [])[shifts.length - 1].id) ||
          "";

        React.useEffect(() => {
          if (reportShiftId) return;
          const last = (shifts || [])[shifts.length - 1];
          if (last && last.id) setReportShiftId(last.id);
        }, [shifts]);

        React.useEffect(() => {
          if (reportMode !== "shift") return;
          if (!defaultRecentShiftId) return;
          if (!reportShiftId) {
            setReportShiftId(defaultRecentShiftId);
            return;
          }
          if (recentShiftIds.size && !recentShiftIds.has(reportShiftId)) {
            setReportShiftId(defaultRecentShiftId);
          }
        }, [reportMode, reportShiftId, defaultRecentShiftId]);

        function ymd(iso) {
          return String(iso || "").slice(0, 10);
        }

        function inYmdRange(iso, from, to) {
          const d = ymd(iso);
          if (!d || !from || !to) return false;
          return d >= from && d <= to;
        }

        function weekRangeYMD() {
          const now = new Date();
          const day = now.getDay();
          const diff = day === 0 ? -6 : 1 - day;
          const monday = new Date(now);
          monday.setDate(now.getDate() + diff);
          monday.setHours(0, 0, 0, 0);
          const sunday = new Date(monday);
          sunday.setDate(monday.getDate() + 6);
          return {
            from: monday.toISOString().slice(0, 10),
            to: sunday.toISOString().slice(0, 10)
          };
        }

        function monthRangeYMD() {
          const now = new Date();
          const first = new Date(now.getFullYear(), now.getMonth(), 1);
          const last = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          return {
            from: first.toISOString().slice(0, 10),
            to: last.toISOString().slice(0, 10)
          };
        }

        function resolveReportRange() {
          if (reportMode === "custom") return { from: reportFrom, to: reportTo };
          if (reportMode === "week") return weekRangeYMD();
          if (reportMode === "month") return monthRangeYMD();
          const tdy = new Date().toISOString().slice(0, 10);
          return { from: tdy, to: tdy };
        }

        function getReportData() {
          if (reportMode === "shift") {
            const sid =
              reportShiftId || defaultRecentShiftId ||
              (((shifts || [])[shifts.length - 1] && (shifts || [])[shifts.length - 1].id) || "");
            return {
              mode: "shift",
              shiftId: sid,
              range: null,
              shifts: (shifts || []).filter((s) => s && s.id === sid),
              orders: (orders || []).filter((o) => o && o.shiftId === sid),
              inventoryLogs: (inventoryLogs || []).filter((l) => l && l.shiftId === sid),
              clientDebts: (clientDebts || []).filter(
                (d) =>
                  d &&
                  (d.originalShiftId === sid || d.paidShiftId === sid || d.chargedShiftId === sid)
              )
            };
          }

          const range = resolveReportRange();
          return {
            mode: reportMode,
            shiftId: null,
            range,
            shifts: (shifts || []).filter((s) => s && inYmdRange(s.date, range.from, range.to)),
            orders: (orders || []).filter((o) => o && inYmdRange(o.createdAt, range.from, range.to)),
            inventoryLogs: (inventoryLogs || []).filter((l) => l && inYmdRange(l.createdAt, range.from, range.to)),
            clientDebts: (clientDebts || []).filter(
              (d) =>
                d &&
                (inYmdRange(d.createdAt, range.from, range.to) ||
                  inYmdRange(d.paidAt, range.from, range.to) ||
                  inYmdRange(d.chargedAt, range.from, range.to))
            )
          };
        }

        function handleExportExcel() {
          const data = getReportData();
          const XLSX = window.XLSX;
          if (!XLSX || !XLSX.utils) {
            alert("XLSX library not loaded");
            return;
          }

          const confirmed = (data.orders || []).filter(
            (o) => o && (o.status === "paid" || o.status === "unpaid" || o.status === "debt")
          );
          const paid = confirmed.filter((o) => o.status === "paid");
          const unpaid = confirmed.filter((o) => o.status !== "paid");
          const totalRevenue = confirmed.reduce(
            (sum, o) => sum + ((o.totals && o.totals.total) || 0),
            0
          );
          const paidRevenue = paid.reduce(
            (sum, o) => sum + ((o.totals && o.totals.total) || 0),
            0
          );
          const unpaidRevenue = unpaid.reduce(
            (sum, o) => sum + ((o.totals && o.totals.total) || 0),
            0
          );

          const lines = [];
          confirmed.forEach((o) => {
            (o.items || []).forEach((l) => {
              lines.push({
                orderId: o.id,
                shiftId: o.shiftId,
                createdAt: o.createdAt,
                status: o.status,
                productId: l.id,
                name: l.name,
                qty: l.qty,
                price: l.price,
                modifiers: l.modifiers ? JSON.stringify(l.modifiers) : ""
              });
            });
          });

          const wb = XLSX.utils.book_new();
          const summaryRows = [
            {
              mode: data.mode,
              shiftId: data.shiftId || "",
              from: data.range ? data.range.from : "",
              to: data.range ? data.range.to : "",
              totalOrders: confirmed.length,
              paidOrders: paid.length,
              unpaidOrders: unpaid.length,
              totalRevenue,
              paidRevenue,
              unpaidRevenue,
              totalShifts: (data.shifts || []).length,
              totalInventoryLogs: (data.inventoryLogs || []).length
            }
          ];

          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(summaryRows),
            "Résumé"
          );

          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(
              (data.shifts || []).map((s) => ({
                id: s.id,
                date: s.date,
                period: s.period,
                status: s.status,
                openedAt: s.openedAt,
                closedAt: s.closedAt,
                openingFloatCash: typeof s.openingFloatCash === "number" ? s.openingFloatCash : 0,
                closingFloatCash: typeof s.closingFloatCash === "number" ? s.closingFloatCash : 0,
                closingFloatSetAt: s.closingFloatSetAt || "",
                closingFloatConfirmedAt: s.closingFloatConfirmedAt || "",
                closingFloatConfirmedBy: s.closingFloatConfirmedBy || "",
                closingFloatConfirmedValue:
                  typeof s.closingFloatConfirmedValue === "number" ? s.closingFloatConfirmedValue : 0,
                openingExpectedCash: typeof s.openingExpectedCash === "number" ? s.openingExpectedCash : 0,
                revenue: s.revenue,
                orderCount: s.orderCount,
                expectedCash: s.expectedCash,
                openedBy: s.openedBy,
                closedBy: s.closedBy
              }))
            ),
            "Shifts"
          );

          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(
              confirmed.map((o) => ({
                id: o.id,
                ticketCode: o.ticketCode,
                shiftId: o.shiftId,
                status: o.status,
                createdAt: o.createdAt,
                paidAt: o.paidAt,
                cashierId: o.cashierId,
                debtId: o.debtId || "",
                debtCustomerName: o.debtCustomerName || "",
                total: (o.totals && o.totals.total) || 0
              }))
            ),
            "Orders"
          );

          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(lines),
            "OrderLines"
          );

          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(
              (data.inventoryLogs || []).map((l) => ({
                createdAt: l.createdAt,
                ingredientId: l.ingredientId,
                delta: l.delta,
                reason: l.reason,
                shiftId: l.shiftId,
                orderId: l.orderId || "",
                userId: l.userId || "",
                totalCost: typeof l.totalCost === "number" ? l.totalCost : 0,
                unitPrice: typeof l.unitPrice === "number" ? l.unitPrice : ""
              }))
            ),
            "InventoryLogs"
          );

          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(
              (data.clientDebts || []).map((d) => ({
                id: d.id,
                orderId: d.orderId,
                customerName: d.customerName,
                amount: typeof d.amount === "number" ? d.amount : 0,
                waiterId: d.waiterId,
                originalShiftId: d.originalShiftId || "",
                createdAt: d.createdAt || "",
                dueAt: d.dueAt || "",
                paidAt: d.paidAt || "",
                paidBy: d.paidBy || "",
                paidShiftId: d.paidShiftId || "",
                chargedAt: d.chargedAt || "",
                chargedShiftId: d.chargedShiftId || ""
              }))
            ),
            "Debts"
          );

          const base = "cafe_halab_report";
          const suffix =
            data.mode === "shift"
              ? "_" + String(data.shiftId || "shift")
              : "_" +
                String((data.range && data.range.from) || "") +
                "_" +
                String((data.range && data.range.to) || "");
          XLSX.writeFile(wb, base + suffix + ".xlsx");
        }

        const reportData = getReportData();
        const reportConfirmed = (reportData.orders || []).filter(
          (o) => o && (o.status === "paid" || o.status === "unpaid" || o.status === "debt")
        );
        const reportPaid = reportConfirmed.filter((o) => o.status === "paid");

        const reportShiftDate =
          reportData && reportData.mode === "shift"
            ? ((reportData.shifts && reportData.shifts[0] && reportData.shifts[0].date) ||
              ymd(reportConfirmed[0] && reportConfirmed[0].createdAt) ||
              new Date().toISOString().slice(0, 10))
            : null;
        const reportRange = reportData.range ||
          (reportShiftDate ? { from: reportShiftDate, to: reportShiftDate } : null);

        function listDays(from, to, maxDays) {
          if (!from || !to) return [];
          const out = [];
          try {
            const start = new Date(from + "T00:00:00");
            const end = new Date(to + "T00:00:00");
            if (!Number.isFinite(start.getTime()) || !Number.isFinite(end.getTime())) return [];
            const d = new Date(start);
            d.setHours(0, 0, 0, 0);
            const max = typeof maxDays === "number" ? maxDays : 31;
            for (let i = 0; i < max + 1; i++) {
              const key = d.toISOString().slice(0, 10);
              out.push(key);
              if (key >= to) break;
              d.setDate(d.getDate() + 1);
            }
          } catch (e) {}
          return out;
        }

        const dayKeys = reportRange ? listDays(reportRange.from, reportRange.to, 31) : [];
        const daySeries = dayKeys.map((key) => {
          const dayOrders = reportConfirmed.filter(
            (o) => o && ymd(o.createdAt) === key
          );
          const dayPaidOrders = dayOrders.filter((o) => o.status === "paid");
          const dayUnpaidOrders = dayOrders.filter((o) => o.status === "unpaid");
          const dayDebtOrders = dayOrders.filter((o) => o.status === "debt");

          const paidSales = dayPaidOrders.reduce((s, o) => s + ((o.totals && o.totals.total) || 0), 0);
          const paidCount = dayPaidOrders.length;
          const unpaidTotal = dayUnpaidOrders.reduce((s, o) => s + ((o.totals && o.totals.total) || 0), 0);
          const debtOrdersTotal = dayDebtOrders.reduce((s, o) => s + ((o.totals && o.totals.total) || 0), 0);

          const purchases = (reportData.inventoryLogs || [])
            .filter((l) => l && l.reason === "purchase" && ymd(l.createdAt) === key)
            .reduce((s, l) => s + (typeof l.totalCost === "number" ? l.totalCost : 0), 0);

          const debtsPaid = (reportData.clientDebts || [])
            .filter((d) => d && d.paidAt && !d.chargedAt && ymd(d.paidAt) === key)
            .reduce((s, d) => s + (typeof d.amount === "number" ? d.amount : 0), 0);

          const debtsCharged = (reportData.clientDebts || [])
            .filter((d) => d && d.chargedAt && ymd(d.chargedAt) === key)
            .reduce((s, d) => s + (typeof d.amount === "number" ? d.amount : 0), 0);

          return {
            key,
            paidSales,
            paidCount,
            purchases,
            debtsPaid,
            debtsCharged,
            unpaidTotal,
            debtOrdersTotal
          };
        });

        function maxOf(series, field) {
          return (series || []).reduce(
            (m, r) => Math.max(m, typeof r[field] === "number" ? r[field] : 0),
            0
          );
        }

        function renderMiniBars(series, field, max, color) {
          const safeMax = max > 0 ? max : 1;
          const wrapStyle = {
            display: "grid",
            gridTemplateColumns: `repeat(${Math.max(1, (series || []).length)}, minmax(0, 1fr))`,
            gap: 6,
            alignItems: "end",
            height: 110,
            marginTop: 10
          };
          return React.createElement(
            "div",
            { style: wrapStyle },
            (series || []).map((r) => {
              const v = typeof r[field] === "number" ? r[field] : 0;
              const h = Math.max(10, Math.round((v / safeMax) * 110));
              return React.createElement(
                "div",
                {
                  key: r.key,
                  title: `${r.key} · ${Number(v || 0).toFixed(2)}`,
                  style: {
                    height: h,
                    borderRadius: 14,
                    background: color,
                    boxShadow: "0 10px 18px rgba(15,23,42,0.12)"
                  }
                }
              );
            })
          );
        }

        return React.createElement(
          "div",
          { style: { display: "grid", gap: 12 } },
          React.createElement(
            "div",
            {
              style: {
                borderRadius: 12,
                padding: 10,
                border: "1px solid rgba(148,163,184,0.5)",
                background: "rgba(255,255,255,0.92)",
                fontSize: 12
              }
            },
            React.createElement(
              "div",
              { style: { fontWeight: 800, marginBottom: 6 } },
              (t && t.reportExportTitle) || "Extraction"
            ),
            React.createElement(
              "select",
              {
                value: reportMode,
                onChange: (e) => setReportMode(e.target.value),
                style: { width: "100%", padding: 6, fontSize: 12 }
              },
              React.createElement("option", { value: "shift" }, "Shift"),
              React.createElement("option", { value: "week" }, "Semaine"),
              React.createElement("option", { value: "month" }, "Mois"),
              React.createElement("option", { value: "custom" }, "Personnalisé")
            ),
            reportMode === "shift" &&
              React.createElement(
                "select",
                {
                  value: reportShiftId,
                  onChange: (e) => setReportShiftId(e.target.value),
                  style: { width: "100%", padding: 6, fontSize: 12, marginTop: 6 }
                },
                (recentShiftOptions.length ? recentShiftOptions : (shifts || []))
                  .slice()
                  .reverse()
                  .map((s) =>
                    React.createElement(
                      "option",
                      { key: s.id, value: s.id },
                      String(s.date || "") +
                        " " +
                        String(s.period || "") +
                        " (" +
                        String(s.status || "") +
                        ")"
                    )
                  )
              ),
            reportMode === "custom" &&
              React.createElement(
                "div",
                { style: { display: "grid", gap: 6, marginTop: 6 } },
                React.createElement("input", {
                  type: "date",
                  value: reportFrom,
                  onChange: (e) => setReportFrom(e.target.value),
                  style: { padding: 6, fontSize: 12 }
                }),
                React.createElement("input", {
                  type: "date",
                  value: reportTo,
                  onChange: (e) => setReportTo(e.target.value),
                  style: { padding: 6, fontSize: 12 }
                })
              ),
            React.createElement(
              "button",
              {
                className: "category-btn",
                type: "button",
                style: { marginTop: 8, width: "100%" },
                onClick: handleExportExcel
              },
              (t && t.reportExportExcel) || "Exporter Excel (.xlsx)"
            )
          ),
          React.createElement(
            "div",
            { className: "admin-dashboard-grid" },
            (() => {
              const totalPaidSales = reportPaid.reduce(
                (s, o) => s + ((o.totals && o.totals.total) || 0),
                0
              );
              const totalPurchases = (reportData.inventoryLogs || [])
                .filter((l) => l && l.reason === "purchase")
                .reduce((s, l) => s + (typeof l.totalCost === "number" ? l.totalCost : 0), 0);
              const totalDebtsPaid = (reportData.clientDebts || [])
                .filter((d) => d && d.paidAt && !d.chargedAt)
                .reduce((s, d) => s + (typeof d.amount === "number" ? d.amount : 0), 0);
              const totalDebtsCharged = (reportData.clientDebts || [])
                .filter((d) => d && d.chargedAt)
                .reduce((s, d) => s + (typeof d.amount === "number" ? d.amount : 0), 0);
              const totalUnpaid = reportConfirmed
                .filter((o) => o && o.status === "unpaid")
                .reduce((s, o) => s + ((o.totals && o.totals.total) || 0), 0);
              const totalDebtOrders = reportConfirmed
                .filter((o) => o && o.status === "debt")
                .reduce((s, o) => s + ((o.totals && o.totals.total) || 0), 0);

              const maxPaidSales = maxOf(daySeries, "paidSales");
              const maxPurchases = maxOf(daySeries, "purchases");
              const maxDebtsPaid = maxOf(daySeries, "debtsPaid");
              const maxDebtsCharged = maxOf(daySeries, "debtsCharged");
              const maxUnpaid = maxOf(daySeries, "unpaidTotal");
              const maxDebtOrders = maxOf(daySeries, "debtOrdersTotal");

              function card(title, value, bars) {
                return React.createElement(
                  "div",
                  { className: "admin-kpi-card" },
                  React.createElement(
                    "div",
                    { className: "admin-kpi-title" },
                    title
                  ),
                  React.createElement(
                    "div",
                    { className: "admin-kpi-value" },
                    value
                  ),
                  bars
                );
              }

              const salesTitle = lang === "ar" ? "المبيعات (مدفوعة)" : "Ventes (payées)";
              const paidCountTitle = lang === "ar" ? "عدد الطلبات (مدفوعة)" : "Nb commandes (payées)";
              const purchasesTitle = lang === "ar" ? "المشتريات" : "Achats";
              const debtsPaidTitle = lang === "ar" ? "ديون مُحصّلة (نقداً)" : "Dettes payées (cash)";
              const debtsChargedTitle = lang === "ar" ? "ديون مُضافة (48س)" : "Dettes ajoutées (48h)";
              const unpaidTitle = lang === "ar" ? "غير مدفوع" : "Impayés";
              const debtOrdersTitle = lang === "ar" ? "ديون (طلبات)" : "Impayés (dettes)";

              return React.createElement(
                React.Fragment,
                null,
                card(
                  salesTitle,
                  `${Number(totalPaidSales || 0).toFixed(2)} DHS`,
                  daySeries.length ? renderMiniBars(daySeries, "paidSales", maxPaidSales, "rgba(16,185,129,0.85)") : null
                ),
                card(
                  paidCountTitle,
                  String(reportPaid.length),
                  daySeries.length ? renderMiniBars(daySeries, "paidCount", Math.max(1, maxOf(daySeries, "paidCount")), "rgba(37,99,235,0.85)") : null
                ),
                card(
                  purchasesTitle,
                  `${Number(totalPurchases || 0).toFixed(2)} DHS`,
                  daySeries.length ? renderMiniBars(daySeries, "purchases", maxPurchases, "rgba(249,115,22,0.85)") : null
                ),
                card(
                  debtsPaidTitle,
                  `${Number(totalDebtsPaid || 0).toFixed(2)} DHS`,
                  daySeries.length ? renderMiniBars(daySeries, "debtsPaid", maxDebtsPaid, "rgba(34,197,94,0.75)") : null
                ),
                card(
                  debtsChargedTitle,
                  `${Number(totalDebtsCharged || 0).toFixed(2)} DHS`,
                  daySeries.length ? renderMiniBars(daySeries, "debtsCharged", maxDebtsCharged, "rgba(244,63,94,0.75)") : null
                ),
                card(
                  unpaidTitle,
                  `${Number(totalUnpaid || 0).toFixed(2)} DHS`,
                  daySeries.length ? renderMiniBars(daySeries, "unpaidTotal", maxUnpaid, "rgba(148,163,184,0.85)") : null
                ),
                card(
                  debtOrdersTitle,
                  `${Number(totalDebtOrders || 0).toFixed(2)} DHS`,
                  daySeries.length ? renderMiniBars(daySeries, "debtOrdersTotal", maxDebtOrders, "rgba(99,102,241,0.75)") : null
                )
              );
            })()
          ),
          React.createElement(AdminInventoryAlertsReport, { inventory, t, lang, isPhone })
        );
      }

      function FirebaseLoginOverlay({ t, lang, onSignedIn, onDismiss }) {
        const [email, setEmail] = React.useState("");
        const [password, setPassword] = React.useState("");
        const [loading, setLoading] = React.useState(false);
        const [error, setError] = React.useState(null);

        async function handleSubmit(ev) {
          ev.preventDefault();
          if (!window.firebaseAuth) return;
          setLoading(true);
          setError(null);
          try {
            const res = await window.firebaseAuth.signInWithEmailAndPassword(
              String(email || "").trim(),
              String(password || "")
            );
            setPassword("");
            setLoading(false);
            if (onSignedIn) onSignedIn(res && res.user ? res.user : null);
          } catch (e) {
            const msg =
              (e && e.code ? e.code + ": " : "") +
              (e && e.message ? e.message : "");
            setError(msg || "Erreur");
            setLoading(false);
          }
        }

        return React.createElement(
          "div",
          {
            style: {
              position: "fixed",
              inset: 0,
              background: "rgba(15,23,42,0.55)",
              display: "flex",
              alignItems: "center",
              justifyContent: "center",
              padding: 16,
              zIndex: 9999
            }
          },
          React.createElement(
            "section",
            {
              className: "panel",
              style: {
                maxWidth: 460,
                width: "100%",
                textAlign: lang === "ar" ? "right" : "left"
              }
            },
            React.createElement(
              "h3",
              { style: { marginTop: 0 } },
              (t && t.firebaseLoginTitle) || "Connexion Cloud"
            ),
            React.createElement(
              "p",
              { style: { fontSize: 13, marginTop: 6, color: "#334155" } },
              (t && t.firebaseLoginSubtitle) ||
                "Connectez-vous pour synchroniser les données du POS vers le cloud."
            ),
            React.createElement(
              "form",
              {
                onSubmit: handleSubmit,
                style: {
                  display: "flex",
                  flexDirection: "column",
                  gap: 10,
                  marginTop: 12
                }
              },
              React.createElement("input", {
                type: "email",
                autoComplete: "email",
                value: email,
                onChange: (e) => setEmail(e.target.value),
                placeholder: (t && t.firebaseEmailLabel) || "Email",
                style: { padding: 10, fontSize: 14 }
              }),
              React.createElement("input", {
                type: "password",
                autoComplete: "current-password",
                value: password,
                onChange: (e) => setPassword(e.target.value),
                placeholder: (t && t.firebasePasswordLabel) || "Mot de passe",
                style: { padding: 10, fontSize: 14 }
              }),
              React.createElement(
                "div",
                { style: { display: "flex", gap: 8, marginTop: 4 } },
                React.createElement(
                  "button",
                  { className: "btn-primary", type: "submit", disabled: loading },
                  loading
                    ? (t && t.firebaseLoggingIn) || "Connexion..."
                    : (t && t.firebaseLoginBtn) || "Se connecter"
                ),
                React.createElement(
                  "button",
                  {
                    className: "category-btn",
                    type: "button",
                    onClick: onDismiss
                  },
                  (t && t.firebaseOfflineBtn) || "Continuer hors ligne"
                )
              ),
              error &&
                React.createElement(
                  "div",
                  { style: { fontSize: 12, color: "#b91c1c", marginTop: 6 } },
                  error
                )
            )
          )
        );
      }

      function FirebaseAuthBadge({ t, lang, firebaseUser, dismissed, onOpenLogin, onLogout }) {
        const cloudEnabled = !!(window.firebaseDb && firebaseUser);
        const label = cloudEnabled
          ? (t && t.firebaseCloudConnected) || "Cloud: connecté"
          : (t && t.firebaseCloudDisconnected) || "Cloud: non connecté";

        return React.createElement(
          "div",
          {
            style: {
              display: "flex",
              gap: 8,
              alignItems: "center",
              marginLeft: 10,
              padding: "6px 10px",
              borderRadius: 999,
              background: "rgba(15,23,42,0.06)",
              border: "1px solid rgba(148,163,184,0.4)",
              fontSize: 12,
              whiteSpace: "nowrap"
            }
          },
          React.createElement(
            "span",
            { style: { fontWeight: 700 } },
            label
          ),
          firebaseUser &&
            React.createElement(
              "span",
              { style: { color: "#475569" } },
              firebaseUser.email
            ),
          firebaseUser
            ? React.createElement(
                "button",
                { className: "category-btn", onClick: onLogout, type: "button" },
                (t && t.firebaseLogoutBtn) || (lang === "ar" ? "تسجيل الخروج" : "Déconnexion")
              )
            : dismissed
              ? React.createElement(
                  "button",
                  {
                    className: "category-btn",
                    onClick: onOpenLogin,
                    type: "button"
                  },
                  (t && t.firebaseCloudConnectBtn) || (lang === "ar" ? "اتصال" : "Connexion")
                )
              : null
        );
      }

      function AdminInventoryEditor({ inventory, t, onAdjust, onUpdate, lang, isPhone }) {
        const items = Object.values(inventory)
          .slice()
          .sort((a, b) => ingredientLabel(a, lang).localeCompare(ingredientLabel(b, lang)));
        const [selectedId, setSelectedId] = React.useState(items[0]?.id || null);
        const [adjustValue, setAdjustValue] = React.useState("");
        const selected = selectedId ? inventory[selectedId] : null;
        const [currentQty, setCurrentQty] = React.useState(
          selected ? String(selected.currentQty) : ""
        );
        const [minQty, setMinQty] = React.useState(
          selected ? String(selected.minQty) : ""
        );
        const [nameFr, setNameFr] = React.useState(
          selected ? String(selected.nameFr || selected.name || "") : ""
        );
        const [nameAr, setNameAr] = React.useState(
          selected ? String(selected.nameAr || "") : ""
        );
        const [expiryDate, setExpiryDate] = React.useState(
          selected && selected.expiryDate ? String(selected.expiryDate).slice(0, 10) : ""
        );

        React.useEffect(() => {
          const s = selectedId ? inventory[selectedId] : null;
          setCurrentQty(s ? String(s.currentQty) : "");
          setMinQty(s ? String(s.minQty) : "");
          setNameFr(s ? String(s.nameFr || s.name || "") : "");
          setNameAr(s ? String(s.nameAr || "") : "");
          setExpiryDate(s && s.expiryDate ? String(s.expiryDate).slice(0, 10) : "");
        }, [selectedId, inventory]);

        function parseNum(v) {
          const n = Number(String(v).replace(",", "."));
          return Number.isFinite(n) ? n : null;
        }

        function handleAdd() {
          if (!selectedId) return;
          const n = parseNum(adjustValue);
          if (n == null || n <= 0) return;
          onAdjust(selectedId, n);
          setAdjustValue("");
        }

        function handleRemove() {
          if (!selectedId) return;
          const n = parseNum(adjustValue);
          if (n == null || n <= 0) return;
          onAdjust(selectedId, -n);
          setAdjustValue("");
        }

        function handleUpdate() {
          if (!selectedId) return;
          const c = parseNum(currentQty);
          const m = parseNum(minQty);
          if (c == null || m == null) return;
          onUpdate(selectedId, c, m, expiryDate || null, nameFr, nameAr);
        }

        if (!items.length) {
          return React.createElement(
            "div",
            { style: { fontSize: 12 } },
            t.inventorySelectItem || "Sélectionner un article"
          );
        }

        return React.createElement(
          "div",
          {
            style: {
              display: "grid",
              gridTemplateColumns: isPhone ? "1fr" : "minmax(0, 1.4fr) minmax(0, 2fr)",
              gap: 14,
              alignItems: "flex-start"
            }
          },
          React.createElement(
            "div",
            {
              style: {
                borderRadius: 10,
                background: "linear-gradient(145deg,#eef2ff,#e0f2fe)",
                border: "1px solid rgba(129,140,248,0.6)",
                maxHeight: isPhone ? 200 : 260,
                overflowY: "auto"
              }
            },
            items.map((ing) =>
              React.createElement(
                "div",
                {
                  key: ing.id,
                  onClick: () => setSelectedId(ing.id),
                  style: {
                    padding: "8px 10px",
                    cursor: "pointer",
                    fontSize: 12,
                    background:
                      ing.id === selectedId ? "rgba(129,140,248,0.3)" : "transparent"
                  }
                },
                ingredientLabel(ing, lang),
                " (",
                ing.unit,
                ")"
              )
            )
          ),
          React.createElement(
            "div",
            {
              style: {
                borderRadius: 12,
                padding: 10,
                background: "rgba(15,23,42,0.02)",
                border: "1px solid #e5e7eb",
                boxShadow: "0 8px 18px rgba(15,23,42,0.08)"
              }
            },
            React.createElement(
              "h4",
              { style: { marginTop: 0, marginBottom: 6 } },
              (t && t.inventoryEditTitle) || "Modifier"
            ),
            !selected
              ? React.createElement(
                  "div",
                  { style: { fontSize: 12, color: "#6b7280" } },
                  t.inventorySelectItem || "Sélectionner un article"
                )
              : React.createElement(
                  "div",
                  null,
                  React.createElement(
                    "div",
                    { style: { marginBottom: 8, fontSize: 12 } },
                    "Article: ",
                    ingredientLabel(selected, lang),
                    selected.unit ? " (" + selected.unit + ")" : ""
                  ),
                  React.createElement(
                    "div",
                    { style: { display: "grid", gap: 8, marginBottom: 10 } },
                    React.createElement(
                      "div",
                      { style: { display: "grid", gap: 6 } },
                      React.createElement(
                        "div",
                        { style: { fontSize: 12, fontWeight: 800 } },
                        lang === "ar" ? "الاسم بالفرنسية" : "Nom (FR)"
                      ),
                      React.createElement("input", {
                        value: nameFr,
                        onChange: (e) => setNameFr(e.target.value),
                        placeholder: lang === "ar" ? "الاسم بالفرنسية" : "Nom en français",
                        style: { padding: 8, fontSize: 12, borderRadius: 10, border: "1px solid #e5e7eb" }
                      })
                    ),
                    React.createElement(
                      "div",
                      { style: { display: "grid", gap: 6 } },
                      React.createElement(
                        "div",
                        { style: { fontSize: 12, fontWeight: 800 } },
                        lang === "ar" ? "الاسم بالعربية" : "Nom (AR)"
                      ),
                      React.createElement("input", {
                        value: nameAr,
                        onChange: (e) => setNameAr(e.target.value),
                        placeholder: lang === "ar" ? "الاسم بالعربية" : "Nom en arabe",
                        style: {
                          padding: 8,
                          fontSize: 12,
                          borderRadius: 10,
                          border: "1px solid #e5e7eb",
                          direction: "rtl"
                        }
                      })
                    )
                  ),
                  React.createElement(
                    "div",
                    { style: { display: "grid", gap: 8 } },
                    React.createElement(
                      "div",
                      null,
                      React.createElement(
                        "div",
                        { style: { fontWeight: 600, marginBottom: 2 } },
                        (t && t.inventoryCurrentQty) || "Quantité actuelle"
                      ),
                      React.createElement("input", {
                        value: currentQty,
                        onChange: (e) => setCurrentQty(e.target.value),
                        style: { width: "100%", padding: 4, fontSize: 12 }
                      })
                    ),
                    React.createElement(
                      "div",
                      null,
                      React.createElement(
                        "div",
                        { style: { fontWeight: 600, marginBottom: 2 } },
                        (t && t.inventoryMinQty) || "Seuil minimum"
                      ),
                      React.createElement("input", {
                        value: minQty,
                        onChange: (e) => setMinQty(e.target.value),
                        style: { width: "100%", padding: 4, fontSize: 12 }
                      })
                    ),
                    React.createElement(
                      "div",
                      null,
                      React.createElement(
                        "div",
                        { style: { fontWeight: 600, marginBottom: 2 } },
                        (t && t.inventoryExpiryLabel) || "Expiration"
                      ),
                      React.createElement("input", {
                        type: "date",
                        value: expiryDate,
                        onChange: (e) => setExpiryDate(e.target.value),
                        style: { width: "100%", padding: 4, fontSize: 12 }
                      })
                    ),
                    React.createElement(
                      "div",
                      null,
                      React.createElement(
                        "div",
                        { style: { fontWeight: 600, marginBottom: 2 } },
                        (t && t.inventoryAdjustLabel) || "Ajustement"
                      ),
                      React.createElement("input", {
                        value: adjustValue,
                        onChange: (e) => setAdjustValue(e.target.value),
                        style: { width: "100%", padding: 4, fontSize: 12 }
                      }),
                      React.createElement(
                        "div",
                        {
                          style: {
                            display: "flex",
                            gap: 6,
                            marginTop: 6,
                            flexWrap: "wrap"
                          }
                        },
                        React.createElement(
                          "button",
                          {
                            type: "button",
                            className: "btn-primary",
                            onClick: handleAdd
                          },
                          (t && t.inventoryAddBtn) || "Ajouter"
                        ),
                        React.createElement(
                          "button",
                          {
                            type: "button",
                            className: "btn-warning",
                            onClick: handleRemove
                          },
                          (t && t.inventoryRemoveBtn) || "Retirer"
                        )
                      )
                    ),
                    React.createElement(
                      "button",
                      {
                        type: "button",
                        className: "btn-primary",
                        style: { marginTop: 8 },
                        onClick: handleUpdate
                      },
                      (t && t.inventoryUpdateBtn) || "Mettre à jour"
                    )
                  )
                )
          )
        );
      }

      function AdminShiftPanel(props) {
        return React.createElement(ShiftPanel, props);
      }

      function ShiftPanel({
        currentUser,
        activeShift,
        shifts,
        onOpenShift,
        onCloseShift
      }) {
        const [period, setPeriod] = React.useState("morning");
        const today = new Date().toISOString().slice(0, 10);

        if (
          !currentUser ||
          (currentUser.role !== "manager" && currentUser.role !== "admin")
        ) {
          return React.createElement(
            "p",
            { style: { fontSize: 12 } },
            "Admin seulement."
          );
        }

        const lastShifts = shifts.slice(-5).reverse();

        function handleOpen() {
          onOpenShift(today, period);
        }

        function handleClose() {
          onCloseShift();
        }

        return React.createElement(
          "div",
          null,
          React.createElement(
            "h3",
            null,
            "Shift du jour: " + today
          ),
          React.createElement(
            "div",
            { style: { marginBottom: 8 } },
            activeShift
              ? "Ouvert: " + activeShift.date + " (" + activeShift.period + ")"
              : "Aucun shift ouvert"
          ),
          !activeShift &&
            React.createElement(
              "div",
              { style: { display: "flex", gap: 4, marginBottom: 8 } },
              React.createElement(
                "select",
                {
                  value: period,
                  onChange: (e) => setPeriod(e.target.value),
                  style: { padding: 4, fontSize: 12 }
                },
                React.createElement("option", { value: "morning" }, "Matin"),
                React.createElement(
                  "option",
                  { value: "afternoon" },
                  "Après-midi"
                )
              ),
              React.createElement(
                "button",
                {
                  className: "btn-primary",
                  type: "button",
                  onClick: handleOpen
                },
                "Ouvrir shift"
              )
            ),
          handoffOpen &&
            e(
              "div",
              {
                style: {
                  position: "fixed",
                  inset: 0,
                  background: "rgba(15,23,42,0.55)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  padding: 16,
                  zIndex: 56
                }
              },
              e(
                "section",
                { className: "panel", style: { maxWidth: 520, width: "100%" } },
                e(
                  "h3",
                  { style: { marginTop: 0 } },
                  lang === "ar" ? "تسليم النادل" : "Passation (handoff)"
                ),
                e(
                  "p",
                  { style: { fontSize: 13, marginTop: 6 } },
                  lang === "ar"
                    ? "يتطلب موافقة المدير وتأكيد المبلغ من الطرفين."
                    : "Nécessite l'accord admin et la confirmation du montant par les deux employés."
                ),
                e(
                  "form",
                  { onSubmit: confirmHandoff, style: { display: "grid", gap: 10, marginTop: 10 } },
                  e(
                    "select",
                    {
                      value: handoffToWorkerId,
                      onChange: (ev) => setHandoffToWorkerId(ev.target.value),
                      style: { padding: 10, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                    },
                    e("option", { value: "" }, lang === "ar" ? "اختر الموظف" : "Choisir l'employé"),
                    (users || [])
                      .filter((u) => u && u.role === "worker" && u.posAccess !== false && activeWorker && u.id !== activeWorker.id)
                      .map((u) => e("option", { key: u.id, value: u.id }, String(u.name || u.id)))
                  ),
                  e(
                    "div",
                    { style: { display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 } },
                    e("input", {
                      type: "password",
                      value: handoffFromPin,
                      onChange: (ev) => setHandoffFromPin(ev.target.value),
                      placeholder: lang === "ar" ? "PIN الموظف الحالي" : "PIN sortant",
                      style: { padding: 10, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                    }),
                    e("input", {
                      type: "password",
                      value: handoffToPin,
                      onChange: (ev) => setHandoffToPin(ev.target.value),
                      placeholder: lang === "ar" ? "PIN الموظف القادم" : "PIN entrant",
                      style: { padding: 10, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                    })
                  ),
                  e(
                    "div",
                    { style: { display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 } },
                    e("input", {
                      value: handoffFromAmount,
                      onChange: (ev) => setHandoffFromAmount(ev.target.value),
                      inputMode: "decimal",
                      placeholder: lang === "ar" ? "المبلغ المتوقع (خارج)" : "Cash attendu (sortant)",
                      style: { padding: 10, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                    }),
                    e("input", {
                      value: handoffToAmount,
                      onChange: (ev) => setHandoffToAmount(ev.target.value),
                      inputMode: "decimal",
                      placeholder: lang === "ar" ? "المبلغ المتوقع (داخل)" : "Cash attendu (entrant)",
                      style: { padding: 10, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                    })
                  ),
                  handoffError &&
                    e(
                      "div",
                      { style: { fontSize: 12, color: "#b91c1c" } },
                      handoffError
                    ),
                  e(
                    "div",
                    { style: { display: "flex", gap: 8, justifyContent: "flex-end" } },
                    e(
                      "button",
                      { className: "category-btn", type: "button", onClick: closeHandoffPrompt },
                      (t && t.cancelBtn) || (lang === "ar" ? "إلغاء" : "Annuler")
                    ),
                    e(
                      "button",
                      { className: "btn-primary", type: "submit", disabled: !(adminUser && adminUser.role === "admin") },
                      lang === "ar" ? "تأكيد" : "Confirmer"
                    )
                  )
                )
              )
            ),
          activeShift &&
            React.createElement(
              "button",
              {
                className: "btn-primary",
                type: "button",
                onClick: handleClose
              },
              "Fermer shift"
            ),
          React.createElement("hr", { style: { margin: "10px 0" } }),
          React.createElement("h4", null, "Derniers shifts"),
          lastShifts.length === 0
            ? React.createElement(
                "p",
                { style: { fontSize: 12 } },
                "Aucun shift."
              )
            : lastShifts.map((s) =>
                React.createElement(
                  "div",
                  { key: s.id, style: { fontSize: 12, marginBottom: 4 } },
                  s.date,
                  " ",
                  s.period,
                  " | statut: ",
                  s.status,
                  " | commandes: ",
                  s.orderCount,
                  " | CA: ",
                  s.revenue.toFixed(2),
                  " DHS | cash attendu: ",
                  s.expectedCash.toFixed(2),
                  " DHS"
                )
              )
        );
      }

      function ManagerStats({ shifts, orders, inventoryLogs, inventory, isPhone }) {
        if (!shifts.length) {
          return React.createElement(
            "p",
            { style: { fontSize: 12 } },
            "Aucun shift."
          );
        }

        function unitForIngredient(id) {
          return inventory && inventory[id] ? inventory[id].unit : "";
        }

        function getShiftStats(shift) {
          const shiftOrders = orders.filter((o) => o.shiftId === shift.id);
          const paidOrders = shiftOrders.filter((o) => o.status === "paid");
          const revenue = paidOrders.reduce(
            (sum, o) => sum + o.totals.total,
            0
          );
          const orderCount = paidOrders.length;
          const expectedCash =
            typeof shift.expectedCash === "number" ? shift.expectedCash : revenue;

          const logs = inventoryLogs.filter(
            (log) => log.shiftId === shift.id && log.reason === "sale"
          );
          const byIngredient = {};
          logs.forEach((log) => {
            byIngredient[log.ingredientId] =
              (byIngredient[log.ingredientId] || 0) + log.delta;
          });

          return { revenue, orderCount, expectedCash, byIngredient };
        }

        return React.createElement(
          "div",
          null,
          shifts
            .slice()
            .reverse()
            .map((shift) => {
              const stats = getShiftStats(shift);
              return React.createElement(
                "div",
                {
                  key: shift.id,
                  style: {
                    borderRadius: 12,
                    padding: 10,
                    marginBottom: 10,
                    background:
                      "linear-gradient(135deg, rgba(56,189,248,0.1), rgba(59,130,246,0.16))",
                    border: "1px solid rgba(59,130,246,0.35)",
                    boxShadow: "0 10px 24px rgba(15,23,42,0.15)"
                  }
                },
                React.createElement(
                  "div",
                  { style: { fontSize: 13, fontWeight: 600 } },
                  shift.date,
                  " ",
                  shift.period,
                  " (",
                  shift.status,
                  ")"
                ),
                React.createElement(
                  "div",
                  { style: { fontSize: 12, marginTop: 4 } },
                  "Commandes payées: ",
                  stats.orderCount,
                  " | CA: ",
                  stats.revenue.toFixed(2),
                  " DHS | Cash attendu: ",
                  stats.expectedCash.toFixed(2),
                  " DHS"
                ),
                React.createElement(
                  "div",
                  { style: { marginTop: 6, fontSize: 12 } },
                  "Consommation stock:"
                ),
                Object.keys(stats.byIngredient).length === 0
                  ? React.createElement(
                      "div",
                      { style: { fontSize: 11 } },
                      "Aucun mouvement."
                    )
                  : Object.entries(stats.byIngredient).map(([ingId, delta]) =>
                      React.createElement(
                        "div",
                        { key: ingId, style: { fontSize: 11 } },
                        ingId,
                        ": ",
                        delta,
                        " ",
                        unitForIngredient(ingId)
                      )
                    )
              );
            })
        );
      }

      function AdminStaffPanel({ users, advances, lang, t, onUpsertUser, onDeleteUser, onChangePin, onApproveAdvance, onRejectAdvance, onCreateAdvance, isPhone }) {
        const workers = (users || []).filter((u) => u && u.role === "worker");
        const managers = (users || []).filter((u) => u && u.role === "manager");
        const admins = (users || []).filter((u) => u && u.role === "admin");

        const [edit, setEdit] = React.useState(() => {
          const next = {};
          workers.forEach((u) => {
            next[u.id] = {
              name: u.name != null ? String(u.name) : "",
              pin: u.pin != null ? String(u.pin) : "",
              inventoryAccess: u && u.inventoryAccess === true ? "yes" : "no",
              salary: typeof u.salary === "number" ? String(u.salary) : "0",
              posAccess: u.posAccess === false ? "no" : "yes",
              cycleStartDate: u.cycleStartDate ? String(u.cycleStartDate) : ""
            };
          });
          return next;
        });

        const [newName, setNewName] = React.useState("");
        const [newPin, setNewPin] = React.useState("");
        const [newInventoryAccess, setNewInventoryAccess] = React.useState("no");
        const [newSalary, setNewSalary] = React.useState("0");
        const [newPosAccess, setNewPosAccess] = React.useState("yes");
        const [newCycleStartDate, setNewCycleStartDate] = React.useState(() => new Date().toISOString().slice(0, 10));
        const [newErr, setNewErr] = React.useState(null);

        const [draftAdv, setDraftAdv] = React.useState(() => ({}));

        React.useEffect(() => {
          const next = {};
          workers.forEach((u) => {
            next[u.id] = {
              name: u.name != null ? String(u.name) : "",
              pin: u.pin != null ? String(u.pin) : "",
              inventoryAccess: u && u.inventoryAccess === true ? "yes" : "no",
              salary: typeof u.salary === "number" ? String(u.salary) : "0",
              posAccess: u.posAccess === false ? "no" : "yes",
              cycleStartDate: u.cycleStartDate ? String(u.cycleStartDate) : ""
            };
          });
          setEdit(next);
        }, [users]);

        function parseNum(v) {
          const n = Number(String(v == null ? "" : v).replace(",", "."));
          return Number.isFinite(n) ? n : null;
        }

        const approved = (advances || []).filter((a) => a && a.status === "approved");
        const pending = (advances || []).filter((a) => a && a.status === "pending");

        const posWorkers = workers.filter((u) => u && u.posAccess !== false);
        const nonPosWorkers = workers.filter((u) => u && u.posAccess === false);

        function salaryPeriodKeyFor(user, atIso) {
          const r = salaryPeriodRangeForUser(user, atIso);
          return r.from + "|" + r.to;
        }

        function salaryMonthIndexFor(user, periodFromYmd) {
          const start = parseYmdParts(user && user.cycleStartDate ? user.cycleStartDate : null);
          const cur = parseYmdParts(periodFromYmd);
          if (!start || !cur) return 1;
          return (cur.y * 12 + cur.mo) - (start.y * 12 + start.mo) + 1;
        }

        function rangeLabel(fromYmd, toYmd) {
          try {
            const df = new Date(String(fromYmd || "") + "T00:00:00Z");
            const dt = new Date(String(toYmd || "") + "T00:00:00Z");
            const locale = lang === "ar" ? "ar-MA" : "fr-FR";
            const a = df.toLocaleDateString(locale, { year: "numeric", month: "short", day: "2-digit" });
            const b = dt.toLocaleDateString(locale, { year: "numeric", month: "short", day: "2-digit" });
            return a + " → " + b;
          } catch (e) {
            return String(fromYmd || "") + " → " + String(toYmd || "");
          }
        }

        function userNameById(id) {
          const u = (users || []).find((x) => x && x.id === id);
          return u ? u.name : id || "";
        }

        function fmt(iso) {
          try {
            if (!iso) return "";
            const d = new Date(iso);
            return d.toLocaleString(lang === "ar" ? "ar-MA" : "fr-FR", {
              year: "2-digit",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit"
            });
          } catch (e) {
            return String(iso || "");
          }
        }

        function buildWorkerId(name) {
          const base = String(name || "worker").trim().toLowerCase().replace(/\s+/g, "_").replace(/[^a-z0-9_]/g, "");
          return "worker_" + (base || "user") + "_" + String(Date.now());
        }

        function handleCreateWorker() {
          if (!onUpsertUser) return;
          const nm = String(newName || "").trim();
          const pn = String(newPin || "").trim();
          const sal = parseNum(newSalary);
          const posAccess = String(newPosAccess || "yes") !== "no";
          const inventoryAccess = posAccess && String(newInventoryAccess || "no") === "yes";
          const startYmd = String(newCycleStartDate || "").trim();
          if (!nm) {
            setNewErr(lang === "ar" ? "الاسم مطلوب" : "Nom requis");
            return;
          }
          if (posAccess && !pn) {
            setNewErr(lang === "ar" ? "PIN مطلوب" : "PIN requis");
            return;
          }
          if (sal == null || sal < 0) {
            setNewErr(lang === "ar" ? "راتب غير صالح" : "Salaire invalide");
            return;
          }
          if (!parseYmdParts(startYmd)) {
            setNewErr(lang === "ar" ? "تاريخ البداية غير صالح" : "Date début invalide");
            return;
          }
          const id = buildWorkerId(nm);
          setNewErr(null);
          setNewName("");
          setNewPin("");
          setNewInventoryAccess("no");
          setNewSalary("0");
          setNewPosAccess("yes");
          setNewCycleStartDate(new Date().toISOString().slice(0, 10));
          onUpsertUser({ id, role: "worker", name: nm, pin: posAccess ? pn : "", inventoryAccess: inventoryAccess, salary: sal, posAccess: posAccess, cycleStartDate: startYmd });
        }

        function handleSaveWorker(id) {
          if (!onUpsertUser) return;
          const row = edit && Object.prototype.hasOwnProperty.call(edit, id) ? edit[id] : null;
          if (!row) return;
          const nm = String(row.name || "").trim();
          const pn = String(row.pin || "").trim();
          const sal = parseNum(row.salary);
          const posAccess = String(row.posAccess || "yes") !== "no";
          const inventoryAccess = posAccess && String(row.inventoryAccess || "no") === "yes";
          const startYmd = String(row.cycleStartDate || "").trim();
          if (!nm || (posAccess && !pn) || sal == null || sal < 0) return;
          if (!parseYmdParts(startYmd)) return;
          onUpsertUser({ id, role: "worker", name: nm, pin: posAccess ? pn : "", inventoryAccess: inventoryAccess, salary: sal, posAccess: posAccess, cycleStartDate: startYmd });
        }

        const title = (t && t.staffTitle) || (lang === "ar" ? "الموظفون" : "Staff");
        const advancesTitle = lang === "ar" ? "طلبات السلف" : "Demandes d'avance";
        const waitersTitle = lang === "ar" ? "النوادل (POS)" : "Serveurs (POS)";
        const otherWorkersTitle = lang === "ar" ? "العمال (بدون POS)" : "Employés (sans POS)";
        const managersTitle = lang === "ar" ? "المدير" : "Manager";
        const adminsTitle = lang === "ar" ? "المدراء" : "Admins";

        return React.createElement(
          "div",
          { style: { display: "grid", gap: 14 } },
          React.createElement("div", { style: { fontWeight: 900, fontSize: 16 } }, title),
          React.createElement(
            "div",
            { style: { display: "grid", gap: 8 } },
            React.createElement(
              "div",
              { style: { fontWeight: 800 } },
              advancesTitle,
              " (",
              String(pending.length),
              ")"
            ),
            pending.length
              ? React.createElement(
                  "div",
                  { style: { display: "grid", gap: 8 } },
                  pending
                    .slice()
                    .reverse()
                    .slice(0, 12)
                    .map((a) =>
                      React.createElement(
                        "div",
                        {
                          key: a.id,
                          style: {
                            padding: 10,
                            borderRadius: 12,
                            border: "1px solid rgba(251,146,60,0.45)",
                            background: "rgba(255,247,237,0.9)",
                            display: "flex",
                            justifyContent: "space-between",
                            alignItems: "center",
                            gap: 10
                          }
                        },
                        React.createElement(
                          "div",
                          { style: { display: "grid", gap: 2 } },
                          React.createElement(
                            "div",
                            { style: { fontWeight: 900, fontSize: 12 } },
                            String(userNameById(a.workerId) || ""),
                            " · ",
                            Number(typeof a.amount === "number" ? a.amount : 0).toFixed(2),
                            " DHS"
                          ),
                          React.createElement(
                            "div",
                            { style: { fontSize: 11, color: "#6b7280", fontWeight: 800 } },
                            "Shift: ",
                            String(a.shiftId || ""),
                            " · ",
                            fmt(a.requestedAt)
                          )
                        ),
                        React.createElement(
                          "div",
                          { style: { display: "flex", gap: 8, alignItems: "center" } },
                          React.createElement(
                            "button",
                            {
                              className: "btn-primary",
                              type: "button",
                              onClick: () => onApproveAdvance && onApproveAdvance(a.id)
                            },
                            lang === "ar" ? "موافقة" : "Approuver"
                          ),
                          React.createElement(
                            "button",
                            {
                              className: "category-btn",
                              type: "button",
                              onClick: () => onRejectAdvance && onRejectAdvance(a.id)
                            },
                            lang === "ar" ? "رفض" : "Rejeter"
                          )
                        )
                      )
                    )
                )
              : React.createElement(
                  "div",
                  { style: { fontSize: 12, color: "#64748b" } },
                  lang === "ar" ? "لا توجد طلبات." : "Aucune demande."
                )
          ),
          React.createElement(
            "div",
            { style: { display: "grid", gap: 10 } },
            React.createElement("div", { style: { fontWeight: 800 } }, waitersTitle),
            React.createElement(
              "div",
              {
                style: {
                  padding: 10,
                  borderRadius: 12,
                  border: "1px solid rgba(148,163,184,0.45)",
                  background: "rgba(255,255,255,0.9)",
                  display: "grid",
                  gap: 8
                }
              },
              React.createElement(
                "div",
                { style: { fontSize: 12, fontWeight: 900 } },
                lang === "ar" ? "إضافة موظف" : "Ajouter un employé"
              ),
              React.createElement(
                "div",
                {
                  style: {
                    display: "grid",
                    gridTemplateColumns: isPhone ? "1fr" : "1fr 140px 140px 120px 140px 170px 140px",
                    gap: 8
                  }
                },
                React.createElement("input", {
                  value: newName,
                  onChange: (e) => setNewName(e.target.value),
                  placeholder: lang === "ar" ? "الاسم" : "Nom",
                  style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                }),
                React.createElement(
                  "select",
                  {
                    value: newPosAccess,
                    onChange: (e) => setNewPosAccess(e.target.value),
                    style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)", fontSize: 12 }
                  },
                  React.createElement("option", { value: "yes" }, lang === "ar" ? "نادل (POS)" : "Serveur (POS)"),
                  React.createElement("option", { value: "no" }, lang === "ar" ? "عامل (بدون POS)" : "Employé (sans POS)" )
                ),
                React.createElement(
                  "select",
                  {
                    value: newInventoryAccess,
                    onChange: (e) => setNewInventoryAccess(e.target.value),
                    disabled: String(newPosAccess || "yes") === "no",
                    style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)", fontSize: 12 }
                  },
                  React.createElement("option", { value: "no" }, lang === "ar" ? "مخزون: لا" : "Stock: Non"),
                  React.createElement("option", { value: "yes" }, lang === "ar" ? "مخزون: نعم" : "Stock: Oui")
                ),
                React.createElement("input", {
                  value: newPin,
                  onChange: (e) => setNewPin(e.target.value),
                  placeholder: "PIN",
                  disabled: String(newPosAccess || "yes") === "no",
                  style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                }),
                React.createElement("input", {
                  value: newSalary,
                  onChange: (e) => setNewSalary(e.target.value),
                  placeholder: lang === "ar" ? "الراتب" : "Salaire",
                  style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                }),
                React.createElement("input", {
                  type: "date",
                  value: newCycleStartDate,
                  onChange: (e) => setNewCycleStartDate(e.target.value),
                  style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                }),
                React.createElement(
                  "button",
                  { className: "btn-primary", type: "button", onClick: handleCreateWorker },
                  lang === "ar" ? "إضافة" : "Ajouter"
                )
              ),
              newErr && React.createElement("div", { style: { fontSize: 12, color: "#b91c1c" } }, newErr)
            ),
            posWorkers.length
              ? React.createElement(
                  "div",
                  { style: { display: "grid", gap: 8 } },
                  posWorkers.map((u) => {
                    const row = edit && Object.prototype.hasOwnProperty.call(edit, u.id) ? edit[u.id] : null;
                    const nowIso = new Date().toISOString();
                    const pr = salaryPeriodRangeForUser(u, nowIso);
                    const fromYmd = pr.from;
                    const toYmd = pr.to;
                    const monthIndex = salaryMonthIndexFor(u, fromYmd);

                    const taken = approved.reduce((s, a) => {
                      if (!a || a.workerId !== u.id) return s;
                      if (a.salaryPeriodFrom && a.salaryPeriodTo) {
                        if (a.salaryPeriodFrom !== fromYmd || a.salaryPeriodTo !== toYmd) return s;
                      } else {
                        const d = isoToYmd(a.requestedAt);
                        if (!(d && d >= fromYmd && d <= toYmd)) return s;
                      }
                      const amt = typeof a.amount === "number" ? a.amount : 0;
                      return s + amt;
                    }, 0);

                    const pendingAmt = pending.reduce((s, a) => {
                      if (!a || a.workerId !== u.id) return s;
                      if (a.salaryPeriodFrom && a.salaryPeriodTo) {
                        if (a.salaryPeriodFrom !== fromYmd || a.salaryPeriodTo !== toYmd) return s;
                      } else {
                        const d = isoToYmd(a.requestedAt);
                        if (!(d && d >= fromYmd && d <= toYmd)) return s;
                      }
                      const amt = typeof a.amount === "number" ? a.amount : 0;
                      return s + amt;
                    }, 0);

                    const salaryVal = typeof u.salary === "number" ? u.salary : 0;
                    const remaining = salaryVal - taken;
                    const advDraft = draftAdv && Object.prototype.hasOwnProperty.call(draftAdv, u.id) ? draftAdv[u.id] : "";
                    return React.createElement(
                      "div",
                      {
                        key: u.id,
                        style: {
                          padding: 10,
                          borderRadius: 12,
                          border: "1px solid rgba(148,163,184,0.35)",
                          background: "rgba(255,255,255,0.85)",
                          display: "grid",
                          gap: 8
                        }
                      },
                      React.createElement(
                        "div",
                        {
                          style: {
                            display: "grid",
                            gridTemplateColumns: isPhone ? "1fr" : "1fr 140px 140px 120px 140px 170px 1fr",
                            gap: 8,
                            alignItems: isPhone ? "stretch" : "center"
                          }
                        },
                        React.createElement("input", {
                          value: row ? row.name : String(u.name || ""),
                          onChange: (e) =>
                            setEdit((p) => ({
                              ...(p || {}),
                              [u.id]: { ...(p && p[u.id] ? p[u.id] : {}), name: e.target.value }
                            })),
                          style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                        }),
                        React.createElement(
                          "select",
                          {
                            value: row ? row.posAccess : (u.posAccess === false ? "no" : "yes"),
                            onChange: (e) =>
                              setEdit((p) => ({
                                ...(p || {}),
                                [u.id]: { ...(p && p[u.id] ? p[u.id] : {}), posAccess: e.target.value }
                              })),
                            style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)", fontSize: 12 }
                          },
                          React.createElement("option", { value: "yes" }, lang === "ar" ? "نادل" : "POS"),
                          React.createElement("option", { value: "no" }, lang === "ar" ? "عامل" : "No POS")
                        ),
                        React.createElement(
                          "select",
                          {
                            value: row ? row.inventoryAccess : (u && u.inventoryAccess === true ? "yes" : "no"),
                            onChange: (e) =>
                              setEdit((p) => ({
                                ...(p || {}),
                                [u.id]: { ...(p && p[u.id] ? p[u.id] : {}), inventoryAccess: e.target.value }
                              })),
                            disabled: String(row ? row.posAccess : (u.posAccess === false ? "no" : "yes")) === "no",
                            style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)", fontSize: 12 }
                          },
                          React.createElement("option", { value: "no" }, lang === "ar" ? "مخزون: لا" : "Stock: Non"),
                          React.createElement("option", { value: "yes" }, lang === "ar" ? "مخزون: نعم" : "Stock: Oui")
                        ),
                        React.createElement("input", {
                          value: row ? row.pin : String(u.pin || ""),
                          onChange: (e) =>
                            setEdit((p) => ({
                              ...(p || {}),
                              [u.id]: { ...(p && p[u.id] ? p[u.id] : {}), pin: e.target.value }
                            })),
                          placeholder: "PIN",
                          disabled: String(row ? row.posAccess : (u.posAccess === false ? "no" : "yes")) === "no",
                          style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                        }),
                        React.createElement("input", {
                          value: row ? row.salary : String(typeof u.salary === "number" ? u.salary : 0),
                          onChange: (e) =>
                            setEdit((p) => ({
                              ...(p || {}),
                              [u.id]: { ...(p && p[u.id] ? p[u.id] : {}), salary: e.target.value }
                            })),
                          placeholder: lang === "ar" ? "الراتب" : "Salaire",
                          style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                        }),
                        React.createElement("input", {
                          type: "date",
                          value: row ? row.cycleStartDate : String(u.cycleStartDate || ""),
                          onChange: (e) =>
                            setEdit((p) => ({
                              ...(p || {}),
                              [u.id]: { ...(p && p[u.id] ? p[u.id] : {}), cycleStartDate: e.target.value }
                            })),
                          style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                        }),
                        React.createElement(
                          "div",
                          { style: { fontSize: 11, color: "#334155", fontWeight: 800 } },
                          (lang === "ar" ? "الفترة " : "Période "),
                          String(monthIndex),
                          ": ",
                          rangeLabel(fromYmd, toYmd),
                          " | ",
                          (lang === "ar" ? "مأخوذ: " : "Pris: "),
                          Number(taken || 0).toFixed(2),
                          " DHS",
                          pendingAmt > 0
                            ? (lang === "ar" ? " | قيد الانتظار: " : " | En attente: ") + Number(pendingAmt || 0).toFixed(2) + " DHS"
                            : "",
                          " | ",
                          (lang === "ar" ? "متبقي: " : "Reste: "),
                          Number(remaining || 0).toFixed(2),
                          " DHS"
                        )
                      ),
                      React.createElement(
                        "div",
                        { style: { display: "flex", gap: 8, justifyContent: "flex-end", alignItems: "center", flexWrap: "wrap" } },
                        React.createElement("input", {
                          value: advDraft,
                          onChange: (e) => setDraftAdv((p) => ({ ...(p || {}), [u.id]: e.target.value })),
                          placeholder: lang === "ar" ? "سلفة" : "Avance",
                          style: { width: 120, padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                        }),
                        React.createElement(
                          "button",
                          {
                            className: "category-btn",
                            type: "button",
                            disabled: !onCreateAdvance,
                            onClick: () => {
                              const amt = parseNum(advDraft);
                              if (amt == null || amt <= 0) return;
                              setDraftAdv((p) => ({ ...(p || {}), [u.id]: "" }));
                              onCreateAdvance && onCreateAdvance(u.id, amt);
                            }
                          },
                          lang === "ar" ? "إضافة سلفة" : "Ajouter avance"
                        ),
                        React.createElement(
                          "button",
                          { className: "category-btn", type: "button", onClick: () => handleSaveWorker(u.id) },
                          lang === "ar" ? "حفظ" : "Enregistrer"
                        ),
                        React.createElement(
                          "button",
                          {
                            className: "category-btn",
                            type: "button",
                            onClick: () => onDeleteUser && onDeleteUser(u.id)
                          },
                          lang === "ar" ? "حذف" : "Supprimer"
                        )
                      )
                    );
                  })
                )
              : React.createElement(
                  "div",
                  { style: { fontSize: 12, color: "#64748b" } },
                  lang === "ar" ? "لا يوجد نُوّادل." : "Aucun serveur."
                )
          ),
          React.createElement(
            "div",
            { style: { display: "grid", gap: 10 } },
            React.createElement("div", { style: { fontWeight: 800 } }, otherWorkersTitle),
            nonPosWorkers.length
              ? React.createElement(
                  "div",
                  { style: { display: "grid", gap: 8 } },
                  nonPosWorkers.map((u) => {
                    const row = edit && Object.prototype.hasOwnProperty.call(edit, u.id) ? edit[u.id] : null;
                    const nowIso = new Date().toISOString();
                    const pr = salaryPeriodRangeForUser(u, nowIso);
                    const fromYmd = pr.from;
                    const toYmd = pr.to;
                    const monthIndex = salaryMonthIndexFor(u, fromYmd);

                    const taken = approved.reduce((s, a) => {
                      if (!a || a.workerId !== u.id) return s;
                      if (a.salaryPeriodFrom && a.salaryPeriodTo) {
                        if (a.salaryPeriodFrom !== fromYmd || a.salaryPeriodTo !== toYmd) return s;
                      } else {
                        const d = isoToYmd(a.requestedAt);
                        if (!(d && d >= fromYmd && d <= toYmd)) return s;
                      }
                      const amt = typeof a.amount === "number" ? a.amount : 0;
                      return s + amt;
                    }, 0);

                    const pendingAmt = pending.reduce((s, a) => {
                      if (!a || a.workerId !== u.id) return s;
                      if (a.salaryPeriodFrom && a.salaryPeriodTo) {
                        if (a.salaryPeriodFrom !== fromYmd || a.salaryPeriodTo !== toYmd) return s;
                      } else {
                        const d = isoToYmd(a.requestedAt);
                        if (!(d && d >= fromYmd && d <= toYmd)) return s;
                      }
                      const amt = typeof a.amount === "number" ? a.amount : 0;
                      return s + amt;
                    }, 0);

                    const salaryVal = typeof u.salary === "number" ? u.salary : 0;
                    const remaining = salaryVal - taken;
                    const advDraft = draftAdv && Object.prototype.hasOwnProperty.call(draftAdv, u.id) ? draftAdv[u.id] : "";

                    return React.createElement(
                      "div",
                      {
                        key: u.id,
                        style: {
                          padding: 10,
                          borderRadius: 12,
                          border: "1px solid rgba(148,163,184,0.35)",
                          background: "rgba(255,255,255,0.85)",
                          display: "grid",
                          gap: 8
                        }
                      },
                      React.createElement(
                        "div",
                        {
                          style: {
                            display: "grid",
                            gridTemplateColumns: isPhone ? "1fr" : "1fr 140px 120px 140px 170px 1fr",
                            gap: 8,
                            alignItems: isPhone ? "stretch" : "center"
                          }
                        },
                        React.createElement("input", {
                          value: row ? row.name : String(u.name || ""),
                          onChange: (e) =>
                            setEdit((p) => ({
                              ...(p || {}),
                              [u.id]: { ...(p && p[u.id] ? p[u.id] : {}), name: e.target.value }
                            })),
                          style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                        }),
                        React.createElement(
                          "select",
                          {
                            value: row ? row.posAccess : (u.posAccess === false ? "no" : "yes"),
                            onChange: (e) =>
                              setEdit((p) => ({
                                ...(p || {}),
                                [u.id]: { ...(p && p[u.id] ? p[u.id] : {}), posAccess: e.target.value }
                              })),
                            style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)", fontSize: 12 }
                          },
                          React.createElement("option", { value: "yes" }, lang === "ar" ? "نادل" : "POS"),
                          React.createElement("option", { value: "no" }, lang === "ar" ? "عامل" : "No POS")
                        ),
                        React.createElement("input", {
                          value: row ? row.pin : String(u.pin || ""),
                          onChange: (e) =>
                            setEdit((p) => ({
                              ...(p || {}),
                              [u.id]: { ...(p && p[u.id] ? p[u.id] : {}), pin: e.target.value }
                            })),
                          placeholder: "PIN",
                          disabled: String(row ? row.posAccess : (u.posAccess === false ? "no" : "yes")) === "no",
                          style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                        }),
                        React.createElement("input", {
                          value: row ? row.salary : String(typeof u.salary === "number" ? u.salary : 0),
                          onChange: (e) =>
                            setEdit((p) => ({
                              ...(p || {}),
                              [u.id]: { ...(p && p[u.id] ? p[u.id] : {}), salary: e.target.value }
                            })),
                          placeholder: lang === "ar" ? "الراتب" : "Salaire",
                          style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                        }),
                        React.createElement("input", {
                          type: "date",
                          value: row ? row.cycleStartDate : String(u.cycleStartDate || ""),
                          onChange: (e) =>
                            setEdit((p) => ({
                              ...(p || {}),
                              [u.id]: { ...(p && p[u.id] ? p[u.id] : {}), cycleStartDate: e.target.value }
                            })),
                          style: { padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                        }),
                        React.createElement(
                          "div",
                          { style: { fontSize: 11, color: "#334155", fontWeight: 800 } },
                          (lang === "ar" ? "الفترة " : "Période "),
                          String(monthIndex),
                          ": ",
                          rangeLabel(fromYmd, toYmd),
                          " | ",
                          (lang === "ar" ? "مأخوذ: " : "Pris: "),
                          Number(taken || 0).toFixed(2),
                          " DHS",
                          pendingAmt > 0
                            ? (lang === "ar" ? " | قيد الانتظار: " : " | En attente: ") + Number(pendingAmt || 0).toFixed(2) + " DHS"
                            : "",
                          " | ",
                          (lang === "ar" ? "متبقي: " : "Reste: "),
                          Number(remaining || 0).toFixed(2),
                          " DHS"
                        )
                      ),
                      React.createElement(
                        "div",
                        { style: { display: "flex", gap: 8, justifyContent: "flex-end", alignItems: "center", flexWrap: "wrap" } },
                        React.createElement("input", {
                          value: advDraft,
                          onChange: (e) => setDraftAdv((p) => ({ ...(p || {}), [u.id]: e.target.value })),
                          placeholder: lang === "ar" ? "سلفة" : "Avance",
                          style: { width: 120, padding: 8, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                        }),
                        React.createElement(
                          "button",
                          {
                            className: "category-btn",
                            type: "button",
                            disabled: !onCreateAdvance,
                            onClick: () => {
                              const amt = parseNum(advDraft);
                              if (amt == null || amt <= 0) return;
                              setDraftAdv((p) => ({ ...(p || {}), [u.id]: "" }));
                              onCreateAdvance && onCreateAdvance(u.id, amt);
                            }
                          },
                          lang === "ar" ? "إضافة سلفة" : "Ajouter avance"
                        ),
                        React.createElement(
                          "button",
                          { className: "category-btn", type: "button", onClick: () => handleSaveWorker(u.id) },
                          lang === "ar" ? "حفظ" : "Enregistrer"
                        ),
                        React.createElement(
                          "button",
                          {
                            className: "category-btn",
                            type: "button",
                            onClick: () => onDeleteUser && onDeleteUser(u.id)
                          },
                          lang === "ar" ? "حذف" : "Supprimer"
                        )
                      )
                    );
                  })
                )
              : React.createElement(
                  "div",
                  { style: { fontSize: 12, color: "#64748b" } },
                  lang === "ar" ? "لا يوجد موظفون بدون POS." : "Aucun employé sans POS."
                )
          ),
          React.createElement(
            "div",
            { style: { display: "grid", gap: 10 } },
            React.createElement("div", { style: { fontWeight: 800 } }, managersTitle),
            React.createElement(AdminUsersPanel, { users: managers, onChangePin: onChangePin })
          ),
          React.createElement(
            "div",
            { style: { display: "grid", gap: 10 } },
            React.createElement("div", { style: { fontWeight: 800 } }, adminsTitle),
            React.createElement(AdminUsersPanel, { users: admins, onChangePin: onChangePin })
          )
        );
      }

      function AdminUsersPanel({ users, onChangePin }) {
        const [pins, setPins] = React.useState(() => {
          const next = {};
          (users || []).forEach((u) => {
            if (!u || !u.id) return;
            next[u.id] = u.pin != null ? String(u.pin) : "";
          });
          return next;
        });

        React.useEffect(() => {
          const next = {};
          (users || []).forEach((u) => {
            if (!u || !u.id) return;
            next[u.id] = u.pin != null ? String(u.pin) : "";
          });
          setPins(next);
        }, [users]);

        function rowStyle() {
          return {
            display: "flex",
            alignItems: "center",
            justifyContent: "space-between",
            gap: 10,
            borderRadius: 12,
            border: "1px solid rgba(148,163,184,0.35)",
            background: "rgba(255,255,255,0.82)",
            padding: "8px 10px",
            fontSize: 12
          };
        }

        function handleSave(userId) {
          if (!onChangePin) return;
          const newPin = pins && Object.prototype.hasOwnProperty.call(pins, userId)
            ? pins[userId]
            : "";
          onChangePin(userId, String(newPin || ""));
        }

        if (!users || users.length === 0) {
          return React.createElement(
            "p",
            { style: { fontSize: 12 } },
            "Aucun utilisateur."
          );
        }

        return React.createElement(
          "div",
          { style: { display: "grid", gap: 8 } },
          users.map((u) => {
            if (!u || !u.id) return null;
            return React.createElement(
              "div",
              { key: u.id, style: rowStyle() },
              React.createElement(
                "div",
                { style: { display: "flex", flexDirection: "column", gap: 2 } },
                React.createElement(
                  "div",
                  { style: { fontWeight: 700 } },
                  String(u.name || u.id)
                ),
                React.createElement(
                  "div",
                  { style: { fontSize: 11, color: "#6b7280" } },
                  "role: ",
                  String(u.role || "")
                )
              ),
              React.createElement(
                "div",
                { style: { display: "flex", alignItems: "center", gap: 8 } },
                React.createElement("input", {
                  value:
                    pins && Object.prototype.hasOwnProperty.call(pins, u.id)
                      ? pins[u.id]
                      : "",
                  onChange: (ev) => {
                    const val = ev && ev.target ? ev.target.value : "";
                    setPins((prev) => ({ ...(prev || {}), [u.id]: String(val) }));
                  },
                  placeholder: "PIN",
                  style: {
                    width: 90,
                    padding: "6px 10px",
                    borderRadius: 10,
                    border: "1px solid rgba(148,163,184,0.55)",
                    fontSize: 12
                  }
                }),
                React.createElement(
                  "button",
                  {
                    className: "category-btn",
                    type: "button",
                    disabled: !onChangePin,
                    onClick: () => handleSave(u.id)
                  },
                  "Enregistrer"
                )
              )
            );
          })
        );
      }

      function AdminStats({ shifts, orders, inventoryLogs, inventory, t, lang }) {
        if (!shifts.length) {
          return React.createElement(
            "p",
            { style: { fontSize: 12 } },
            "Aucun shift pour l'instant."
          );
        }

        const [reportMode, setReportMode] = React.useState("shift");
        const [reportShiftId, setReportShiftId] = React.useState(() => {
          const last = shifts[shifts.length - 1];
          return last && last.id ? last.id : "";
        });
        const [reportFrom, setReportFrom] = React.useState(() =>
          new Date().toISOString().slice(0, 10)
        );
        const [reportTo, setReportTo] = React.useState(() =>
          new Date().toISOString().slice(0, 10)
        );

        React.useEffect(() => {
          if (reportShiftId) return;
          const last = shifts[shifts.length - 1];
          if (last && last.id) setReportShiftId(last.id);
        }, [shifts]);

        const [feedbackSettings, setFeedbackSettings] = React.useState(() => {
          try {
            const api = window.__CAFE_HALAB_FEEDBACK__;
            if (api && api.getSettings) return api.getSettings();
          } catch (e) {}
          return { sfx: true, haptics: true, volume: 0.14 };
        });

        function setFeedbackPatch(patch) {
          try {
            const api = window.__CAFE_HALAB_FEEDBACK__;
            if (api && api.setSettings) api.setSettings(patch);
          } catch (e) {}
          setFeedbackSettings((p) => Object.assign({}, p || {}, patch || {}));
        }

        function ymd(iso) {
          return String(iso || "").slice(0, 10);
        }

        function inYmdRange(iso, from, to) {
          const d = ymd(iso);
          if (!d || !from || !to) return false;
          return d >= from && d <= to;
        }

        function weekRangeYMD() {
          const now = new Date();
          const day = now.getDay();
          const diff = day === 0 ? -6 : 1 - day;
          const monday = new Date(now);
          monday.setDate(now.getDate() + diff);
          monday.setHours(0, 0, 0, 0);
          const sunday = new Date(monday);
          sunday.setDate(monday.getDate() + 6);
          return {
            from: monday.toISOString().slice(0, 10),
            to: sunday.toISOString().slice(0, 10)
          };
        }

        function monthRangeYMD() {
          const now = new Date();
          const first = new Date(now.getFullYear(), now.getMonth(), 1);
          const last = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          return {
            from: first.toISOString().slice(0, 10),
            to: last.toISOString().slice(0, 10)
          };
        }

        function resolveReportRange() {
          if (reportMode === "custom") return { from: reportFrom, to: reportTo };
          if (reportMode === "week") return weekRangeYMD();
          if (reportMode === "month") return monthRangeYMD();
          const tdy = new Date().toISOString().slice(0, 10);
          return { from: tdy, to: tdy };
        }

        function getReportData() {
          if (reportMode === "shift") {
            const sid = reportShiftId || ((shifts[shifts.length - 1] && shifts[shifts.length - 1].id) || "");
            return {
              mode: "shift",
              shiftId: sid,
              range: null,
              shifts: (shifts || []).filter((s) => s && s.id === sid),
              orders: (orders || []).filter((o) => o && o.shiftId === sid),
              inventoryLogs: (inventoryLogs || []).filter((l) => l && l.shiftId === sid)
            };
          }

          const range = resolveReportRange();
          return {
            mode: reportMode,
            shiftId: null,
            range,
            shifts: (shifts || []).filter((s) => s && inYmdRange(s.date, range.from, range.to)),
            orders: (orders || []).filter((o) => o && inYmdRange(o.createdAt, range.from, range.to)),
            inventoryLogs: (inventoryLogs || []).filter((l) => l && inYmdRange(l.createdAt, range.from, range.to))
          };
        }

        function handleExportExcel() {
          const data = getReportData();
          const XLSX = window.XLSX;
          if (!XLSX || !XLSX.utils) {
            alert("XLSX library not loaded");
            return;
          }

          const confirmed = (data.orders || []).filter(
            (o) => o && (o.status === "paid" || o.status === "unpaid" || o.status === "debt")
          );
          const paid = confirmed.filter((o) => o.status === "paid");
          const unpaid = confirmed.filter((o) => o.status !== "paid");
          const totalRevenue = confirmed.reduce(
            (sum, o) => sum + ((o.totals && o.totals.total) || 0),
            0
          );
          const paidRevenue = paid.reduce(
            (sum, o) => sum + ((o.totals && o.totals.total) || 0),
            0
          );
          const unpaidRevenue = unpaid.reduce(
            (sum, o) => sum + ((o.totals && o.totals.total) || 0),
            0
          );

          const lines = [];
          confirmed.forEach((o) => {
            (o.items || []).forEach((l) => {
              lines.push({
                orderId: o.id,
                shiftId: o.shiftId,
                createdAt: o.createdAt,
                status: o.status,
                productId: l.id,
                name: l.name,
                qty: l.qty,
                price: l.price,
                modifiers: l.modifiers ? JSON.stringify(l.modifiers) : ""
              });
            });
          });

          const wb = XLSX.utils.book_new();
          const summaryRows = [
            {
              mode: data.mode,
              shiftId: data.shiftId || "",
              from: data.range ? data.range.from : "",
              to: data.range ? data.range.to : "",
              totalOrders: confirmed.length,
              paidOrders: paid.length,
              unpaidOrders: unpaid.length,
              totalRevenue,
              paidRevenue,
              unpaidRevenue,
              totalShifts: (data.shifts || []).length,
              totalInventoryLogs: (data.inventoryLogs || []).length
            }
          ];

          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(summaryRows),
            "Résumé"
          );

          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(
              (data.shifts || []).map((s) => ({
                id: s.id,
                date: s.date,
                period: s.period,
                status: s.status,
                openedAt: s.openedAt,
                closedAt: s.closedAt,
                revenue: s.revenue,
                orderCount: s.orderCount,
                expectedCash: s.expectedCash,
                openedBy: s.openedBy,
                closedBy: s.closedBy
              }))
            ),
            "Shifts"
          );

          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(
              confirmed.map((o) => ({
                id: o.id,
                ticketCode: o.ticketCode,
                shiftId: o.shiftId,
                status: o.status,
                createdAt: o.createdAt,
                paidAt: o.paidAt,
                cashierId: o.cashierId,
                total: (o.totals && o.totals.total) || 0
              }))
            ),
            "Orders"
          );

          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(lines),
            "OrderLines"
          );

          XLSX.utils.book_append_sheet(
            wb,
            XLSX.utils.json_to_sheet(
              (data.inventoryLogs || []).map((l) => ({
                createdAt: l.createdAt,
                ingredientId: l.ingredientId,
                delta: l.delta,
                reason: l.reason,
                shiftId: l.shiftId,
                orderId: l.orderId || ""
              }))
            ),
            "InventoryLogs"
          );

          const base = "cafe_halab_report";
          const suffix =
            data.mode === "shift"
              ? "_" + String(data.shiftId || "shift")
              : "_" + String((data.range && data.range.from) || "") + "_" + String((data.range && data.range.to) || "");
          XLSX.writeFile(wb, base + suffix + ".xlsx");
        }

        const confirmedOrders = (orders || []).filter(
          (o) => o && (o.status === "paid" || o.status === "unpaid" || o.status === "debt")
        );
        const paidOrders = confirmedOrders.filter((o) => o.status === "paid");
        const unpaidOrders = confirmedOrders.filter((o) => o.status !== "paid");
        const totalRevenue = confirmedOrders.reduce(
          (sum, o) => sum + ((o.totals && o.totals.total) || 0),
          0
        );
        const totalPaidOrders = paidOrders.length;
        const totalUnpaidOrders = unpaidOrders.length;
        const unpaidRevenue = unpaidOrders.reduce(
          (sum, o) => sum + ((o.totals && o.totals.total) || 0),
          0
        );

        function nameForIngredient(id) {
          return inventory[id]?.name || id;
        }

        function unitForIngredient(id) {
          return inventory[id]?.unit || "";
        }

        function formatQty(value, unit) {
          if (value == null || Number.isNaN(value)) return "";
          if (unit === "pcs") {
            const v = Math.round(value);
            return String(v);
          }
          const rounded = Math.round(value * 1000) / 1000;
          return String(rounded).replace(/\.0+$/, "").replace(/(\.\d*[1-9])0+$/, "$1");
        }

        function formatDateTime(iso) {
          if (!iso) return "";
          try {
            const d = new Date(iso);
            return d.toLocaleString(lang === "ar" ? "ar-MA" : "fr-FR", {
              year: "2-digit",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit"
            });
          } catch (e) {
            return "";
          }
        }

        function displayOrderNumber(orderId) {
          if (!orderId) return "";
          const digits = String(orderId).replace(/\D/g, "");
          if (digits.length) return digits.slice(-4);
          return String(orderId).slice(-4);
        }

        const lastShift = shifts[shifts.length - 1];
        const lastShiftId = lastShift ? lastShift.id : null;

        const totalSaleByIngredient = {};
        const lastShiftSaleByIngredient = {};
        const lastUpdateByIngredient = {};
        inventoryLogs.forEach((log) => {
          if (!log || !log.ingredientId) return;

          const prevIso = lastUpdateByIngredient[log.ingredientId];
          if (!prevIso || (log.createdAt && log.createdAt > prevIso)) {
            lastUpdateByIngredient[log.ingredientId] = log.createdAt;
          }

          if (log.reason === "sale") {
            totalSaleByIngredient[log.ingredientId] =
              (totalSaleByIngredient[log.ingredientId] || 0) + (log.delta || 0);
            if (lastShiftId && log.shiftId === lastShiftId) {
              lastShiftSaleByIngredient[log.ingredientId] =
                (lastShiftSaleByIngredient[log.ingredientId] || 0) + (log.delta || 0);
            }
          }
        });

        const ingredientIds = Object.keys(inventory || {}).sort((a, b) =>
          nameForIngredient(a).localeCompare(nameForIngredient(b))
        );

        const tableTitle =
          (t && t.inventoryTableTitle) || "Tableau du stock";
        const colIngredient =
          (t && t.inventoryTableIngredient) || "Ingrédient";
        const colLastShift =
          (t && t.inventoryTableLastShift) || "Consommation (dernier shift)";
        const colTotal = (t && t.inventoryTableTotal) || "Consommation (total)";
        const colInitial = (t && t.inventoryTableInitial) || "Quantité initiale";
        const colRemaining =
          (t && t.inventoryTableRemaining) || "Quantité restante";
        const colLastUpdate =
          (t && t.inventoryTableLastUpdate) || "Dernière mise à jour";

        const thStyle = {
          textAlign: lang === "ar" ? "right" : "left",
          padding: "8px 8px",
          fontSize: 11,
          fontWeight: 700,
          color: "#0f172a",
          borderBottom: "1px solid rgba(148,163,184,0.6)",
          background: "rgba(226,232,240,0.8)",
          position: "sticky",
          top: 0
        };
        const tdStyle = {
          padding: "7px 8px",
          fontSize: 11,
          borderBottom: "1px solid rgba(148,163,184,0.25)",
          verticalAlign: "top"
        };

        return React.createElement(
          "div",
          null,
          React.createElement(
            "div",
            {
              style: {
                display: "grid",
                gridTemplateColumns: "repeat(auto-fit, minmax(200px, 1fr))",
                gap: 10,
                marginBottom: 10
              }
            },
            React.createElement(
              "div",
              {
                style: {
                  borderRadius: 12,
                  padding: 10,
                  border: "1px solid rgba(148,163,184,0.5)",
                  background: "rgba(255,255,255,0.85)",
                  fontSize: 12
                }
              },
              React.createElement(
                "div",
                { style: { fontWeight: 800, marginBottom: 6 } },
                "Rapport"
              ),
              React.createElement(
                "select",
                {
                  value: reportMode,
                  onChange: (e) => setReportMode(e.target.value),
                  style: { width: "100%", padding: 6, fontSize: 12 }
                },
                React.createElement("option", { value: "shift" }, "Shift"),
                React.createElement("option", { value: "week" }, "Semaine"),
                React.createElement("option", { value: "month" }, "Mois"),
                React.createElement("option", { value: "custom" }, "Personnalisé")
              ),
              reportMode === "shift" &&
                React.createElement(
                  "select",
                  {
                    value: reportShiftId,
                    onChange: (e) => setReportShiftId(e.target.value),
                    style: { width: "100%", padding: 6, fontSize: 12, marginTop: 6 }
                  },
                  (shifts || [])
                    .slice()
                    .reverse()
                    .map((s) =>
                      React.createElement(
                        "option",
                        { key: s.id, value: s.id },
                        String(s.date || "") + " " + String(s.period || "") + " (" + String(s.status || "") + ")"
                      )
                    )
                ),
              reportMode === "custom" &&
                React.createElement(
                  "div",
                  { style: { display: "grid", gap: 6, marginTop: 6 } },
                  React.createElement("input", {
                    type: "date",
                    value: reportFrom,
                    onChange: (e) => setReportFrom(e.target.value),
                    style: { padding: 6, fontSize: 12 }
                  }),
                  React.createElement("input", {
                    type: "date",
                    value: reportTo,
                    onChange: (e) => setReportTo(e.target.value),
                    style: { padding: 6, fontSize: 12 }
                  })
                ),
              React.createElement(
                "button",
                {
                  className: "category-btn",
                  type: "button",
                  style: { marginTop: 8, width: "100%" },
                  onClick: handleExportExcel
                },
                "Exporter Excel (.xlsx)"
              )
            ),
            React.createElement(
              "div",
              {
                style: {
                  borderRadius: 12,
                  padding: 10,
                  border: "1px solid rgba(148,163,184,0.5)",
                  background: "rgba(255,255,255,0.85)",
                  fontSize: 12
                }
              },
              React.createElement(
                "div",
                { style: { fontWeight: 800, marginBottom: 6 } },
                "Feedback"
              ),
              React.createElement(
                "label",
                { style: { display: "flex", gap: 8, alignItems: "center" } },
                React.createElement("input", {
                  type: "checkbox",
                  checked: !!feedbackSettings.sfx,
                  onChange: (e) => setFeedbackPatch({ sfx: !!e.target.checked })
                }),
                "Sons"
              ),
              React.createElement(
                "label",
                { style: { display: "flex", gap: 8, alignItems: "center", marginTop: 6 } },
                React.createElement("input", {
                  type: "checkbox",
                  checked: !!feedbackSettings.haptics,
                  onChange: (e) => setFeedbackPatch({ haptics: !!e.target.checked })
                }),
                "Vibrations"
              ),
              React.createElement(
                "label",
                { style: { display: "grid", gap: 4, marginTop: 8 } },
                React.createElement("span", null, "Volume"),
                React.createElement("input", {
                  type: "range",
                  min: "0",
                  max: "0.4",
                  step: "0.01",
                  value: String(feedbackSettings.volume != null ? feedbackSettings.volume : 0.14),
                  onChange: (e) => setFeedbackPatch({ volume: parseFloat(e.target.value) || 0 })
                })
              )
            )
          ),
          React.createElement(
            "div",
            {
              style: {
                display: "grid",
                gridTemplateColumns: "repeat(auto-fit, minmax(140px, 1fr))",
                gap: 10,
                marginBottom: 10
              }
            },
            React.createElement(
              "div",
              {
                style: {
                  borderRadius: 12,
                  padding: 10,
                  background:
                    "linear-gradient(135deg, #22c55e, #a3e635)",
                  color: "#0f172a",
                  boxShadow: "0 10px 24px rgba(34,197,94,0.6)",
                  fontSize: 12
                }
              },
              React.createElement(
                "div",
                { style: { fontWeight: 700, marginBottom: 4 } },
                "CA total"
              ),
              React.createElement(
                "div",
                { style: { fontSize: 16 } },
                totalRevenue.toFixed(2),
                " DHS"
              )
            ),
            React.createElement(
              "div",
              {
                style: {
                  borderRadius: 12,
                  padding: 10,
                  background:
                    "linear-gradient(135deg, #38bdf8, #6366f1)",
                  color: "#f9fafb",
                  boxShadow: "0 10px 24px rgba(59,130,246,0.6)",
                  fontSize: 12
                }
              },
              React.createElement(
                "div",
                { style: { fontWeight: 700, marginBottom: 4 } },
                (t && t.paidOrdersTitle) || "Commandes payées"
              ),
              React.createElement(
                "div",
                { style: { fontSize: 16 } },
                totalPaidOrders
              )
            ),
            React.createElement(
              "div",
              {
                style: {
                  borderRadius: 12,
                  padding: 10,
                  background:
                    "linear-gradient(135deg, #f97316, #fb7185)",
                  color: "#f9fafb",
                  boxShadow: "0 10px 24px rgba(248,113,113,0.5)",
                  fontSize: 12
                }
              },
              React.createElement(
                "div",
                { style: { fontWeight: 700, marginBottom: 4 } },
                (t && t.unpaidOrdersTitle) || "Commandes non payées"
              ),
              React.createElement(
                "div",
                { style: { fontSize: 16 } },
                totalUnpaidOrders
              )
            ),
            React.createElement(
              "div",
              {
                style: {
                  borderRadius: 12,
                  padding: 10,
                  background:
                    "linear-gradient(135deg, #f97316, #fb7185)",
                  color: "#f9fafb",
                  boxShadow: "0 10px 24px rgba(248,113,113,0.5)",
                  fontSize: 12
                }
              },
              React.createElement(
                "div",
                { style: { fontWeight: 700, marginBottom: 4 } },
                "Nombre de shifts"
              ),
              React.createElement(
                "div",
                { style: { fontSize: 16 } },
                shifts.length
              )
            )
          ),
          React.createElement(
            "div",
            { style: { marginTop: 6, fontSize: 12 } },
            React.createElement(
              "div",
              { style: { fontWeight: 600, marginBottom: 4 } },
              (t && t.unpaidOrdersTitle) || "Commandes non payées"
            ),
            React.createElement(
              "div",
              { style: { fontSize: 11, color: "#475569", marginBottom: 8 } },
              ((t && t.caPendingLabel) || "CA non encaissé") +
                ": " +
                unpaidRevenue.toFixed(2) +
                " DHS"
            ),
            totalUnpaidOrders === 0
              ? React.createElement(
                  "div",
                  { style: { fontSize: 12, color: "#6b7280" } },
                  (t && t.noUnpaidOrders) || "Aucune commande non payée."
                )
              : React.createElement(
                  "div",
                  {
                    style: {
                      border: "1px solid rgba(148,163,184,0.5)",
                      borderRadius: 12,
                      overflow: "auto",
                      maxHeight: 220,
                      background: "rgba(255,255,255,0.85)"
                    }
                  },
                  unpaidOrders
                    .slice()
                    .sort((a, b) => (b.createdAt || "").localeCompare(a.createdAt || ""))
                    .map((o) =>
                      React.createElement(
                        "div",
                        {
                          key: o.id,
                          className: "ticket-card" + ((exitingOrderIds && exitingOrderIds[o.id]) ? " ticket-card--exit" : ""),
                          style: {
                            display: "flex",
                            justifyContent: "space-between",
                            alignItems: "baseline",
                            gap: 10,
                            padding: "8px 10px",
                            borderBottom: "1px solid rgba(148,163,184,0.25)",
                            fontSize: 12
                          }
                        },
                        React.createElement(
                          "div",
                          { style: { fontWeight: 700 } },
                          (() => {
                            const code = String(o.ticketCode || ("#" + displayOrderNumber(o.id)));
                            const nm = String(o.orderName || "").trim();
                            const namePart = nm && nm !== code ? nm + " · " : "";
                            return ((t && t.orderLabel) || "Commande") + " " + namePart + code;
                          })()
                        ),
                        React.createElement(
                          "div",
                          { style: { fontSize: 11, color: "#6b7280" } },
                          formatDateTime(o.createdAt)
                        ),
                        React.createElement(
                          "div",
                          { style: { whiteSpace: "nowrap", fontWeight: 800 } },
                          (((o.totals && o.totals.total) || 0).toFixed(2)) + " DHS"
                        )
                      )
                    )
                )
          ),
          React.createElement(
            "div",
            { style: { marginTop: 6, fontSize: 12 } },
            React.createElement(
              "div",
              { style: { fontWeight: 600, marginBottom: 4 } },
              tableTitle
            ),
            React.createElement(
              "div",
              {
                style: {
                  marginTop: 6,
                  borderRadius: 12,
                  overflow: "auto",
                  border: "1px solid rgba(148,163,184,0.5)",
                  background: "rgba(255,255,255,0.85)"
                }
              },
              React.createElement(
                "table",
                {
                  style: {
                    width: "100%",
                    borderCollapse: "collapse",
                    minWidth: isPhone ? 520 : 720
                  }
                },
                React.createElement(
                  "thead",
                  null,
                  React.createElement(
                    "tr",
                    null,
                    React.createElement("th", { style: thStyle }, colIngredient),
                    React.createElement("th", { style: thStyle }, colLastShift),
                    React.createElement("th", { style: thStyle }, colTotal),
                    React.createElement("th", { style: thStyle }, colInitial),
                    React.createElement("th", { style: thStyle }, colRemaining),
                    React.createElement("th", { style: thStyle }, colLastUpdate)
                  )
                ),
                React.createElement(
                  "tbody",
                  null,
                  ingredientIds.map((id) => {
                    const unit = unitForIngredient(id);
                    const initialQty =
                      (INVENTORY_INITIAL[id] && INVENTORY_INITIAL[id].currentQty) != null
                        ? INVENTORY_INITIAL[id].currentQty
                        : inventory[id]?.currentQty;
                    const remainingQty = inventory[id]?.currentQty;

                    const totalDelta = totalSaleByIngredient[id] || 0;
                    const lastShiftDelta = lastShiftSaleByIngredient[id] || 0;
                    const totalConsumed = totalDelta < 0 ? -totalDelta : 0;
                    const lastShiftConsumed = lastShiftDelta < 0 ? -lastShiftDelta : 0;
                    const lastUpdate = formatDateTime(lastUpdateByIngredient[id]);

                    return React.createElement(
                      "tr",
                      { key: id },
                      React.createElement(
                        "td",
                        { style: tdStyle },
                        nameForIngredient(id)
                      ),
                      React.createElement(
                        "td",
                        { style: tdStyle },
                        formatQty(lastShiftConsumed, unit),
                        " ",
                        unit
                      ),
                      React.createElement(
                        "td",
                        { style: tdStyle },
                        formatQty(totalConsumed, unit),
                        " ",
                        unit
                      ),
                      React.createElement(
                        "td",
                        { style: tdStyle },
                        formatQty(initialQty, unit),
                        " ",
                        unit
                      ),
                      React.createElement(
                        "td",
                        { style: tdStyle },
                        formatQty(remainingQty, unit),
                        " ",
                        unit
                      ),
                      React.createElement("td", { style: tdStyle }, lastUpdate)
                    );
                  })
                )
              )
            )
          )
        );
      }

      function AdminOrdersTickets({
        orders,
        users,
        lang,
        t,
        activeShiftId,
        shifts,
        onMarkPaid,
        exitingOrderIds
      }) {
        const isRTL = lang === "ar";

        const [expandedPaid, setExpandedPaid] = React.useState({});

        function displayOrderNumber(orderId) {
          if (!orderId) return "";
          const digits = String(orderId).replace(/\D/g, "");
          if (digits.length) return digits.slice(-4);
          return String(orderId).slice(-4);
        }

        function userNameById(id) {
          const u = (users || []).find((x) => x && x.id === id);
          return (u && u.name) || String(id || "");
        }

        function drinkValueLabel(value) {
          if (value === "tea") return (t && t.drinkTea) || "Thé";
          if (value === "coffee_milk") return (t && t.drinkCoffeeMilk) || "Café au lait";
          return value || "";
        }

        function lineModifiersLabel(line) {
          const mods = (line && line.modifiers) || {};
          const parts = [];
          if (mods.milk != null) {
            parts.push(`${t.milkInLine}: ${mods.milk ? t.milkYes : t.milkNo}`);
          }
          if (mods.sugar) {
            parts.push(`${t.sugarInLine}: ${mods.sugar}`);
          }
          if (mods.sirop) {
            parts.push(`${(t && t.siropInLine) || "sirop"}: ${(t && t.siropWith) || "Avec"}`);
          }
          if (mods.water) {
            const fee = Number(mods.waterFee) || 0;
            parts.push(
              `${(t && t.waterInLine) || "eau"}: ${(t && t.waterWith) || "Avec"}${fee ? " +" + fee : ""}`
            );
          }
          if (mods.waterSize) {
            const label =
              mods.waterSize === "half"
                ? (t && t.waterHalf) || "1/2L"
                : (t && t.waterQuarter) || "1/4L";
            parts.push(`${(t && t.waterInLine) || "eau"}: ${label}`);
          }
          if (mods.herb) {
            parts.push(`${t.herbInLine}: ${herbValueLabel(mods.herb, t)}`);
          }
          if (mods.drink) {
            parts.push(`${t.drinkInLine}: ${drinkValueLabel(mods.drink)}`);
          }
          if (mods.eggCount) {
            parts.push(`${t.eggsInLine}: ${mods.eggCount}`);
          }
          if (mods.sbDrinkId || mods.sbDrinkName || mods.sbDrinkNameFr || mods.sbDrinkNameAr) {
            const sbDrinkLabel =
              lang === "ar"
                ? mods.sbDrinkNameAr || mods.sbDrinkName || mods.sbDrinkNameFr || ""
                : mods.sbDrinkNameFr || mods.sbDrinkName || mods.sbDrinkNameAr || "";
            if (sbDrinkLabel) {
              parts.push((lang === "ar" ? "مشروب" : "Boisson") + ": " + sbDrinkLabel);
            }
          }
          if (mods.sbEggCount) {
            parts.push((lang === "ar" ? "بيض" : "Oeufs") + ": " + String(mods.sbEggCount));
          }
          if (mods.sbKashir) parts.push(lang === "ar" ? "كاشير" : "Kashir");
          if (mods.sbFromage) parts.push(lang === "ar" ? "جبن" : "Fromage");
          if (mods.sbWater) parts.push(lang === "ar" ? "ماء" : "Eau");
          if (mods.sbCroissant) parts.push(lang === "ar" ? "كرواسون" : "Croissant");
          if (mods.sbBreakfastSet) parts.push(lang === "ar" ? "باك الفطور (+5)" : "Breakfast set (+5)");
          if (mods.sbCheesePieces) {
            parts.push(
              (lang === "ar" ? "قطع الجبن" : "Fromage pièces") + ": " + String(mods.sbCheesePieces)
            );
          }
          if (line && (line.containerType || line.cupSize)) {
            const typeLabel =
              line.containerType === "glass"
                ? lang === "ar"
                  ? "زجاج"
                  : "Verre"
                : lang === "ar"
                ? "بلاستيك"
                : "Jetable";
            const sizeLabel =
              line.cupSize === "large"
                ? lang === "ar"
                  ? "كبير"
                  : "Grand"
                : lang === "ar"
                ? "صغير"
                : "Petit";
            parts.push(
              (lang === "ar" ? "كأس" : "Gobelet") + ": " + typeLabel + " " + sizeLabel
            );
          }
          return parts.length ? "(" + parts.join(", ") + ")" : "";
        }

        function formatDateTimeSafe(iso) {
          try {
            if (!iso) return "";
            const d = new Date(iso);
            if (!Number.isFinite(d.getTime())) return String(iso);
            return d.toLocaleString(lang === "ar" ? "ar-MA" : "fr-FR", {
              year: "2-digit",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit"
            });
          } catch (e) {
            return String(iso || "");
          }
        }

        const confirmedOrders = (orders || []).filter(
          (o) => o && (o.status === "paid" || o.status === "unpaid" || o.status === "debt")
        );
        const scopedOrders = activeShiftId
          ? confirmedOrders.filter((o) => o.shiftId === activeShiftId)
          : confirmedOrders;

        const unpaid = scopedOrders
          .filter((o) => o.status !== "paid")
          .slice()
          .sort((a, b) => String(b.createdAt || "").localeCompare(String(a.createdAt || "")));

        const paid = scopedOrders
          .filter((o) => o.status === "paid")
          .slice()
          .sort((a, b) => String(b.paidAt || b.createdAt || "").localeCompare(String(a.paidAt || a.createdAt || "")));

        return React.createElement(
          "div",
          { dir: isRTL ? "rtl" : "ltr" },
          React.createElement(
            "div",
            { style: { display: "flex", justifyContent: "space-between", gap: 10, alignItems: "baseline" } },
            React.createElement(
              "h3",
              { style: { marginTop: 0, marginBottom: 8 } },
              (t && t.ordersInProgress) || "Commandes en attente"
            ),
            React.createElement(
              "div",
              { style: { fontSize: 12, color: "#6b7280" } },
              activeShiftId
                ? ((t && t.shiftLabel) || "Shift") + ": " + String(activeShiftId)
                : ((t && t.shiftLabel) || "Shift") + ": " + ((t && t.allLabel) || "Tous")
            )
          ),
          unpaid.length === 0
            ? React.createElement(
                "div",
                { style: { fontSize: 12, color: "#6b7280" } },
                (t && t.noOrdersInProgress) || "Aucune commande en attente."
              )
            : unpaid.map((o) =>
                React.createElement(
                  "div",
                  {
                    key: o.id,
                    className:
                      "ticket-card" +
                      ((exitingOrderIds && exitingOrderIds[o.id]) ? " ticket-card--exit" : ""),
                    style: {
                      borderRadius: 14,
                      border: "1px solid rgba(148,163,184,0.55)",
                      background:
                        "linear-gradient(145deg, rgba(255,255,255,0.96), rgba(224,231,255,0.72))",
                      boxShadow: "0 10px 22px rgba(15,23,42,0.10)",
                      padding: 10,
                      marginBottom: 10
                    }
                  },
                  React.createElement(
                    "div",
                    {
                      style: {
                        display: "flex",
                        justifyContent: "space-between",
                        alignItems: "baseline",
                        gap: 10
                      }
                    },
                    React.createElement(
                      "div",
                      { style: { fontSize: 12, fontWeight: 700 } },
                      (() => {
                        const code = String(o.ticketCode || (o.id ? "#" + o.id : ""));
                        const nm = String(o.orderName || "").trim();
                        const namePart = nm && nm !== code ? nm + " · " : "";
                        return (t && t.orderLabel ? t.orderLabel : "Commande") + " " + namePart + code;
                      })() +
                        (o && o.serviceType === "takeaway"
                          ? lang === "ar"
                            ? " · خارجي"
                            : " · À emporter"
                          : "")
                    ),
                    React.createElement(
                      "div",
                      { style: { fontSize: 12, color: "#374151" } },
                      formatDateTimeSafe(o.createdAt)
                    )
                  ),
                  React.createElement(
                    "div",
                    { style: { fontSize: 11, color: "#6b7280", marginTop: 4 } },
                    (t && t.waiterLabel ? t.waiterLabel : "Serveur") + ": " + userNameById(o.cashierId)
                  ),
                  Array.isArray(o.items) && o.items.length
                    ? React.createElement(
                        "div",
                        { style: { marginTop: 8 } },
                        o.items.map((line) =>
                          React.createElement(
                            "div",
                            {
                              key: String(line && line.key ? line.key : Math.random()),
                              style: {
                                display: "flex",
                                justifyContent: "space-between",
                                gap: 10,
                                fontSize: 12,
                                padding: "2px 0"
                              }
                            },
                            React.createElement(
                              "div",
                              { style: { flex: 1 } },
                              React.createElement(
                                "div",
                                { style: { fontWeight: 700 } },
                                String((line && line.qty) || 1) + "× ",
                                lang === "ar"
                                  ? String((line && (line.nameAr || line.name)) || "")
                                  : String((line && (line.nameFr || line.name)) || "")
                              ),
                              lineModifiersLabel(line)
                                ? React.createElement(
                                    "div",
                                    { style: { fontSize: 11, color: "#64748b" } },
                                    lineModifiersLabel(line)
                                  )
                                : null
                            ),
                            React.createElement(
                              "div",
                              { style: { whiteSpace: "nowrap" } },
                              `${(((line && line.price) || 0) * ((line && line.qty) || 1)).toFixed(2)} DHS`
                            )
                          )
                        )
                      )
                    : null,
                  React.createElement(
                    "div",
                    {
                      style: {
                        display: "flex",
                        justifyContent: "space-between",
                        alignItems: "center",
                        marginTop: 10
                      }
                    },
                    React.createElement(
                      "div",
                      { style: { fontWeight: 700, fontSize: 12 } },
                      "#" + displayOrderNumber(o.id) + " • " + `${(((o.totals && o.totals.total) || 0).toFixed(2))} DHS`
                    ),
                    onMarkPaid
                      ? React.createElement(
                          "button",
                          {
                            className: "category-btn",
                            disabled: !!(exitingOrderIds && exitingOrderIds[o.id]),
                            onClick: () => {
                              onMarkPaid(o.id);
                            }
                          },
                          (t && t.markPaid) || "Déclarer payé"
                        )
                      : null
                  )
                )
              ),
          React.createElement(
            "div",
            { style: { marginTop: 16 } },
            React.createElement(
              "h4",
              { style: { margin: "0 0 8px", fontSize: 13 } },
              (t && t.paidOrdersTitle) || "Commandes payées"
            ),
            paid.length === 0
              ? React.createElement(
                  "div",
                  { style: { fontSize: 12, color: "#6b7280" } },
                  (t && t.noPaidOrders) || "Aucune commande payée."
                )
              : paid.slice(0, 30).map((o) =>
                  React.createElement(
                    "div",
                    {
                      key: o.id,
                      style: {
                        borderRadius: 12,
                        border: "1px solid rgba(148,163,184,0.35)",
                        background: "rgba(255,255,255,0.82)",
                        padding: "8px 10px",
                        marginBottom: 8,
                        fontSize: 12,
                        display: "grid",
                        gridTemplateColumns: "minmax(0, 1fr) auto",
                        gap: 10
                      }
                    },
                    React.createElement(
                      "div",
                      { style: { display: "grid", gap: 2 } },
                      React.createElement(
                        "div",
                        { style: { fontWeight: 800 } },
                        (() => {
                          const code = String(o.ticketCode || (o.id ? "#" + o.id : ""));
                          const nm = String(o.orderName || "").trim();
                          return nm && nm !== code ? nm : code;
                        })()
                      ),
                      React.createElement(
                        "div",
                        { style: { fontSize: 11, color: "#64748b" } },
                        String(o.ticketCode || ("#" + displayOrderNumber(o.id)))
                      ),
                      React.createElement(
                        "div",
                        { style: { color: "#6b7280" } },
                        formatDateTimeSafe(o.paidAt || o.createdAt)
                      ),
                      React.createElement(
                        "button",
                        {
                          type: "button",
                          className: "category-btn",
                          style: { width: "fit-content", marginTop: 4 },
                          onClick: () =>
                            setExpandedPaid((p) =>
                              Object.assign({}, p || {}, { [o.id]: !(p && p[o.id]) })
                            )
                        },
                        (expandedPaid && expandedPaid[o.id])
                          ? ((t && t.hideDetailsBtn) || "Masquer")
                          : ((t && t.detailsBtn) || "Détails")
                      ),
                      expandedPaid && expandedPaid[o.id] && Array.isArray(o.items) && o.items.length
                        ? React.createElement(
                            "div",
                            {
                              style: {
                                marginTop: 6,
                                borderTop: "1px dashed rgba(148,163,184,0.6)",
                                paddingTop: 6
                              }
                            },
                            o.items.map((line) =>
                              React.createElement(
                                "div",
                                {
                                  key: String(line && line.key ? line.key : Math.random()),
                                  style: {
                                    display: "flex",
                                    justifyContent: "space-between",
                                    gap: 10,
                                    fontSize: 12,
                                    padding: "2px 0"
                                  }
                                },
                                React.createElement(
                                  "div",
                                  { style: { flex: 1 } },
                                  React.createElement(
                                    "div",
                                    { style: { fontWeight: 700 } },
                                    String((line && line.qty) || 1) + "× ",
                                    lang === "ar"
                                      ? String((line && (line.nameAr || line.name)) || "")
                                      : String((line && (line.nameFr || line.name)) || "")
                                  ),
                                  lineModifiersLabel(line)
                                    ? React.createElement(
                                        "div",
                                        { style: { fontSize: 11, color: "#64748b" } },
                                        lineModifiersLabel(line)
                                      )
                                    : null
                                ),
                                React.createElement(
                                  "div",
                                  { style: { whiteSpace: "nowrap" } },
                                  `${(((line && line.price) || 0) * ((line && line.qty) || 1)).toFixed(2)} DHS`
                                )
                              )
                            )
                          )
                        : null
                    ),
                    React.createElement(
                      "div",
                      { style: { fontWeight: 800, whiteSpace: "nowrap" } },
                      `${((Number((o.totals && o.totals.total) || 0) || 0).toFixed(2))} DHS`
                    )
                  )
                )
          )
        );
      }

      function AdminMenuEditor({ menu, onUpdateMenuItem, onAddMenuItem, onSaveMenu, isPhone }) {
        const [selectedId, setSelectedId] = React.useState((menu && menu[0] && menu[0].id) || "");
        const [newNameFr, setNewNameFr] = React.useState("");
        const [newNameAr, setNewNameAr] = React.useState("");
        const [newPrice, setNewPrice] = React.useState("");
        const [newCategory, setNewCategory] = React.useState("Breakfast");
        const [newImage, setNewImage] = React.useState("");
        const [newError, setNewError] = React.useState(null);

        React.useEffect(() => {
          const list = Array.isArray(menu) ? menu : [];
          if (!list.length) {
            if (selectedId) setSelectedId("");
            return;
          }
          if (!selectedId) {
            setSelectedId(list[0].id);
            return;
          }
          const ok = list.some((m) => m && m.id === selectedId);
          if (!ok) setSelectedId(list[0].id);
        }, [menu]);

        const item = selectedId ? (menu || []).find((m) => m && m.id === selectedId) : null;

        function handleChange(field, value) {
          onUpdateMenuItem(selectedId, { [field]: value });
        }

        function handleNewImageFile(ev) {
          try {
            const file = ev && ev.target && ev.target.files ? ev.target.files[0] : null;
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
              try {
                setNewImage(String(reader.result || ""));
              } catch (e) {}
            };
            reader.readAsDataURL(file);
          } catch (e) {}
        }

        function handleEditImageFile(ev) {
          try {
            if (!item || !item.id) return;
            const file = ev && ev.target && ev.target.files ? ev.target.files[0] : null;
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
              try {
                onUpdateMenuItem(item.id, { image: String(reader.result || "") });
              } catch (e) {}
            };
            reader.readAsDataURL(file);
          } catch (e) {}
        }

        function addNewItem(ev) {
          if (ev && ev.preventDefault) ev.preventDefault();
          setNewError(null);
          const nameFr = String(newNameFr || "").trim();
          const nameAr = String(newNameAr || "").trim();
          const name = nameFr || nameAr;
          if (!name) {
            setNewError("Nom requis.");
            return;
          }
          const priceNum = parseFloat(String(newPrice || "").trim());
          if (!Number.isFinite(priceNum) || priceNum < 0) {
            setNewError("Prix invalide.");
            return;
          }
          const cat = String(newCategory || "").trim() || "Breakfast";

          let id = makeId("menu");
          try {
            const list = Array.isArray(menu) ? menu : [];
            while (list.some((m) => m && m.id === id)) {
              id = makeId("menu");
            }
          } catch (e) {}

          const created = {
            id,
            name,
            nameFr: nameFr || name,
            nameAr: nameAr || "",
            price: Number(priceNum || 0) || 0,
            category: cat,
            image: String(newImage || ""),
            modifiers: []
          };
          if (onAddMenuItem) onAddMenuItem(created);
          setSelectedId(id);
          setNewNameFr("");
          setNewNameAr("");
          setNewPrice("");
          setNewCategory("Breakfast");
          setNewImage("");
        }

        return React.createElement(
          "div",
          {
            style: {
              display: "grid",
              gap: 14,
              alignItems: "flex-start"
            }
          },
          React.createElement(
            "div",
            {
              style: {
                fontSize: 12,
                padding: 10,
                borderRadius: 12,
                background: "linear-gradient(135deg, rgba(255,255,255,0.98), rgba(224,231,255,0.72))",
                border: "1px solid rgba(148,163,184,0.5)",
                boxShadow: "0 10px 24px rgba(15,23,42,0.10)"
              }
            },
            React.createElement(
              "div",
              { style: { display: "flex", justifyContent: "space-between", alignItems: "baseline" } },
              React.createElement("h4", { style: { margin: 0 } }, "Ajouter un article"),
              React.createElement(
                "button",
                {
                  type: "button",
                  className: "category-btn",
                  onClick: () => {
                    setNewNameFr("");
                    setNewNameAr("");
                    setNewPrice("");
                    setNewCategory("Breakfast");
                    setNewImage("");
                    setNewError(null);
                  }
                },
                "Réinitialiser"
              )
            ),
            React.createElement(
              "form",
              { onSubmit: addNewItem, style: { display: "grid", gap: 10, marginTop: 10 } },
              React.createElement(
                "div",
                { style: { display: "grid", gridTemplateColumns: isPhone ? "1fr" : "1fr 1fr", gap: 10 } },
                React.createElement(
                  "div",
                  null,
                  React.createElement("div", { style: { fontWeight: 600, marginBottom: 2 } }, "Nom FR"),
                  React.createElement("input", {
                    value: newNameFr,
                    onChange: (e) => setNewNameFr(e.target.value),
                    style: { width: "100%", padding: 8, fontSize: 12 }
                  })
                ),
                React.createElement(
                  "div",
                  null,
                  React.createElement("div", { style: { fontWeight: 600, marginBottom: 2 } }, "Nom AR"),
                  React.createElement("input", {
                    value: newNameAr,
                    onChange: (e) => setNewNameAr(e.target.value),
                    style: { width: "100%", padding: 8, fontSize: 12 }
                  })
                )
              ),
              React.createElement(
                "div",
                { style: { display: "grid", gridTemplateColumns: isPhone ? "1fr" : "1fr 1fr", gap: 10 } },
                React.createElement(
                  "div",
                  null,
                  React.createElement("div", { style: { fontWeight: 600, marginBottom: 2 } }, "Prix (DHS)"),
                  React.createElement("input", {
                    type: "number",
                    inputMode: "decimal",
                    value: newPrice,
                    onChange: (e) => setNewPrice(e.target.value),
                    style: { width: "100%", padding: 8, fontSize: 12 }
                  })
                ),
                React.createElement(
                  "div",
                  null,
                  React.createElement("div", { style: { fontWeight: 600, marginBottom: 2 } }, "Catégorie"),
                  React.createElement(
                    "select",
                    {
                      value: newCategory,
                      onChange: (e) => setNewCategory(e.target.value),
                      style: { width: "100%", padding: 8, fontSize: 12 }
                    },
                    React.createElement("option", { value: "Breakfast" }, "Breakfast"),
                    React.createElement("option", { value: "Hot Drinks" }, "Hot Drinks"),
                    React.createElement("option", { value: "Cold Drinks" }, "Cold Drinks"),
                    React.createElement("option", { value: "Others" }, "Others")
                  )
                )
              ),
              React.createElement(
                "div",
                null,
                React.createElement("div", { style: { fontWeight: 600, marginBottom: 2 } }, "Image"),
                React.createElement("input", {
                  type: "file",
                  accept: "image/*",
                  onChange: handleNewImageFile,
                  style: { width: "100%", padding: 6, fontSize: 12 }
                }),
                newImage
                  ? React.createElement(
                      "div",
                      { style: { marginTop: 8 } },
                      React.createElement("img", {
                        src: newImage,
                        alt: "preview",
                        style: { width: 120, height: 80, objectFit: "cover", borderRadius: 10, border: "1px solid rgba(148,163,184,0.5)" }
                      })
                    )
                  : null
              ),
              newError
                ? React.createElement(
                    "div",
                    { style: { fontSize: 12, color: "#b91c1c" } },
                    newError
                  )
                : null,
              React.createElement(
                "div",
                { style: { display: "flex", justifyContent: "flex-end" } },
                React.createElement(
                  "button",
                  { className: "btn-primary", type: "submit" },
                  "Ajouter"
                )
              )
            )
          ),
          React.createElement(
            "div",
            {
              style: {
                display: "grid",
                gridTemplateColumns: isPhone ? "1fr" : "minmax(0, 1.4fr) minmax(0, 2fr)",
                gap: 14,
                alignItems: "flex-start"
              }
            },
          React.createElement(
            "div",
            {
              style: {
                minWidth: isPhone ? 0 : 220,
                maxHeight: isPhone ? 220 : 280,
                overflowY: "auto",
                borderRadius: 10,
                background: "linear-gradient(145deg,#f9fafb,#e5e7eb)",
                border: "1px solid #e5e7eb"
              }
            },
            (menu && menu.length
              ? menu.map((m) =>
                  React.createElement(
                    "div",
                    {
                      key: m.id,
                      onClick: () => setSelectedId(m.id),
                      style: {
                        padding: "6px 10px",
                        cursor: "pointer",
                        fontSize: 12,
                        background:
                          m.id === selectedId ? "#e5e7eb" : "transparent"
                      }
                    },
                    m.nameFr || m.name,
                    " - ",
                    m.price.toFixed(2),
                    " DHS"
                  )
                )
              : React.createElement(
                  "div",
                  { style: { padding: 10, fontSize: 12, color: "#6b7280" } },
                  "Aucun article."
                ))
          ),
          React.createElement(
            "div",
            {
              style: {
                flex: 1,
                fontSize: 12,
                padding: 10,
                borderRadius: 12,
                background:
                  "linear-gradient(135deg, rgba(251,251,255,0.98), #e5e7eb)",
                border: "1px solid rgba(148,163,184,0.5)",
                boxShadow: "0 10px 24px rgba(15,23,42,0.12)"
              }
            },
            React.createElement(
              "div",
              { style: { display: "flex", justifyContent: "space-between" } },
              React.createElement("h4", null, "Éditer l'article"),
              React.createElement(
                "button",
                {
                  type: "button",
                  className: "btn-primary",
                  style: {
                    padding: "6px 14px",
                    fontSize: 11
                  },
                  onClick: () => onSaveMenu(menu)
                },
                "Enregistrer"
              )
            ),
            item
              ? React.createElement(
                  "div",
                  { style: { marginTop: 4, fontSize: 11, color: "#6b7280" } },
                  "ID: ",
                  item.id
                )
              : null,
            React.createElement(
              "div",
              { style: { marginTop: 6 } },
              React.createElement(
                "div",
                { style: { fontWeight: 600, marginBottom: 2 } },
                "Nom FR:"
              ),
              React.createElement("input", {
                value: item ? item.nameFr || "" : "",
                onChange: (e) => item && handleChange("nameFr", e.target.value),
                style: { width: "100%", padding: 4, fontSize: 12 }
              })
            ),
            React.createElement(
              "div",
              { style: { marginTop: 6 } },
              React.createElement(
                "div",
                { style: { fontWeight: 600, marginBottom: 2 } },
                "Nom AR:"
              ),
              React.createElement("input", {
                value: item ? item.nameAr || "" : "",
                onChange: (e) => item && handleChange("nameAr", e.target.value),
                style: { width: "100%", padding: 4, fontSize: 12 }
              })
            ),
            React.createElement(
              "div",
              { style: { marginTop: 6 } },
              React.createElement(
                "div",
                { style: { fontWeight: 600, marginBottom: 2 } },
                "Prix DHS:"
              ),
              React.createElement("input", {
                type: "number",
                value: item ? item.price : 0,
                onChange: (e) => item && handleChange("price", parseFloat(e.target.value) || 0),
                style: { width: "100%", padding: 4, fontSize: 12 }
              })
            ),
            React.createElement(
              "div",
              { style: { marginTop: 6 } },
              React.createElement(
                "div",
                { style: { fontWeight: 600, marginBottom: 2 } },
                "Catégorie:"
              ),
              React.createElement(
                "select",
                {
                  value: item ? item.category || "Breakfast" : "Breakfast",
                  onChange: (e) => item && handleChange("category", e.target.value),
                  style: { width: "100%", padding: 4, fontSize: 12 }
                },
                React.createElement("option", { value: "Breakfast" }, "Breakfast"),
                React.createElement("option", { value: "Hot Drinks" }, "Hot Drinks"),
                React.createElement("option", { value: "Cold Drinks" }, "Cold Drinks"),
                React.createElement("option", { value: "Others" }, "Others")
              )
            ),
            React.createElement(
              "div",
              { style: { marginTop: 6 } },
              React.createElement(
                "div",
                { style: { fontWeight: 600, marginBottom: 2 } },
                "Image:"
              ),
              React.createElement("input", {
                type: "file",
                accept: "image/*",
                onChange: handleEditImageFile,
                style: { width: "100%", padding: 4, fontSize: 12 }
              }),
              item && item.image
                ? React.createElement(
                    "div",
                    { style: { marginTop: 8 } },
                    React.createElement("img", {
                      src: resolveImageSrc(item.image),
                      alt: "preview",
                      style: { width: 120, height: 80, objectFit: "cover", borderRadius: 10, border: "1px solid rgba(148,163,184,0.5)" }
                    })
                  )
                : null
            )
          )
          )
        );
      }

      function POSApp() {
        const [lang, setLang] = React.useState("fr");
        const t = DICTIONARY[lang];

        const [isPhone, setIsPhone] = React.useState(() => {
          try {
            return !!(window.matchMedia && window.matchMedia("(max-width: 600px)").matches);
          } catch (e) {
            return false;
          }
        });

        React.useEffect(() => {
          if (!window.matchMedia) return;
          const mq = window.matchMedia("(max-width: 600px)");
          function handleChange(ev) {
            setIsPhone(!!(ev && ev.matches));
          }
          try {
            if (mq.addEventListener) mq.addEventListener("change", handleChange);
            else mq.addListener(handleChange);
          } catch (e) {}
          try {
            setIsPhone(!!mq.matches);
          } catch (e) {}
          return () => {
            try {
              if (mq.removeEventListener) mq.removeEventListener("change", handleChange);
              else mq.removeListener(handleChange);
            } catch (e) {}
          };
        }, []);

        const [activeCategory, setActiveCategory] = React.useState(null);
        const [posSection, setPosSection] = React.useState("sales");
        const [menu, setMenu] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_menu");
            const parsed = raw ? JSON.parse(raw) : null;
            if (Array.isArray(parsed) && parsed.length) {
              return migrateMenuArray(parsed);
            }
          } catch (e) {}
          return INITIAL_MENU_DATA.slice();
        });

        React.useEffect(() => {
          setMenu((p) => migrateMenuArray(p));
        }, []);
        const [users, setUsers] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_state");
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && Array.isArray(parsed.users) && parsed.users.length) return parsed.users;
          } catch (e) {}
          try {
            const rawUsers = window.localStorage.getItem("cafe_halab_users");
            const parsedUsers = rawUsers ? JSON.parse(rawUsers) : null;
            if (Array.isArray(parsedUsers) && parsedUsers.length) return parsedUsers;
          } catch (e) {}
          return USERS.slice();
        });

        React.useEffect(() => {
          setUsers((prev) => ensureDefaultUsers(prev));
        }, []);
        const [cart, setCart] = React.useState([]);
        const [cartEnterKeys, setCartEnterKeys] = React.useState({});
        const cartEnterTimeoutsRef = React.useRef({});
        const prevCartKeysRef = React.useRef(new Set());

        const [favorites, setFavorites] = React.useState([]);
        const [favoritePromptOpen, setFavoritePromptOpen] = React.useState(false);
        const [favoritePromptValue, setFavoritePromptValue] = React.useState("");
        const [favoritePromptError, setFavoritePromptError] = React.useState(null);
        const [favoritePromptLineKey, setFavoritePromptLineKey] = React.useState(null);

        const [cartServiceType, setCartServiceType] = React.useState("dine_in");
        const [glassCupCustomerName, setGlassCupCustomerName] = React.useState("");
        const [orderName, setOrderName] = React.useState("");

        const [exitingOrderIds, setExitingOrderIds] = React.useState({});
        const exitingOrderTimeoutsRef = React.useRef({});

        const [submitting, setSubmitting] = React.useState(false);
        const [status, setStatus] = React.useState(null);

        const [adminUser, setAdminUser] = React.useState(null);
        const [managerUnlocked, setManagerUnlocked] = React.useState(() => {
          try {
            return window.localStorage.getItem("cafe_halab_manager_unlocked") === "1";
          } catch (e) {
            return false;
          }
        });
        const [managerSelectedShiftId, setManagerSelectedShiftId] = React.useState("");
        const [managerGateOpen, setManagerGateOpen] = React.useState(false);
        const [managerGateValue, setManagerGateValue] = React.useState("");
        const [managerGateError, setManagerGateError] = React.useState(null);
        const [activeWorker, setActiveWorker] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_session");
            const sess = raw ? JSON.parse(raw) : null;
            const id = sess && sess.activeWorkerId ? sess.activeWorkerId : null;
            if (!id) return null;
            let pool = USERS;
            try {
              const rawState = window.localStorage.getItem("cafe_halab_state");
              const parsedState = rawState ? JSON.parse(rawState) : null;
              if (parsedState && Array.isArray(parsedState.users) && parsedState.users.length) {
                pool = parsedState.users;
              }
            } catch (e) {}
            try {
              const rawUsers = window.localStorage.getItem("cafe_halab_users");
              const parsedUsers = rawUsers ? JSON.parse(rawUsers) : null;
              if (Array.isArray(parsedUsers) && parsedUsers.length) pool = parsedUsers;
            } catch (e) {}
            return (pool || []).find((u) => u && u.id === id) || null;
          } catch (e) {
            return null;
          }
        });
        const [view, setView] = React.useState("pos");
        const [adminSection, setAdminSection] = React.useState("overview");
        const [activeShift, setActiveShift] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_session");
            const sess = raw ? JSON.parse(raw) : null;
            const s = sess && sess.activeShift ? sess.activeShift : null;
            if (!s || typeof s !== "object") return null;
            return s;
          } catch (e) {
            return null;
          }
        });
        const [shifts, setShifts] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_state");
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && Array.isArray(parsed.shifts)) return parsed.shifts;
          } catch (e) {}
          return [];
        });
        const [adminOverviewShiftId, setAdminOverviewShiftId] = React.useState("");
        const [orders, setOrders] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_state");
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && Array.isArray(parsed.orders)) return parsed.orders;
          } catch (e) {}
          return [];
        });
        const [cupLoans, setCupLoans] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_state");
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && Array.isArray(parsed.cupLoans)) return parsed.cupLoans;
          } catch (e) {}
          return [];
        });
        const [clientDebts, setClientDebts] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_state");
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && Array.isArray(parsed.clientDebts)) return parsed.clientDebts;
          } catch (e) {}
          return [];
        });
        const [advances, setAdvances] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_state");
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && Array.isArray(parsed.advances)) return parsed.advances;
          } catch (e) {}
          return [];
        });
        const [closeShiftGateOpen, setCloseShiftGateOpen] = React.useState(false);
        const [closeShiftDebtNames, setCloseShiftDebtNames] = React.useState({});
        const [closeShiftFloatOpen, setCloseShiftFloatOpen] = React.useState(false);
        const [closeShiftFloatValue, setCloseShiftFloatValue] = React.useState("");
        const [closeShiftFloatError, setCloseShiftFloatError] = React.useState(null);
        const [closeShiftTargetId, setCloseShiftTargetId] = React.useState(null);
        const [closeShiftReport, setCloseShiftReport] = React.useState(null);
        const [pendingShiftOpen, setPendingShiftOpen] = React.useState(null);
        const [floatConfirmOpen, setFloatConfirmOpen] = React.useState(false);
        const [floatConfirmExpected, setFloatConfirmExpected] = React.useState(null);
        const [floatConfirmValue, setFloatConfirmValue] = React.useState("");
        const [floatConfirmError, setFloatConfirmError] = React.useState(null);

        const [advanceOpen, setAdvanceOpen] = React.useState(false);
        const [advanceAmount, setAdvanceAmount] = React.useState("");
        const [advanceError, setAdvanceError] = React.useState(null);
        const [inventory, setInventory] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_state");
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && parsed.inventory && typeof parsed.inventory === "object") {
              const merged = { ...INVENTORY_INITIAL };
              Object.keys(parsed.inventory || {}).forEach((id) => {
                const saved = parsed.inventory[id];
                if (!saved || typeof saved !== "object") return;
                const base = merged[id] && typeof merged[id] === "object" ? merged[id] : { id };
                merged[id] = { ...base, ...saved, id };
              });
              return merged;
            }
          } catch (e) {}
          return INVENTORY_INITIAL;
        });
        const [inventoryLogs, setInventoryLogs] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_state");
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && Array.isArray(parsed.inventoryLogs)) return parsed.inventoryLogs;
          } catch (e) {}
          return [];
        });

        const [purchaseInvoices, setPurchaseInvoices] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_state");
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && Array.isArray(parsed.purchaseInvoices)) return parsed.purchaseInvoices;
          } catch (e) {}
          return [];
        });

        const [stockCountRequests, setStockCountRequests] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_state");
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && Array.isArray(parsed.stockCountRequests)) return parsed.stockCountRequests;
          } catch (e) {}
          return [];
        });

        const [firebaseUser, setFirebaseUser] = React.useState(null);
        const [firebaseAuthReady, setFirebaseAuthReady] = React.useState(false);
        const [firebaseLoginDismissed, setFirebaseLoginDismissed] = React.useState(false);

        const [shiftPin, setShiftPin] = React.useState("");
        const [calcOpen, setCalcOpen] = React.useState(false);
        const [purchaseOpen, setPurchaseOpen] = React.useState(false);
        const [calcExpr, setCalcExpr] = React.useState("");
        const [calcCashPaid, setCalcCashPaid] = React.useState("");
        const [calcManualAmount, setCalcManualAmount] = React.useState("");
        const [cupLoansOpen, setCupLoansOpen] = React.useState(false);

        React.useEffect(() => {
          try {
            window.localStorage.setItem("cafe_halab_manager_unlocked", managerUnlocked ? "1" : "0");
          } catch (e) {}
        }, [managerUnlocked]);

        React.useEffect(() => {
          if (purchaseOpen && !activeShift) setPurchaseOpen(false);
        }, [purchaseOpen, activeShift]);
        const [calcItems, setCalcItems] = React.useState([]);
        const [calcNumTarget, setCalcNumTarget] = React.useState("cash");
        const [waiterPeriod, setWaiterPeriod] = React.useState(() => {
          try {
            const ctx = autoShiftContextNow();
            return (ctx && ctx.period) || "morning";
          } catch (e) {
            return "morning";
          }
        });
        const [shiftError, setShiftError] = React.useState(null);

        const blockingOpenShift = React.useMemo(() => {
          try {
            return (shifts || []).find((s) => s && s.status === "open") || null;
          } catch (e) {
            return null;
          }
        }, [shifts]);

        const pinWorkerCandidate = React.useMemo(() => {
          try {
            const v = normalizePinValue(shiftPin);
            if (v.length !== 4) return null;
            return (
              (users || []).find(
                (u) => u && u.role === "worker" && u.posAccess !== false && u.pin === v
              ) || null
            );
          } catch (e) {
            return null;
          }
        }, [shiftPin, users]);

        function canWorkerForceCloseShift(worker, shift) {
          if (!worker || !shift) return false;
          const opener = shift.openedBy || shift.currentOperatorId || null;
          if (!opener) return true;
          return opener === worker.id;
        }

        function startForceCloseShift(shiftId, closedById) {
          if (!shiftId) return;
          const rec = (shifts || []).find((s) => s && s.id === shiftId) || null;
          if (!rec || rec.status !== "open") {
            setShiftError(lang === "ar" ? "لا يوجد شيفت مفتوح." : "Aucun shift ouvert.");
            return;
          }
          setCloseShiftActorOverride(closedById || null);
          setShiftError(null);
          openCloseShiftFloatPrompt(shiftId);
        }

        const [shiftPaused, setShiftPaused] = React.useState(() => {
          try {
            const raw = window.localStorage.getItem("cafe_halab_session");
            const sess = raw ? JSON.parse(raw) : null;
            return !!(sess && sess.shiftPaused);
          } catch (e) {
            return false;
          }
        });
        const [pinPromptMode, setPinPromptMode] = React.useState(null);
        const [pinPromptValue, setPinPromptValue] = React.useState("");
        const [pinPromptError, setPinPromptError] = React.useState(null);
        const lastActivityRef = React.useRef(Date.now());

        const [handoffOpen, setHandoffOpen] = React.useState(false);
        const [handoffToWorkerId, setHandoffToWorkerId] = React.useState("");
        const [handoffFromPin, setHandoffFromPin] = React.useState("");
        const [handoffToPin, setHandoffToPin] = React.useState("");
        const [handoffFromAmount, setHandoffFromAmount] = React.useState("");
        const [handoffToAmount, setHandoffToAmount] = React.useState("");
        const [handoffError, setHandoffError] = React.useState(null);

        const [adminOpenDate, setAdminOpenDate] = React.useState("");
        const [adminOpenPeriod, setAdminOpenPeriod] = React.useState("");
        const [adminOpenWorkerId, setAdminOpenWorkerId] = React.useState("");
        const [adminOpenFloat, setAdminOpenFloat] = React.useState("");

        const [closeShiftActorOverride, setCloseShiftActorOverride] = React.useState(null);

        const CLOUD_APP_ID = "cafe-halab-pos";
        const cloudEnabled = !!(window.firebaseDb && firebaseUser);

        React.useEffect(() => {
          const cutoff = Date.now() - 72 * 60 * 60 * 1000;
          const recent = (shifts || []).filter((s) => s && shiftTimeMs(s) >= cutoff);
          const recentIds = new Set(recent.map((s) => s && s.id).filter(Boolean));
          const preferred =
            activeShift && activeShift.id && recentIds.has(activeShift.id)
              ? activeShift.id
              : null;
          const lastRecent = recent.length ? recent[recent.length - 1] : null;
          const fallback =
            preferred ||
            (lastRecent && lastRecent.id) ||
            ((shifts && shifts[shifts.length - 1] && shifts[shifts.length - 1].id) || "");
          if (!adminOverviewShiftId) {
            if (fallback) setAdminOverviewShiftId(fallback);
            return;
          }
          if (recentIds.size && recentIds.has(adminOverviewShiftId)) return;
          if (fallback && fallback !== adminOverviewShiftId) setAdminOverviewShiftId(fallback);
        }, [shifts, activeShift, adminOverviewShiftId]);

        function makeId(prefix) {
          return (
            prefix +
            "_" +
            Date.now() +
            "_" +
            Math.random().toString(16).slice(2)
          );
        }

        function hashString(str) {
          const s = String(str == null ? "" : str);
          let h = 5381;
          for (let i = 0; i < s.length; i++) {
            h = ((h << 5) + h) ^ s.charCodeAt(i);
          }
          return (h >>> 0).toString(16);
        }

        function stableStringify(obj) {
          if (!obj || typeof obj !== "object") return JSON.stringify(obj);
          const keys = Object.keys(obj).sort();
          const out = {};
          for (let i = 0; i < keys.length; i++) {
            const k = keys[i];
            out[k] = obj[k];
          }
          return JSON.stringify(out);
        }

        const deviceIdRef = React.useRef(null);

        React.useEffect(() => {
          if (deviceIdRef.current) return;
          try {
            const existing = window.localStorage.getItem("cafe_halab_device_id");
            if (existing) {
              deviceIdRef.current = existing;
              return;
            }
          } catch (e) {}

          deviceIdRef.current = makeId("dev");
          try {
            window.localStorage.setItem("cafe_halab_device_id", deviceIdRef.current);
          } catch (e) {}
        }, []);

        function cloudAppDoc() {
          if (!window.firebaseDb) return null;
          return window.firebaseDb.collection("posApps").doc(CLOUD_APP_ID);
        }

        function cloudCol(name) {
          const root = cloudAppDoc();
          return root ? root.collection(name) : null;
        }

        React.useEffect(() => {
          try {
            window.localStorage.setItem(
              "cafe_halab_state",
              JSON.stringify({
                shifts,
                orders,
                cupLoans,
                clientDebts,
                inventory,
                inventoryLogs,
                purchaseInvoices,
                stockCountRequests,
                users,
                advances
              })
            );
          } catch (e) {}
        }, [shifts, orders, cupLoans, clientDebts, inventory, inventoryLogs, purchaseInvoices, stockCountRequests, users, advances]);

        React.useEffect(() => {
          try {
            window.localStorage.setItem("cafe_halab_users", JSON.stringify(users || []));
          } catch (e) {}
        }, [users]);

        React.useEffect(() => {
          try {
            window.localStorage.setItem(
              "cafe_halab_session",
              JSON.stringify({
                activeWorkerId: activeWorker ? activeWorker.id : null,
                activeShift: activeShift || null,
                shiftPaused: !!shiftPaused
              })
            );
          } catch (e) {}
        }, [activeWorker, activeShift, shiftPaused]);

        React.useEffect(() => {
          if (!activeShift) return;
          const found = shifts.find((s) => s && s.id === activeShift.id);
          if (!found) return;
          if (found.status && found.status !== "open") {
            setActiveShift(null);
            setActiveWorker(null);
            setShiftPaused(false);
            return;
          }
          setActiveShift(found);
        }, [shifts]);

        React.useEffect(() => {
          if (!window.firebaseAuth || !window.firebaseAuth.onAuthStateChanged) {
            setFirebaseAuthReady(true);
            return;
          }
          const unsub = window.firebaseAuth.onAuthStateChanged((u) => {
            setFirebaseUser(u || null);
            setFirebaseAuthReady(true);
          });
          return () => {
            try {
              if (typeof unsub === "function") unsub();
            } catch (e) {}
          };
        }, []);

        function openFirebaseLogin() {
          setFirebaseLoginDismissed(false);
        }

        function dismissFirebaseLogin() {
          setFirebaseLoginDismissed(true);
        }

        function handleFirebaseSignedIn(u) {
          setFirebaseUser(u || (window.firebaseAuth ? window.firebaseAuth.currentUser : null));
          setFirebaseLoginDismissed(false);
        }

        function handleFirebaseLogout() {
          if (!window.firebaseAuth) return;
          try {
            window.firebaseAuth.signOut();
          } catch (e) {}
          setFirebaseLoginDismissed(false);
        }

        React.useEffect(() => {
          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          if (!db) return;

          const shiftsCol = cloudCol("shifts");
          const ordersCol = cloudCol("orders");
          const cupLoansCol = cloudCol("cupLoans");
          const debtsCol = cloudCol("clientDebts");
          const invCol = cloudCol("inventory");
          const logsCol = cloudCol("inventoryLogs");
          const invoicesCol = cloudCol("purchaseInvoices");
          const stockCountsCol = cloudCol("stockCountRequests");
          const usersCol = cloudCol("users");
          const advancesCol = cloudCol("advances");
          if (!shiftsCol || !ordersCol || !cupLoansCol || !debtsCol || !invCol || !logsCol || !invoicesCol || !stockCountsCol || !usersCol || !advancesCol) return;

          let cancelled = false;

          invCol
            .limit(1)
            .get()
            .then((snap) => {
              if (cancelled) return;
              if (!snap || !snap.empty) return;
              const batch = db.batch();
              const nowIso = new Date().toISOString();
              Object.values(INVENTORY_INITIAL || {}).forEach((ing) => {
                if (!ing || !ing.id) return;
                batch.set(
                  invCol.doc(ing.id),
                  {
                    id: ing.id,
                    name: ing.name || ing.id,
                    unit: ing.unit || "",
                    currentQty: ing.currentQty,
                    minQty: ing.minQty,
                    updatedAt: nowIso
                  },
                  { merge: true }
                );
              });
              return batch.commit();
            })
            .catch(() => {});

          usersCol
            .limit(1)
            .get()
            .then((snap) => {
              if (cancelled) return;
              if (!snap || !snap.empty) return;
              const batch = db.batch();
              const nowIso = new Date().toISOString();
              (USERS || []).forEach((u) => {
                if (!u || !u.id) return;
                batch.set(
                  usersCol.doc(u.id),
                  {
                    id: u.id,
                    name: u.name || u.id,
                    role: u.role || "worker",
                    pin: u.pin || "",
                    salary: typeof u.salary === "number" ? u.salary : 0,
                    appId: CLOUD_APP_ID,
                    deviceId: deviceIdRef.current,
                    updatedAt: nowIso
                  },
                  { merge: true }
                );
              });
              return batch.commit();
            })
            .catch(() => {});

          const unsubShifts = shiftsCol.onSnapshot(
            (snap) => {
              const next = [];
              snap.forEach((doc) => {
                const d = doc && doc.data ? doc.data() : null;
                if (!d || typeof d !== "object") return;
                next.push({ ...d, id: d.id || doc.id });
              });
              next.sort((a, b) => String(a.id || "").localeCompare(String(b.id || "")));
              setShifts(next);
            },
            (err) => {
              setStatus({ type: "err", message: String((err && err.message) || err || "Cloud error") });
            }
          );

          const unsubOrders = ordersCol.onSnapshot(
            (snap) => {
              const next = [];
              snap.forEach((doc) => {
                const d = doc && doc.data ? doc.data() : null;
                if (!d || typeof d !== "object") return;
                next.push({ ...d, id: d.id || doc.id });
              });
              next.sort((a, b) => String(a.createdAt || "").localeCompare(String(b.createdAt || "")));
              setOrders(next);
            },
            (err) => {
              setStatus({ type: "err", message: String((err && err.message) || err || "Cloud error") });
            }
          );

          const unsubCupLoans = cupLoansCol.onSnapshot(
            (snap) => {
              const next = [];
              snap.forEach((doc) => {
                const d = doc && doc.data ? doc.data() : null;
                if (!d || typeof d !== "object") return;
                next.push({ ...d, id: d.id || doc.id });
              });
              next.sort((a, b) => String(a.createdAt || "").localeCompare(String(b.createdAt || "")));
              setCupLoans(next);
            },
            (err) => {
              setStatus({ type: "err", message: String((err && err.message) || err || "Cloud error") });
            }
          );

          const unsubDebts = debtsCol.onSnapshot(
            (snap) => {
              const next = [];
              snap.forEach((doc) => {
                const d = doc && doc.data ? doc.data() : null;
                if (!d || typeof d !== "object") return;
                next.push({ ...d, id: d.id || doc.id });
              });
              next.sort((a, b) => String(a.createdAt || "").localeCompare(String(b.createdAt || "")));
              setClientDebts(next);
            },
            (err) => {
              setStatus({ type: "err", message: String((err && err.message) || err || "Cloud error") });
            }
          );

          const unsubInv = invCol.onSnapshot(
            (snap) => {
              const merged = { ...INVENTORY_INITIAL };
              snap.forEach((doc) => {
                const d = doc && doc.data ? doc.data() : null;
                if (!d || typeof d !== "object") return;
                const id = d.id || doc.id;
                const base = merged[id] && typeof merged[id] === "object" ? merged[id] : { id };
                merged[id] = { ...base, ...d, id };
              });
              setInventory(merged);
            },
            (err) => {
              setStatus({ type: "err", message: String((err && err.message) || err || "Cloud error") });
            }
          );

          const unsubLogs = logsCol.onSnapshot(
            (snap) => {
              const next = [];
              snap.forEach((doc) => {
                const d = doc && doc.data ? doc.data() : null;
                if (!d || typeof d !== "object") return;
                next.push({ ...d, id: d.id || doc.id });
              });
              next.sort((a, b) => String(a.createdAt || "").localeCompare(String(b.createdAt || "")));
              setInventoryLogs(next);
            },
            (err) => {
              setStatus({ type: "err", message: String((err && err.message) || err || "Cloud error") });
            }
          );

          const unsubInvoices = invoicesCol.onSnapshot(
            (snap) => {
              const next = [];
              snap.forEach((doc) => {
                const d = doc && doc.data ? doc.data() : null;
                if (!d || typeof d !== "object") return;
                next.push({ ...d, id: d.id || doc.id });
              });
              next.sort((a, b) => String(a.createdAt || "").localeCompare(String(b.createdAt || "")));
              setPurchaseInvoices(next);
            },
            (err) => {
              setStatus({ type: "err", message: String((err && err.message) || err || "Cloud error") });
            }
          );

          const unsubStockCounts = stockCountsCol.onSnapshot(
            (snap) => {
              const next = [];
              snap.forEach((doc) => {
                const d = doc && doc.data ? doc.data() : null;
                if (!d || typeof d !== "object") return;
                next.push({ ...d, id: d.id || doc.id });
              });
              next.sort((a, b) => String(a.requestedAt || a.createdAt || "").localeCompare(String(b.requestedAt || b.createdAt || "")));
              setStockCountRequests(next);
            },
            (err) => {
              setStatus({ type: "err", message: String((err && err.message) || err || "Cloud error") });
            }
          );

          const unsubUsers = usersCol.onSnapshot(
            (snap) => {
              const next = [];
              snap.forEach((doc) => {
                const d = doc && doc.data ? doc.data() : null;
                if (!d || typeof d !== "object") return;
                next.push({ ...d, id: d.id || doc.id });
              });
              next.sort((a, b) => String(a.name || a.id || "").localeCompare(String(b.name || b.id || "")));
              const merged = ensureDefaultUsers(next);
              setUsers(merged);

              try {
                const have = new Set(next.map((u) => (u && u.id ? String(u.id) : null)).filter(Boolean));
                const nowIso = new Date().toISOString();
                (USERS || []).forEach((u) => {
                  if (!u || !u.id) return;
                  if (have.has(String(u.id))) return;
                  usersCol
                    .doc(String(u.id))
                    .set(
                      {
                        id: String(u.id),
                        name: u.name || String(u.id),
                        role: u.role || "worker",
                        pin: u.pin || "",
                        salary: typeof u.salary === "number" ? u.salary : 0,
                        appId: CLOUD_APP_ID,
                        deviceId: deviceIdRef.current,
                        updatedAt: nowIso
                      },
                      { merge: true }
                    )
                    .catch(() => {});
                });
              } catch (e) {}
            },
            (err) => {
              setStatus({ type: "err", message: String((err && err.message) || err || "Cloud error") });
            }
          );

          const unsubAdvances = advancesCol.onSnapshot(
            (snap) => {
              const next = [];
              snap.forEach((doc) => {
                const d = doc && doc.data ? doc.data() : null;
                if (!d || typeof d !== "object") return;
                next.push({ ...d, id: d.id || doc.id });
              });
              next.sort((a, b) => String(a.requestedAt || "").localeCompare(String(b.requestedAt || "")));
              setAdvances(next);
            },
            (err) => {
              setStatus({ type: "err", message: String((err && err.message) || err || "Cloud error") });
            }
          );

          return () => {
            cancelled = true;
            try {
              if (typeof unsubShifts === "function") unsubShifts();
            } catch (e) {}
            try {
              if (typeof unsubOrders === "function") unsubOrders();
            } catch (e) {}
            try {
              if (typeof unsubCupLoans === "function") unsubCupLoans();
            } catch (e) {}
            try {
              if (typeof unsubDebts === "function") unsubDebts();
            } catch (e) {}
            try {
              if (typeof unsubInv === "function") unsubInv();
            } catch (e) {}
            try {
              if (typeof unsubLogs === "function") unsubLogs();
            } catch (e) {}
            try {
              if (typeof unsubInvoices === "function") unsubInvoices();
            } catch (e) {}
            try {
              if (typeof unsubStockCounts === "function") unsubStockCounts();
            } catch (e) {}
            try {
              if (typeof unsubUsers === "function") unsubUsers();
            } catch (e) {}
            try {
              if (typeof unsubAdvances === "function") unsubAdvances();
            } catch (e) {}
          };
        }, [cloudEnabled]);

        React.useEffect(() => {
          if (!activeWorker || !activeWorker.id) return;
          const u = (users || []).find((x) => x && x.id === activeWorker.id) || null;
          if (!u) {
            setActiveWorker(null);
            return;
          }
          if (u.name !== activeWorker.name || u.pin !== activeWorker.pin) {
            setActiveWorker(u);
          }
        }, [users]);

        const activeWorkerId = activeWorker && activeWorker.id ? String(activeWorker.id) : "";

        React.useEffect(() => {
          if (!activeWorkerId) {
            setFavorites([]);
            return;
          }
          if (cloudEnabled) return;
          try {
            const raw = window.localStorage.getItem("cafe_halab_favorites_" + activeWorkerId);
            const parsed = raw ? JSON.parse(raw) : null;
            if (Array.isArray(parsed)) {
              setFavorites(parsed);
              return;
            }
          } catch (e) {}
          setFavorites([]);
        }, [activeWorkerId, cloudEnabled]);

        React.useEffect(() => {
          if (!activeWorkerId) return;
          if (cloudEnabled) return;
          try {
            window.localStorage.setItem(
              "cafe_halab_favorites_" + activeWorkerId,
              JSON.stringify(favorites || [])
            );
          } catch (e) {}
        }, [favorites, activeWorkerId, cloudEnabled]);

        React.useEffect(() => {
          if (!cloudEnabled) return;
          if (!activeWorkerId) {
            setFavorites([]);
            return;
          }
          const favCol = cloudCol("favorites");
          if (!favCol) return;
          const unsub = favCol.where("userId", "==", activeWorkerId).onSnapshot(
            (snap) => {
              const next = [];
              snap.forEach((doc) => {
                const d = doc && doc.data ? doc.data() : null;
                if (!d || typeof d !== "object") return;
                next.push({ ...d, id: d.id || doc.id });
              });
              next.sort((a, b) => String(a.name || a.id || "").localeCompare(String(b.name || b.id || "")));
              setFavorites(next);
            },
            (err) => {
              setStatus({ type: "err", message: String((err && err.message) || err || "Cloud error") });
            }
          );
          return () => {
            try {
              if (typeof unsub === "function") unsub();
            } catch (e) {}
          };
        }, [cloudEnabled, activeWorkerId]);

        const categories = React.useMemo(
          () => INITIAL_CATEGORIES.slice(),
          []
        );

        const favoritesById = React.useMemo(() => {
          const map = {};
          (favorites || []).forEach((f) => {
            if (!f || !f.id) return;
            map[String(f.id)] = f;
          });
          return map;
        }, [favorites]);

        const favoritesSorted = React.useMemo(() => {
          return (favorites || [])
            .slice()
            .sort((a, b) =>
              String(b.updatedAt || b.createdAt || "").localeCompare(String(a.updatedAt || a.createdAt || ""))
            );
        }, [favorites]);

        const filteredProducts = React.useMemo(() => {
          if (!activeCategory) return [];
          return menu.filter((p) => p.category === activeCategory);
        }, [activeCategory, menu]);

        const unpaidOrders = React.useMemo(() => {
          if (!activeShift) return [];
          return orders.filter(
            (o) => o.shiftId === activeShift.id && o.status === "unpaid"
          );
        }, [orders, activeShift]);

        const blockingCloseOrders = React.useMemo(() => {
          if (!activeShift) return [];
          return (orders || [])
            .filter((o) => o && o.shiftId === activeShift.id && o.status === "unpaid")
            .slice()
            .sort((a, b) => String(b.createdAt || "").localeCompare(String(a.createdAt || "")));
        }, [orders, activeShift]);

        const waiterDebtsToCollect = React.useMemo(() => {
          if (!activeWorker) return [];
          return (clientDebts || [])
            .filter((d) => d && d.waiterId === activeWorker.id && !d.paidAt)
            .slice()
            .sort((a, b) => String(b.createdAt || "").localeCompare(String(a.createdAt || "")));
        }, [clientDebts, activeWorker]);

        function formatTime(iso) {
          try {
            const d = new Date(iso);
            return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
          } catch (e) {
            return "";
          }
        }

        function displayOrderNumber(orderId) {
          if (!orderId) return "";
          const digits = String(orderId).replace(/\D/g, "");
          if (digits.length) return digits.slice(-4);
          return String(orderId).slice(-4);
        }

        function userNameById(userId) {
          const u = users.find((x) => x.id === userId);
          return u ? u.name : userId;
        }

        function lineLabel(line) {
          const base = lang === "ar" ? line.nameAr || line.name : line.nameFr || line.name;
          return base;
        }

        function lineModifiersLabel(line) {
          const mods = line.modifiers || {};
          const parts = [];
          if (mods.milk != null) {
            parts.push(`${t.milkInLine}: ${mods.milk ? t.milkYes : t.milkNo}`);
          }
          if (mods.sugar) {
            parts.push(`${t.sugarInLine}: ${mods.sugar}`);
          }
          if (mods.sirop) {
            parts.push(`${(t && t.siropInLine) || "sirop"}: ${(t && t.siropWith) || "Avec"}`);
          }
          if (mods.water) {
            const fee = Number(mods.waterFee) || 0;
            parts.push(
              `${(t && t.waterInLine) || "eau"}: ${(t && t.waterWith) || "Avec"}${fee ? " +" + fee : ""}`
            );
          }
          if (mods.waterSize) {
            const label =
              mods.waterSize === "half"
                ? (t && t.waterHalf) || "1/2L"
                : (t && t.waterQuarter) || "1/4L";
            parts.push(`${(t && t.waterInLine) || "eau"}: ${label}`);
          }
          if (mods.herb) {
            parts.push(`${t.herbInLine}: ${herbValueLabel(mods.herb, t)}`);
          }
          if (mods.drink) {
            parts.push(`${t.drinkInLine}: ${mods.drink}`);
          }
          if (mods.eggCount) {
            parts.push(`${t.eggsInLine}: ${mods.eggCount}`);
          }
          if (mods.sbDrinkId || mods.sbDrinkName || mods.sbDrinkNameFr || mods.sbDrinkNameAr) {
            const sbDrinkLabel =
              lang === "ar"
                ? mods.sbDrinkNameAr || mods.sbDrinkName || mods.sbDrinkNameFr || ""
                : mods.sbDrinkNameFr || mods.sbDrinkName || mods.sbDrinkNameAr || "";
            if (sbDrinkLabel) {
              parts.push((lang === "ar" ? "مشروب" : "Boisson") + ": " + sbDrinkLabel);
            }
          }
          if (mods.sbEggCount) {
            parts.push((lang === "ar" ? "بيض" : "Oeufs") + ": " + String(mods.sbEggCount));
          }
          if (mods.sbKashir) parts.push(lang === "ar" ? "كاشير" : "Kashir");
          if (mods.sbFromage) parts.push(lang === "ar" ? "جبن" : "Fromage");
          if (mods.sbWater) parts.push(lang === "ar" ? "ماء" : "Eau");
          if (mods.sbCroissant) parts.push(lang === "ar" ? "كرواسون" : "Croissant");
          if (mods.sbBreakfastSet) parts.push(lang === "ar" ? "باك الفطور (+5)" : "Breakfast set (+5)");
          if (mods.sbCheesePieces) {
            parts.push(
              (lang === "ar" ? "قطع الجبن" : "Fromage pièces") + ": " + String(mods.sbCheesePieces)
            );
          }
          if (line && (line.containerType || line.cupSize)) {
            const typeLabel =
              line.containerType === "glass"
                ? lang === "ar"
                  ? "زجاج"
                  : "Verre"
                : lang === "ar"
                ? "بلاستيك"
                : "Jetable";
            const sizeLabel =
              line.cupSize === "large"
                ? lang === "ar"
                  ? "كبير"
                  : "Grand"
                : lang === "ar"
                ? "صغير"
                : "Petit";
            parts.push(
              (lang === "ar" ? "كأس" : "Gobelet") + ": " + typeLabel + " " + sizeLabel
            );
          }
          return parts.length ? "(" + parts.join(", ") + ")" : "";
        }

        React.useEffect(() => {
          if (!activeShift || !activeWorker) return;

          function bump() {
            lastActivityRef.current = Date.now();
          }

          const events = ["click", "keydown", "touchstart", "mousemove"];
          events.forEach((ev) => window.addEventListener(ev, bump, true));
          return () => {
            events.forEach((ev) => window.removeEventListener(ev, bump, true));
          };
        }, [activeShift, activeWorker]);

        React.useEffect(() => {
          if (!activeShift || !activeWorker) return;
          if (shiftPaused) return;

          const timeoutMs = 5 * 60 * 1000;
          const interval = window.setInterval(() => {
            if (Date.now() - lastActivityRef.current >= timeoutMs) {
              setShiftPaused(true);
              setStatus({
                type: "err",
                message:
                  t.autoPausedMessage ||
                  "Shift mis en pause automatiquement (inactivité)."
              });
            }
          }, 1000);

          return () => window.clearInterval(interval);
        }, [activeShift, activeWorker, shiftPaused, t]);

        function openPinPrompt(mode) {
          setPinPromptMode(mode);
          setPinPromptValue("");
          setPinPromptError(null);
        }

        function normalizePinValue(v) {
          return String(v == null ? "" : v)
            .replace(/\D/g, "")
            .slice(0, 4);
        }

        function pinShiftDigit(d) {
          setShiftPin((p) => normalizePinValue(String(p || "") + String(d)));
        }

        function pinShiftBackspace() {
          setShiftPin((p) => normalizePinValue(String(p || "").slice(0, -1)));
        }

        function pinShiftConfirm() {
          if (normalizePinValue(shiftPin).length !== 4) return;
          handleOpenWaiterShift({ preventDefault: () => {} });
        }

        function pinPromptDigit(d) {
          setPinPromptValue((p) => normalizePinValue(String(p || "") + String(d)));
        }

        function pinPromptBackspace() {
          setPinPromptValue((p) => normalizePinValue(String(p || "").slice(0, -1)));
        }

        function pinPromptConfirm() {
          if (normalizePinValue(pinPromptValue).length !== 4) return;
          confirmPinPrompt({ preventDefault: () => {} });
        }

        function renderPinPad(value, onDigit, onBackspace, onConfirm, confirmLabel) {
          const ready = normalizePinValue(value).length === 4;
          const baseBtn = {
            width: "100%",
            padding: "12px 0",
            borderRadius: 14,
            fontSize: 20,
            fontWeight: 900
          };
          return e(
            "div",
            {
              style: {
                display: "grid",
                gridTemplateColumns: "repeat(3, minmax(0, 1fr))",
                gap: 10,
                width: "100%",
                maxWidth: 320,
                margin: "12px auto 0"
              }
            },
            ["1", "2", "3", "4", "5", "6", "7", "8", "9"].map((d) =>
              e(
                "button",
                {
                  key: d,
                  type: "button",
                  className: "category-btn",
                  style: baseBtn,
                  onClick: () => onDigit && onDigit(d)
                },
                d
              )
            ),
            e(
              "button",
              {
                key: "0",
                type: "button",
                className: "category-btn",
                style: baseBtn,
                onClick: () => onDigit && onDigit("0")
              },
              "0"
            ),
            e(
              "button",
              {
                key: "bs",
                type: "button",
                className: "category-btn pin-backspace",
                style: Object.assign({}, baseBtn, { background: "#fff7ed", border: "1px solid rgba(245,158,11,0.6)" }),
                onClick: () => onBackspace && onBackspace()
              },
              "⌫"
            ),
            e(
              "button",
              {
                key: "ok",
                type: "button",
                className: "btn-primary",
                disabled: !ready,
                style: baseBtn,
                onClick: () => onConfirm && onConfirm()
              },
              confirmLabel || (t && t.confirmPinBtn) || "Confirmer"
            )
          );
        }

        function calcSafeEval(expr) {
          const raw = String(expr == null ? "" : expr)
            .replace(/×/g, "*")
            .replace(/÷/g, "/")
            .trim();
          if (!raw) return null;
          if (!/^[0-9+\-*/().\s]*$/.test(raw)) return null;
          try {
            const v = Function('"use strict";return (' + raw + ')')();
            return typeof v === "number" && Number.isFinite(v) ? v : null;
          } catch (e) {
            return null;
          }
        }

        const calcExprValue = React.useMemo(() => calcSafeEval(calcExpr), [calcExpr]);
        const calcTotalToPay = React.useMemo(
          () => (calcItems || []).reduce((s, it) => s + (Number(it && it.amount) || 0), 0),
          [calcItems]
        );
        const calcCashPaidNum = React.useMemo(() => {
          const n = parseCash(calcCashPaid);
          return n == null ? 0 : n;
        }, [calcCashPaid]);
        const calcChangeDue = React.useMemo(
          () => calcCashPaidNum - (Number(calcTotalToPay) || 0),
          [calcCashPaidNum, calcTotalToPay]
        );

        function calcAppend(tok) {
          setCalcExpr((p) => String(p || "") + String(tok || ""));
        }

        function calcExprBackspace() {
          setCalcExpr((p) => String(p || "").slice(0, -1));
        }

        function calcExprClear() {
          setCalcExpr("");
        }

        function calcExprApplyResult() {
          if (calcExprValue == null) return;
          setCalcExpr(String(calcExprValue));
        }

        function calcClearAll() {
          setCalcExpr("");
          setCalcCashPaid("");
          setCalcManualAmount("");
          setCalcItems([]);
        }

        function calcAddManual() {
          const n = parseCash(calcManualAmount);
          if (n == null) return;
          setCalcItems((p) => [
            ...((p || []).filter(Boolean)),
            { id: makeId("calc"), label: lang === "ar" ? "يدوي" : "Manuel", amount: n, kind: "manual" }
          ]);
          setCalcManualAmount("");
        }

        function calcAddOrderById(orderId) {
          const id = String(orderId || "");
          if (!id) return;
          const o = (orders || []).find((x) => x && String(x.id) === id) || null;
          if (!o) return;
          const amt = o && o.totals && typeof o.totals.total === "number" ? o.totals.total : 0;
          const code = String(o.ticketCode || ("#" + displayOrderNumber(o.id)));
          const nm = String(o.orderName || "").trim();
          const displayName = nm && nm !== code ? nm + " · " + code : code;
          const label =
            (t.orderLabel || "Commande") +
            " " +
            displayName;
          setCalcItems((p) => {
            const arr = (p || []).filter(Boolean);
            if (arr.some((it) => it && String(it.id) === id)) return arr;
            return [...arr, { id, label, amount: Number(amt || 0) || 0, kind: "order" }];
          });
        }

        function calcRemoveItem(id) {
          const key = String(id || "");
          if (!key) return;
          setCalcItems((p) => (p || []).filter((it) => it && String(it.id) !== key));
        }

        function calcHandleDrop(ev) {
          try {
            if (ev && ev.preventDefault) ev.preventDefault();
            const dt = ev && ev.dataTransfer;
            const raw = dt ? dt.getData("text/plain") : "";
            const id = String(raw || "").trim();
            if (id) calcAddOrderById(id);
          } catch (e) {}
        }

        const canDragOrders = React.useMemo(() => {
          try {
            if (typeof window === "undefined") return false;
            const hasTouch =
              (navigator && typeof navigator.maxTouchPoints === "number" && navigator.maxTouchPoints > 0) ||
              ("ontouchstart" in window);
            return !hasTouch;
          } catch (e) {
            return false;
          }
        }, []);

        function normalizeMoneyText(v) {
          const s = String(v == null ? "" : v);
          let out = "";
          let dot = false;
          for (let i = 0; i < s.length; i++) {
            const ch = s[i];
            if (ch >= "0" && ch <= "9") out += ch;
            else if ((ch === "." || ch === ",") && !dot) {
              out += ".";
              dot = true;
            }
          }
          return out.slice(0, 12);
        }

        function calcGetNumValue() {
          return calcNumTarget === "manual" ? calcManualAmount : calcCashPaid;
        }

        function calcSetNumValue(v) {
          const next = normalizeMoneyText(v);
          if (calcNumTarget === "manual") setCalcManualAmount(next);
          else setCalcCashPaid(next);
        }

        function calcNumDigit(d) {
          calcSetNumValue(String(calcGetNumValue() || "") + String(d));
        }

        function calcNumDot() {
          const cur = String(calcGetNumValue() || "");
          if (cur.indexOf(".") >= 0) return;
          calcSetNumValue(cur ? cur + "." : "0.");
        }

        function calcNumBackspace() {
          calcSetNumValue(String(calcGetNumValue() || "").slice(0, -1));
        }

        function calcNumClear() {
          calcSetNumValue("");
        }

        function calcAddCashAmount(amount) {
          const a = Number(amount);
          if (!Number.isFinite(a) || a <= 0) return;
          setCalcNumTarget("cash");
          setCalcCashPaid((p) => {
            const cur = parseCash(p);
            const base = cur == null ? 0 : cur;
            const next = base + a;
            return normalizeMoneyText(String(Number(next.toFixed(2))));
          });
        }

        const CALC_BILLS = React.useMemo(
          () => [
            { amount: 200, src: "./200-moroccan-dirhams.jpg" },
            { amount: 100, src: "./100-moroccan-dirhams.jpg" },
            { amount: 50, src: "./50-moroccan-dirhams.jpg" },
            { amount: 20, src: "./20-Dirhams.jpg" }
          ],
          []
        );

        function closePinPrompt() {
          setPinPromptMode(null);
          setPinPromptValue("");
          setPinPromptError(null);
        }

        function confirmPinPrompt(ev) {
          if (ev && ev.preventDefault) ev.preventDefault();
          const entered = String(pinPromptValue || "");
          const pending = activeShift && activeShift.pendingHandoff ? activeShift.pendingHandoff : null;

          if (pinPromptMode === "resume" && pending) {
            const toWorker = (users || []).find(
              (u) => u && u.role === "worker" && u.posAccess !== false && u.id === pending.toWorkerId
            );
            if (!toWorker || String(toWorker.pin || "") !== entered) {
              setPinPromptError(t.pinIncorrect || "PIN incorrect");
              return;
            }

            const nowIso = new Date().toISOString();
            const event = { ...pending, toConfirmedAt: nowIso };

            setShifts((prev) =>
              (prev || []).map((s) =>
                s && s.id === activeShift.id
                  ? {
                      ...s,
                      currentOperatorId: toWorker.id,
                      pendingHandoff: null,
                      operatorHandoffs: [...((s.operatorHandoffs || []).filter(Boolean)), event],
                      updatedAt: nowIso
                    }
                  : s
              )
            );

            setActiveShift((s) =>
              s && s.id === activeShift.id
                ? {
                    ...s,
                    currentOperatorId: toWorker.id,
                    pendingHandoff: null,
                    operatorHandoffs: [...(((s && s.operatorHandoffs) || []).filter(Boolean)), event]
                  }
                : s
            );

            setActiveWorker(toWorker);
            setShiftPaused(false);
            lastActivityRef.current = Date.now();
            setStatus(null);

            closePinPrompt();

            if (!cloudEnabled) return;
            const shiftsCol = cloudCol("shifts");
            if (!shiftsCol) return;
            try {
              shiftsCol
                .doc(activeShift.id)
                .set(
                  {
                    id: activeShift.id,
                    currentOperatorId: toWorker.id,
                    pendingHandoff: null,
                    operatorHandoffs: [...(((activeShift && activeShift.operatorHandoffs) || []).filter(Boolean)), event],
                    updatedAt: nowIso
                  },
                  { merge: true }
                )
                .catch(() => {});
            } catch (e) {}
            return;
          }

          const worker = activeWorker && entered === activeWorker.pin ? activeWorker : null;
          if (!worker) {
            setPinPromptError(t.pinIncorrect || "PIN incorrect");
            return;
          }

          if (pinPromptMode === "pause") {
            setActiveWorker(worker);
            setShiftPaused(true);
          } else if (pinPromptMode === "resume") {
            setActiveWorker(worker);
            setShiftPaused(false);
            lastActivityRef.current = Date.now();
            setStatus(null);
          }

          closePinPrompt();
        }

        function openHandoffPrompt() {
          if (!activeShift || !activeWorker) return;
          const shiftRec = (shifts || []).find((s) => s && s.id === activeShift.id) || null;
          const pending =
            (shiftRec && shiftRec.pendingHandoff) ||
            (activeShift && activeShift.pendingHandoff) ||
            null;
          if (pending) {
            setStatus({
              type: "err",
              message:
                lang === "ar"
                  ? "هناك تسليم قيد الانتظار."
                  : "Une passation est déjà en attente."
            });
            return;
          }
          const expectedNow =
            shiftRec && typeof shiftRec.expectedCash === "number"
              ? shiftRec.expectedCash
              : typeof activeShift.expectedCash === "number"
              ? activeShift.expectedCash
              : 0;
          const pool = (users || []).filter((u) => u && u.role === "worker" && u.posAccess !== false);
          const defTo = (pool || []).find((u) => u && u.id !== activeWorker.id) || null;
          setHandoffToWorkerId(defTo ? defTo.id : "");
          setHandoffFromPin("");
          setHandoffToPin("");
          setHandoffFromAmount(String((Number(expectedNow || 0) || 0).toFixed(2)));
          setHandoffToAmount(String((Number(expectedNow || 0) || 0).toFixed(2)));
          setHandoffError(null);
          setHandoffOpen(true);
        }

        function closeHandoffPrompt() {
          setHandoffOpen(false);
          setHandoffError(null);
        }

        function confirmHandoff(ev) {
          if (ev && ev.preventDefault) ev.preventDefault();
          if (!activeShift || !activeWorker) return;
          const toId = String(handoffToWorkerId || "");
          const toWorker = (users || []).find((u) => u && u.role === "worker" && u.id === toId) || null;
          if (!toWorker || toWorker.posAccess === false) {
            setHandoffError(lang === "ar" ? "الموظف غير صالح" : "Employé invalide");
            return;
          }
          const fromPinOk = String(handoffFromPin || "") === String(activeWorker.pin || "");
          if (!fromPinOk) {
            setHandoffError(t.pinIncorrect || "PIN incorrect");
            return;
          }
          const a1 = parseCash(handoffFromAmount);
          if (a1 == null || a1 < 0) {
            setHandoffError(lang === "ar" ? "قيمة غير صالحة" : "Valeur invalide");
            return;
          }

          const nowIso = new Date().toISOString();
          const pending = {
            id: makeId("handoff"),
            shiftId: activeShift.id,
            fromWorkerId: activeWorker.id,
            toWorkerId: toWorker.id,
            expectedCash: Number(a1 || 0) || 0,
            fromConfirmedAt: nowIso,
            initiatedAt: nowIso
          };

          setShifts((prev) =>
            (prev || []).map((s) =>
              s && s.id === activeShift.id
                ? {
                    ...s,
                    pendingHandoff: pending,
                    updatedAt: nowIso
                  }
                : s
            )
          );

          setActiveShift((s) =>
            s && s.id === activeShift.id
              ? {
                  ...s,
                  pendingHandoff: pending
                }
              : s
          );

          setShiftPaused(true);
          lastActivityRef.current = Date.now();
          setStatus({
            type: "ok",
            message:
              lang === "ar"
                ? "تسليم قيد الانتظار: سلّم " +
                  Number(pending.expectedCash || 0).toFixed(2) +
                  " درهم إلى " +
                  String(toWorker.name || toWorker.id) +
                  "."
                : "Passation en attente: donner " +
                  Number(pending.expectedCash || 0).toFixed(2) +
                  " DHS à " +
                  String(toWorker.name || toWorker.id) +
                  "."
          });
          closeHandoffPrompt();

          if (!cloudEnabled) return;
          const shiftsCol = cloudCol("shifts");
          if (!shiftsCol) return;
          try {
            shiftsCol
              .doc(activeShift.id)
              .set(
                {
                  id: activeShift.id,
                  pendingHandoff: pending,
                  updatedAt: nowIso
                },
                { merge: true }
              )
              .catch(() => {});
          } catch (e) {}
        }

        function handleAddToCart(product, modifiers, extras) {
          if (shiftPaused) {
            setStatus({
              type: "err",
              message: t.shiftPausedBlocking || "Shift en pause."
            });
            return;
          }

          function isDrinkProduct(p) {
            const cat = p && p.category;
            if (cat === "Hot Drinks" || cat === "Cold Drinks") return true;
            const id = p && p.id;
            if (!id) return false;
            return (
              id === "other_water" ||
              String(id).startsWith("soda_") ||
              String(id).startsWith("water_") ||
              String(id).startsWith("juice_") ||
              String(id).startsWith("tea_")
            );
          }

          setCart((prev) => {
            const hasAnyModifiers = (() => {
              if (!modifiers || typeof modifiers !== "object") return false;
              try {
                const keys = Object.keys(modifiers);
                for (let i = 0; i < keys.length; i++) {
                  const v = modifiers[keys[i]];
                  if (v == null) continue;
                  if (v === false) continue;
                  if (typeof v === "string" && v.trim() === "") continue;
                  if (typeof v === "number" && (!Number.isFinite(v) || v === 0)) continue;
                  return true;
                }
              } catch (e) {}
              return false;
            })();

            const keySuffix =
              extras && extras.favoriteId ? `__${String(extras.favoriteId)}` : "";

            const key =
              product.id +
              (hasAnyModifiers ? `_${stableStringify(modifiers)}` : "") +
              keySuffix;

            const forceNewLine =
              cartServiceType === "takeaway" && isDrinkProduct(product);
            const finalKey = forceNewLine ? key + "_" + makeId("line") : key;

            const existing = prev.find((line) => line.key === finalKey);
            if (existing) {
              return prev.map((line) =>
                line.key === finalKey ? { ...line, qty: line.qty + 1 } : line
              );
            }

            const defaultCup =
              cartServiceType === "takeaway" && isDrinkProduct(product)
                ? { containerType: "disposable", cupSize: "small" }
                : {};
            return [
              ...prev,
              {
                key: finalKey,
                id: product.id,
                name: product.name,
                price: product.price,
                qty: 1,
                modifiers: modifiers || {},
                ...defaultCup,
                ...(extras && typeof extras === "object" ? extras : {})
              }
            ];
          });
        }

        function favoriteDocIdForLine(line) {
          if (!activeWorkerId) return "";
          if (!line || !line.id) return "";
          const raw =
            activeWorkerId +
            "|" +
            String(line.id) +
            "|" +
            stableStringify((line && line.modifiers) || {}) +
            "|" +
            String(Number(line.price || 0) || 0) +
            "|" +
            String((line && line.containerType) || "") +
            "|" +
            String((line && line.cupSize) || "");
          return "fav_" + activeWorkerId + "_" + hashString(raw);
        }

        function closeFavoritePrompt() {
          setFavoritePromptOpen(false);
          setFavoritePromptError(null);
          setFavoritePromptValue("");
          setFavoritePromptLineKey(null);
        }

        function saveFavoriteFromLine(line, favName) {
          if (!line || !line.id) return;
          if (!activeWorkerId) return;
          const favId = favoriteDocIdForLine(line);
          if (!favId) return;
          const nowIso = new Date().toISOString();
          const rec = {
            id: favId,
            userId: activeWorkerId,
            name: String(favName || "").trim(),
            productId: String(line.id || ""),
            baseName: String(line.name || ""),
            price: Number(line.price || 0) || 0,
            modifiers: (line && line.modifiers) || {},
            containerType: line && line.containerType ? String(line.containerType) : null,
            cupSize: line && line.cupSize ? String(line.cupSize) : null,
            updatedAt: nowIso,
            createdAt: nowIso,
            appId: CLOUD_APP_ID,
            deviceId: deviceIdRef.current
          };

          setFavorites((prev) => {
            const list = Array.isArray(prev) ? prev : [];
            const idx = list.findIndex((f) => f && f.id === favId);
            if (idx >= 0) {
              const next = list.slice();
              const old = next[idx] || {};
              next[idx] = { ...old, ...rec, createdAt: old.createdAt || rec.createdAt };
              return next;
            }
            return [...list, rec];
          });

          if (!cloudEnabled) return;
          const favCol = cloudCol("favorites");
          if (!favCol) return;
          try {
            favCol
              .doc(favId)
              .set(rec, { merge: true })
              .catch(() => {});
          } catch (e) {}
        }

        function removeFavoriteById(favId) {
          if (!favId) return;
          setFavorites((prev) => (prev || []).filter((f) => f && f.id !== favId));
          if (!cloudEnabled) return;
          const favCol = cloudCol("favorites");
          if (!favCol) return;
          try {
            favCol
              .doc(favId)
              .delete()
              .catch(() => {});
          } catch (e) {}
        }

        function toggleFavoriteLine(line) {
          if (!line) return;
          if (shiftPaused) {
            setStatus({ type: "err", message: t.shiftPausedBlocking || "Shift en pause." });
            return;
          }
          if (!activeWorkerId) {
            setStatus({ type: "err", message: (t && t.needWorkerLogin) || "Ouvrir un shift." });
            return;
          }
          const favId = favoriteDocIdForLine(line);
          if (!favId) return;
          const exists = !!(favoritesById && favoritesById[favId]);
          if (exists) {
            removeFavoriteById(favId);
            setStatus({ type: "ok", message: lang === "ar" ? "تم حذف المفضل." : "Favori supprimé." });
            return;
          }
          setFavoritePromptLineKey(line.key);
          setFavoritePromptValue(String(line.name || ""));
          setFavoritePromptError(null);
          setFavoritePromptOpen(true);
        }

        function confirmFavoritePrompt(ev) {
          if (ev && ev.preventDefault) ev.preventDefault();
          const name = String(favoritePromptValue || "").trim();
          if (!name) {
            setFavoritePromptError(lang === "ar" ? "الاسم مطلوب" : "Nom requis");
            return;
          }
          const line = (cart || []).find((l) => l && l.key === favoritePromptLineKey) || null;
          if (!line) {
            closeFavoritePrompt();
            return;
          }
          saveFavoriteFromLine(line, name);
          closeFavoritePrompt();
          setStatus({ type: "ok", message: lang === "ar" ? "تم حفظه في المفضلة." : "Ajouté aux favoris." });
        }

        function addFavoriteToCart(fav) {
          if (!fav) return;
          const base = (menu || []).find((p) => p && p.id === fav.productId) || null;
          const baseName = base
            ? lang === "ar"
              ? base.nameAr || base.name
              : base.nameFr || base.name
            : String(fav.productId || "");
          const effectiveProduct = base
            ? {
                ...base,
                name: String(fav.name || baseName),
                price: Number(fav.price || base.price || 0) || 0
              }
            : {
                id: String(fav.productId || ""),
                name: String(fav.name || baseName),
                price: Number(fav.price || 0) || 0
              };

          const extras = {};
          if (fav.containerType) extras.containerType = fav.containerType;
          if (fav.cupSize) extras.cupSize = fav.cupSize;
          extras.favoriteId = fav.id;

          handleAddToCart(effectiveProduct, (fav && fav.modifiers) || {}, extras);
        }

        React.useEffect(() => {
          const prev = prevCartKeysRef.current || new Set();
          const nextSet = new Set((cart || []).map((l) => l && l.key).filter(Boolean));
          (cart || []).forEach((line) => {
            if (!line || !line.key) return;
            if (prev.has(line.key)) return;
            setCartEnterKeys((p) => ({ ...(p || {}), [line.key]: true }));
            try {
              const existing = cartEnterTimeoutsRef.current && cartEnterTimeoutsRef.current[line.key];
              if (existing) clearTimeout(existing);
              cartEnterTimeoutsRef.current[line.key] = setTimeout(() => {
                setCartEnterKeys((p) => {
                  const n = { ...(p || {}) };
                  delete n[line.key];
                  return n;
                });
                if (cartEnterTimeoutsRef.current) delete cartEnterTimeoutsRef.current[line.key];
              }, 180);
            } catch (e) {}
          });
          if (cartEnterTimeoutsRef.current) {
            Object.keys(cartEnterTimeoutsRef.current).forEach((k) => {
              if (!nextSet.has(k)) {
                try { clearTimeout(cartEnterTimeoutsRef.current[k]); } catch (e) {}
                delete cartEnterTimeoutsRef.current[k];
              }
            });
          }
          prevCartKeysRef.current = nextSet;
        }, [cart]);

        function updateQty(key, delta) {
          if (shiftPaused) {
            setStatus({
              type: "err",
              message: t.shiftPausedBlocking || "Shift en pause."
            });
            return;
          }
          setCart((prev) =>
            prev
              .map((line) =>
                line.key === key ? { ...line, qty: line.qty + delta } : line
              )
              .filter((line) => line.qty > 0)
          );
        }

        const totals = React.useMemo(() => {
          const subtotal = cart.reduce((sum, line) => sum + line.price * line.qty, 0);
          const taxRate = 0.0;
          const tax = subtotal * taxRate;
          const cupFee = (cartServiceType !== "takeaway")
            ? 0
            : (cart || []).reduce((sum, line) => {
                if (!line || !line.id) return sum;
                if (line.containerType === "glass") return sum;
                const id = String(line.id || "");
                if (id.startsWith("water_")) return sum;
                if (!isDrinkLineForCup(line)) return sum;
                const qty = Number(line.qty || 0) || 0;
                if (qty <= 0) return sum;
                return sum + qty * 1;
              }, 0);

          const total = subtotal + tax + cupFee;
          return { subtotal, tax, cupFee, total };
        }, [cart, cartServiceType, menu]);

        function isDrinkLineForCup(line) {
          if (!line || !line.id) return false;
          const p = (menu || []).find((m) => m && m.id === line.id) || null;
          if (p && (p.category === "Hot Drinks" || p.category === "Cold Drinks")) return true;

          const id = line.id;
          if (id === "coffee" || id === "coffee_with_milk" || id === "nescafe" || id === "machada") return true;
          const s = String(id);
          return (
            s === "other_water" ||
            s.startsWith("tea_") ||
            s.startsWith("juice_") ||
            s.startsWith("soda_") ||
            s.startsWith("water_")
          );
        }

        const needsGlassCupCustomerName = React.useMemo(() => {
          if (cartServiceType !== "takeaway") return false;
          return (cart || []).some(
            (l) => l && l.containerType === "glass" && isDrinkLineForCup(l)
          );
        }, [cart, cartServiceType, menu]);

        const openCupLoanSummary = React.useMemo(() => {
          const result = { small: 0, large: 0, total: 0 };
          (cupLoans || []).forEach((l) => {
            if (!l || l.status === "returned") return;
            if (l.kind !== "glass") return;
            const qty = Number(l.qty || 0) || 0;
            if (qty <= 0) return;
            if (l.size === "large") result.large += qty;
            else result.small += qty;
          });
          result.total = result.small + result.large;
          return result;
        }, [cupLoans]);

        function applyInventoryCupDelta(ingredientId, delta, nowIso, reason, orderId, shiftId, userId) {
          if (!ingredientId || !delta) return;
          const logId = makeId("log");
          setInventory((prev) => {
            if (!prev || !prev[ingredientId]) return prev;
            return {
              ...prev,
              [ingredientId]: {
                ...prev[ingredientId],
                currentQty: (prev[ingredientId].currentQty || 0) + delta
              }
            };
          });
          setInventoryLogs((prev) => [
            ...(prev || []),
            {
              id: logId,
              ingredientId,
              delta,
              reason: reason || "cup",
              orderId: orderId || null,
              shiftId: shiftId || (activeShift ? activeShift.id : null),
              userId: userId || (activeWorker ? activeWorker.id : null),
              createdAt: nowIso
            }
          ]);

          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          const invCol = cloudCol("inventory");
          const logsCol = cloudCol("inventoryLogs");
          if (!db || !invCol || !logsCol) return;
          try {
            const batch = db.batch();
            const inc = firebase.firestore.FieldValue.increment;
            batch.set(
              invCol.doc(ingredientId),
              { id: ingredientId, currentQty: inc(delta), updatedAt: nowIso },
              { merge: true }
            );
            batch.set(
              logsCol.doc(logId),
              {
                id: logId,
                ingredientId,
                delta,
                reason: reason || "cup",
                orderId: orderId || null,
                shiftId: shiftId || (activeShift ? activeShift.id : null),
                userId: userId || (activeWorker ? activeWorker.id : null),
                appId: CLOUD_APP_ID,
                deviceId: deviceIdRef.current,
                createdAt: nowIso
              },
              { merge: true }
            );
            batch.commit().catch(() => {});
          } catch (e) {}
        }

        function handleCloseCupLoans() {
          setCupLoansOpen(false);
        }

        function handleMarkCupLoanReturned(loanId, refundDeposit) {
          if (!loanId) return;
          if (shiftPaused) {
            setStatus({ type: "err", message: t.shiftPausedBlocking || "Shift en pause." });
            return;
          }
          if (!activeShift || !activeWorker) return;

          const rec = (cupLoans || []).find((l) => l && l.id === loanId) || null;
          if (!rec || rec.status === "returned") return;

          const nowIso = new Date().toISOString();
          const nextRefund = !!(refundDeposit && rec.depositPaid && !rec.depositRefunded);

          const patch = {
            status: "returned",
            returnedAt: nowIso,
            returnedShiftId: activeShift.id,
            returnedBy: activeWorker.id,
            depositRefunded: nextRefund ? true : !!rec.depositRefunded,
            depositRefundedAt: nextRefund ? nowIso : (rec.depositRefundedAt || null),
            refundShiftId: nextRefund ? activeShift.id : (rec.refundShiftId || null),
            refundBy: nextRefund ? activeWorker.id : (rec.refundBy || null),
            updatedAt: nowIso
          };

          setCupLoans((prev) =>
            (prev || []).map((l) => (l && l.id === loanId ? { ...l, ...patch } : l))
          );

          const size = rec.size === "large" ? "large" : "small";
          const qty = Number(rec.qty || 0) || 0;
          if (qty > 0) {
            const ingId = size === "large" ? "cup_glass_large" : "cup_glass_small";
            applyInventoryCupDelta(ingId, qty, nowIso, "cup_return", rec.orderId || null, activeShift.id, activeWorker.id);
          }

          if (nextRefund) {
            const amount = Number(rec.depositAmount || 0) || 0;
            if (amount > 0) applyShiftExpectedCashDelta(activeShift.id, -amount, nowIso);
          }

          if (!cloudEnabled) return;
          const loansCol = cloudCol("cupLoans");
          if (!loansCol) return;
          try {
            loansCol.doc(loanId).set(patch, { merge: true }).catch(() => {});
          } catch (e) {}
        }

        function accumulateIngredientsForOrder(orderItems, opts) {
          const result = {};
          const COFFEE_IDS = new Set(["coffee", "coffee_with_milk", "nescafe", "machada"]);
          const serviceType = opts && opts.serviceType === "takeaway" ? "takeaway" : "dine_in";

          function isDrinkId(id) {
            if (!id) return false;
            if (COFFEE_IDS.has(id)) return true;
            const s = String(id);
            return (
              s === "other_water" ||
              s.startsWith("tea_") ||
              s.startsWith("juice_") ||
              s.startsWith("soda_") ||
              s.startsWith("water_")
            );
          }

          function add(ingredientId, amountPerUnit, qty) {
            if (!ingredientId || !amountPerUnit) return;
            const delta = -amountPerUnit * qty;
            result[ingredientId] = (result[ingredientId] || 0) + delta;
          }

          function addRecipe(recipe, qty) {
            if (!recipe) return;
            Object.entries(recipe).forEach(([ingredientId, perUnit]) => {
              add(ingredientId, perUnit, qty);
            });
          }

          function addSugarFor(type, sugarLevel, qty) {
            if (!sugarLevel || sugarLevel === "none") return;

            if (type === "coffee") {
              const KG_PER_CUBE = 1 / 180;
              const cubes = sugarLevel === "low" ? 1 : sugarLevel === "medium" ? 2 : 3;
              add("sugar_cubes", KG_PER_CUBE * cubes, qty);
              return;
            }

            if (type === "tea") {
              const grams = sugarLevel === "low" ? 5 : sugarLevel === "medium" ? 10 : 15;
              add("sugar_powder", grams / 1000, qty);
              return;
            }
          }

          orderItems.forEach((line) => {
            const qty = line.qty || 1;
            const mods = line.modifiers || {};
            const baseRecipe = MENU_RECIPES[line.id];

            addRecipe(baseRecipe, qty);

            if (line.id === "other_water") {
              const size = mods.waterSize === "half" ? "half" : "quarter";
              add(size === "half" ? "water_bottle_half" : "water_bottle_small", 1, qty);
            }

            if (mods.water === true) {
              add("water_bottle_small", 1, qty);
            }

            if (line.id === "fried_eggs" && mods.eggCount) {
              const baseEggs = (baseRecipe && baseRecipe.eggs) || 0;
              const desired = Number(mods.eggCount) || 0;
              const extra = desired - baseEggs;
              if (extra !== 0) {
                result.eggs = (result.eggs || 0) + -extra * qty;
              }
            }

            if (mods.drink === "tea") {
              add("tea_leaves", 0.006, qty);
              addSugarFor("tea", mods.sugar, qty);
            } else if (mods.drink === "coffee_milk") {
              add("coffee_beans", 0.01, qty);
              add("milk", 0.18, qty);
              addSugarFor("coffee", mods.sugar, qty);
            }

            if (COFFEE_IDS.has(line.id)) {
              if (mods.milk === true && (!baseRecipe || baseRecipe.milk == null)) {
                add("milk", 0.18, qty);
              }
              if (mods.milk === false && baseRecipe && baseRecipe.milk != null) {
                result.milk = (result.milk || 0) + baseRecipe.milk * qty;
              }
              addSugarFor("coffee", mods.sugar, qty);
            }

            if (line.id === "tea_lipton" || line.id === "tea_mint" || line.id === "tea_berrad") {
              addSugarFor("tea", mods.sugar, qty);
            }

            if (serviceType === "takeaway" && isDrinkId(line.id)) {
              const container = line.containerType === "glass" ? "glass" : "disposable";
              const size = line.cupSize === "large" ? "large" : "small";
              const cupIngredientId =
                container === "glass"
                  ? size === "large"
                    ? "cup_glass_large"
                    : "cup_glass_small"
                  : size === "large"
                  ? "cup_disposable_large"
                  : "cup_disposable_small";
              add(cupIngredientId, 1, qty);
            }
          });

          return result;
        }

        function applyInventoryConsumption(
          ingredientDeltas,
          shiftId,
          orderId,
          userId
        ) {
          const nowIso = new Date().toISOString();
          const logEntries = Object.entries(ingredientDeltas).map(([ingId, delta]) => ({
            id: makeId("log"),
            ingredientId: ingId,
            delta,
            reason: "sale",
            orderId,
            shiftId,
            userId,
            createdAt: nowIso
          }));

          setInventory((prev) => {
            const copy = { ...prev };
            Object.entries(ingredientDeltas).forEach(([ingId, delta]) => {
              if (!copy[ingId]) return;
              copy[ingId] = {
                ...copy[ingId],
                currentQty: copy[ingId].currentQty + delta
              };
            });
            return copy;
          });
          setInventoryLogs((prev) => [...prev, ...logEntries]);

          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          const invCol = cloudCol("inventory");
          const logsCol = cloudCol("inventoryLogs");
          if (!db || !invCol || !logsCol) return;

          try {
            const batch = db.batch();
            const inc = firebase.firestore.FieldValue.increment;
            Object.entries(ingredientDeltas).forEach(([ingId, delta]) => {
              if (!ingId || !delta) return;
              batch.set(
                invCol.doc(ingId),
                {
                  id: ingId,
                  currentQty: inc(delta),
                  updatedAt: nowIso
                },
                { merge: true }
              );
            });

            logEntries.forEach((entry) => {
              if (!entry || !entry.id) return;
              batch.set(
                logsCol.doc(entry.id),
                {
                  ...entry,
                  appId: CLOUD_APP_ID,
                  deviceId: deviceIdRef.current
                },
                { merge: true }
              );
            });
            batch.commit().catch(() => {});
          } catch (e) {}
        }

        function handleInventoryAdjust(ingredientId, delta) {
          if (!ingredientId || !delta) return;
          const nowIso = new Date().toISOString();
          const logId = makeId("log");
          setInventory((prev) => {
            if (!prev[ingredientId]) return prev;
            return {
              ...prev,
              [ingredientId]: {
                ...prev[ingredientId],
                currentQty: prev[ingredientId].currentQty + delta
              }
            };
          });
          setInventoryLogs((prev) => [
            ...prev,
            {
              id: logId,
              ingredientId,
              delta,
              reason: "adjust",
              orderId: null,
              shiftId: activeShift ? activeShift.id : null,
              userId: adminUser ? adminUser.id : null,
              createdAt: nowIso
            }
          ]);

          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          const invCol = cloudCol("inventory");
          const logsCol = cloudCol("inventoryLogs");
          if (!db || !invCol || !logsCol) return;

          try {
            const batch = db.batch();
            const inc = firebase.firestore.FieldValue.increment;
            batch.set(
              invCol.doc(ingredientId),
              {
                id: ingredientId,
                currentQty: inc(delta),
                updatedAt: nowIso
              },
              { merge: true }
            );
            batch.set(
              logsCol.doc(logId),
              {
                id: logId,
                ingredientId,
                delta,
                reason: "adjust",
                orderId: null,
                shiftId: activeShift ? activeShift.id : null,
                userId: adminUser ? adminUser.id : null,
                appId: CLOUD_APP_ID,
                deviceId: deviceIdRef.current,
                createdAt: nowIso
              },
              { merge: true }
            );
            batch.commit().catch(() => {});
          } catch (e) {}
        }

        function handleInventoryUpdate(ingredientId, currentQty, minQty, expiryDate, nameFr, nameAr) {
          if (!ingredientId) return;
          const nowIso = new Date().toISOString();
          const logId = makeId("log");
          setInventory((prev) => {
            const ing = prev[ingredientId];
            if (!ing) return prev;
            const nextExpiry = expiryDate === undefined ? ing.expiryDate : expiryDate;
            const nextNameFr = nameFr === undefined ? ing.nameFr : String(nameFr || "");
            const nextNameAr = nameAr === undefined ? ing.nameAr : String(nameAr || "");
            const nextName = nextNameFr || ing.name || ingredientId;
            return {
              ...prev,
              [ingredientId]: {
                ...ing,
                name: nextName,
                nameFr: nextNameFr,
                nameAr: nextNameAr,
                currentQty,
                minQty,
                expiryDate: nextExpiry
              }
            };
          });
          setInventoryLogs((prev) => {
            const ing = inventory[ingredientId];
            const oldQty = ing ? ing.currentQty : null;
            const diff = oldQty == null ? 0 : currentQty - oldQty;
            if (!diff) return prev;
            return [
              ...prev,
              {
                id: logId,
                ingredientId,
                delta: diff,
                reason: "adjust",
                orderId: null,
                shiftId: activeShift ? activeShift.id : null,
                userId: adminUser ? adminUser.id : null,
                createdAt: nowIso
              }
            ];
          });

          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          const invCol = cloudCol("inventory");
          const logsCol = cloudCol("inventoryLogs");
          if (!db || !invCol || !logsCol) return;

          try {
            db
              .runTransaction((tx) => {
                const invRef = invCol.doc(ingredientId);
                return tx.get(invRef).then((snap) => {
                  const data = snap && snap.data ? snap.data() : null;
                  const prevQty = data && typeof data.currentQty === "number" ? data.currentQty : null;
                  const delta = prevQty == null ? 0 : currentQty - prevQty;
                  const expiryPatch =
                    expiryDate === undefined ? {} : { expiryDate: expiryDate || null };
                  const namePatch = {
                    name: (nameFr && String(nameFr)) || (data && data.name) || ingredientId,
                    nameFr: nameFr === undefined ? (data && data.nameFr) : String(nameFr || ""),
                    nameAr: nameAr === undefined ? (data && data.nameAr) : String(nameAr || "")
                  };
                  tx.set(
                    invRef,
                    Object.assign(
                      { id: ingredientId, currentQty, minQty, updatedAt: nowIso },
                      expiryPatch,
                      namePatch
                    ),
                    { merge: true }
                  );
                  if (delta) {
                    tx.set(
                      logsCol.doc(logId),
                      {
                        id: logId,
                        ingredientId,
                        delta,
                        reason: "adjust",
                        orderId: null,
                        shiftId: activeShift ? activeShift.id : null,
                        userId: adminUser ? adminUser.id : null,
                        appId: CLOUD_APP_ID,
                        deviceId: deviceIdRef.current,
                        createdAt: nowIso
                      },
                      { merge: true }
                    );
                  }
                });
              })
              .catch(() => {});
          } catch (e) {}
        }

        function handleDeclareOrderDebt(orderId) {
          const order = orders.find((o) => o && o.id === orderId);
          if (!order || order.status !== "unpaid") return;
          const name = String((closeShiftDebtNames && closeShiftDebtNames[orderId]) || "").trim();
          if (!name) return;

          const nowIso = new Date().toISOString();
          const dueIso = new Date(Date.now() + 48 * 60 * 60 * 1000).toISOString();
          const debtId = makeId("debt");
          const amount = (order.totals && typeof order.totals.total === "number") ? order.totals.total : 0;

          setOrders((prev) =>
            (prev || []).map((o) =>
              o && o.id === orderId
                ? { ...o, status: "debt", debtId, debtCustomerName: name }
                : o
            )
          );
          setClientDebts((prev) => [
            ...(prev || []),
            {
              id: debtId,
              orderId,
              originalShiftId: order.shiftId,
              waiterId: order.cashierId,
              customerName: name,
              amount,
              createdAt: nowIso,
              dueAt: dueIso,
              paidAt: null,
              paidBy: null,
              paidShiftId: null,
              chargedAt: null,
              chargedShiftId: null
            }
          ]);
          setCloseShiftDebtNames((p) => ({ ...(p || {}), [orderId]: "" }));

          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          const ordersCol = cloudCol("orders");
          const debtsCol = cloudCol("clientDebts");
          if (!db || !ordersCol || !debtsCol) return;
          try {
            const batch = db.batch();
            batch.set(
              ordersCol.doc(orderId),
              { status: "debt", debtId, debtCustomerName: name, updatedAt: nowIso },
              { merge: true }
            );
            batch.set(
              debtsCol.doc(debtId),
              {
                id: debtId,
                orderId,
                originalShiftId: order.shiftId,
                waiterId: order.cashierId,
                customerName: name,
                amount,
                createdAt: nowIso,
                dueAt: dueIso,
                paidAt: null,
                paidBy: null,
                paidShiftId: null,
                chargedAt: null,
                chargedShiftId: null,
                appId: CLOUD_APP_ID,
                deviceId: deviceIdRef.current,
                updatedAt: nowIso
              },
              { merge: true }
            );
            batch.commit().catch(() => {});
          } catch (e) {}
        }

        function handleMarkDebtPaid(debtId) {
          const debt = (clientDebts || []).find((d) => d && d.id === debtId);
          if (!debt || debt.paidAt) return;
          const order = orders.find((o) => o && o.id === debt.orderId);
          const nowIso = new Date().toISOString();
          const actorId = (activeWorker && activeWorker.id) || (adminUser && adminUser.id) || null;
          const amount = typeof debt.amount === "number" ? debt.amount : 0;
          const targetShiftId = activeShift ? activeShift.id : null;

          setClientDebts((prev) =>
            (prev || []).map((d) =>
              d && d.id === debtId
                ? { ...d, paidAt: nowIso, paidBy: actorId, paidShiftId: targetShiftId }
                : d
            )
          );
          if (order) {
            setOrders((prev) =>
              (prev || []).map((o) =>
                o && o.id === order.id
                  ? { ...o, status: "paid", paidAt: nowIso, paidShiftId: targetShiftId }
                  : o
              )
            );
          }

          if (targetShiftId && !debt.chargedAt && amount > 0) {
            updateShiftStats(targetShiftId, amount);
          }

          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          const debtsCol = cloudCol("clientDebts");
          const ordersCol = cloudCol("orders");
          const shiftsCol = cloudCol("shifts");
          if (!db || !debtsCol || !ordersCol || !shiftsCol) return;
          try {
            const batch = db.batch();
            batch.set(
              debtsCol.doc(debtId),
              { paidAt: nowIso, paidBy: actorId, paidShiftId: targetShiftId, updatedAt: nowIso },
              { merge: true }
            );
            if (order) {
              batch.set(
                ordersCol.doc(order.id),
                { status: "paid", paidAt: nowIso, paidShiftId: targetShiftId, updatedAt: nowIso },
                { merge: true }
              );
            }
            if (targetShiftId && !debt.chargedAt && amount > 0) {
              const inc = firebase.firestore.FieldValue.increment;
              batch.set(
                shiftsCol.doc(targetShiftId),
                {
                  id: targetShiftId,
                  revenue: inc(amount),
                  orderCount: inc(1),
                  expectedCash: inc(amount),
                  updatedAt: nowIso
                },
                { merge: true }
              );
            }
            batch.commit().catch(() => {});
          } catch (e) {}
        }

        function handleInventoryPurchase(ingredientId, qty, totalCost, actorOverride, deductFromExpectedCash) {
          if (!ingredientId) return;
          const actor =
            actorOverride && typeof actorOverride === "object"
              ? actorOverride
              : adminUser && (adminUser.role === "admin" || adminUser.role === "manager")
              ? adminUser
              : activeWorker;
          const actorId = actor ? actor.id : null;
          const canPurchase =
            !!activeShift &&
            (!!(adminUser && adminUser.role === "admin") ||
              !!activeWorker);
          if (!canPurchase) {
            setStatus({ type: "err", message: lang === "ar" ? "غير مسموح" : "Accès refusé." });
            return;
          }
          const q = Number(qty);
          const cost = Number(totalCost);
          if (!Number.isFinite(q) || q <= 0) return;
          if (!Number.isFinite(cost) || cost < 0) return;
          const nowIso = new Date().toISOString();
          const logId = makeId("log");
          const packSize =
            inventory &&
            inventory[ingredientId] &&
            typeof inventory[ingredientId].packSize === "number" &&
            Number.isFinite(inventory[ingredientId].packSize) &&
            inventory[ingredientId].packSize > 0
              ? inventory[ingredientId].packSize
              : null;
          const effectiveQty = packSize ? q * packSize : q;
          const unitPrice = effectiveQty ? cost / effectiveQty : null;
          const shiftId = activeShift ? activeShift.id : null;
          const affectsShiftCash = !!(shiftId && deductFromExpectedCash === true);

          setInventory((prev) => {
            if (!prev || !prev[ingredientId]) return prev;
            return {
              ...prev,
              [ingredientId]: {
                ...prev[ingredientId],
                currentQty: (prev[ingredientId].currentQty || 0) + effectiveQty
              }
            };
          });
          setInventoryLogs((prev) => [
            ...prev,
            {
              id: logId,
              ingredientId,
              delta: effectiveQty,
              reason: "purchase",
              orderId: null,
              shiftId: shiftId,
              userId: actorId,
              totalCost: cost,
              unitPrice: unitPrice,
              deductFromExpectedCash: affectsShiftCash,
              createdAt: nowIso
            }
          ]);
          if (shiftId && affectsShiftCash) {
            setShifts((prev) =>
              (prev || []).map((s) =>
                s && s.id === shiftId
                  ? { ...s, expectedCash: (s.expectedCash || 0) - cost }
                  : s
              )
            );
            setActiveShift((s) =>
              s && s.id === shiftId
                ? { ...s, expectedCash: (s.expectedCash || 0) - cost }
                : s
            );
          }
          setStatus({
            type: "ok",
            message: lang === "ar" ? "تمت إضافة الشراء." : "Achat ajouté."
          });

          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          const invCol = cloudCol("inventory");
          const logsCol = cloudCol("inventoryLogs");
          const shiftsCol = cloudCol("shifts");
          if (!db || !invCol || !logsCol || !shiftsCol) return;

          try {
            const batch = db.batch();
            const inc = firebase.firestore.FieldValue.increment;
            batch.set(
              invCol.doc(ingredientId),
              { id: ingredientId, currentQty: inc(effectiveQty), updatedAt: nowIso },
              { merge: true }
            );
            batch.set(
              logsCol.doc(logId),
              {
                id: logId,
                ingredientId,
                delta: effectiveQty,
                reason: "purchase",
                orderId: null,
                shiftId: shiftId,
                userId: actorId,
                totalCost: cost,
                unitPrice: unitPrice,
                deductFromExpectedCash: affectsShiftCash,
                appId: CLOUD_APP_ID,
                deviceId: deviceIdRef.current,
                createdAt: nowIso
              },
              { merge: true }
            );
            if (shiftId && affectsShiftCash) {
              batch.set(
                shiftsCol.doc(shiftId),
                { id: shiftId, expectedCash: inc(-cost), updatedAt: nowIso },
                { merge: true }
              );
            }
            batch.commit().catch(() => {});
          } catch (e) {}
        }

        function handleInventoryPurchaseInvoice(payload, actorOverride, deductFromExpectedCash) {
          const meta = payload && typeof payload === "object" ? payload : null;
          const rawLines = meta && Array.isArray(meta.lines) ? meta.lines.filter(Boolean) : [];
          if (!rawLines.length) return;

          const actor =
            actorOverride && typeof actorOverride === "object"
              ? actorOverride
              : adminUser && (adminUser.role === "admin" || adminUser.role === "manager")
              ? adminUser
              : activeWorker;
          const actorId = actor ? actor.id : null;

          const canPurchase =
            !!activeShift &&
            (!!(adminUser && adminUser.role === "admin") ||
              !!activeWorker);
          if (!canPurchase) {
            setStatus({ type: "err", message: lang === "ar" ? "غير مسموح" : "Accès refusé." });
            return;
          }

          function parseNum(v) {
            const n = Number(String(v == null ? "" : v).replace(",", "."));
            return Number.isFinite(n) ? n : null;
          }

          const nowIso = new Date().toISOString();
          const invoiceId = makeId("inv");
          const shiftId = activeShift ? activeShift.id : null;
          const invoiceNumber = meta && meta.invoiceNumber ? String(meta.invoiceNumber || "").trim() : "";
          const supplierName = meta && meta.supplierName ? String(meta.supplierName || "").trim() : "";
          const note = meta && meta.note ? String(meta.note || "").trim() : "";

          const affectsShiftCash = !!(shiftId && deductFromExpectedCash === true);

          const lines = [];
          const logEntries = [];
          const ingredientDeltas = {};
          let invoiceTotalCost = 0;

          for (let i = 0; i < rawLines.length; i++) {
            const ln = rawLines[i];
            const ingredientId = String(ln.ingredientId || "");
            if (!ingredientId) continue;
            const q = parseNum(ln.qty);
            const cost = parseNum(ln.totalCost);
            if (q == null || q <= 0) continue;
            if (cost == null || cost < 0) continue;

            const ing = inventory && inventory[ingredientId] ? inventory[ingredientId] : null;
            const packSize =
              ing && typeof ing.packSize === "number" && Number.isFinite(ing.packSize) && ing.packSize > 0
                ? ing.packSize
                : null;
            const effectiveQty = packSize ? q * packSize : q;
            const unitPrice = effectiveQty ? cost / effectiveQty : null;

            const logId = makeId("log");
            invoiceTotalCost += cost;
            ingredientDeltas[ingredientId] = (ingredientDeltas[ingredientId] || 0) + effectiveQty;
            lines.push({
              id: makeId("invline"),
              ingredientId,
              qty: q,
              effectiveQty,
              totalCost: cost,
              unitPrice
            });
            logEntries.push({
              id: logId,
              ingredientId,
              delta: effectiveQty,
              reason: "purchase",
              orderId: null,
              shiftId: shiftId,
              userId: actorId,
              totalCost: cost,
              unitPrice: unitPrice,
              invoiceId,
              deductFromExpectedCash: affectsShiftCash,
              createdAt: nowIso
            });
          }

          if (!lines.length) return;

          const invoice = {
            id: invoiceId,
            supplierName,
            invoiceNumber,
            note,
            shiftId,
            userId: actorId,
            createdAt: nowIso,
            totalCost: Number(invoiceTotalCost || 0) || 0,
            deductFromExpectedCash: affectsShiftCash,
            lineCount: lines.length,
            lines
          };

          setInventory((prev) => {
            const copy = { ...(prev || {}) };
            Object.entries(ingredientDeltas).forEach(([id, delta]) => {
              if (!copy[id]) return;
              copy[id] = { ...copy[id], currentQty: (copy[id].currentQty || 0) + delta };
            });
            return copy;
          });
          setInventoryLogs((prev) => [...(prev || []), ...logEntries]);
          setPurchaseInvoices((prev) => [...(prev || []), invoice]);

          if (shiftId && affectsShiftCash && invoiceTotalCost) {
            setShifts((prev) =>
              (prev || []).map((s) =>
                s && s.id === shiftId
                  ? { ...s, expectedCash: (s.expectedCash || 0) - invoiceTotalCost }
                  : s
              )
            );
            setActiveShift((s) =>
              s && s.id === shiftId
                ? { ...s, expectedCash: (s.expectedCash || 0) - invoiceTotalCost }
                : s
            );
          }

          setStatus({
            type: "ok",
            message: lang === "ar" ? "تمت إضافة الفاتورة." : "Facture ajoutée."
          });

          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          const invCol = cloudCol("inventory");
          const logsCol = cloudCol("inventoryLogs");
          const shiftsCol = cloudCol("shifts");
          const invoicesCol = cloudCol("purchaseInvoices");
          if (!db || !invCol || !logsCol || !shiftsCol || !invoicesCol) return;

          try {
            const batch = db.batch();
            const inc = firebase.firestore.FieldValue.increment;

            Object.entries(ingredientDeltas).forEach(([id, delta]) => {
              if (!id || !delta) return;
              batch.set(
                invCol.doc(id),
                { id, currentQty: inc(delta), updatedAt: nowIso },
                { merge: true }
              );
            });

            logEntries.forEach((entry) => {
              if (!entry || !entry.id) return;
              batch.set(
                logsCol.doc(entry.id),
                {
                  ...entry,
                  appId: CLOUD_APP_ID,
                  deviceId: deviceIdRef.current,
                  updatedAt: nowIso
                },
                { merge: true }
              );
            });

            batch.set(
              invoicesCol.doc(invoiceId),
              {
                ...invoice,
                appId: CLOUD_APP_ID,
                deviceId: deviceIdRef.current,
                updatedAt: nowIso
              },
              { merge: true }
            );

            if (shiftId && affectsShiftCash && invoiceTotalCost) {
              batch.set(
                shiftsCol.doc(shiftId),
                { id: shiftId, expectedCash: inc(-invoiceTotalCost), updatedAt: nowIso },
                { merge: true }
              );
            }

            batch.commit().catch(() => {});
          } catch (e) {}
        }

        function handleCreateStockCountRequest(ingredientId, assignedToId, note) {
          const requester = adminUser && (adminUser.role === "admin" || adminUser.role === "manager") ? adminUser : null;
          if (!requester) return;

          const id = makeId("sc");
          const ingId = String(ingredientId || "");
          const toId = String(assignedToId || "");
          if (!ingId || !toId) return;

          const nowIso = new Date().toISOString();
          const shiftId = activeShift ? activeShift.id : null;
          const ing = inventory && inventory[ingId] ? inventory[ingId] : null;
          const expectedQty = ing && typeof ing.currentQty === "number" ? ing.currentQty : 0;

          const req = {
            id,
            ingredientId: ingId,
            assignedToId: toId,
            requestedById: requester.id,
            requestedAt: nowIso,
            shiftId,
            status: "open",
            expectedQty,
            note: note ? String(note) : ""
          };
          setStockCountRequests((prev) => [...(prev || []), req]);

          if (!cloudEnabled) return;
          const stockCountsCol = cloudCol("stockCountRequests");
          if (!stockCountsCol) return;
          try {
            stockCountsCol
              .doc(id)
              .set(
                {
                  ...req,
                  appId: CLOUD_APP_ID,
                  deviceId: deviceIdRef.current,
                  updatedAt: nowIso
                },
                { merge: true }
              )
              .catch(() => {});
          } catch (e) {}
        }

        function handleSubmitStockCountRequest(requestId, countedQty) {
          const id = String(requestId || "");
          if (!id) return;
          const req = (stockCountRequests || []).find((r) => r && r.id === id) || null;
          if (!req || req.status !== "open") return;
          if (!activeWorker || req.assignedToId !== activeWorker.id) return;

          const n = Number(String(countedQty == null ? "" : countedQty).replace(",", "."));
          if (!Number.isFinite(n) || n < 0) return;
          const nowIso = new Date().toISOString();
          const expectedQty = typeof req.expectedQty === "number" ? req.expectedQty : 0;
          const variance = n - expectedQty;

          const patch = {
            status: "submitted",
            countedQty: n,
            variance: variance,
            submittedAt: nowIso,
            submittedById: activeWorker.id,
            updatedAt: nowIso
          };

          setStockCountRequests((prev) =>
            (prev || []).map((r) => (r && r.id === id ? { ...r, ...patch } : r))
          );

          if (!cloudEnabled) return;
          const stockCountsCol = cloudCol("stockCountRequests");
          if (!stockCountsCol) return;
          try {
            stockCountsCol
              .doc(id)
              .set(
                {
                  ...patch,
                  id,
                  appId: CLOUD_APP_ID,
                  deviceId: deviceIdRef.current
                },
                { merge: true }
              )
              .catch(() => {});
          } catch (e) {}
        }

        function handleAdminLogin(user) {
          setAdminUser(user);
        }

        function handleAdminLogout() {
          setAdminUser(null);
        }

        function handleChangeUserPin(userId, newPin) {
          handleUpsertUser({ id: userId, pin: newPin });
        }

        function handleUpsertUser(partial) {
          if (!partial) return;
          const nowIso = new Date().toISOString();
          setUsers((prev) => {
            const list = (prev || []).slice();
            const idx = list.findIndex((u) => u && u.id === partial.id);
            if (idx === -1) {
              const base = (USERS || []).find((u) => u && u.id === partial.id) || null;
              list.push({
                id: partial.id,
                name: partial.name || (base && base.name) || partial.id,
                role: partial.role || (base && base.role) || "worker",
                pin:
                  partial.pin !== undefined
                    ? (partial.pin || "")
                    : (base && base.pin ? String(base.pin) : ""),
                salary: typeof partial.salary === "number" ? partial.salary : 0,
                posAccess: partial.posAccess === false ? false : true,
                cycleStartDate: partial.cycleStartDate || null
              });
              return ensureDefaultUsers(list);
            }
            const cur = list[idx];
            list[idx] = {
              ...cur,
              ...partial,
              salary:
                partial.salary === undefined
                  ? (typeof cur.salary === "number" ? cur.salary : 0)
                  : (Number(partial.salary) || 0),
              posAccess:
                partial.posAccess === undefined
                  ? (cur && cur.posAccess === false ? false : true)
                  : (partial.posAccess === false ? false : true),
              cycleStartDate:
                partial.cycleStartDate === undefined
                  ? (cur && cur.cycleStartDate ? cur.cycleStartDate : null)
                  : (partial.cycleStartDate ? String(partial.cycleStartDate) : null)
            };
            return ensureDefaultUsers(list);
          });

          if (!cloudEnabled) return;
          const usersCol = cloudCol("users");
          if (!usersCol) return;
          try {
            usersCol
              .doc(partial.id)
              .set(
                {
                  ...partial,
                  id: partial.id,
                  updatedAt: nowIso,
                  appId: CLOUD_APP_ID,
                  deviceId: deviceIdRef.current
                },
                { merge: true }
              )
              .catch(() => {});
          } catch (e) {}
        }

        function handleDeleteUser(userId) {
          if (!userId) return;
          if (userId === "manager_halab" || userId === "admin_nouri") {
            setStatus({ type: "err", message: "Utilisateur protégé." });
            return;
          }
          setUsers((prev) => (prev || []).filter((u) => u && u.id !== userId));
          if (activeWorker && activeWorker.id === userId) {
            setActiveWorker(null);
            setShiftPaused(false);
          }
          if (adminUser && adminUser.id === userId) {
            setAdminUser(null);
          }
          if (!cloudEnabled) return;
          const usersCol = cloudCol("users");
          if (!usersCol) return;
          try {
            usersCol.doc(userId).delete().catch(() => {});
          } catch (e) {}
        }

        function applyShiftExpectedCashDelta(shiftId, delta, nowIso) {
          if (!shiftId) return;
          const d = Number(delta || 0) || 0;
          if (!d) return;
          setShifts((prev) =>
            (prev || []).map((s) =>
              s && s.id === shiftId
                ? { ...s, expectedCash: (s.expectedCash || 0) + d }
                : s
            )
          );
          setActiveShift((s) =>
            s && s.id === shiftId
              ? { ...s, expectedCash: (s.expectedCash || 0) + d }
              : s
          );

          if (!cloudEnabled) return;
          const shiftsCol = cloudCol("shifts");
          if (!shiftsCol) return;
          try {
            const inc = firebase.firestore.FieldValue.increment;
            shiftsCol
              .doc(shiftId)
              .set(
                { id: shiftId, expectedCash: inc(d), updatedAt: nowIso || new Date().toISOString() },
                { merge: true }
              )
              .catch(() => {});
          } catch (e) {}
        }

        function openAdvancePrompt() {
          if (!activeShift || !activeWorker) return;
          setAdvanceError(null);
          setAdvanceAmount("");
          setAdvanceOpen(true);
        }

        function submitAdvanceRequest(ev) {
          if (ev && ev.preventDefault) ev.preventDefault();
          if (!activeShift || !activeWorker) return;
          const parsed = parseCash(advanceAmount);
          if (parsed == null || parsed <= 0) {
            setAdvanceError(lang === "ar" ? "قيمة غير صالحة" : "Valeur invalide");
            return;
          }
          const amount = Number(parsed || 0) || 0;
          const nowIso = new Date().toISOString();
          const shiftId = activeShift.id;
          const requiresAdmin = amount > 100;
          const id = makeId("adv");
          const rec = {
            id,
            workerId: activeWorker.id,
            shiftId,
            amount,
            requestedAt: nowIso,
            status: requiresAdmin ? "pending" : "approved",
            approvedAt: requiresAdmin ? null : nowIso,
            approvedBy: requiresAdmin ? null : activeWorker.id,
            rejectedAt: null,
            rejectedBy: null
          };

          setAdvances((prev) => [...(prev || []), rec]);
          setAdvanceOpen(false);
          setAdvanceError(null);

          if (!requiresAdmin) {
            applyShiftExpectedCashDelta(shiftId, -amount, nowIso);
            setStatus({
              type: "ok",
              message: lang === "ar" ? "تم تسجيل السلفة." : "Avance enregistrée."
            });
          } else {
            setStatus({
              type: "err",
              message:
                lang === "ar"
                  ? "سلفة أكبر من 100 درهم: تحتاج موافقة المدير."
                  : "Avance > 100 DHS: autorisation admin requise."
            });
          }

          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          const advancesCol = cloudCol("advances");
          const shiftsCol = cloudCol("shifts");
          if (!db || !advancesCol || !shiftsCol) return;
          try {
            const batch = db.batch();
            batch.set(
              advancesCol.doc(id),
              {
                ...rec,
                appId: CLOUD_APP_ID,
                deviceId: deviceIdRef.current,
                updatedAt: nowIso
              },
              { merge: true }
            );
            if (!requiresAdmin) {
              const inc = firebase.firestore.FieldValue.increment;
              batch.set(
                shiftsCol.doc(shiftId),
                { id: shiftId, expectedCash: inc(-amount), updatedAt: nowIso },
                { merge: true }
              );
            }
            batch.commit().catch(() => {});
          } catch (e) {}
        }

        function handleApproveAdvance(advanceId) {
          if (!advanceId || !adminUser) return;
          const nowIso = new Date().toISOString();
          const rec = (advances || []).find((a) => a && a.id === advanceId) || null;
          if (!rec || rec.status !== "pending") return;
          const amount = Number(rec.amount || 0) || 0;
          const shiftId = rec.shiftId;

          setAdvances((prev) =>
            (prev || []).map((a) =>
              a && a.id === advanceId
                ? { ...a, status: "approved", approvedAt: nowIso, approvedBy: adminUser.id }
                : a
            )
          );

          if (shiftId && amount > 0) {
            applyShiftExpectedCashDelta(shiftId, -amount, nowIso);
          }

          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          const advancesCol = cloudCol("advances");
          const shiftsCol = cloudCol("shifts");
          if (!db || !advancesCol || !shiftsCol) return;
          try {
            const batch = db.batch();
            batch.set(
              advancesCol.doc(advanceId),
              { status: "approved", approvedAt: nowIso, approvedBy: adminUser.id, updatedAt: nowIso },
              { merge: true }
            );
            if (shiftId && amount > 0) {
              const inc = firebase.firestore.FieldValue.increment;
              batch.set(
                shiftsCol.doc(shiftId),
                { id: shiftId, expectedCash: inc(-amount), updatedAt: nowIso },
                { merge: true }
              );
            }
            batch.commit().catch(() => {});
          } catch (e) {}
        }

        function handleRejectAdvance(advanceId) {
          if (!advanceId || !adminUser) return;
          const nowIso = new Date().toISOString();
          const rec = (advances || []).find((a) => a && a.id === advanceId) || null;
          if (!rec || rec.status !== "pending") return;
          setAdvances((prev) =>
            (prev || []).map((a) =>
              a && a.id === advanceId
                ? { ...a, status: "rejected", rejectedAt: nowIso, rejectedBy: adminUser.id }
                : a
            )
          );
          if (!cloudEnabled) return;
          const advancesCol = cloudCol("advances");
          if (!advancesCol) return;
          try {
            advancesCol
              .doc(advanceId)
              .set({ status: "rejected", rejectedAt: nowIso, rejectedBy: adminUser.id, updatedAt: nowIso }, { merge: true })
              .catch(() => {});
          } catch (e) {}
        }

        function handleOpenShift(dateStr, period) {
          const id = buildShiftId(dateStr, period);
          const newShift = {
            id,
            date: dateStr,
            period,
            status: "open",
            openedAt: new Date().toISOString(),
            closedAt: null,
            openedBy: adminUser ? adminUser.id : null,
            closedBy: null,
            revenue: 0,
            orderCount: 0,
            openingFloatCash: 0,
            openingExpectedCash: 0,
            expectedCash: 0
          };
          setActiveShift(newShift);
          setShifts((prev) => {
            const exists = prev.some((s) => s && s.id === newShift.id);
            if (!exists) return [...prev, newShift];
            return prev.map((s) => (s && s.id === newShift.id ? { ...s, ...newShift } : s));
          });

          if (cloudEnabled) {
            const shiftsCol = cloudCol("shifts");
            if (shiftsCol) {
              const nowIso = newShift.openedAt;
              shiftsCol
                .doc(id)
                .set(
                  {
                    ...newShift,
                    openingExpectedCash: newShift.expectedCash,
                    appId: CLOUD_APP_ID,
                    deviceId: deviceIdRef.current,
                    updatedAt: nowIso
                  },
                  { merge: true }
                )
                .catch(() => {});
            }
          }
        }

        function handleCloseShift() {
          if (!activeShift) return;
          const closedAt = new Date().toISOString();
          setShifts((prev) =>
            prev.map((s) =>
              s.id === activeShift.id
                ? { ...s, status: "closed", closedAt }
                : s
            )
          );

          if (cloudEnabled) {
            const shiftsCol = cloudCol("shifts");
            if (shiftsCol) {
              shiftsCol
                .doc(activeShift.id)
                .set(
                  {
                    id: activeShift.id,
                    status: "closed",
                    closedAt,
                    closedBy: adminUser ? adminUser.id : null,
                    updatedAt: closedAt
                  },
                  { merge: true }
                )
                .catch(() => {});
            }
          }
          setActiveShift(null);
        }

        function updateShiftStats(shiftId, amount) {
          setShifts((prev) =>
            prev.map((s) =>
              s.id === shiftId
                ? {
                    ...s,
                    revenue: (s.revenue || 0) + amount,
                    orderCount: (s.orderCount || 0) + 1,
                    expectedCash: (s.expectedCash || 0) + amount
                  }
                : s
            )
          );
        }

        async function handleSubmitOrder() {
          if (!cart.length) return;
          if (!activeWorker) {
            setStatus({
              type: "err",
              message:
                t.needWorkerLogin ||
                "Ouvrez un shift (PIN serveur) avant de prendre une commande."
            });
            return;
          }
          if (shiftPaused) {
            setStatus({
              type: "err",
              message: t.shiftPausedBlocking || "Shift en pause."
            });
            return;
          }
          if (!activeShift) {
            setStatus({
              type: "err",
              message: t.noShiftOpen || "Aucun shift ouvert."
            });
            return;
          }

          if (needsGlassCupCustomerName && !String(glassCupCustomerName || "").trim()) {
            setStatus({
              type: "err",
              message: (t && t.glassCupCustomerNameRequired) || "Nom du client requis pour verre à emporter."
            });
            return;
          }

          setSubmitting(true);
          setStatus(null);

          const now = new Date();
          const nowIso = now.toISOString();
          const orderId = makeId("ord");
          const ticketDay = pad2(now.getDate());
          const ticketMonth = pad2(now.getMonth() + 1);
          const shiftCode = periodToShiftCode(activeShift.period);
          const waiterCode = makeWaiterCode(activeWorker.name);
          const ticketPrefix = `${ticketDay}${ticketMonth}${shiftCode}${waiterCode}`;
          const maxExistingSeq = (orders || []).reduce((max, o) => {
            const code = o && o.ticketCode ? String(o.ticketCode) : "";
            if (!code || !code.startsWith(ticketPrefix)) return max;
            const tail = code.slice(-3);
            const parsed = parseInt(tail, 10);
            if (!Number.isFinite(parsed)) return max;
            return Math.max(max, parsed);
          }, 0);
          const ticketSeq = pad3(maxExistingSeq + 1);
          const ticketCode = ticketPrefix + ticketSeq;

          const orderNameTrimmed = String(orderName || "").trim();

          const order = {
            id: orderId,
            appId: "cafe-halab-pos",
            orderName: orderNameTrimmed,
            serviceType: cartServiceType,
            glassCupCustomerName: needsGlassCupCustomerName ? String(glassCupCustomerName || "").trim() : "",
            items: cart.map((line) => {
              const p = menu.find((m) => m.id === line.id);
              return {
                ...line,
                nameFr: p?.nameFr || line.name,
                nameAr: p?.nameAr || line.name
              };
            }),
            totals: {
              subtotal: totals && typeof totals.subtotal === "number" ? totals.subtotal : 0,
              tax: totals && typeof totals.tax === "number" ? totals.tax : 0,
              cupFee: totals && typeof totals.cupFee === "number" ? totals.cupFee : 0,
              total: totals && typeof totals.total === "number" ? totals.total : 0
            },
            currency: "DHS",
            status: "unpaid",
            createdAt: nowIso,
            shiftId: activeShift.id,
            cashierId: activeWorker.id,
            ticketCode,
            ticketPrefix,
            ticketSeq
          };

          const loansToCreate = [];
          if (cartServiceType === "takeaway") {
            const customerName = String(order.glassCupCustomerName || "").trim();
            const counts = { small: 0, large: 0 };
            (cart || []).forEach((line) => {
              if (!line || line.containerType !== "glass") return;
              if (!isDrinkLineForCup(line)) return;
              const size = line.cupSize === "large" ? "large" : "small";
              const qty = Number(line.qty || 0) || 0;
              if (qty <= 0) return;
              counts[size] += qty;
            });

            if (customerName && (counts.small > 0 || counts.large > 0)) {
              (counts.small > 0 ? ["small"] : [])
                .concat(counts.large > 0 ? ["large"] : [])
                .forEach((size) => {
                  const qty = size === "large" ? counts.large : counts.small;
                  const unitDeposit = size === "large" ? 10 : 5;
                  const depositAmount = qty * unitDeposit;
                  loansToCreate.push({
                    id: makeId("cupLoan"),
                    kind: "glass",
                    size,
                    qty,
                    customerName,
                    depositPaid: true,
                    depositAmount,
                    depositPaidAt: nowIso,
                    depositRefunded: false,
                    depositRefundedAt: null,
                    status: "out",
                    createdAt: nowIso,
                    orderId,
                    shiftId: activeShift.id,
                    waiterId: activeWorker.id,
                    returnedAt: null,
                    returnedShiftId: null,
                    returnedBy: null
                  });
                });
            }
          }

          const depositTotal = (loansToCreate || []).reduce((sum, l) => {
            if (!l || !l.depositPaid) return sum;
            const v = Number(l.depositAmount || 0) || 0;
            return sum + v;
          }, 0);
          if (depositTotal > 0) {
            applyShiftExpectedCashDelta(activeShift.id, depositTotal, nowIso);
          }

          const ingredientDeltas = accumulateIngredientsForOrder(cart, { serviceType: cartServiceType });
          applyInventoryConsumption(
            ingredientDeltas,
            activeShift.id,
            orderId,
            activeWorker.id
          );

          setOrders((prev) => [...prev, order]);
          if (loansToCreate.length) setCupLoans((prev) => [...(prev || []), ...loansToCreate]);

          if (cloudEnabled) {
            const ordersCol = cloudCol("orders");
            const loansCol = cloudCol("cupLoans");
            const nowIso = order.createdAt;
            const shiftsCol = cloudCol("shifts");
            if (ordersCol) {
              ordersCol
                .doc(orderId)
                .set(
                  {
                    ...order,
                    appId: CLOUD_APP_ID,
                    deviceId: deviceIdRef.current,
                    updatedAt: nowIso
                  },
                  { merge: true }
                )
                .catch(() => {});
            }
            if (loansCol && loansToCreate.length) {
              loansToCreate.forEach((l) => {
                if (!l || !l.id) return;
                try {
                  loansCol
                    .doc(l.id)
                    .set(
                      { ...l, appId: CLOUD_APP_ID, deviceId: deviceIdRef.current, updatedAt: nowIso },
                      { merge: true }
                    )
                    .catch(() => {});
                } catch (e) {}
              });
            }
            if (shiftsCol && depositTotal > 0) {
              try {
                const inc = firebase.firestore.FieldValue.increment;
                shiftsCol
                  .doc(activeShift.id)
                  .set(
                    { id: activeShift.id, expectedCash: inc(depositTotal), updatedAt: nowIso },
                    { merge: true }
                  )
                  .catch(() => {});
              } catch (e) {}
            }
          }

          await new Promise((resolve) => setTimeout(resolve, 300));
          setStatus({
            type: "ok",
            message: t.orderAddedPending || "Commande ajoutée aux commandes en attente."
          });
          setCart([]);
          setGlassCupCustomerName("");
          setOrderName("");
          setSubmitting(false);
        }

        function handleMarkOrderPaidAnimated(orderId) {
          if (!orderId) return;
          if (exitingOrderIds && exitingOrderIds[orderId]) return;
          setExitingOrderIds((prev) => ({ ...(prev || {}), [orderId]: true }));
          try {
            const existing = exitingOrderTimeoutsRef.current && exitingOrderTimeoutsRef.current[orderId];
            if (existing) clearTimeout(existing);
            exitingOrderTimeoutsRef.current[orderId] = setTimeout(() => {
              try {
                handleMarkOrderPaid(orderId);
              } finally {
                setExitingOrderIds((prev) => {
                  const n = { ...(prev || {}) };
                  delete n[orderId];
                  return n;
                });
                if (exitingOrderTimeoutsRef.current) delete exitingOrderTimeoutsRef.current[orderId];
              }
            }, 280);
          } catch (e) {}
        }

        function handleMarkOrderPaid(orderId) {
          const order = orders.find((o) => o && o.id === orderId);
          if (!order || order.status === "paid") return;
          if (order.status === "debt" && order.debtId) {
            handleMarkDebtPaid(order.debtId);
            return;
          }
          const paidAt = new Date().toISOString();

          setOrders((prev) =>
            prev.map((o) =>
              o && o.id === orderId ? { ...o, status: "paid", paidAt } : o
            )
          );
          updateShiftStats(order.shiftId, order.totals.total);

          if (!cloudEnabled) return;
          const db = window.firebaseDb;
          const ordersCol = cloudCol("orders");
          const shiftsCol = cloudCol("shifts");
          if (!db || !ordersCol || !shiftsCol) return;

          try {
            const orderRef = ordersCol.doc(orderId);
            const shiftRef = shiftsCol.doc(order.shiftId);
            const inc = firebase.firestore.FieldValue.increment;
            db
              .runTransaction((tx) =>
                tx.get(orderRef).then((snap) => {
                  const data = snap && snap.data ? snap.data() : null;
                  if (data && data.status === "paid") return;
                  tx.set(
                    orderRef,
                    { status: "paid", paidAt, updatedAt: paidAt },
                    { merge: true }
                  );
                  tx.set(
                    shiftRef,
                    {
                      id: order.shiftId,
                      revenue: inc(order.totals.total),
                      orderCount: inc(1),
                      expectedCash: inc(order.totals.total),
                      updatedAt: paidAt
                    },
                    { merge: true }
                  );
                })
              )
              .catch(() => {});
          } catch (e) {}
        }

        function handleUpdateMenuItem(id, partial) {
          setMenu((prev) => {
            const next = prev.map((m) =>
              m.id === id ? { ...m, ...partial } : m
            );
            return next;
          });
          const idx = INITIAL_MENU_DATA.findIndex((m) => m.id === id);
          if (idx !== -1) {
            INITIAL_MENU_DATA[idx] = { ...INITIAL_MENU_DATA[idx], ...partial };
          }
        }

        function handleAddMenuItem(item) {
          if (!item || !item.id) return;
          setMenu((prev) => {
            const arr = Array.isArray(prev) ? prev : [];
            if (arr.some((m) => m && m.id === item.id)) return arr;
            const next = [...arr, item];
            try {
              window.localStorage.setItem("cafe_halab_menu", JSON.stringify(next));
            } catch (e) {}
            return next;
          });
          try {
            INITIAL_MENU_DATA.push(item);
          } catch (e) {}
          setStatus({ type: "ok", message: "Article ajouté." });
        }

        function handleSaveMenu(currentMenu) {
          try {
            window.localStorage.setItem(
              "cafe_halab_menu",
              JSON.stringify(currentMenu)
            );
            setStatus({ type: "ok", message: "Menu enregistré." });
          } catch (e) {
            setStatus({ type: "err", message: "Erreur lors de l'enregistrement." });
          }
        }

        function canSeeManager() {
          return (adminUser && adminUser.role === "admin") || !!managerUnlocked;
        }

        function canSeeAdmin() {
          return adminUser && adminUser.role === "admin";
        }

        function managerPinValue() {
          const u = (users || []).find((x) => x && x.role === "manager") || null;
          return u && u.pin != null ? String(u.pin) : "";
        }

        function openManagerGate() {
          setManagerGateError(null);
          setManagerGateValue("");
          setManagerGateOpen(true);
        }

        function closeManagerGate() {
          setManagerGateOpen(false);
          setManagerGateError(null);
          setManagerGateValue("");
        }

        function confirmManagerGate(ev) {
          if (ev && ev.preventDefault) ev.preventDefault();
          const expected = normalizePinValue(managerPinValue());
          const got = normalizePinValue(managerGateValue);
          if (!expected || got !== expected) {
            setManagerGateError(t.pinIncorrect || "PIN incorrect");
            return;
          }
          setManagerUnlocked(true);
          closeManagerGate();
          setView("manager");
        }

        function handleOpenWaiterShift(ev) {
          if (ev && ev.preventDefault) ev.preventDefault();
          const worker = users.find(
            (u) => u.role === "worker" && u.posAccess !== false && u.pin === shiftPin
          );
          if (!worker) {
            setShiftError(t.pinIncorrect || "PIN incorrect");
            return;
          }

          const auto = autoShiftContextNow();
          const today = (auto && auto.dateStr) || localYmd(new Date());
          const period = (auto && auto.period) || waiterPeriod || "morning";
          setWaiterPeriod(period);

          const shiftId = buildShiftId(today, period);

          const existing = (shifts || []).find((s) => s && s.id === shiftId) || null;
          if (existing) {
            if (!existing.status || existing.status === "open") {
              setActiveShift(existing);
              setActiveWorker(worker);
              setShiftPaused(false);
              lastActivityRef.current = Date.now();
              setShiftPin("");
              setShiftError(null);
              return;
            }
            setShiftError(lang === "ar" ? "هذا الشيفت مغلق بالفعل" : "Ce shift est déjà fermé");
            return;
          }

          const otherOpen = (shifts || []).find((s) => s && s.status === "open") || null;
          if (otherOpen) {
            setShiftError(
              (lang === "ar" ? "هناك شيفت مفتوح بالفعل: " : "Un shift est déjà ouvert: ") + String(otherOpen.id || "")
            );
            return;
          }

          const prevPeriodShiftId = previousShiftKeyFor(today, period);
          const prevPeriodShift = (shifts || []).find((s) => s && s.id === prevPeriodShiftId) || null;
          let srcShift =
            prevPeriodShift && typeof prevPeriodShift.closingFloatCash === "number"
              ? prevPeriodShift
              : null;
          if (!srcShift) {
            srcShift = findMostRecentClosedShiftWithFloat(shifts, shiftId);
          }
          const prevFloat =
            srcShift && typeof srcShift.closingFloatCash === "number"
              ? srcShift.closingFloatCash
              : null;

          if (prevFloat != null) {
            setPendingShiftOpen({ worker, today, shiftId, period, prevShiftId: srcShift ? srcShift.id : prevPeriodShiftId });
            setFloatConfirmExpected(prevFloat);
            setFloatConfirmValue(String(prevFloat.toFixed(2)));
            setFloatConfirmError(null);
            setFloatConfirmOpen(true);
            setShiftPin("");
            setShiftError(null);
            return;
          }

          openWaiterShiftNow({ worker, today, shiftId, period, prevShiftId: prevPeriodShiftId }, 0);
        }

        function openWaiterShiftNow(ctx, openingFloatCash) {
          const worker = ctx && ctx.worker;
          const today = ctx && ctx.today;
          const shiftId = ctx && ctx.shiftId;
          const period = ctx && ctx.period;
          const prevShiftId = ctx && ctx.prevShiftId;
          const adminOpenedBy = ctx && ctx.adminOpenedBy ? ctx.adminOpenedBy : null;
          if (!worker || !today || !shiftId || !period) return;

          const prevShift = prevShiftId
            ? (shifts || []).find((s) => s && s.id === prevShiftId)
            : null;
          const shouldConfirmPrevFloat =
            !!(prevShift && typeof prevShift.closingFloatCash === "number");

          const cutoff = Date.now() - 48 * 60 * 60 * 1000;
          const overdue = (clientDebts || []).filter(
            (d) =>
              d &&
              d.waiterId === worker.id &&
              !d.paidAt &&
              !d.chargedAt &&
              d.createdAt &&
              new Date(d.createdAt).getTime() <= cutoff
          );
          const overdueSum = overdue.reduce(
            (s, d) => s + (typeof d.amount === "number" ? d.amount : 0),
            0
          );

          const openingExpectedCash = (Number(openingFloatCash || 0) || 0) + (overdueSum || 0);

          const newShift = {
            id: shiftId,
            date: today,
            period,
            status: "open",
            openedAt: new Date().toISOString(),
            closedAt: null,
            orderCount: 0,
            revenue: 0,
            openingFloatCash: Number(openingFloatCash || 0) || 0,
            openingExpectedCash: openingExpectedCash || 0,
            expectedCash: openingExpectedCash || 0,
            openedBy: worker.id,
            openedByAdmin: adminOpenedBy,
            currentOperatorId: worker.id,
            operatorHandoffs: []
          };

          if (overdue.length) {
            const chargedAt = newShift.openedAt;
            const ids = new Set(overdue.map((d) => d && d.id).filter(Boolean));
            setClientDebts((prev) =>
              (prev || []).map((d) =>
                d && ids.has(d.id)
                  ? { ...d, chargedAt, chargedShiftId: shiftId }
                  : d
              )
            );
            setStatus({
              type: "err",
              message:
                ((t && t.clientUnpaidDebtLabel) || "Client unpaid debt") +
                ": +" +
                overdueSum.toFixed(2) +
                " DHS"
            });
          }

          setActiveShift(newShift);
          setShifts((prev) => {
            const exists = prev.some((s) => s && s.id === newShift.id);
            if (!exists) return [...prev, newShift];
            return prev.map((s) => (s && s.id === newShift.id ? { ...s, ...newShift } : s));
          });

          if (cloudEnabled) {
            const db = window.firebaseDb;
            const shiftsCol = cloudCol("shifts");
            const debtsCol = cloudCol("clientDebts");
            if (db && shiftsCol && debtsCol) {
              const nowIso = newShift.openedAt;
              try {
                const batch = db.batch();
                batch.set(
                  shiftsCol.doc(shiftId),
                  {
                    ...newShift,
                    appId: CLOUD_APP_ID,
                    deviceId: deviceIdRef.current,
                    updatedAt: nowIso
                  },
                  { merge: true }
                );
                if (shouldConfirmPrevFloat && prevShiftId) {
                  batch.set(
                    shiftsCol.doc(prevShiftId),
                    {
                      id: prevShiftId,
                      closingFloatConfirmedAt: nowIso,
                      closingFloatConfirmedBy: worker.id,
                      closingFloatConfirmedValue: Number(openingFloatCash || 0) || 0,
                      updatedAt: nowIso
                    },
                    { merge: true }
                  );
                }
                if (overdue.length) {
                  overdue.forEach((d) => {
                    if (!d || !d.id) return;
                    batch.set(
                      debtsCol.doc(d.id),
                      { chargedAt: nowIso, chargedShiftId: shiftId, updatedAt: nowIso },
                      { merge: true }
                    );
                  });
                }
                batch.commit().catch(() => {});
              } catch (e) {}
            }
          }
          setActiveWorker(worker);
          setShiftPaused(false);
          lastActivityRef.current = Date.now();
          setShiftError(null);
          setActiveCategory(null);
          setPosSection("sales");
          setView("pos");
        }

        function confirmFloatAndOpenShift(ev) {
          if (ev && ev.preventDefault) ev.preventDefault();
          if (!pendingShiftOpen) return;
          const parsed = parseCash(floatConfirmValue);
          if (parsed == null || parsed < 0) {
            setFloatConfirmError((t && t.pinIncorrect) || "Valeur invalide");
            return;
          }
          setFloatConfirmOpen(false);
          setFloatConfirmError(null);
          const ctx = pendingShiftOpen;
          setPendingShiftOpen(null);
          openWaiterShiftNow(ctx, parsed);
        }

        function handleCloseWaiterShift() {
          if (activeShift && blockingCloseOrders && blockingCloseOrders.length) {
            setCloseShiftGateOpen(true);
            return;
          }
          setCloseShiftActorOverride(null);
          openCloseShiftFloatPrompt();
        }

        function forceCloseWaiterShift() {
          if (blockingCloseOrders && blockingCloseOrders.length) return;
          setCloseShiftActorOverride(null);
          openCloseShiftFloatPrompt();
        }

        function openCloseShiftFloatPrompt(targetShiftId) {
          const sid = targetShiftId || (activeShift && activeShift.id);
          if (!sid) return;
          setCloseShiftTargetId(sid);
          setCloseShiftGateOpen(false);
          setCloseShiftFloatError(null);
          const shiftRec = (shifts || []).find((s) => s && s.id === sid) || null;
          const fallbackActive = activeShift && activeShift.id === sid ? activeShift : null;
          const initialFloat =
            shiftRec && typeof shiftRec.openingFloatCash === "number"
              ? shiftRec.openingFloatCash
              : fallbackActive && typeof fallbackActive.openingFloatCash === "number"
              ? fallbackActive.openingFloatCash
              : 0;
          try {
            const shiftOrders = (orders || []).filter(
              (o) =>
                o &&
                o.shiftId === sid &&
                (o.status === "paid" || o.status === "unpaid" || o.status === "debt")
            );
            const paidOrders = shiftOrders.filter((o) => o.status === "paid");
            const debtOrders = shiftOrders.filter((o) => o.status === "debt");
            const unpaidOrders = shiftOrders.filter((o) => o.status === "unpaid");

            const paidRevenue = paidOrders.reduce(
              (sum, o) => sum + (Number((o.totals && o.totals.total) || 0) || 0),
              0
            );
            const debtTotal = debtOrders.reduce(
              (sum, o) => sum + (Number((o.totals && o.totals.total) || 0) || 0),
              0
            );
            const unpaidTotal = unpaidOrders.reduce(
              (sum, o) => sum + (Number((o.totals && o.totals.total) || 0) || 0),
              0
            );

            const purchasesLogs = (inventoryLogs || []).filter(
              (l) =>
                l &&
                l.shiftId === sid &&
                l.reason === "purchase" &&
                l.deductFromExpectedCash !== false
            );
            const purchasesTotal = purchasesLogs.reduce(
              (sum, l) => sum + (Number(l.totalCost || 0) || 0),
              0
            );

            const debtsCreated = (clientDebts || []).filter(
              (d) => d && d.originalShiftId === sid
            );
            const debtsCreatedTotal = debtsCreated.reduce(
              (sum, d) => sum + (Number(d.amount || 0) || 0),
              0
            );

            const debtsPaidInShift = (clientDebts || []).filter(
              (d) => d && d.paidShiftId === sid && d.paidAt
            );
            const debtsPaidTotal = debtsPaidInShift.reduce(
              (sum, d) => sum + (Number(d.amount || 0) || 0),
              0
            );

            setCloseShiftReport({
              shiftId: sid,
              orderCount: shiftOrders.length,
              paidCount: paidOrders.length,
              paidRevenue,
              debtCount: debtOrders.length,
              debtTotal,
              unpaidCount: unpaidOrders.length,
              unpaidTotal,
              purchasesTotal,
              debtsCreatedCount: debtsCreated.length,
              debtsCreatedTotal,
              debtsPaidCount: debtsPaidInShift.length,
              debtsPaidTotal,
              openingFloatCash: Number(initialFloat || 0) || 0
            });
          } catch (e) {
            setCloseShiftReport(null);
          }
          setCloseShiftFloatValue(String((Number(initialFloat || 0) || 0).toFixed(2)));
          setCloseShiftFloatOpen(true);
        }

        function confirmCloseShiftWithFloat(ev) {
          if (ev && ev.preventDefault) ev.preventDefault();
          const sid = closeShiftTargetId || (activeShift && activeShift.id);
          if (!sid) return;
          const parsed = parseCash(closeShiftFloatValue);
          if (parsed == null || parsed < 0) {
            setCloseShiftFloatError((t && t.pinIncorrect) || "Valeur invalide");
            return;
          }
          setCloseShiftFloatError(null);
          setCloseShiftFloatOpen(false);
          setCloseShiftReport(null);
          const actor = closeShiftActorOverride;
          setCloseShiftActorOverride(null);
          setCloseShiftTargetId(null);
          finalizeCloseShiftById(sid, parsed, actor);
        }

        function finalizeCloseShiftById(shiftId, closingFloatCash, closedByOverride) {
          if (!shiftId) return;
          const closedAt = new Date().toISOString();
          const closedBy =
            closedByOverride != null
              ? closedByOverride
              : activeWorker
              ? activeWorker.id
              : null;
          const floatVal = Number(closingFloatCash || 0) || 0;
          setShifts((prev) =>
            (prev || []).map((s) =>
              s && s.id === shiftId
                ? {
                    ...s,
                    status: "closed",
                    closedAt,
                    closedBy,
                    closingFloatCash: floatVal,
                    closingFloatSetAt: closedAt
                  }
                : s
            )
          );

          if (cloudEnabled) {
            const shiftsCol = cloudCol("shifts");
            if (shiftsCol) {
              shiftsCol
                .doc(shiftId)
                .set(
                  {
                    id: shiftId,
                    status: "closed",
                    closedAt,
                    closedBy,
                    closingFloatCash: floatVal,
                    closingFloatSetAt: closedAt,
                    updatedAt: closedAt
                  },
                  { merge: true }
                )
                .catch(() => {});
            }
          }

          if (activeShift && activeShift.id === shiftId) {
            setActiveShift(null);
            setActiveWorker(null);
            setCart([]);
            setOrderName("");
            setActiveCategory(null);
            setPosSection("sales");
            setShiftPaused(false);
            closePinPrompt();
            setCloseShiftGateOpen(false);
          }
          setShiftError(null);
        }

        function adminOpenWaiterShiftOverride(ev) {
          if (ev && ev.preventDefault) ev.preventDefault();
          if (!adminUser || adminUser.role !== "admin") return;

          const pool = (users || []).filter((u) => u && u.role === "worker" && u.posAccess !== false);
          const workerId = adminOpenWorkerId || (pool[0] && pool[0].id) || "";
          const worker = (users || []).find((u) => u && u.id === workerId) || null;
          if (!worker) return;

          const auto = autoShiftContextNow();
          const dateStr = adminOpenDate || (auto && auto.dateStr) || localYmd(new Date());
          const period = adminOpenPeriod || (auto && auto.period) || "morning";
          const shiftId = buildShiftId(dateStr, period);

          const existing = (shifts || []).find((s) => s && s.id === shiftId) || null;
          if (existing) {
            if (!existing.status || existing.status === "open") {
              setActiveShift(existing);
              setActiveWorker(worker);
              setShiftPaused(false);
              lastActivityRef.current = Date.now();
              setShiftError(null);
              setView("pos");
              return;
            }
            setShiftError(lang === "ar" ? "هذا الشيفت مغلق بالفعل" : "Ce shift est déjà fermé");
            return;
          }

          const otherOpen = (shifts || []).find((s) => s && s.status === "open") || null;
          if (otherOpen) {
            setShiftError(
              (lang === "ar" ? "هناك شيفت مفتوح بالفعل: " : "Un shift est déjà ouvert: ") + String(otherOpen.id || "")
            );
            return;
          }

          const prevPeriodShiftId = previousShiftKeyFor(dateStr, period);
          const prevPeriodShift = (shifts || []).find((s) => s && s.id === prevPeriodShiftId) || null;
          let srcShift =
            prevPeriodShift && typeof prevPeriodShift.closingFloatCash === "number"
              ? prevPeriodShift
              : null;
          if (!srcShift) {
            srcShift = findMostRecentClosedShiftWithFloat(shifts, shiftId);
          }
          const defaultFloat =
            srcShift && typeof srcShift.closingFloatCash === "number"
              ? srcShift.closingFloatCash
              : 0;
          const parsed = parseCash(adminOpenFloat);
          const openingFloat = parsed != null && parsed >= 0 ? parsed : (Number(defaultFloat || 0) || 0);

          openWaiterShiftNow(
            {
              worker,
              today: dateStr,
              shiftId,
              period,
              prevShiftId: srcShift ? srcShift.id : prevPeriodShiftId,
              adminOpenedBy: adminUser.id
            },
            openingFloat
          );
        }

        function adminCloseWaiterShift() {
          if (!adminUser || adminUser.role !== "admin") return;
          if (!activeShift) return;
          setCloseShiftActorOverride(adminUser.id);
          openCloseShiftFloatPrompt();
        }

        function openAdminShiftOverrideDefaults() {
          try {
            const auto = autoShiftContextNow();
            if (!adminOpenDate) setAdminOpenDate((auto && auto.dateStr) || localYmd(new Date()));
            if (!adminOpenPeriod) setAdminOpenPeriod((auto && auto.period) || "morning");
            if (!adminOpenWorkerId) {
              const pool = (users || []).filter((u) => u && u.role === "worker" && u.posAccess !== false);
              if (pool && pool[0] && pool[0].id) setAdminOpenWorkerId(pool[0].id);
            }
          } catch (e) {}
        }

        return e(
          "div",
          { className: "app-shell" },
          window.firebaseAuth &&
            firebaseAuthReady &&
            !firebaseUser &&
            !firebaseLoginDismissed &&
            e(FirebaseLoginOverlay, {
              t,
              lang,
              onSignedIn: handleFirebaseSignedIn,
              onDismiss: dismissFirebaseLogin
            }),
          favoritePromptOpen &&
            e(
              "div",
              {
                style: {
                  position: "fixed",
                  inset: 0,
                  background: "rgba(15,23,42,0.55)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  padding: 16,
                  zIndex: 57
                }
              },
              e(
                "section",
                { className: "panel", style: { maxWidth: 460, width: "100%" } },
                e(
                  "h3",
                  { style: { marginTop: 0 } },
                  lang === "ar" ? "حفظ في المفضلة" : "Enregistrer favori"
                ),
                e(
                  "p",
                  { style: { fontSize: 13, marginTop: 6 } },
                  lang === "ar"
                    ? "أدخل اسمًا لهذا الطلب المفضل."
                    : "Donnez un nom à ce favori."
                ),
                e(
                  "form",
                  { onSubmit: confirmFavoritePrompt, style: { display: "grid", gap: 10, marginTop: 10 } },
                  e("input", {
                    value: favoritePromptValue,
                    onChange: (ev) => setFavoritePromptValue(ev.target.value),
                    inputMode: "text",
                    autoComplete: "off",
                    placeholder: lang === "ar" ? "اسم المفضل" : "Nom du favori",
                    style: { padding: 10, fontSize: 16 }
                  }),
                  favoritePromptError &&
                    e(
                      "div",
                      { style: { fontSize: 12, color: "#b91c1c" } },
                      favoritePromptError
                    ),
                  e(
                    "div",
                    { style: { display: "flex", gap: 8, justifyContent: "flex-end" } },
                    e(
                      "button",
                      {
                        className: "category-btn",
                        type: "button",
                        onClick: closeFavoritePrompt
                      },
                      (t && t.cancelBtn) || (lang === "ar" ? "إلغاء" : "Annuler")
                    ),
                    e(
                      "button",
                      { className: "btn-primary", type: "submit" },
                      lang === "ar" ? "حفظ" : "Enregistrer"
                    )
                  )
                )
              )
            ),
          advanceOpen &&
            e(
              "div",
              {
                style: {
                  position: "fixed",
                  inset: 0,
                  background: "rgba(15,23,42,0.55)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  padding: 16,
                  zIndex: 56
                }
              },
              e(
                "section",
                { className: "panel", style: { maxWidth: 460, width: "100%" } },
                e(
                  "h3",
                  { style: { marginTop: 0 } },
                  lang === "ar" ? "سلفة" : "Avance"
                ),
                e(
                  "p",
                  { style: { fontSize: 13, marginTop: 6 } },
                  lang === "ar"
                    ? "أدخل مبلغ السلفة. إذا كان أكبر من 100 درهم فسيحتاج موافقة المدير."
                    : "Saisissez le montant. Si > 100 DHS, une autorisation admin est requise."
                ),
                e(
                  "form",
                  { onSubmit: submitAdvanceRequest, style: { display: "grid", gap: 10, marginTop: 10 } },
                  e("input", {
                    value: advanceAmount,
                    onChange: (ev) => setAdvanceAmount(ev.target.value),
                    inputMode: "decimal",
                    placeholder: "0.00",
                    style: { padding: 10, fontSize: 18, textAlign: "center" }
                  }),
                  advanceError &&
                    e(
                      "div",
                      { style: { fontSize: 12, color: "#b91c1c" } },
                      advanceError
                    ),
                  e(
                    "div",
                    { style: { display: "flex", gap: 8, justifyContent: "flex-end" } },
                    e(
                      "button",
                      {
                        className: "category-btn",
                        type: "button",
                        onClick: () => setAdvanceOpen(false)
                      },
                      (t && t.cancelBtn) || (lang === "ar" ? "إلغاء" : "Annuler")
                    ),
                    e(
                      "button",
                      { className: "btn-primary", type: "submit" },
                      lang === "ar" ? "تأكيد" : "Confirmer"
                    )
                  )
                )
              )
            ),
          e(
            "header",
            null,
            e(
              "div",
              { className: "brand" },
              e("img", {
                src: "./cafe-halab-logo.png",
                alt: t.appTitle,
                className: "brand-logo"
              }),
              e(
                "div",
                null,
                e("h1", null, t.appTitle),
                e("span", null, t.uiSubtitle)
              )
            ),
            // Admin login only
            e(LoginPanel, {
              currentUser: adminUser,
              users: users.filter((u) => u && u.role === "admin"),
              onLogin: handleAdminLogin,
              onLogout: handleAdminLogout
            }),
            e(FirebaseAuthBadge, {
              t,
              lang,
              firebaseUser,
              dismissed: firebaseLoginDismissed,
              onOpenLogin: openFirebaseLogin,
              onLogout: handleFirebaseLogout
            }),
            e(
              "div",
              { style: { marginLeft: "auto", display: "flex", gap: 6, alignItems: "center" } },
              e(
                "button",
                {
                  className: "category-btn" + (view === "pos" ? " active" : ""),
                  onClick: () => setView("pos")
                },
                "POS"
              ),
              e(
                "button",
                {
                  className:
                    "category-btn" + (view === "manager" ? " active" : ""),
                  onClick: () => (canSeeManager() ? setView("manager") : openManagerGate()),
                  disabled: false
                },
                "Manager"
              ),
              e(
                "button",
                {
                  className: "category-btn" + (view === "admin" ? " active" : ""),
                  onClick: () => {
                    setAdminSection("overview");
                    setView("admin");
                  },
                  disabled: !canSeeAdmin()
                },
                "Admin"
              ),
              e(
                "button",
                {
                  type: "button",
                  className: "category-btn" + (lang === "fr" ? " active" : ""),
                  onClick: () => setLang("fr")
                },
                t.langFr
              ),
              e(
                "button",
                {
                  type: "button",
                  className: "category-btn" + (lang === "ar" ? " active" : ""),
                  onClick: () => setLang("ar")
                },
                t.langAr
              )
            )
          ),
          pinPromptMode &&
            e(
              "div",
              {
                style: {
                  position: "fixed",
                  inset: 0,
                  background: "rgba(15,23,42,0.55)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  padding: 16,
                  zIndex: 50
                }
              },
              e(
                "section",
                { className: "panel", style: { maxWidth: 420, width: "100%" } },
                e(
                  "h3",
                  { style: { marginTop: 0 } },
                  pinPromptMode === "pause"
                    ? t.confirmPauseTitle || "Confirmer la pause"
                    : t.shiftPausedTitle || "Shift en pause"
                ),
                e(
                  "p",
                  { style: { fontSize: 13, marginTop: 6 } },
                  pinPromptMode === "pause"
                    ? t.confirmPauseSubtitle ||
                      "Saisir votre PIN pour mettre le shift en pause."
                    : pinPromptMode === "resume" && activeShift && activeShift.pendingHandoff
                      ? (lang === "ar"
                          ? "أدخل رقم PIN للنادل القادم لتأكيد الاستلام."
                          : "Saisir le PIN du serveur entrant pour confirmer la réception.")
                      : t.shiftPausedSubtitle ||
                        "Saisir le PIN du serveur pour reprendre."
                ),
                e(
                  "form",
                  {
                    onSubmit: confirmPinPrompt,
                    style: {
                      display: "flex",
                      flexDirection: "column",
                      gap: 10,
                      marginTop: 10
                    }
                  },
                  e("input", {
                    type: "password",
                    value: pinPromptValue,
                    readOnly: true,
                    inputMode: "none",
                    onChange: (ev) => setPinPromptValue(normalizePinValue(ev.target.value)),
                    placeholder: t.pinLabel || "PIN",
                    style: {
                      padding: 10,
                      fontSize: 18,
                      textAlign: "center"
                    }
                  }),
                  renderPinPad(
                    pinPromptValue,
                    pinPromptDigit,
                    pinPromptBackspace,
                    pinPromptConfirm,
                    t.confirmPinBtn || "Confirmer"
                  ),
                  e(
                    "button",
                    {
                      className: "btn-primary",
                      type: "submit",
                      disabled: normalizePinValue(pinPromptValue).length !== 4
                    },
                    t.confirmPinBtn || "Confirmer"
                  ),
                  e(
                    "button",
                    {
                      className: "category-btn",
                      type: "button",
                      onClick: closePinPrompt
                    },
                    t.closeBtn || "Fermer"
                  ),
                  pinPromptError &&
                    e(
                      "div",
                      { style: { fontSize: 12, color: "#b91c1c" } },
                      pinPromptError
                    )
                )
              )
            ),
          managerGateOpen &&
            e(
              "div",
              {
                style: {
                  position: "fixed",
                  inset: 0,
                  background: "rgba(15,23,42,0.55)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  padding: 16,
                  zIndex: 52
                }
              },
              e(
                "section",
                { className: "panel", style: { maxWidth: 420, width: "100%" } },
                e(
                  "h3",
                  { style: { marginTop: 0 } },
                  lang === "ar" ? "مدير" : "Manager"
                ),
                e(
                  "p",
                  { style: { fontSize: 13, marginTop: 6 } },
                  lang === "ar" ? "أدخل رمز المدير" : "Saisir le code manager"
                ),
                e(
                  "form",
                  {
                    onSubmit: confirmManagerGate,
                    style: {
                      display: "flex",
                      flexDirection: "column",
                      gap: 10,
                      marginTop: 10
                    }
                  },
                  e("input", {
                    type: "password",
                    value: managerGateValue,
                    readOnly: true,
                    inputMode: "none",
                    onChange: (ev) => setManagerGateValue(normalizePinValue(ev.target.value)),
                    placeholder: t.pinLabel || "PIN",
                    style: {
                      padding: 10,
                      fontSize: 18,
                      textAlign: "center"
                    }
                  }),
                  renderPinPad(
                    managerGateValue,
                    (d) => setManagerGateValue((v) => normalizePinValue(String(v || "") + String(d || ""))),
                    () => setManagerGateValue((v) => normalizePinValue(String(v || "").slice(0, -1))),
                    () => confirmManagerGate({ preventDefault: () => {} }),
                    t.confirmPinBtn || "Confirmer"
                  ),
                  e(
                    "button",
                    {
                      className: "btn-primary",
                      type: "submit",
                      disabled: normalizePinValue(managerGateValue).length !== 4
                    },
                    t.confirmPinBtn || "Confirmer"
                  ),
                  e(
                    "button",
                    {
                      className: "category-btn",
                      type: "button",
                      onClick: closeManagerGate
                    },
                    t.closeBtn || "Fermer"
                  ),
                  managerGateError &&
                    e(
                      "div",
                      { style: { fontSize: 12, color: "#b91c1c" } },
                      managerGateError
                    )
                )
              )
            ),
          calcOpen &&
            e(
              "div",
              {
                style: {
                  position: "fixed",
                  inset: 0,
                  background: "rgba(15,23,42,0.55)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  padding: 16,
                  zIndex: 58
                }
              },
              e(
                "section",
                { className: "panel", style: { maxWidth: 760, width: "100%" } },
                e(
                  "div",
                  { style: { display: "flex", justifyContent: "space-between", alignItems: "center", gap: 10 } },
                  e(
                    "h3",
                    { style: { marginTop: 0, marginBottom: 0 } },
                    lang === "ar" ? "آلة حاسبة" : "Calculatrice"
                  ),
                  e(
                    "button",
                    {
                      className: "category-btn",
                      type: "button",
                      onClick: () => setCalcOpen(false)
                    },
                    (t && t.closeBtn) || "Fermer"
                  )
                ),
                e(
                  "div",
                  {
                    style: {
                      display: "grid",
                      gridTemplateColumns: isPhone ? "1fr" : "minmax(0, 1fr) minmax(0, 1fr)",
                      gap: 14,
                      marginTop: 12,
                      alignItems: "start"
                    }
                  },
                  e(
                    "div",
                    { style: { minWidth: 0 } },
                    e(
                      "div",
                      { style: { fontSize: 12, fontWeight: 900, marginBottom: 6 } },
                      lang === "ar" ? "الحساب" : "Calcul"
                    ),
                    e("input", {
                      value: calcExpr,
                      readOnly: true,
                      placeholder: "0",
                      style: {
                        width: "100%",
                        boxSizing: "border-box",
                        padding: 10,
                        fontSize: 18,
                        textAlign: "right",
                        borderRadius: 12,
                        border: "1px solid rgba(148,163,184,0.55)"
                      }
                    }),
                    e(
                      "div",
                      { style: { marginTop: 8, fontSize: 12, color: "#374151", display: "flex", justifyContent: "space-between" } },
                      e(
                        "div",
                        null,
                        (lang === "ar" ? "النتيجة" : "Résultat") +
                          ": " +
                          (calcExprValue == null ? "—" : Number(calcExprValue || 0).toFixed(2))
                      ),
                      e(
                        "button",
                        {
                          className: "btn-primary",
                          type: "button",
                          disabled: calcExprValue == null,
                          onClick: calcExprApplyResult
                        },
                        "="
                      )
                    ),
                    e(
                      "div",
                      {
                        style: {
                          marginTop: 10,
                          display: "grid",
                          gridTemplateColumns: "repeat(4, minmax(0, 1fr))",
                          gap: 8
                        }
                      },
                      [
                        "7",
                        "8",
                        "9",
                        "÷",
                        "4",
                        "5",
                        "6",
                        "×",
                        "1",
                        "2",
                        "3",
                        "-",
                        "0",
                        ".",
                        "C",
                        "+"
                      ].map((k) =>
                        e(
                          "button",
                          {
                            key: k,
                            type: "button",
                            className: k === "C" ? "btn-warning" : "category-btn",
                            onClick: () => {
                              if (k === "C") return calcExprClear();
                              if (k === "÷" || k === "×") return calcAppend(k);
                              if (k === "+" || k === "-") return calcAppend(k);
                              return calcAppend(k);
                            },
                            style: { padding: "10px 0", borderRadius: 12, fontWeight: 900 }
                          },
                          k
                        )
                      ),
                      e(
                        "button",
                        {
                          key: "(",
                          type: "button",
                          className: "category-btn",
                          onClick: () => calcAppend("("),
                          style: { padding: "10px 0", borderRadius: 12, fontWeight: 900 }
                        },
                        "("
                      ),
                      e(
                        "button",
                        {
                          key: ")",
                          type: "button",
                          className: "category-btn",
                          onClick: () => calcAppend(")"),
                          style: { padding: "10px 0", borderRadius: 12, fontWeight: 900 }
                        },
                        ")"
                      ),
                      e(
                        "button",
                        {
                          key: "bs",
                          type: "button",
                          className: "category-btn pin-backspace",
                          onClick: calcExprBackspace,
                          style: { padding: "10px 0", borderRadius: 12, fontWeight: 900 }
                        },
                        "⌫"
                      ),
                      e(
                        "button",
                        {
                          key: "clrall",
                          type: "button",
                          className: "btn-danger",
                          onClick: calcClearAll,
                          style: { padding: "10px 0", borderRadius: 12, fontWeight: 900 }
                        },
                        lang === "ar" ? "مسح" : "Vider"
                      )
                    )
                  ),
                  e(
                    "div",
                    { style: { minWidth: 0 } },
                    e(
                      "div",
                      { style: { fontSize: 12, fontWeight: 900, marginBottom: 6 } },
                      lang === "ar" ? "الدفع" : "Paiement"
                    ),
                    e(
                      "div",
                      { style: { display: "grid", gap: 8 } },
                      e(
                        "div",
                        {
                          style: {
                            display: "grid",
                            gridTemplateColumns: "repeat(2, minmax(0, 1fr))",
                            gap: 8,
                            marginBottom: 2
                          }
                        },
                        CALC_BILLS.map((b) =>
                          e(
                            "button",
                            {
                              key: "bill_" + String(b.amount),
                              type: "button",
                              className: "category-btn",
                              onClick: () => calcAddCashAmount(b.amount),
                              style: {
                                position: "relative",
                                padding: 0,
                                overflow: "hidden",
                                borderRadius: 14,
                                height: 64,
                                border: "1px solid rgba(148,163,184,0.55)",
                                background: "#fff"
                              }
                            },
                            e("img", {
                              src: b.src,
                              alt: String(b.amount) + " DHS",
                              style: {
                                width: "100%",
                                height: "100%",
                                objectFit: "cover",
                                display: "block"
                              }
                            }),
                            e(
                              "div",
                              {
                                style: {
                                  position: "absolute",
                                  right: 8,
                                  bottom: 8,
                                  padding: "4px 8px",
                                  borderRadius: 999,
                                  fontSize: 12,
                                  fontWeight: 900,
                                  background: "rgba(15,23,42,0.72)",
                                  color: "#fff"
                                }
                              },
                              `+${b.amount}`
                            )
                          )
                        )
                      ),
                      e(
                        "div",
                        { style: { display: "grid", gap: 6 } },
                        e(
                          "div",
                          { style: { fontSize: 12, fontWeight: 800 } },
                          lang === "ar" ? "النقد المدفوع" : "Cash payé"
                        ),
                        e("input", {
                          value: calcCashPaid,
                          readOnly: true,
                          onClick: () => setCalcNumTarget("cash"),
                          onFocus: () => setCalcNumTarget("cash"),
                          onChange: (ev) => setCalcCashPaid(normalizeMoneyText(ev.target.value)),
                          inputMode: "none",
                          placeholder: "0.00",
                          style: {
                            width: "100%",
                            boxSizing: "border-box",
                            padding: 10,
                            fontSize: 18,
                            textAlign: "right",
                            borderRadius: 12,
                            border:
                              calcNumTarget === "cash"
                                ? "2px solid rgba(249,115,22,0.75)"
                                : "1px solid rgba(148,163,184,0.55)"
                          }
                        })
                      ),
                      e(
                        "div",
                        { style: { display: "flex", gap: 8, alignItems: "center" } },
                        e("input", {
                          value: calcManualAmount,
                          readOnly: true,
                          onClick: () => setCalcNumTarget("manual"),
                          onFocus: () => setCalcNumTarget("manual"),
                          onChange: (ev) => setCalcManualAmount(normalizeMoneyText(ev.target.value)),
                          inputMode: "none",
                          placeholder: lang === "ar" ? "إضافة مبلغ" : "Ajouter montant",
                          style: {
                            flex: 1,
                            boxSizing: "border-box",
                            padding: 10,
                            fontSize: 14,
                            borderRadius: 12,
                            border:
                              calcNumTarget === "manual"
                                ? "2px solid rgba(249,115,22,0.75)"
                                : "1px solid rgba(148,163,184,0.55)"
                          }
                        }),
                        e(
                          "button",
                          {
                            className: "category-btn",
                            type: "button",
                            disabled: parseCash(calcManualAmount) == null,
                            onClick: calcAddManual
                          },
                          lang === "ar" ? "إضافة" : "Ajouter"
                        )
                      ),
                      e(
                        "div",
                        {
                          style: {
                            display: "grid",
                            gridTemplateColumns: "repeat(3, minmax(0, 1fr))",
                            gap: 8
                          }
                        },
                        ["1", "2", "3", "4", "5", "6", "7", "8", "9"].map((d) =>
                          e(
                            "button",
                            {
                              key: "m" + d,
                              type: "button",
                              className: "category-btn",
                              onClick: () => calcNumDigit(d),
                              style: { padding: "10px 0", borderRadius: 12, fontWeight: 900 }
                            },
                            d
                          )
                        ),
                        e(
                          "button",
                          {
                            key: "mdot",
                            type: "button",
                            className: "category-btn",
                            onClick: calcNumDot,
                            style: { padding: "10px 0", borderRadius: 12, fontWeight: 900 }
                          },
                          "."
                        ),
                        e(
                          "button",
                          {
                            key: "m0",
                            type: "button",
                            className: "category-btn",
                            onClick: () => calcNumDigit("0"),
                            style: { padding: "10px 0", borderRadius: 12, fontWeight: 900 }
                          },
                          "0"
                        ),
                        e(
                          "button",
                          {
                            key: "mbs",
                            type: "button",
                            className: "category-btn pin-backspace",
                            onClick: calcNumBackspace,
                            style: { padding: "10px 0", borderRadius: 12, fontWeight: 900 }
                          },
                          "⌫"
                        ),
                        e(
                          "button",
                          {
                            key: "mclr",
                            type: "button",
                            className: "btn-warning",
                            onClick: calcNumClear,
                            style: { padding: "10px 0", borderRadius: 12, fontWeight: 900, gridColumn: "1 / -1" }
                          },
                          calcNumTarget === "manual"
                            ? (lang === "ar" ? "مسح المبلغ اليدوي" : "Vider (manuel)")
                            : (lang === "ar" ? "مسح النقد" : "Vider (cash)")
                        )
                      ),
                      e(
                        "div",
                        {
                          style: {
                            borderRadius: 14,
                            border: "1px dashed rgba(148,163,184,0.65)",
                            background: "rgba(248,250,252,0.8)",
                            padding: 10
                          },
                          onDragOver: canDragOrders
                            ? (ev) => {
                                try {
                                  ev.preventDefault();
                                } catch (e) {}
                              }
                            : undefined,
                          onDrop: canDragOrders ? calcHandleDrop : undefined
                        },
                        e(
                          "div",
                          { style: { fontSize: 12, fontWeight: 900, marginBottom: 8 } },
                          lang === "ar" ? "الطلبات المختارة" : "Commandes sélectionnées"
                        ),
                        canDragOrders
                          ? e(
                              "div",
                              { style: { fontSize: 11, color: "#6b7280", marginBottom: 8 } },
                              lang === "ar"
                                ? "اسحب الطلبات هنا (سطح مكتب)."
                                : "Glissez les commandes ici (desktop)."
                            )
                          : null,
                        (calcItems || []).length
                          ? e(
                              "div",
                              { style: { display: "grid", gap: 8 } },
                              (calcItems || []).map((it) =>
                                e(
                                  "div",
                                  {
                                    key: it.id,
                                    style: {
                                      display: "flex",
                                      justifyContent: "space-between",
                                      alignItems: "center",
                                      gap: 10,
                                      padding: "8px 10px",
                                      borderRadius: 12,
                                      border: "1px solid rgba(148,163,184,0.35)",
                                      background: "rgba(255,255,255,0.75)"
                                    }
                                  },
                                  e(
                                    "div",
                                    { style: { fontSize: 12, fontWeight: 800 } },
                                    String(it.label || "")
                                  ),
                                  e(
                                    "div",
                                    { style: { display: "flex", gap: 8, alignItems: "center" } },
                                    e(
                                      "div",
                                      { style: { fontSize: 12, fontWeight: 900, whiteSpace: "nowrap" } },
                                      `${Number(it.amount || 0).toFixed(2)} DHS`
                                    ),
                                    e(
                                      "button",
                                      {
                                        className: "category-btn",
                                        type: "button",
                                        onClick: () => calcRemoveItem(it.id)
                                      },
                                      "✕"
                                    )
                                  )
                                )
                              )
                            )
                          : e(
                              "div",
                              { style: { fontSize: 12, color: "#6b7280" } },
                              lang === "ar" ? "لا توجد عناصر." : "Aucun élément."
                            ),
                        e(
                          "div",
                          {
                            style: {
                              marginTop: 10,
                              paddingTop: 10,
                              borderTop: "1px solid rgba(148,163,184,0.35)",
                              display: "grid",
                              gap: 6
                            }
                          },
                          e(
                            "div",
                            { style: { display: "flex", justifyContent: "space-between" } },
                            e(
                              "div",
                              { style: { fontSize: 12, fontWeight: 900 } },
                              lang === "ar" ? "المجموع" : "Total à payer"
                            ),
                            e(
                              "div",
                              { style: { fontSize: 12, fontWeight: 900 } },
                              `${Number(calcTotalToPay || 0).toFixed(2)} DHS`
                            )
                          ),
                          e(
                            "div",
                            { style: { display: "flex", justifyContent: "space-between" } },
                            e(
                              "div",
                              { style: { fontSize: 12, fontWeight: 900 } },
                              lang === "ar" ? "الباقي" : "Monnaie à rendre"
                            ),
                            e(
                              "div",
                              {
                                style: {
                                  fontSize: 12,
                                  fontWeight: 900,
                                  color: calcChangeDue < 0 ? "#b91c1c" : "#065f46"
                                }
                              },
                              `${Number(calcChangeDue || 0).toFixed(2)} DHS`
                            )
                          )
                        )
                      )
                    )
                  )
                )
              )
            ),
          purchaseOpen &&
            e(
              "div",
              {
                style: {
                  position: "fixed",
                  inset: 0,
                  background: "rgba(15,23,42,0.55)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  padding: 16,
                  zIndex: 58
                }
              },
              e(
                "section",
                { className: "panel", style: { maxWidth: 760, width: "100%" } },
                e(
                  "div",
                  {
                    style: {
                      display: "flex",
                      justifyContent: "space-between",
                      alignItems: "center",
                      gap: 10
                    }
                  },
                  e(
                    "h3",
                    { style: { marginTop: 0, marginBottom: 0 } },
                    (t && t.purchaseTitle) || (lang === "ar" ? "مشتريات (المخزون)" : "Achats (stock)")
                  ),
                  e(
                    "button",
                    {
                      className: "category-btn",
                      type: "button",
                      onClick: () => setPurchaseOpen(false)
                    },
                    (t && t.closeBtn) || "Fermer"
                  )
                ),
                e(
                  "div",
                  { style: { marginTop: 12 } },
                  e(WaiterPurchasesHub, {
                    inventory,
                    t,
                    lang,
                    activeShift,
                    activeWorker,
                    adminUser,
                    shifts,
                    onPurchase: handleInventoryPurchase,
                    onPurchaseInvoice: handleInventoryPurchaseInvoice,
                    stockCountRequests,
                    onSubmitStockCountRequest: handleSubmitStockCountRequest,
                    canPurchase:
                      !!activeShift &&
                      (!!(adminUser && (adminUser.role === "admin" || adminUser.role === "manager")) ||
                        !!activeWorker)
                  })
                )
              )
            ),
          view === "pos" &&
            cupLoansOpen &&
            e(
              "div",
              {
                style: {
                  position: "fixed",
                  inset: 0,
                  background: "rgba(15,23,42,0.55)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  padding: 16,
                  zIndex: 58
                }
              },
              e(
                "section",
                { className: "panel", style: { maxWidth: 720, width: "100%" } },
                e(
                  "div",
                  { style: { display: "flex", justifyContent: "space-between", alignItems: "center", gap: 10 } },
                  e(
                    "h3",
                    { style: { marginTop: 0, marginBottom: 0 } },
                    (t && t.cupLoansTitle) || "Verres à récupérer"
                  ),
                  e(
                    "button",
                    { className: "category-btn", type: "button", onClick: handleCloseCupLoans },
                    (t && t.closeBtn) || "Fermer"
                  )
                ),
                ((cupLoans || []).filter((l) => l && l.kind === "glass" && l.status !== "returned").length === 0)
                  ? e(
                      "div",
                      { style: { marginTop: 10, fontSize: 12, color: "#6b7280" } },
                      (t && t.cupLoansEmpty) || "Aucun verre à récupérer."
                    )
                  : e(
                      "div",
                      { style: { marginTop: 12, display: "grid", gap: 10 } },
                      (cupLoans || [])
                        .filter((l) => l && l.kind === "glass" && l.status !== "returned")
                        .slice()
                        .sort((a, b) => String(b.createdAt || "").localeCompare(String(a.createdAt || "")))
                        .map((l) => {
                          const qty = Number(l.qty || 0) || 0;
                          const size = l.size === "large" ? "large" : "small";
                          const refundable = !!l.depositPaid;

                          let createdLabel = "";
                          try {
                            if (l.createdAt) {
                              const dt = new Date(l.createdAt);
                              createdLabel = dt.toLocaleString(lang === "ar" ? "ar-MA" : "fr-FR", {
                                year: "2-digit",
                                month: "2-digit",
                                day: "2-digit",
                                hour: "2-digit",
                                minute: "2-digit"
                              });
                            }
                          } catch (e) {}

                          return e(
                            "div",
                            {
                              key: l.id,
                              style: {
                                borderRadius: 14,
                                border: "1px solid rgba(148,163,184,0.55)",
                                background: "rgba(255,255,255,0.92)",
                                padding: 10,
                                display: "grid",
                                gap: 8
                              }
                            },
                            e(
                              "div",
                              { style: { display: "flex", justifyContent: "space-between", gap: 10, alignItems: "baseline" } },
                              e(
                                "div",
                                { style: { fontWeight: 900, fontSize: 13 } },
                                String(l.customerName || "") +
                                  (qty
                                    ? " · " +
                                      qty +
                                      "× " +
                                      (size === "large"
                                        ? lang === "ar"
                                          ? "كبير"
                                          : "Grand"
                                        : lang === "ar"
                                        ? "صغير"
                                        : "Petit")
                                    : "")
                              ),
                              e(
                                "div",
                                { style: { fontSize: 12, color: "#374151", whiteSpace: "nowrap" } },
                                createdLabel
                              )
                            ),
                            e(
                              "div",
                              { style: { display: "flex", justifyContent: "space-between", gap: 10, alignItems: "center" } },
                              e(
                                "div",
                                { style: { fontSize: 12, color: "#6b7280" } },
                                ((t && t.cupLoansRefundableYes && t.cupLoansRefundableNo)
                                  ? refundable
                                    ? t.cupLoansRefundableYes
                                    : t.cupLoansRefundableNo
                                  : refundable
                                  ? "Remboursable"
                                  : "Non remboursable") +
                                  (refundable && l.depositAmount != null
                                    ? " · " + Number(l.depositAmount || 0).toFixed(2) + " DHS"
                                    : "")
                              ),
                              e(
                                "div",
                                { style: { display: "flex", gap: 8, alignItems: "center" } },
                                e(
                                  "button",
                                  {
                                    className: "category-btn",
                                    type: "button",
                                    onClick: () => handleMarkCupLoanReturned(l.id, false)
                                  },
                                  (t && t.cupLoansMarkReturned) || "Marquer retourné"
                                ),
                                refundable &&
                                  e(
                                    "button",
                                    {
                                      className: "btn-warning",
                                      type: "button",
                                      onClick: () => handleMarkCupLoanReturned(l.id, true)
                                    },
                                    (t && t.cupLoansReturnAndRefund) || "Retour + remboursement"
                                  )
                              )
                            )
                          );
                        })
                    )
              )
            ),
          handoffOpen &&
            e(
              "div",
              {
                style: {
                  position: "fixed",
                  inset: 0,
                  background: "rgba(15,23,42,0.55)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  padding: 16,
                  zIndex: 59
                }
              },
              e(
                "section",
                { className: "panel", style: { maxWidth: 520, width: "100%" } },
                e(
                  "div",
                  { style: { display: "flex", justifyContent: "space-between", alignItems: "center", gap: 10 } },
                  e(
                    "h3",
                    { style: { marginTop: 0, marginBottom: 0 } },
                    lang === "ar" ? "تسليم النادل" : "Passation"
                  ),
                  e(
                    "button",
                    { className: "category-btn", type: "button", onClick: closeHandoffPrompt },
                    (t && t.closeBtn) || "Fermer"
                  )
                ),
                e(
                  "p",
                  { style: { fontSize: 13, marginTop: 10 } },
                  lang === "ar"
                    ? "اختر النادل القادم. سيظهر المبلغ الذي يجب تسليمه. بعد التسليم، النادل القادم يضغط (استئناف) ويدخل PIN لتأكيد الاستلام."
                    : "Choisissez le serveur entrant. Le montant à donner sera affiché. Après remise, le serveur entrant clique (Reprendre) et saisit son PIN pour confirmer la réception."
                ),
                e(
                  "form",
                  { onSubmit: confirmHandoff, style: { display: "grid", gap: 10, marginTop: 10 } },
                  e(
                    "select",
                    {
                      value: handoffToWorkerId,
                      onChange: (ev) => setHandoffToWorkerId(ev.target.value),
                      style: { padding: 10, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                    },
                    e("option", { value: "" }, lang === "ar" ? "اختر الموظف" : "Choisir l'employé"),
                    (users || [])
                      .filter(
                        (u) =>
                          u &&
                          u.role === "worker" &&
                          u.posAccess !== false &&
                          activeWorker &&
                          u.id !== activeWorker.id
                      )
                      .map((u) => e("option", { key: u.id, value: u.id }, String(u.name || u.id)))
                  ),
                  e(
                    "div",
                    { style: { display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 } },
                    e("input", {
                      type: "password",
                      value: handoffFromPin,
                      onChange: (ev) => setHandoffFromPin(normalizePinValue(ev.target.value)),
                      placeholder: lang === "ar" ? "PIN الموظف الحالي" : "PIN sortant",
                      style: { padding: 10, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                    }),
                    e("input", {
                      value: handoffFromAmount,
                      onChange: (ev) => setHandoffFromAmount(ev.target.value),
                      inputMode: "decimal",
                      placeholder: lang === "ar" ? "المبلغ الذي يجب تسليمه" : "Montant à donner",
                      style: { padding: 10, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)" }
                    })
                  ),
                  handoffError &&
                    e(
                      "div",
                      { style: { fontSize: 12, color: "#b91c1c" } },
                      handoffError
                    ),
                  e(
                    "div",
                    { style: { display: "flex", gap: 8, justifyContent: "flex-end" } },
                    e(
                      "button",
                      { className: "category-btn", type: "button", onClick: closeHandoffPrompt },
                      (t && t.cancelBtn) || (lang === "ar" ? "إلغاء" : "Annuler")
                    ),
                    e(
                      "button",
                      {
                        className: "btn-primary",
                        type: "submit",
                        disabled: !(handoffToWorkerId && normalizePinValue(handoffFromPin).length === 4)
                      },
                      lang === "ar" ? "بدء التسليم" : "Démarrer"
                    )
                  )
                )
              )
            ),
          closeShiftGateOpen &&
            e(
              "div",
              {
                style: {
                  position: "fixed",
                  inset: 0,
                  background: "rgba(15,23,42,0.55)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  padding: 16,
                  zIndex: 55
                }
              },
              e(
                "section",
                { className: "panel", style: { maxWidth: 720, width: "100%" } },
                e(
                  "h3",
                  { style: { marginTop: 0 } },
                  (t && t.shiftCloseBlockedTitle) || "Shift: commandes non payées"
                ),
                e(
                  "p",
                  { style: { fontSize: 13, marginTop: 6 } },
                  (t && t.shiftCloseBlockedSubtitle) ||
                    "Vous devez déclarer chaque commande comme payée ou dette (avec nom du client) avant de fermer le shift."
                ),
                blockingCloseOrders && blockingCloseOrders.length
                  ? e(
                      "div",
                      { style: { marginTop: 12, display: "grid", gap: 10 } },
                      blockingCloseOrders.map((o) =>
                        e(
                          "div",
                          {
                            key: o.id,
                            style: {
                              borderRadius: 14,
                              border: "1px solid rgba(148,163,184,0.55)",
                              background: "rgba(255,255,255,0.92)",
                              padding: 12
                            }
                          },
                          e(
                            "div",
                            {
                              style: {
                                display: "flex",
                                justifyContent: "space-between",
                                alignItems: "baseline",
                                gap: 10
                              }
                            },
                            e(
                              "div",
                              { style: { fontWeight: 800, fontSize: 13 } },
                              (() => {
                                const code = String(o.ticketCode || ("#" + displayOrderNumber(o.id)));
                                const nm = String(o.orderName || "").trim();
                                const namePart = nm && nm !== code ? nm + " · " : "";
                                return (t.orderLabel || "Commande") + " " + namePart + code;
                              })()
                            ),
                            e(
                              "div",
                              { style: { fontSize: 12, color: "#374151" } },
                              formatTime(o.createdAt)
                            )
                          ),
                          e(
                            "div",
                            { style: { marginTop: 8, display: "flex", justifyContent: "space-between", gap: 10 } },
                            e(
                              "div",
                              { style: { fontWeight: 900 } },
                              `${(o.totals && o.totals.total ? o.totals.total : 0).toFixed(2)} DHS`
                            ),
                            e(
                              "button",
                              {
                                className: "category-btn",
                                disabled: !!(exitingOrderIds && exitingOrderIds[o.id]),
                                onClick: () => handleMarkOrderPaidAnimated(o.id)
                              },
                              t.markPaid || "Déclarer payé"
                            )
                          ),
                          e(
                            "div",
                            { style: { marginTop: 10, display: "grid", gap: 6 } },
                            e(
                              "div",
                              { style: { fontSize: 12, fontWeight: 700 } },
                              (t && t.debtCustomerNameLabel) || "Nom du client"
                            ),
                            e("input", {
                              value: (closeShiftDebtNames && closeShiftDebtNames[o.id]) || "",
                              onChange: (ev) =>
                                setCloseShiftDebtNames((p) => ({
                                  ...(p || {}),
                                  [o.id]: ev.target.value
                                })),
                              inputMode: "text",
                              autoComplete: "name",
                              enterKeyHint: "done",
                              autoCapitalize: "words",
                              placeholder:
                                (t && t.debtCustomerNamePlaceholder) || "Nom du client",
                              style: { width: "100%", padding: 10, fontSize: 14 }
                            }),
                            e(
                              "button",
                              {
                                className: "btn-primary",
                                type: "button",
                                disabled: !String((closeShiftDebtNames && closeShiftDebtNames[o.id]) || "").trim(),
                                onClick: () => handleDeclareOrderDebt(o.id)
                              },
                              (t && t.declareDebtBtn) || "Déclarer dette"
                            )
                          )
                        )
                      )
                    )
                  : e(
                      "div",
                      { style: { marginTop: 12, fontSize: 12, color: "#64748b" } },
                      (t && t.noOrdersInProgress) || "Aucune commande en attente."
                    ),
                e(
                  "div",
                  { style: { display: "flex", gap: 8, justifyContent: "flex-end", marginTop: 14 } },
                  e(
                    "button",
                    {
                      className: "category-btn",
                      type: "button",
                      onClick: () => setCloseShiftGateOpen(false)
                    },
                    (t && t.cancelBtn) || "Annuler"
                  ),
                  e(
                    "button",
                    {
                      className: "btn-primary",
                      type: "button",
                      disabled: !!(blockingCloseOrders && blockingCloseOrders.length),
                      onClick: forceCloseWaiterShift
                    },
                    (t && t.closeShiftNowBtn) || "Fermer le shift"
                  )
                )
              )
            ),
          closeShiftFloatOpen &&
            e(
              "div",
              {
                style: {
                  position: "fixed",
                  inset: 0,
                  background: "rgba(15,23,42,0.55)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  padding: 16,
                  zIndex: 56
                }
              },
              e(
                "section",
                { className: "panel", style: { maxWidth: 420, width: "100%" } },
                e(
                  "h3",
                  { style: { marginTop: 0 } },
                  (t && t.closeShiftFloatTitle) || "Fonds pour le prochain shift"
                ),
                e(
                  "p",
                  { style: { fontSize: 13, marginTop: 6 } },
                  (t && t.closeShiftFloatSubtitle) ||
                    "Saisissez le fonds (cash) que vous laissez pour le prochain serveur."
                ),
                closeShiftReport &&
                  e(
                    "div",
                    {
                      style: {
                        marginTop: 10,
                        padding: 10,
                        borderRadius: 12,
                        background: "rgba(255,255,255,0.85)",
                        border: "1px solid rgba(148,163,184,0.55)",
                        display: "grid",
                        gap: 8
                      }
                    },
                    e(
                      "div",
                      { style: { fontSize: 12, fontWeight: 900, color: "#334155" } },
                      lang === "ar" ? "تقرير النوبة" : "Rapport du shift"
                    ),
                    e(
                      "div",
                      { style: { fontSize: 12, color: "#475569", display: "grid", gap: 4 } },
                      e(
                        "div",
                        null,
                        (lang === "ar" ? "الطلبات" : "Commandes") +
                          ": " +
                          String(closeShiftReport.orderCount || 0)
                      ),
                      e(
                        "div",
                        null,
                        (lang === "ar" ? "المبيعات (مدفوع)" : "Ventes (payé)") +
                          ": " +
                          `${Number(closeShiftReport.paidRevenue || 0).toFixed(2)} DHS` +
                          " (" +
                          String(closeShiftReport.paidCount || 0) +
                          ")"
                      ),
                      e(
                        "div",
                        null,
                        (lang === "ar" ? "ديون (طلبات)" : "Dettes (commandes)") +
                          ": " +
                          `${Number(closeShiftReport.debtTotal || 0).toFixed(2)} DHS` +
                          " (" +
                          String(closeShiftReport.debtCount || 0) +
                          ")"
                      ),
                      e(
                        "div",
                        null,
                        (lang === "ar" ? "المشتريات" : "Achats") +
                          ": " +
                          `${Number(closeShiftReport.purchasesTotal || 0).toFixed(2)} DHS`
                      ),
                      e(
                        "div",
                        null,
                        (lang === "ar" ? "ديون مُنشأة" : "Dettes créées") +
                          ": " +
                          `${Number(closeShiftReport.debtsCreatedTotal || 0).toFixed(2)} DHS` +
                          " (" +
                          String(closeShiftReport.debtsCreatedCount || 0) +
                          ")"
                      ),
                      e(
                        "div",
                        null,
                        (lang === "ar" ? "ديون مُحصّلة" : "Dettes recouvrées") +
                          ": " +
                          `${Number(closeShiftReport.debtsPaidTotal || 0).toFixed(2)} DHS` +
                          " (" +
                          String(closeShiftReport.debtsPaidCount || 0) +
                          ")"
                      )
                    )
                  ),
                e(
                  "form",
                  {
                    onSubmit: confirmCloseShiftWithFloat,
                    style: { display: "grid", gap: 10, marginTop: 10 }
                  },
                  e("input", {
                    value: closeShiftFloatValue,
                    onChange: (ev) => setCloseShiftFloatValue(ev.target.value),
                    inputMode: "decimal",
                    placeholder: "0.00",
                    style: { padding: 10, fontSize: 18, textAlign: "center" }
                  }),
                  closeShiftFloatError &&
                    e(
                      "div",
                      { style: { fontSize: 12, color: "#b91c1c" } },
                      closeShiftFloatError
                    ),
                  e(
                    "div",
                    { style: { display: "flex", gap: 8, justifyContent: "flex-end" } },
                    e(
                      "button",
                      {
                        className: "category-btn",
                        type: "button",
                        onClick: () => {
                          setCloseShiftFloatOpen(false);
                          setCloseShiftTargetId(null);
                          setCloseShiftActorOverride(null);
                          setCloseShiftReport(null);
                        }
                      },
                      (t && t.cancelBtn) || "Annuler"
                    ),
                    e(
                      "button",
                      { className: "btn-primary", type: "submit" },
                      (t && t.closeShiftNowBtn) || "Fermer le shift"
                    )
                  )
                )
              )
            ),
          floatConfirmOpen &&
            e(
              "div",
              {
                style: {
                  position: "fixed",
                  inset: 0,
                  background: "rgba(15,23,42,0.55)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  padding: 16,
                  zIndex: 56
                }
              },
              e(
                "section",
                { className: "panel", style: { maxWidth: 480, width: "100%" } },
                e(
                  "h3",
                  { style: { marginTop: 0 } },
                  (t && t.confirmOpeningFloatTitle) || "Confirmer le fonds de départ"
                ),
                e(
                  "p",
                  { style: { fontSize: 13, marginTop: 6 } },
                  (t && t.confirmOpeningFloatSubtitle) ||
                    "Le serveur précédent a déclaré le fonds ci-dessous. Confirmez le montant avant d'ouvrir votre shift."
                ),
                floatConfirmExpected != null &&
                  e(
                    "div",
                    { style: { fontSize: 12, fontWeight: 800, marginTop: 10 } },
                    ((t && t.previousShiftFloatLabel) || "Fonds déclaré") +
                      ": " +
                      Number(floatConfirmExpected || 0).toFixed(2) +
                      " DHS"
                  ),
                e(
                  "form",
                  {
                    onSubmit: confirmFloatAndOpenShift,
                    style: { display: "grid", gap: 10, marginTop: 10 }
                  },
                  e("input", {
                    value: floatConfirmValue,
                    onChange: (ev) => setFloatConfirmValue(ev.target.value),
                    inputMode: "decimal",
                    placeholder: "0.00",
                    style: { padding: 10, fontSize: 18, textAlign: "center" }
                  }),
                  floatConfirmError &&
                    e(
                      "div",
                      { style: { fontSize: 12, color: "#b91c1c" } },
                      floatConfirmError
                    ),
                  e(
                    "div",
                    { style: { display: "flex", gap: 8, justifyContent: "flex-end" } },
                    e(
                      "button",
                      {
                        className: "category-btn",
                        type: "button",
                        onClick: () => {
                          setFloatConfirmOpen(false);
                          setPendingShiftOpen(null);
                        }
                      },
                      (t && t.cancelBtn) || "Annuler"
                    ),
                    e(
                      "button",
                      { className: "btn-primary", type: "submit" },
                      (t && t.openShiftBtn) || "Ouvrir"
                    )
                  )
                )
              )
            ),
          view === "pos" &&
            !activeShift &&
            e(
              "main",
              { className: "pos-main" },
              e(
                "aside",
                { className: "pos-sidebar" },
                e(
                  "div",
                  { className: "pos-sidebar-brand" },
                  e("img", {
                    src: "./cafe-halab-logo.png",
                    alt: t.appTitle,
                    className: "brand-logo",
                    style: { width: 46, height: 46 }
                  }),
                  e(
                    "div",
                    null,
                    e("div", { className: "pos-sidebar-title" }, "Café Halab POS"),
                    e("div", { className: "pos-sidebar-sub" }, t.posSlogan || "")
                  )
                )
              ),
              e(
                "section",
                {
                  className: "panel",
                  style: { maxWidth: 420, textAlign: "center", gridColumn: "2 / -1" }
                },
                e(
                  "h2",
                  { style: { marginTop: 0, marginBottom: 12 } },
                  t.shiftOpenTitle || "Open Shift"
                ),
                e(
                  "p",
                  { style: { fontSize: 13, marginBottom: 16 } },
                  t.shiftOpenSubtitle ||
                    "Enter waiter PIN to start a shift."
                ),
                e(
                  "form",
                  {
                    onSubmit: handleOpenWaiterShift,
                    style: {
                      display: "flex",
                      flexDirection: "column",
                      gap: 10,
                      alignItems: "center"
                    }
                  },
                  e(
                    "select",
                    {
                      value: ((autoShiftContextNow() || {}).period || waiterPeriod),
                      disabled: true,
                      style: {
                        padding: 8,
                        fontSize: 16,
                        width: 160,
                        textAlign: "center"
                      }
                    },
                    e("option", { value: "morning" }, "Matin"),
                    e("option", { value: "afternoon" }, "Après-midi")
                  ),
                  e("input", {
                    type: "password",
                    value: shiftPin,
                    readOnly: true,
                    inputMode: "none",
                    onChange: (ev) => setShiftPin(normalizePinValue(ev.target.value)),
                    placeholder: t.pinLabel || "PIN",
                    style: {
                      padding: 8,
                      fontSize: 16,
                      width: 160,
                      textAlign: "center"
                    }
                  }),
                  renderPinPad(
                    shiftPin,
                    pinShiftDigit,
                    pinShiftBackspace,
                    pinShiftConfirm,
                    t.openShiftBtn || "OPEN SHIFT"
                  ),
                  e(
                    "button",
                    {
                      className: "btn-primary",
                      type: "submit",
                      disabled: normalizePinValue(shiftPin).length !== 4,
                      style: {
                        padding: "12px 24px",
                        fontSize: 18,
                        fontWeight: 600,
                        width: "100%",
                        maxWidth: 260
                      }
                    },
                    t.openShiftBtn || "OPEN SHIFT"
                  ),
                  shiftError &&
                    e(
                      "span",
                      { style: { color: "#b91c1c", fontSize: 11 } },
                      shiftError
                    )
                  ,
                  blockingOpenShift &&
                    e(
                      "div",
                      {
                        style: {
                          marginTop: 10,
                          width: "100%",
                          maxWidth: 360,
                          padding: 10,
                          borderRadius: 12,
                          border: "1px solid rgba(248,113,113,0.45)",
                          background: "rgba(254,242,242,0.9)",
                          textAlign: "left"
                        }
                      },
                      e(
                        "div",
                        { style: { fontSize: 12, fontWeight: 900, color: "#991b1b" } },
                        lang === "ar"
                          ? "هناك شيفت مفتوح يمنع فتح شيفت جديد"
                          : "Un shift est ouvert et bloque l'ouverture"
                      ),
                      e(
                        "div",
                        { style: { fontSize: 12, marginTop: 4, color: "#7f1d1d" } },
                        "Shift: ",
                        String(blockingOpenShift.id || "")
                      ),
                      e(
                        "div",
                        { style: { display: "flex", gap: 8, marginTop: 10, justifyContent: "flex-end" } },
                        e(
                          "button",
                          {
                            className: "category-btn",
                            type: "button",
                            disabled: !(
                              pinWorkerCandidate &&
                              canWorkerForceCloseShift(pinWorkerCandidate, blockingOpenShift)
                            ),
                            onClick: () => {
                              if (!pinWorkerCandidate) return;
                              if (!canWorkerForceCloseShift(pinWorkerCandidate, blockingOpenShift)) return;
                              startForceCloseShift(blockingOpenShift.id, pinWorkerCandidate.id);
                            }
                          },
                          lang === "ar" ? "إغلاق (بنفس الـ PIN)" : "Fermer (PIN serveur)"
                        ),
                        adminUser &&
                          adminUser.role === "admin" &&
                          e(
                            "button",
                            {
                              className: "btn-primary",
                              type: "button",
                              onClick: () => startForceCloseShift(blockingOpenShift.id, adminUser.id)
                            },
                            lang === "ar" ? "إغلاق (مشرف)" : "Fermer (admin)"
                          )
                      )
                    )
                ),
                adminUser &&
                  adminUser.role === "admin" &&
                  e(
                    "div",
                    {
                      style: {
                        marginTop: 14,
                        borderTop: "1px solid rgba(148,163,184,0.35)",
                        paddingTop: 12,
                        textAlign: "left"
                      }
                    },
                    e(
                      "div",
                      { style: { fontSize: 12, fontWeight: 900, marginBottom: 8 } },
                      lang === "ar" ? "فتح/إغلاق (اختبار)" : "Override admin (test)"
                    ),
                    e(
                      "form",
                      {
                        onSubmit: (ev) => {
                          openAdminShiftOverrideDefaults();
                          adminOpenWaiterShiftOverride(ev);
                        },
                        onClick: openAdminShiftOverrideDefaults,
                        style: { display: "grid", gap: 8 }
                      },
                      e("input", {
                        type: "date",
                        value: adminOpenDate || "",
                        onChange: (ev) => setAdminOpenDate(ev.target.value),
                        style: {
                          padding: 8,
                          borderRadius: 10,
                          border: "1px solid rgba(148,163,184,0.55)"
                        }
                      }),
                      e(
                        "select",
                        {
                          value: adminOpenPeriod || "",
                          onChange: (ev) => setAdminOpenPeriod(ev.target.value),
                          style: {
                            padding: 8,
                            borderRadius: 10,
                            border: "1px solid rgba(148,163,184,0.55)"
                          }
                        },
                        e("option", { value: "" }, lang === "ar" ? "تلقائي" : "Auto"),
                        e("option", { value: "morning" }, lang === "ar" ? "صباح" : "Matin"),
                        e("option", { value: "afternoon" }, lang === "ar" ? "مساء" : "Après-midi")
                      ),
                      e(
                        "select",
                        {
                          value: adminOpenWorkerId || "",
                          onChange: (ev) => setAdminOpenWorkerId(ev.target.value),
                          style: {
                            padding: 8,
                            borderRadius: 10,
                            border: "1px solid rgba(148,163,184,0.55)"
                          }
                        },
                        e("option", { value: "" }, lang === "ar" ? "اختر النادل" : "Choisir le serveur"),
                        (users || [])
                          .filter((u) => u && u.role === "worker" && u.posAccess !== false)
                          .map((u) =>
                            e("option", { key: u.id, value: u.id }, String(u.name || u.id))
                          )
                      ),
                      e("input", {
                        value: adminOpenFloat,
                        onChange: (ev) => setAdminOpenFloat(ev.target.value),
                        inputMode: "decimal",
                        placeholder: lang === "ar" ? "الصندوق" : "Fonds (cash)",
                        style: {
                          padding: 8,
                          borderRadius: 10,
                          border: "1px solid rgba(148,163,184,0.55)"
                        }
                      }),
                      e(
                        "button",
                        { className: "btn-primary", type: "submit" },
                        lang === "ar" ? "فتح (تجاوز)" : "Ouvrir (override)"
                      )
                    )
                  )
              )
            ),
          view === "pos" &&
            activeShift &&
            e(
              "main",
              { className: "pos-main" },
              openCupLoanSummary && openCupLoanSummary.total > 0
                ? e(
                    "button",
                    {
                      type: "button",
                      className: "pos-top-alert",
                      onClick: () => setCupLoansOpen(true)
                    },
                    (t && t.cupLoansBannerPrefix ? t.cupLoansBannerPrefix : "Vous avez") +
                      " " +
                      String(openCupLoanSummary.small || 0) +
                      " " +
                      ((t && t.cupLoansBannerSmall) || "petits verres") +
                      " · " +
                      String(openCupLoanSummary.large || 0) +
                      " " +
                      ((t && t.cupLoansBannerLarge) || "grands verres") +
                      " " +
                      ((t && t.cupLoansBannerSuffix) || "dehors · Cliquez pour détails")
                  )
                : null,
              e(
                "aside",
                { className: "pos-sidebar" },
                e(
                  "div",
                  { className: "pos-sidebar-brand" },
                  e("img", {
                    src: "./cafe-halab-logo.png",
                    alt: t.appTitle,
                    className: "brand-logo",
                    style: { width: 46, height: 46 }
                  }),
                  e(
                    "div",
                    null,
                    e("div", { className: "pos-sidebar-title" }, "Café Halab POS"),
                    e(
                      "div",
                      { className: "pos-sidebar-sub" },
                      t.posSlogan || ""
                    )
                  )
                ),
                e(
                  "div",
                  { className: "pos-sidebar-block" },
                  e(
                    "div",
                    { className: "pos-sidebar-muted" },
                    (t.waiterLabel || "Serveur") +
                      ": " +
                      String((activeWorker && activeWorker.name) || "")
                  ),
                  e(
                    "div",
                    { className: "pos-sidebar-muted" },
                    "Shift: " + String(activeShift.id || "")
                  ),
                  e(
                    "div",
                    { className: "pos-sidebar-muted" },
                    (lang === "ar" ? "الصندوق (بداية)" : "Fond (début)") +
                      ": " +
                      Number((activeShift && activeShift.openingFloatCash) || 0).toFixed(2) +
                      " DHS"
                  )
                ),
                e(
                  "div",
                  { className: "pos-sidebar-actions", style: { marginTop: "auto" } },
                  e(
                    "button",
                    {
                      type: "button",
                      className: "pos-sidebar-pill",
                      onClick: () => setCalcOpen(true)
                    },
                    (lang === "ar" ? "🧮 آلة حاسبة" : "🧮 Calculatrice")
                  ),
                  e(
                    "button",
                    {
                      type: "button",
                      className: "pos-sidebar-pill",
                      onClick: () => setPurchaseOpen(true)
                    },
                    (t && t.purchasesBtn) || (lang === "ar" ? "المشتريات" : "Achats")
                  ),
                  e(
                    "button",
                    {
                      type: "button",
                      className: "pos-sidebar-pill",
                      onClick: handleCloseWaiterShift
                    },
                    t.closeShiftBtn || "Fermer le shift"
                  ),
                  activeShift &&
                    activeWorker &&
                    !shiftPaused &&
                    e(
                      "button",
                      {
                        type: "button",
                        className: "pos-sidebar-pill",
                        onClick: () => openPinPrompt("pause")
                      },
                      t.pauseShiftBtn || "Pause"
                    ),
                  activeShift &&
                    activeWorker &&
                    shiftPaused &&
                    e(
                      "button",
                      {
                        type: "button",
                        className: "pos-sidebar-pill",
                        onClick: () => openPinPrompt("resume")
                      },
                      t.resumeShiftBtn || "Reprendre"
                    ),
                  e(
                    "button",
                    {
                      type: "button",
                      className: "pos-sidebar-pill",
                      onClick: openAdvancePrompt
                    },
                    lang === "ar" ? "سلفة" : "Avance"
                  ),
                  e(
                    "button",
                    {
                      type: "button",
                      className: "pos-sidebar-pill",
                      onClick: openHandoffPrompt
                    },
                    lang === "ar" ? "تسليم" : "Passation"
                  ),
                  adminUser &&
                    adminUser.role === "admin" &&
                    e(
                      "button",
                      {
                        type: "button",
                        className: "pos-sidebar-pill",
                        onClick: adminCloseWaiterShift
                      },
                      lang === "ar" ? "إغلاق (مشرف)" : "Fermer (admin)"
                    )
                )
              ),
              e(
                "section",
                { className: "panel" },
                e(
                  "div",
                  null,
                  !activeCategory &&
                    e(
                      "div",
                      null,
                      e(
                        "div",
                        { className: "pos-category-grid" },
                        categories.map((cat) => {
                          let label = cat;
                          if (cat === "Favorites") label = t.catFavorites;
                          else if (cat === "Breakfast") label = t.catBreakfast;
                          else if (cat === "Hot Drinks") label = t.catHot;
                          else if (cat === "Cold Drinks") label = t.catCold;
                          else if (cat === "Others") label = t.catOthers;
                          const imgSrc =
                            cat === "Breakfast"
                              ? "./Petit Déjeuner.jpg"
                              : cat === "Cold Drinks"
                              ? "./boissons Froides.jpg"
                              : cat === "Others"
                              ? "./autres.jpg"
                              : null;
                          return e(
                            "button",
                            {
                              key: cat,
                              type: "button",
                              className: "pos-category-card",
                              onClick: () =>
                                shiftPaused
                                  ? setStatus({
                                      type: "err",
                                      message:
                                        t.shiftPausedBlocking ||
                                        "Shift en pause."
                                    })
                                  : setActiveCategory(cat)
                            },
                            e(
                              "div",
                              { className: "pos-category-icon" },
                              imgSrc
                                ? e("img", {
                                    src: resolveImageSrc(imgSrc),
                                    alt: label,
                                    style: {
                                      width: "100%",
                                      height: "100%",
                                      borderRadius: 18,
                                      objectFit: "cover",
                                      display: "block"
                                    }
                                  })
                                : cat === "Favorites"
                                ? e(
                                    "svg",
                                    {
                                      width: 42,
                                      height: 42,
                                      viewBox: "0 0 24 24",
                                      fill: "#f59e0b",
                                      stroke: "#d97706",
                                      strokeWidth: "1.5",
                                      strokeLinecap: "round",
                                      strokeLinejoin: "round"
                                    },
                                    e("path", {
                                      d: "M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"
                                    })
                                  )
                                : e(
                                    "svg",
                                    {
                                      width: 42,
                                      height: 42,
                                      viewBox: "0 0 24 24",
                                      fill: "none",
                                      stroke: "#f97316",
                                      strokeWidth: "2",
                                      strokeLinecap: "round",
                                      strokeLinejoin: "round"
                                    },
                                    e("path", { d: "M17 8h1a4 4 0 1 1 0 8h-1" }),
                                    e("path", {
                                      d: "M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V8z"
                                    }),
                                    e("line", { x1: "6", y1: "1", x2: "6", y2: "4" }),
                                    e("line", { x1: "10", y1: "1", x2: "10", y2: "4" }),
                                    e("line", { x1: "14", y1: "1", x2: "14", y2: "4" })
                                  )
                            ),
                            e("div", { className: "pos-category-label" }, label)
                          );
                            })
                          )
                        ),
                      activeCategory &&
                        e(
                          "div",
                          null,
                          e(
                            "div",
                            {
                              style: {
                                display: "flex",
                                justifyContent: "space-between",
                                alignItems: "center",
                                marginBottom: 10
                              }
                            },
                            e(
                              "button",
                              {
                                className: "category-btn",
                                onClick: () =>
                                  shiftPaused
                                    ? setStatus({
                                        type: "err",
                                        message:
                                          t.shiftPausedBlocking ||
                                          "Shift en pause."
                                      })
                                    : setActiveCategory(null)
                              },
                              t.backToMenus || "Retour menus"
                            ),
                            e(
                              "h3",
                              { style: { margin: 0 } },
                              activeCategory === "Favorites"
                                ? t.catFavorites
                                : activeCategory === "Breakfast"
                                ? t.catBreakfast
                                : activeCategory === "Hot Drinks"
                                ? t.catHot
                                : activeCategory === "Cold Drinks"
                                ? t.catCold
                                : t.catOthers
                            )
                          ),
                          e(
                            "div",
                            { className: "products-grid" },
                            activeCategory === "Favorites"
                              ? favoritesSorted && favoritesSorted.length
                                ? favoritesSorted.map((fav) => {
                                    const modsLabel = lineModifiersLabel({
                                      modifiers: (fav && fav.modifiers) || {},
                                      containerType: fav && fav.containerType,
                                      cupSize: fav && fav.cupSize
                                    });
                                    const base = (menu || []).find((p) => p && p.id === fav.productId) || null;
                                    const baseName = base
                                      ? lang === "ar"
                                        ? base.nameAr || base.name
                                        : base.nameFr || base.name
                                      : String(fav.productId || "");
                                    return e(
                                      "button",
                                      {
                                        key: fav.id,
                                        type: "button",
                                        className: "product-card",
                                        onClick: () => addFavoriteToCart(fav),
                                        style: { width: "100%", textAlign: "left", border: "none", cursor: "pointer" }
                                      },
                                      e(
                                        "div",
                                        { className: "product-name" },
                                        String(fav.name || baseName),
                                        modsLabel || ""
                                      ),
                                      e(
                                        "div",
                                        { className: "product-price" },
                                        `${Number((fav && fav.price) || 0).toFixed(2)} DHS`
                                      ),
                                      e(
                                        "div",
                                        { style: { fontSize: 11, color: "#64748b" } },
                                        baseName
                                      )
                                    );
                                  })
                                : e(
                                    "div",
                                    { className: "pos-cart-empty" },
                                    lang === "ar" ? "لا يوجد مفضلات." : "Aucun favori."
                                  )
                              : filteredProducts.map((product) =>
                                  e(ProductCard, {
                                    key: product.id,
                                    product,
                                    menu,
                                    onAdd: handleAddToCart,
                                    lang,
                                    t
                                  })
                                )
                          )
                        )
                    )
              ),
              e(
                "section",
                { className: "panel pos-cart-panel" },
                e(
                  "div",
                  { style: { display: "flex", justifyContent: "space-between", alignItems: "center", gap: 10 } },
                  e("h3", { style: { margin: 0 } }, t.currentOrder),
                  e(
                    "button",
                    {
                      type: "button",
                      className: "category-btn",
                      onClick: () =>
                        shiftPaused
                          ? setStatus({
                              type: "err",
                              message: t.shiftPausedBlocking || "Shift en pause."
                            })
                          : setCartServiceType((p) => {
                              const next = p === "takeaway" ? "dine_in" : "takeaway";
                              if (next !== "takeaway") setGlassCupCustomerName("");
                              return next;
                            })
                    },
                    cartServiceType === "takeaway"
                      ? lang === "ar"
                        ? "خارجي: نعم"
                        : "À emporter: Oui"
                      : lang === "ar"
                      ? "خارجي: لا"
                      : "À emporter: Non"
                  )
                ),
                e(
                  "div",
                  { style: { marginTop: 8, padding: 10, borderRadius: 14, border: "1px solid rgba(148,163,184,0.55)", background: "rgba(255,255,255,0.9)" } },
                  e(
                    "div",
                    { style: { fontSize: 12, fontWeight: 700, marginBottom: 6 } },
                    lang === "ar" ? "اسم الطلب (اختياري)" : "Nom de commande (optionnel)"
                  ),
                  e("input", {
                    value: orderName,
                    onChange: (ev) => setOrderName(ev.target.value),
                    inputMode: "text",
                    autoComplete: "off",
                    enterKeyHint: "done",
                    autoCapitalize: "words",
                    placeholder: lang === "ar" ? "مثال: طاولة 5 / أحمد" : "Ex: Table 5 / Ahmed",
                    style: { width: "100%", padding: 10, fontSize: 14 }
                  })
                ),
                cartServiceType === "takeaway" && needsGlassCupCustomerName
                  ? e(
                      "div",
                      { style: { marginTop: 8, padding: 10, borderRadius: 14, border: "1px solid rgba(148,163,184,0.55)", background: "rgba(255,255,255,0.9)" } },
                      e(
                        "div",
                        { style: { fontSize: 12, fontWeight: 700, marginBottom: 6 } },
                        (t && t.glassCupCustomerNameLabel) || "Nom du client (verre)"
                      ),
                      e("input", {
                        value: glassCupCustomerName,
                        onChange: (ev) => setGlassCupCustomerName(ev.target.value),
                        inputMode: "text",
                        autoComplete: "name",
                        enterKeyHint: "done",
                        autoCapitalize: "words",
                        placeholder: (t && t.glassCupCustomerNamePlaceholder) || "Nom du client",
                        style: { width: "100%", padding: 10, fontSize: 14 }
                      })
                    )
                  : null,
                cart.length === 0
                  ? e("div", { className: "pos-cart-empty" }, t.cartEmpty)
                  : cart.map((line) => {
                      const p = (menu || []).find((m) => m && m.id === line.id) || null;
                      const favId = favoriteDocIdForLine(line);
                      const isFav = !!(favId && favoritesById && favoritesById[favId]);
                      const isDrink =
                        cartServiceType === "takeaway" &&
                        !!(p && (p.category === "Hot Drinks" || p.category === "Cold Drinks")) ||
                        (cartServiceType === "takeaway" &&
                          (String(line.id || "") === "other_water" ||
                            String(line.id || "").startsWith("soda_") ||
                            String(line.id || "").startsWith("water_") ||
                            String(line.id || "").startsWith("juice_") ||
                            String(line.id || "").startsWith("tea_")));

                      return e(
                        "div",
                        { className: "cart-item" + ((cartEnterKeys && cartEnterKeys[line.key]) ? " cart-item--enter" : ""), key: line.key },
                        e(
                          "div",
                          { className: "cart-item-main" },
                          e(
                            "span",
                            null,
                            line.name,
                            lineModifiersLabel(line)
                          ),
                          e(
                            "span",
                            { className: "cart-item-meta" },
                            `${line.qty} x ${line.price.toFixed(2)} DHS`
                          ),
                          isDrink &&
                            e(
                              "div",
                              { style: { display: "flex", gap: 8, marginTop: 6, flexWrap: "wrap" } },
                              e(
                                "select",
                                {
                                  value: line.containerType === "glass" ? "glass" : "disposable",
                                  onChange: (ev) => {
                                    const v = ev && ev.target ? ev.target.value : "disposable";
                                    setCart((prev) =>
                                      (prev || []).map((l) =>
                                        l && l.key === line.key ? { ...l, containerType: v } : l
                                      )
                                    );
                                  },
                                  style: { padding: 6, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)", fontSize: 12 }
                                },
                                e("option", { value: "disposable" }, lang === "ar" ? "بلاستيك" : "Jetable"),
                                e("option", { value: "glass" }, lang === "ar" ? "زجاج" : "Verre")
                              ),
                              e(
                                "select",
                                {
                                  value: line.cupSize === "large" ? "large" : "small",
                                  onChange: (ev) => {
                                    const v = ev && ev.target ? ev.target.value : "small";
                                    setCart((prev) =>
                                      (prev || []).map((l) =>
                                        l && l.key === line.key ? { ...l, cupSize: v } : l
                                      )
                                    );
                                  },
                                  style: { padding: 6, borderRadius: 10, border: "1px solid rgba(148,163,184,0.55)", fontSize: 12 }
                                },
                                e("option", { value: "small" }, lang === "ar" ? "صغير" : "Petit"),
                                e("option", { value: "large" }, lang === "ar" ? "كبير" : "Grand")
                              )
                            )
                        ),
                        e(
                          "div",
                          { className: "cart-item-controls" },
                          e(
                            "button",
                            {
                              type: "button",
                              className: "qty-btn",
                              onClick: () => toggleFavoriteLine(line),
                              title: isFav
                                ? lang === "ar"
                                  ? "حذف من المفضلة"
                                  : "Retirer des favoris"
                                : lang === "ar"
                                ? "حفظ في المفضلة"
                                : "Ajouter aux favoris",
                              style: {
                                width: 24,
                                height: 24,
                                fontSize: 14,
                                borderRadius: 12,
                                border: "1px solid rgba(148, 163, 184, 0.55)",
                                background: isFav ? "rgba(251,191,36,0.24)" : "#fff",
                                color: isFav ? "#b45309" : "#64748b"
                              }
                            },
                            isFav ? "★" : "☆"
                          ),
                          e(
                            "button",
                            {
                              className: "qty-btn",
                              onClick: () => updateQty(line.key, -1)
                            },
                            "-"
                          ),
                          e("span", null, line.qty),
                          e(
                            "button",
                            {
                              className: "qty-btn",
                              onClick: () => updateQty(line.key, 1)
                            },
                            "+"
                          )
                        )
                      );
                    }),
                cart.length > 0 &&
                  e(
                    "div",
                    { style: { marginTop: 8 } },
                    e(
                      "div",
                      { className: "summary-row" },
                      e("span", null, t.subtotal),
                      e("span", null, `${totals.subtotal.toFixed(2)} DHS`)
                    ),
                    e(
                      "div",
                      { className: "summary-row" },
                      e("span", null, t.tax),
                      e("span", null, `${totals.tax.toFixed(2)} DHS`)
                    ),
                    totals.cupFee > 0 &&
                      e(
                        "div",
                        { className: "summary-row" },
                        e("span", null, (t && t.disposableCupFeeLabel) || (lang === "ar" ? "رسوم كوب" : "Gobelet")),
                        e("span", null, `+${Number(totals.cupFee || 0).toFixed(2)} DHS`)
                      ),
                    e(
                      "div",
                      { className: "summary-row total" },
                      e("span", null, t.total),
                      e("span", null, `${totals.total.toFixed(2)} DHS`)
                    )
                  ),
                cart.length > 0 &&
                  e(
                    "button",
                    {
                      className: "btn-primary",
                      style: { marginTop: 10, width: "100%" },
                      disabled: submitting || (needsGlassCupCustomerName && !String(glassCupCustomerName || "").trim()),
                      onClick: handleSubmitOrder
                    },
                    submitting ? t.placingOrder : "Encaisser"
                  ),
                status &&
                  e(
                    "div",
                    {
                      className:
                        "status " + (status.type === "ok" ? "ok" : "err")
                    },
                    status.message
                  ),
                e(
                  "div",
                  { style: { marginTop: 12 } },
                  e(
                    "h4",
                    { style: { margin: "0 0 8px", fontSize: 13 } },
                    t.ordersInProgress || "Commandes en attente"
                  ),
                  waiterDebtsToCollect && waiterDebtsToCollect.length
                    ? e(
                        "div",
                        {
                          style: {
                            marginBottom: 12,
                            padding: 10,
                            borderRadius: 14,
                            border: "1px solid rgba(251,146,60,0.45)",
                            background: "rgba(255,247,237,0.9)"
                          }
                        },
                        e(
                          "div",
                          { style: { fontSize: 12, fontWeight: 900, marginBottom: 8 } },
                          (t && t.debtsToCollectTitle) || "Dettes à encaisser (shifts précédents)"
                        ),
                        e(
                          "div",
                          { style: { display: "grid", gap: 8 } },
                          waiterDebtsToCollect.slice(0, 6).map((d) =>
                            e(
                              "div",
                              {
                                key: d.id,
                                style: {
                                  display: "flex",
                                  justifyContent: "space-between",
                                  alignItems: "center",
                                  gap: 10,
                                  padding: "8px 10px",
                                  borderRadius: 12,
                                  border: "1px solid rgba(148,163,184,0.35)",
                                  background: "rgba(255,255,255,0.75)"
                                }
                              },
                              e(
                                "div",
                                { style: { fontSize: 12 } },
                                e(
                                  "div",
                                  { style: { fontWeight: 800 } },
                                  String(d.customerName || "")
                                ),
                                e(
                                  "div",
                                  { style: { color: "#6b7280", fontSize: 11 } },
                                  `${(typeof d.amount === "number" ? d.amount : 0).toFixed(2)} DHS` +
                                    (d.chargedAt
                                      ? " · " + ((t && t.clientUnpaidDebtLabel) || "Client unpaid debt")
                                      : "")
                                )
                              ),
                              e(
                                "button",
                                {
                                  className: "category-btn",
                                  type: "button",
                                  onClick: () => handleMarkDebtPaid(d.id)
                                },
                                (t && t.markDebtPaid) || "Déclarer dette payée"
                              )
                            )
                          )
                        )
                      )
                    : null,
                  unpaidOrders.length === 0
                    ? e(
                        "div",
                        { style: { fontSize: 12, color: "#6b7280" } },
                        t.noOrdersInProgress || "Aucune commande en attente."
                      )
                    : unpaidOrders
                        .slice()
                        .reverse()
                        .map((o) =>
                          e(
                            "div",
                            {
                              key: o.id,
                              draggable: canDragOrders,
                              onDragStart: canDragOrders
                                ? (ev) => {
                                    try {
                                      if (ev && ev.dataTransfer) {
                                        ev.dataTransfer.setData("text/plain", String(o.id || ""));
                                        ev.dataTransfer.effectAllowed = "copy";
                                      }
                                    } catch (e) {}
                                  }
                                : undefined,
                              style: {
                                borderRadius: 14,
                                border: "1px solid rgba(148,163,184,0.55)",
                                background:
                                  "linear-gradient(145deg, rgba(255,255,255,0.96), rgba(224,231,255,0.72))",
                                boxShadow: "0 10px 22px rgba(15,23,42,0.10)",
                                padding: 10,
                                marginBottom: 10
                              }
                            },
                            e(
                              "div",
                              {
                                style: {
                                  display: "flex",
                                  justifyContent: "space-between",
                                  alignItems: "baseline",
                                  gap: 10
                                }
                              },
                              e(
                                "div",
                                { style: { fontSize: 12, fontWeight: 700 } },
                                (() => {
                                  const code = String(o.ticketCode || ("#" + displayOrderNumber(o.id)));
                                  const nm = String(o.orderName || "").trim();
                                  const namePart = nm && nm !== code ? nm + " · " : "";
                                  return (t.orderLabel || "Commande") + " " + namePart + code;
                                })() +
                                  (o && o.serviceType === "takeaway"
                                    ? lang === "ar"
                                      ? " · خارجي"
                                      : " · À emporter"
                                    : "")
                              ),
                              e(
                                "div",
                                { style: { fontSize: 12, color: "#374151" } },
                                formatTime(o.createdAt)
                              )
                            ),
                            e(
                              "div",
                              { style: { fontSize: 11, color: "#6b7280", marginTop: 4 } },
                              (t.waiterLabel || "Serveur") +
                                ": " +
                                userNameById(o.cashierId)
                            ),
                            e(
                              "div",
                              { style: { marginTop: 8 } },
                              o.items.map((line) =>
                                e(
                                  "div",
                                  {
                                    key: line.key,
                                    style: {
                                      display: "flex",
                                      justifyContent: "space-between",
                                      gap: 10,
                                      fontSize: 12,
                                      padding: "2px 0"
                                    }
                                  },
                                  e(
                                    "div",
                                    { style: { flex: 1 } },
                                    `${line.qty}× `,
                                    lineLabel(line),
                                    " ",
                                    e(
                                      "span",
                                      { style: { fontSize: 11, color: "#6b7280" } },
                                      lineModifiersLabel(line)
                                    )
                                  ),
                                  e(
                                    "div",
                                    { style: { whiteSpace: "nowrap" } },
                                    `${(line.price * line.qty).toFixed(2)} DHS`
                                  )
                                )
                              )
                            ),
                            e(
                              "div",
                              {
                                style: {
                                  display: "flex",
                                  justifyContent: "space-between",
                                  alignItems: "center",
                                  marginTop: 10
                                }
                              },
                              e(
                                "div",
                                { style: { fontWeight: 700, fontSize: 12 } },
                                `${o.totals.total.toFixed(2)} DHS`
                              ),
                              e(
                                "div",
                                { style: { display: "flex", gap: 8, alignItems: "center" } },
                                e(
                                  "button",
                                  {
                                    className: "category-btn",
                                    type: "button",
                                    onClick: () => {
                                      calcAddOrderById(o.id);
                                      setCalcOpen(true);
                                    }
                                  },
                                  lang === "ar" ? "إضافة للحاسبة" : "Add to calc"
                                ),
                                e(
                                  "button",
                                  {
                                    className: "category-btn",
                                    disabled: !!(exitingOrderIds && exitingOrderIds[o.id]),
                                    onClick: () => handleMarkOrderPaidAnimated(o.id)
                                  },
                                  t.markPaid || "Déclarer payé"
                                )
                              )
                            )
                          )
                        )
                )
              )
            ),
          view === "manager" &&
            e(
              "main",
              null,
              (() => {
                if (!canSeeManager()) {
                  return e(
                    "section",
                    { className: "panel" },
                    e("p", { style: { fontSize: 12 } }, lang === "ar" ? "مدير فقط" : "Manager seulement."),
                    e(
                      "button",
                      { className: "btn-primary", type: "button", onClick: openManagerGate },
                      lang === "ar" ? "تسجيل الدخول" : "Se connecter"
                    )
                  );
                }
                const canPurchase =
                  !!activeShift &&
                  (!!(adminUser && adminUser.role === "admin") ||
                    !!activeWorker);

                const managerUser = (users || []).find((u) => u && u.role === "manager") || null;
                const managerAdminUser = (adminUser && adminUser.role === "admin") ? adminUser : managerUser;

                const lowStock = Object.values(inventory || {})
                  .filter((x) => x)
                  .map((ing) => {
                    const cur = Number(ing.currentQty || 0) || 0;
                    const min = Number(ing.minQty || 0) || 0;
                    const missing = Math.max(0, min - cur);
                    return { ing, cur, min, missing };
                  })
                  .filter((x) => x.missing > 0)
                  .sort((a, b) => b.missing - a.missing);

                function money(v) {
                  return `${Number(v || 0).toFixed(2)} DHS`;
                }

                function shiftDetails(shiftId) {
                  const sid = String(shiftId || "");
                  if (!sid) return null;

                  const shiftItem =
                    (shifts || []).find((s) => s && s.id === sid) ||
                    (activeShift && activeShift.id === sid ? activeShift : null);

                  const relevantOrders = (orders || []).filter(
                    (o) =>
                      o &&
                      o.shiftId === sid &&
                      (o.status === "paid" || o.status === "unpaid" || o.status === "debt")
                  );
                  const paidOrders = relevantOrders.filter((o) => o && o.status === "paid");
                  const unpaidOrders = relevantOrders.filter((o) => o && o.status !== "paid");

                  const paidRevenue = paidOrders.reduce(
                    (sum, o) => sum + (Number((o.totals && o.totals.total) || 0) || 0),
                    0
                  );
                  const unpaidTotal = unpaidOrders.reduce(
                    (sum, o) => sum + (Number((o.totals && o.totals.total) || 0) || 0),
                    0
                  );

                  const purchasesLogs = (inventoryLogs || []).filter(
                    (l) => l && l.shiftId === sid && l.reason === "purchase"
                  );
                  const purchasesTotal = purchasesLogs.reduce(
                    (sum, l) => sum + (Number(l.totalCost || 0) || 0),
                    0
                  );

                  const openingFloatCash =
                    shiftItem && typeof shiftItem.openingFloatCash === "number"
                      ? shiftItem.openingFloatCash
                      : 0;

                  return {
                    shift: shiftItem,
                    openingFloatCash,
                    paidRevenue,
                    paidCount: paidOrders.length,
                    unpaidTotal,
                    unpaidCount: unpaidOrders.length,
                    purchasesTotal
                  };
                }

                const currentShiftId = activeShift ? activeShift.id : "";
                const currentDetails = currentShiftId ? shiftDetails(currentShiftId) : null;
                const previousShifts = (shifts || [])
                  .filter((s) => s && (s.status === "closed" || s.closedAt))
                  .slice()
                  .sort((a, b) => shiftTimeMs(b) - shiftTimeMs(a));
                const selectedShiftId = managerSelectedShiftId || (previousShifts[0] && previousShifts[0].id) || "";
                const selectedDetails = selectedShiftId ? shiftDetails(selectedShiftId) : null;

                return e(
                  React.Fragment,
                  null,
                  e(
                    "section",
                    { className: "panel" },
                    e(
                      "h3",
                      { style: { marginTop: 0 } },
                      lang === "ar" ? "تفاصيل الشيفت الحالي" : "Détails du shift en cours"
                    ),
                    !activeShift || !currentDetails
                      ? e(
                          "div",
                          { style: { fontSize: 12, color: "#64748b" } },
                          lang === "ar" ? "لا يوجد شيفت مفتوح" : "Aucun shift ouvert."
                        )
                      : e(
                          "div",
                          {
                            style: {
                              display: "grid",
                              gridTemplateColumns: "repeat(auto-fit, minmax(220px, 1fr))",
                              gap: 10
                            }
                          },
                          e(
                            "div",
                            {
                              style: {
                                borderRadius: 14,
                                border: "1px solid rgba(148,163,184,0.55)",
                                background: "rgba(255,255,255,0.9)",
                                padding: 12
                              }
                            },
                            e(
                              "div",
                              { style: { fontSize: 12, fontWeight: 900, color: "#334155" } },
                              lang === "ar" ? "الصندوق (بداية)" : "Fond (début)"
                            ),
                            e(
                              "div",
                              { style: { fontSize: 18, fontWeight: 900, marginTop: 4 } },
                              money(currentDetails.openingFloatCash)
                            )
                          ),
                          e(
                            "div",
                            {
                              style: {
                                borderRadius: 14,
                                border: "1px solid rgba(148,163,184,0.55)",
                                background: "rgba(255,255,255,0.9)",
                                padding: 12
                              }
                            },
                            e(
                              "div",
                              { style: { fontSize: 12, fontWeight: 900, color: "#334155" } },
                              lang === "ar" ? "المداخيل (مدفوع)" : "Revenu commandes (payé)"
                            ),
                            e(
                              "div",
                              { style: { fontSize: 18, fontWeight: 900, marginTop: 4 } },
                              money(currentDetails.paidRevenue)
                            ),
                            e(
                              "div",
                              { style: { fontSize: 11, color: "#64748b", marginTop: 2 } },
                              (lang === "ar" ? "عدد" : "Nb") + ": " + String(currentDetails.paidCount)
                            )
                          ),
                          e(
                            "div",
                            {
                              style: {
                                borderRadius: 14,
                                border: "1px solid rgba(148,163,184,0.55)",
                                background: "rgba(255,255,255,0.9)",
                                padding: 12
                              }
                            },
                            e(
                              "div",
                              { style: { fontSize: 12, fontWeight: 900, color: "#334155" } },
                              lang === "ar" ? "غير مدفوع" : "Impayé"
                            ),
                            e(
                              "div",
                              { style: { fontSize: 18, fontWeight: 900, marginTop: 4 } },
                              money(currentDetails.unpaidTotal)
                            ),
                            e(
                              "div",
                              { style: { fontSize: 11, color: "#64748b", marginTop: 2 } },
                              (lang === "ar" ? "عدد" : "Nb") + ": " + String(currentDetails.unpaidCount)
                            )
                          ),
                          e(
                            "div",
                            {
                              style: {
                                borderRadius: 14,
                                border: "1px solid rgba(148,163,184,0.55)",
                                background: "rgba(255,255,255,0.9)",
                                padding: 12
                              }
                            },
                            e(
                              "div",
                              { style: { fontSize: 12, fontWeight: 900, color: "#334155" } },
                              lang === "ar" ? "المشتريات (الشيفت)" : "Achats (shift)"
                            ),
                            e(
                              "div",
                              { style: { fontSize: 18, fontWeight: 900, marginTop: 4 } },
                              money(currentDetails.purchasesTotal)
                            )
                          )
                        )
                  ),
                  e(
                    "section",
                    { className: "panel" },
                    e(
                      "h3",
                      { style: { marginTop: 0 } },
                      lang === "ar" ? "تذاكر الشيفت الحالي" : "Tickets du shift en cours"
                    ),
                    !activeShift
                      ? e(
                          "div",
                          { style: { fontSize: 12, color: "#64748b" } },
                          lang === "ar" ? "لا يوجد شيفت مفتوح" : "Aucun shift ouvert."
                        )
                      : e(AdminOrdersTickets, {
                          orders,
                          users,
                          lang,
                          t,
                          activeShiftId: activeShift ? activeShift.id : null,
                          shifts,
                          onMarkPaid: null,
                          exitingOrderIds
                        })
                  ),
                  e(
                    "section",
                    { className: "panel" },
                    e(
                      "h3",
                      { style: { marginTop: 0 } },
                      lang === "ar" ? "الشيفتات السابقة" : "Shifts précédents"
                    ),
                    previousShifts.length === 0
                      ? e(
                          "div",
                          { style: { fontSize: 12, color: "#64748b" } },
                          lang === "ar" ? "لا توجد شيفتات" : "Aucun shift."
                        )
                      : e(
                          "div",
                          {
                            style: {
                              display: "grid",
                              gridTemplateColumns: isPhone
                                ? "1fr"
                                : "minmax(220px, 320px) minmax(0, 1fr)",
                              gap: 10,
                              alignItems: "start"
                            }
                          },
                          e(
                            "div",
                            { style: { display: "grid", gap: 8 } },
                            previousShifts.slice(0, 30).map((s) => {
                              const active = s && s.id === selectedShiftId;
                              return e(
                                "button",
                                {
                                  key: s.id,
                                  type: "button",
                                  className: "category-btn",
                                  onClick: () => setManagerSelectedShiftId(s.id),
                                  style: {
                                    textAlign: "left",
                                    padding: 10,
                                    borderRadius: 12,
                                    background: active
                                      ? "rgba(249,115,22,0.16)"
                                      : "rgba(255,255,255,0.85)",
                                    border: active
                                      ? "1px solid rgba(249,115,22,0.55)"
                                      : "1px solid rgba(148,163,184,0.45)",
                                    fontWeight: active ? 900 : 700
                                  }
                                },
                                String(s.date || "") +
                                  "-" +
                                  String(s.period || "") +
                                  " (" +
                                  String(s.status || "") +
                                  ")"
                              );
                            })
                          ),
                          !selectedDetails
                            ? e(
                                "div",
                                { style: { fontSize: 12, color: "#64748b" } },
                                lang === "ar" ? "اختر شيفت" : "Choisir un shift."
                              )
                            : e(
                                "div",
                                {
                                  style: {
                                    borderRadius: 14,
                                    border: "1px solid rgba(148,163,184,0.55)",
                                    background: "rgba(255,255,255,0.92)",
                                    padding: 12,
                                    display: "grid",
                                    gap: 10
                                  }
                                },
                                e(
                                  "div",
                                  { style: { fontWeight: 900 } },
                                  String((selectedDetails.shift && selectedDetails.shift.id) || "")
                                ),
                                e(
                                  "div",
                                  {
                                    style: {
                                      display: "grid",
                                      gridTemplateColumns: "repeat(auto-fit, minmax(220px, 1fr))",
                                      gap: 10
                                    }
                                  },
                                  e(
                                    "div",
                                    {
                                      style: {
                                        borderRadius: 14,
                                        border: "1px solid rgba(148,163,184,0.45)",
                                        background: "rgba(248,250,252,0.9)",
                                        padding: 10
                                      }
                                    },
                                    e(
                                      "div",
                                      { style: { fontSize: 12, fontWeight: 900, color: "#334155" } },
                                      lang === "ar" ? "الصندوق (بداية)" : "Fond (début)"
                                    ),
                                    e(
                                      "div",
                                      { style: { fontSize: 16, fontWeight: 900, marginTop: 2 } },
                                      money(selectedDetails.openingFloatCash)
                                    )
                                  ),
                                  e(
                                    "div",
                                    {
                                      style: {
                                        borderRadius: 14,
                                        border: "1px solid rgba(148,163,184,0.45)",
                                        background: "rgba(248,250,252,0.9)",
                                        padding: 10
                                      }
                                    },
                                    e(
                                      "div",
                                      { style: { fontSize: 12, fontWeight: 900, color: "#334155" } },
                                      lang === "ar" ? "المداخيل (مدفوع)" : "Revenu commandes (payé)"
                                    ),
                                    e(
                                      "div",
                                      { style: { fontSize: 16, fontWeight: 900, marginTop: 2 } },
                                      money(selectedDetails.paidRevenue)
                                    ),
                                    e(
                                      "div",
                                      { style: { fontSize: 11, color: "#64748b", marginTop: 2 } },
                                      (lang === "ar" ? "عدد" : "Nb") + ": " + String(selectedDetails.paidCount)
                                    )
                                  ),
                                  e(
                                    "div",
                                    {
                                      style: {
                                        borderRadius: 14,
                                        border: "1px solid rgba(148,163,184,0.45)",
                                        background: "rgba(248,250,252,0.9)",
                                        padding: 10
                                      }
                                    },
                                    e(
                                      "div",
                                      { style: { fontSize: 12, fontWeight: 900, color: "#334155" } },
                                      lang === "ar" ? "غير مدفوع" : "Impayé"
                                    ),
                                    e(
                                      "div",
                                      { style: { fontSize: 16, fontWeight: 900, marginTop: 2 } },
                                      money(selectedDetails.unpaidTotal)
                                    ),
                                    e(
                                      "div",
                                      { style: { fontSize: 11, color: "#64748b", marginTop: 2 } },
                                      (lang === "ar" ? "عدد" : "Nb") + ": " + String(selectedDetails.unpaidCount)
                                    )
                                  ),
                                  e(
                                    "div",
                                    {
                                      style: {
                                        borderRadius: 14,
                                        border: "1px solid rgba(148,163,184,0.45)",
                                        background: "rgba(248,250,252,0.9)",
                                        padding: 10
                                      }
                                    },
                                    e(
                                      "div",
                                      { style: { fontSize: 12, fontWeight: 900, color: "#334155" } },
                                      lang === "ar" ? "المشتريات (الشيفت)" : "Achats (shift)"
                                    ),
                                    e(
                                      "div",
                                      { style: { fontSize: 16, fontWeight: 900, marginTop: 2 } },
                                      money(selectedDetails.purchasesTotal)
                                    )
                                  )
                                )
                              )
                        )
                  ),
                  e(
                    "section",
                    { className: "panel" },
                    e(
                      "h3",
                      { style: { marginTop: 0 } },
                      lang === "ar" ? "قائمة التسوق (المخزون)" : "Shopping list (stock)"
                    ),
                    lowStock.length
                      ? e(
                          "div",
                          { style: { display: "grid", gap: 8 } },
                          lowStock.map((x) =>
                            e(
                              "div",
                              {
                                key: x.ing.id,
                                style: {
                                  display: "flex",
                                  justifyContent: "space-between",
                                  gap: 10,
                                  padding: 10,
                                  borderRadius: 12,
                                  border: "1px solid rgba(251,146,60,0.45)",
                                  background: "rgba(255,247,237,0.9)"
                                }
                              },
                              e(
                                "div",
                                { style: { fontSize: 12, fontWeight: 900 } },
                                ingredientLabel(x.ing, lang) || String(x.ing.id || "")
                              ),
                              e(
                                "div",
                                { style: { fontSize: 12, fontWeight: 900, whiteSpace: "nowrap" } },
                                "+",
                                String(x.missing),
                                " ",
                                String(x.ing.unit || "")
                              )
                            )
                          )
                        )
                      : e(
                          "div",
                          { style: { fontSize: 12, color: "#64748b" } },
                          lang === "ar" ? "كل شيء جيد" : "Tout est OK."
                        )
                  ),
                  e(
                    "section",
                    { className: "panel" },
                    e(WaiterPurchasesHub, {
                      inventory,
                      t,
                      lang,
                      activeShift,
                      activeWorker,
                      adminUser: managerAdminUser,
                      shifts,
                      onPurchase: handleInventoryPurchase,
                      onPurchaseInvoice: handleInventoryPurchaseInvoice,
                      stockCountRequests,
                      onSubmitStockCountRequest: handleSubmitStockCountRequest,
                      canPurchase: canPurchase
                    })
                  )
                );
              })(),
              null
            ),
          view === "admin" &&
            e(
              "main",
              { className: "admin-main" },
              !canSeeAdmin()
                ? e(
                    "section",
                    { className: "panel" },
                    e("p", { style: { fontSize: 12 } }, "Admin seulement.")
                  )
                : (() => {
                    const labels =
                      lang === "ar"
                        ? {
                            overview: "نظرة عامة على المبيعات",
                            menu: "القائمة",
                            inventory: "المخزون",
                            reports: "التقارير",
                            staff: "الموظفون",
                            tickets: "التذاكر / الطلبات",
                            debts: "ديون الزبائن",
                            logout: "تسجيل الخروج"
                          }
                        : {
                            overview: "Aperçu des Ventes",
                            menu: "Menu",
                            inventory: "Inventaire",
                            reports: "Rapports",
                            staff: "Staff",
                            tickets: "Orders / Tickets",
                            debts: "Dettes Clients",
                            logout: "Déconnexion"
                          };

                    const todayKey = new Date().toISOString().slice(0, 10);
                    const todaysOrders = orders.filter(
                      (o) => o && String(o.createdAt || "").slice(0, 10) === todayKey
                    );
                    const todaysPaid = todaysOrders.filter((o) => o.status === "paid");
                    const todaysUnpaid = todaysOrders.filter((o) => o.status !== "paid");
                    const todaySales = todaysPaid.reduce(
                      (sum, o) => sum + ((o.totals && o.totals.total) || 0),
                      0
                    );
                    const avgOrder = todaysPaid.length
                      ? todaySales / todaysPaid.length
                      : 0;

                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yKey = yesterday.toISOString().slice(0, 10);
                    const ySales = orders
                      .filter(
                        (o) =>
                          o &&
                          o.status === "paid" &&
                          String(o.createdAt || "").slice(0, 10) === yKey
                      )
                      .reduce((sum, o) => sum + ((o.totals && o.totals.total) || 0), 0);
                    const pct = ySales > 0 ? ((todaySales - ySales) / ySales) * 100 : 0;
                    const pctLabel =
                      (pct >= 0 ? "+" : "") + pct.toFixed(0) + "% vs hier";

                    const days = Array.from({ length: 7 }).map((_, idx) => {
                      const d = new Date();
                      d.setDate(d.getDate() - (6 - idx));
                      const key = d.toISOString().slice(0, 10);
                      const paidInDay = orders.filter(
                        (o) =>
                          o &&
                          o.status === "paid" &&
                          String(o.createdAt || "").slice(0, 10) === key
                      );
                      const sum = paidInDay.reduce((s, o) => s + ((o.totals && o.totals.total) || 0), 0);
                      const count = paidInDay.length;
                      return { key, sum, count, today: key === todayKey };
                    });
                    const maxDay = days.reduce((m, d) => Math.max(m, d.sum), 0) || 1;

                    return e(
                      React.Fragment,
                      null,
                      e(
                        "aside",
                        { className: "admin-sidebar" },
                        e(
                          "div",
                          { className: "pos-sidebar-brand" },
                          e("img", {
                            src: "./cafe-halab-logo.png",
                            alt: t.appTitle,
                            className: "brand-logo",
                            style: { width: 46, height: 46 }
                          }),
                          e(
                            "div",
                            null,
                            e("div", { className: "pos-sidebar-title" }, "Café Halab POS"),
                            e(
                              "div",
                              { className: "pos-sidebar-sub" },
                              "Admin: ",
                              adminUser ? adminUser.name : ""
                            )
                          )
                        ),
                        e(
                          "div",
                          { className: "admin-nav" },
                          e(
                            "button",
                            {
                              type: "button",
                              className:
                                "admin-nav-item" +
                                (adminSection === "overview" ? " active" : ""),
                              onClick: () => setAdminSection("overview")
                            },
                            labels.overview
                          ),
                          e(
                            "button",
                            {
                              type: "button",
                              className:
                                "admin-nav-item" + (adminSection === "menu" ? " active" : ""),
                              onClick: () => setAdminSection("menu")
                            },
                            labels.menu
                          ),
                          e(
                            "button",
                            {
                              type: "button",
                              className:
                                "admin-nav-item" +
                                (adminSection === "inventory" ? " active" : ""),
                              onClick: () => setAdminSection("inventory")
                            },
                            labels.inventory
                          ),
                          e(
                            "button",
                            {
                              type: "button",
                              className:
                                "admin-nav-item" +
                                (adminSection === "reports" ? " active" : ""),
                              onClick: () => setAdminSection("reports")
                            },
                            labels.reports
                          ),
                          e(
                            "button",
                            {
                              type: "button",
                              className:
                                "admin-nav-item" +
                                (adminSection === "staff" ? " active" : ""),
                              onClick: () => setAdminSection("staff")
                            },
                            labels.staff
                          ),
                          e(
                            "button",
                            {
                              type: "button",
                              className:
                                "admin-nav-item" +
                                (adminSection === "tickets" ? " active" : ""),
                              onClick: () => setAdminSection("tickets")
                            },
                            labels.tickets
                          ),
                          e(
                            "button",
                            {
                              type: "button",
                              className:
                                "admin-nav-item" +
                                (adminSection === "debts" ? " active" : ""),
                              onClick: () => setAdminSection("debts")
                            },
                            labels.debts
                          )
                        ),
                        e(
                          "div",
                          { className: "pos-sidebar-actions", style: { marginTop: "auto" } },
                          e(
                            "button",
                            {
                              type: "button",
                              className: "pos-sidebar-pill",
                              onClick: handleAdminLogout
                            },
                            labels.logout
                          )
                        )
                      ),
                      adminSection === "overview"
                        ? e(
                            "section",
                            { className: "panel" },
                            e(
                              "div",
                              { className: "admin-dashboard-grid" },
                              (() => {
                                const cutoff = Date.now() - 72 * 60 * 60 * 1000;
                                const recentShifts = (shifts || [])
                                  .filter((s) => s && shiftTimeMs(s) >= cutoff)
                                  .slice()
                                  .sort((a, b) => shiftTimeMs(a) - shiftTimeMs(b));
                                const selectedShiftId =
                                  adminOverviewShiftId ||
                                  ((recentShifts.length && recentShifts[recentShifts.length - 1] && recentShifts[recentShifts.length - 1].id) ||
                                    (activeShift && activeShift.id) ||
                                    null);
                                const shiftRec = selectedShiftId
                                  ? (shifts || []).find((s) => s && s.id === selectedShiftId)
                                  : null;
                                const openingFloatCash =
                                  shiftRec && typeof shiftRec.openingFloatCash === "number"
                                    ? shiftRec.openingFloatCash
                                    : activeShift && selectedShiftId && activeShift.id === selectedShiftId && typeof activeShift.openingFloatCash === "number"
                                    ? activeShift.openingFloatCash
                                    : 0;
                                const openingExpectedCash =
                                  shiftRec && typeof shiftRec.openingExpectedCash === "number"
                                    ? shiftRec.openingExpectedCash
                                    : activeShift && selectedShiftId && activeShift.id === selectedShiftId && typeof activeShift.openingExpectedCash === "number"
                                    ? activeShift.openingExpectedCash
                                    : 0;
                                const expectedCashNow =
                                  shiftRec && typeof shiftRec.expectedCash === "number"
                                    ? shiftRec.expectedCash
                                    : activeShift && selectedShiftId && activeShift.id === selectedShiftId && typeof activeShift.expectedCash === "number"
                                    ? activeShift.expectedCash
                                    : 0;

                                const shiftOrders = selectedShiftId
                                  ? (orders || []).filter(
                                      (o) =>
                                        o &&
                                        o.shiftId === selectedShiftId &&
                                        (o.status === "paid" || o.status === "unpaid" || o.status === "debt")
                                    )
                                  : [];
                                const paidOrders = shiftOrders.filter((o) => o.status === "paid");
                                const unpaidOrdersNow = shiftOrders.filter((o) => o.status === "unpaid");
                                const debtOrdersNow = shiftOrders.filter((o) => o.status === "debt");

                                const allOrdersTotal = shiftOrders.reduce(
                                  (s, o) => s + ((o.totals && o.totals.total) || 0),
                                  0
                                );
                                const salesCashIn = paidOrders.reduce(
                                  (s, o) => s + ((o.totals && o.totals.total) || 0),
                                  0
                                );
                                const unpaidOpenTotal = unpaidOrdersNow.reduce(
                                  (s, o) => s + ((o.totals && o.totals.total) || 0),
                                  0
                                );
                                const unpaidDebtTotal = debtOrdersNow.reduce(
                                  (s, o) => s + ((o.totals && o.totals.total) || 0),
                                  0
                                );

                                const paidDebtsInShift = selectedShiftId
                                  ? (clientDebts || []).filter(
                                      (d) => d && d.paidShiftId === selectedShiftId
                                    )
                                  : [];
                                const debtPaidCashIn = paidDebtsInShift
                                  .filter((d) => !d.chargedAt)
                                  .reduce((s, d) => s + (typeof d.amount === "number" ? d.amount : 0), 0);

                                const chargedDebtsInShift = selectedShiftId
                                  ? (clientDebts || []).filter(
                                      (d) => d && d.chargedShiftId === selectedShiftId
                                    )
                                  : [];
                                const debtChargedSum = chargedDebtsInShift.reduce(
                                  (s, d) => s + (typeof d.amount === "number" ? d.amount : 0),
                                  0
                                );

                                const purchasesCost = selectedShiftId
                                  ? (inventoryLogs || [])
                                      .filter(
                                        (l) =>
                                          l &&
                                          l.shiftId === selectedShiftId &&
                                          l.reason === "purchase" &&
                                          l.deductFromExpectedCash !== false
                                      )
                                      .reduce((s, l) => s + (typeof l.totalCost === "number" ? l.totalCost : 0), 0)
                                  : 0;

                                const collectedTotal = salesCashIn + debtPaidCashIn;
                                const debtRecoveryTotal = debtPaidCashIn + debtChargedSum;

                                const computedExpectedCash =
                                  Number(openingFloatCash || 0) +
                                  Number(debtChargedSum || 0) +
                                  Number(salesCashIn || 0) +
                                  Number(debtPaidCashIn || 0) -
                                  Number(purchasesCost || 0);
                                const expectedDiff = Number(expectedCashNow || 0) - computedExpectedCash;

                                const shiftLabels =
                                  lang === "ar"
                                    ? {
                                        currentShift: "النوبة الحالية",
                                        startingFunds: "الرصيد في البداية",
                                        startingExpected: "الرصيد الافتتاحي (مع الديون)",
                                        paidOrders: "الطلبات المُحصّلة",
                                        collectedRevenue: "الإيرادات المُحصّلة",
                                        totalOrders: "إجمالي الطلبات",
                                        unpaidTotal: "غير مدفوع",
                                        unpaidDebt: "غير مدفوع (ديون)",
                                        debtRecovery: "تحصيل الديون",
                                        overdueCharged: "ديون مُضافة بعد 48 ساعة",
                                        purchases: "مشتريات (خصم)",
                                        expectedCash: "النقد المتوقع",
                                        expectedRecon: "مطابقة النقد"
                                      }
                                    : {
                                        currentShift: "Shift en cours",
                                        startingFunds: "Fonds (début)",
                                        startingExpected: "Ouverture (fonds+dettes)",
                                        paidOrders: "Commandes encaissées",
                                        collectedRevenue: "Revenu encaissé",
                                        totalOrders: "Total commandes",
                                        unpaidTotal: "Impayés",
                                        unpaidDebt: "Impayés (dettes)",
                                        debtRecovery: "Recouvrement dettes",
                                        overdueCharged: "Dettes ajoutées (48h)",
                                        purchases: "Achats (déduction)",
                                        expectedCash: "Cash attendu",
                                        expectedRecon: "Réconciliation"
                                      };

                                if (!selectedShiftId) return null;

                                return e(
                                  React.Fragment,
                                  null,
                                  e(
                                    "div",
                                    { className: "admin-kpi-card", style: { gridColumn: "1 / -1" } },
                                    e(
                                      "div",
                                      { className: "admin-kpi-title" },
                                      shiftLabels.currentShift
                                    ),
                                    e(
                                      "div",
                                      {
                                        style: {
                                          display: "flex",
                                          gap: 10,
                                          flexWrap: "wrap",
                                          alignItems: "center",
                                          marginTop: 10
                                        }
                                      },
                                      e(
                                        "div",
                                        { style: { fontSize: 12, color: "#64748b", fontWeight: 800 } },
                                        "ID: ",
                                        selectedShiftId
                                      ),
                                      e(
                                        "div",
                                        { style: { marginLeft: "auto", minWidth: isPhone ? 0 : 220, width: "min(520px, 100%)" } },
                                        e(
                                          "select",
                                          {
                                            value: selectedShiftId || "",
                                            onChange: (ev) => setAdminOverviewShiftId(ev.target.value),
                                            style: {
                                              width: "100%",
                                              padding: 8,
                                              fontSize: 12,
                                              borderRadius: 10,
                                              border: "1px solid rgba(148,163,184,0.55)"
                                            }
                                          },
                                          recentShifts
                                            .slice()
                                            .reverse()
                                            .map((s) =>
                                              e(
                                                "option",
                                                { key: s.id, value: s.id },
                                                String(s.date || "") +
                                                  " " +
                                                  String(s.period || "") +
                                                  " (" +
                                                  String(s.status || "") +
                                                  ")"
                                              )
                                            )
                                        )
                                      )
                                    )
                                  ),

                                  e(
                                    "div",
                                    { className: "admin-kpi-card hero hero-start" },
                                    e("div", { className: "admin-kpi-title" }, shiftLabels.startingFunds),
                                    e(
                                      "div",
                                      { className: "admin-kpi-value" },
                                      `${Number(openingFloatCash || 0).toFixed(2)} DHS`
                                    )
                                  ),
                                  e(
                                    "div",
                                    { className: "admin-kpi-card hero hero-paid" },
                                    e("div", { className: "admin-kpi-title" }, shiftLabels.paidOrders),
                                    e(
                                      "div",
                                      { className: "admin-kpi-value" },
                                      `${Number(salesCashIn || 0).toFixed(2)} DHS`
                                    )
                                  ),
                                  e(
                                    "div",
                                    { className: "admin-kpi-card hero hero-expected" },
                                    e("div", { className: "admin-kpi-title" }, shiftLabels.expectedCash),
                                    e(
                                      "div",
                                      { className: "admin-kpi-value" },
                                      `${Number(computedExpectedCash || 0).toFixed(2)} DHS`
                                    )
                                  ),

                                  e(
                                    "div",
                                    { className: "admin-kpi-card" },
                                    e("div", { className: "admin-kpi-title" }, shiftLabels.collectedRevenue),
                                    e(
                                      "div",
                                      { className: "admin-kpi-value" },
                                      `${Number(collectedTotal || 0).toFixed(2)} DHS`
                                    )
                                  ),
                                  e(
                                    "div",
                                    { className: "admin-kpi-card" },
                                    e("div", { className: "admin-kpi-title" }, shiftLabels.startingExpected),
                                    e(
                                      "div",
                                      { className: "admin-kpi-value" },
                                      `${Number(openingExpectedCash || 0).toFixed(2)} DHS`
                                    )
                                  ),
                                  e(
                                    "div",
                                    { className: "admin-kpi-card" },
                                    e("div", { className: "admin-kpi-title" }, shiftLabels.totalOrders),
                                    e(
                                      "div",
                                      { className: "admin-kpi-value" },
                                      `${Number(allOrdersTotal || 0).toFixed(2)} DHS`
                                    )
                                  ),
                                  e(
                                    "div",
                                    { className: "admin-kpi-card" },
                                    e("div", { className: "admin-kpi-title" }, shiftLabels.unpaidTotal),
                                    e(
                                      "div",
                                      { className: "admin-kpi-value" },
                                      `${Number(unpaidOpenTotal || 0).toFixed(2)} DHS`
                                    )
                                  ),
                                  e(
                                    "div",
                                    { className: "admin-kpi-card" },
                                    e("div", { className: "admin-kpi-title" }, shiftLabels.unpaidDebt),
                                    e(
                                      "div",
                                      { className: "admin-kpi-value" },
                                      `${Number(unpaidDebtTotal || 0).toFixed(2)} DHS`
                                    )
                                  ),
                                  e(
                                    "div",
                                    { className: "admin-kpi-card" },
                                    e("div", { className: "admin-kpi-title" }, shiftLabels.debtRecovery),
                                    e(
                                      "div",
                                      { className: "admin-kpi-value" },
                                      `${Number(debtRecoveryTotal || 0).toFixed(2)} DHS`
                                    ),
                                    e(
                                      "div",
                                      { className: "admin-kpi-sub" },
                                      shiftLabels.overdueCharged,
                                      ": +",
                                      Number(debtChargedSum || 0).toFixed(2),
                                      " DHS"
                                    ),
                                    (() => {
                                      const paidAll = (paidDebtsInShift || [])
                                        .slice()
                                        .sort((a, b) => String(b.paidAt || "").localeCompare(String(a.paidAt || "")));
                                      const chargedAll = (chargedDebtsInShift || [])
                                        .slice()
                                        .sort((a, b) => String(b.chargedAt || "").localeCompare(String(a.chargedAt || "")));

                                      const paidNotCharged = paidAll.filter((d) => d && !d.chargedAt);
                                      const paidAlreadyCharged = paidAll.filter((d) => d && d.chargedAt);

                                      function actorLabel(userId) {
                                        if (!userId) return "";
                                        const u = (users || []).find((x) => x && x.id === userId);
                                        if (!u) return String(userId || "");
                                        const roleLabel =
                                          u.role === "admin"
                                            ? lang === "ar"
                                              ? "مدير"
                                              : "Admin"
                                            : u.role === "worker"
                                              ? lang === "ar"
                                                ? "نادل"
                                                : "Serveur"
                                              : String(u.role || "");
                                        return String(u.name || userId) + (roleLabel ? " (" + roleLabel + ")" : "");
                                      }

                                      function rowLabel(d, mode) {
                                        const name = String(d && d.customerName ? d.customerName : "");
                                        const amt = typeof d.amount === "number" ? d.amount : 0;
                                        const who = actorLabel(d && d.paidBy);
                                        const waiter = actorLabel(d && d.waiterId);
                                        if (mode === "paid") {
                                          const tag = lang === "ar" ? "مدفوعة" : "Payée";
                                          const by = lang === "ar" ? "بواسطة" : "par";
                                          return {
                                            left: name || (lang === "ar" ? "زبون" : "Client"),
                                            right: amt.toFixed(2) + " DHS",
                                            sub: who ? tag + " " + by + " " + who : tag
                                          };
                                        }
                                        const tag = lang === "ar" ? "48س" : "48h";
                                        const auto = lang === "ar" ? "تلقائي" : "Auto";
                                        const by = lang === "ar" ? "على" : "sur";
                                        return {
                                          left: name || (lang === "ar" ? "زبون" : "Client"),
                                          right: amt.toFixed(2) + " DHS",
                                          sub: waiter ? tag + " · " + auto + " " + by + " " + waiter : tag + " · " + auto
                                        };
                                      }

                                      const anyRows =
                                        paidNotCharged.length || paidAlreadyCharged.length || chargedAll.length;
                                      if (!anyRows) return null;

                                      const detailsTitle = lang === "ar" ? "التفاصيل" : "Détails";
                                      const paidTitle = lang === "ar" ? "ديون مُحصّلة" : "Dettes payées";
                                      const paidChargedTitle =
                                        lang === "ar"
                                          ? "ديون مُحصّلة (كانت محسوبة)"
                                          : "Payées (déjà ajoutées 48h)";
                                      const chargedTitle =
                                        lang === "ar" ? "ديون مُضافة (48س)" : "Dettes ajoutées (48h)";

                                      function renderList(title, rows, mode) {
                                        if (!rows.length) return null;
                                        return e(
                                          "div",
                                          { style: { display: "grid", gap: 6 } },
                                          e(
                                            "div",
                                            { style: { fontSize: 11, fontWeight: 900, color: "#334155" } },
                                            title
                                          ),
                                          rows.slice(0, 6).map((d) => {
                                            const r = rowLabel(d, mode);
                                            return e(
                                              "div",
                                              {
                                                key: String(d && d.id ? d.id : Math.random()),
                                                style: {
                                                  display: "grid",
                                                  gap: 2,
                                                  padding: "6px 8px",
                                                  borderRadius: 10,
                                                  border: "1px solid rgba(148,163,184,0.25)",
                                                  background: "rgba(255,255,255,0.75)"
                                                }
                                              },
                                              e(
                                                "div",
                                                {
                                                  style: {
                                                    display: "flex",
                                                    justifyContent: "space-between",
                                                    gap: 10,
                                                    fontSize: 12,
                                                    fontWeight: 900
                                                  }
                                                },
                                                e("div", null, r.left),
                                                e("div", { style: { whiteSpace: "nowrap" } }, r.right)
                                              ),
                                              e(
                                                "div",
                                                { style: { fontSize: 11, color: "#64748b", fontWeight: 800 } },
                                                r.sub
                                              )
                                            );
                                          }),
                                          rows.length > 6
                                            ? e(
                                                "div",
                                                { style: { fontSize: 11, color: "#64748b", fontWeight: 800 } },
                                                "+",
                                                String(rows.length - 6),
                                                lang === "ar" ? " المزيد" : " more"
                                              )
                                            : null
                                        );
                                      }

                                      return e(
                                        "div",
                                        {
                                          style: {
                                            marginTop: 10,
                                            display: "grid",
                                            gap: 10,
                                            maxHeight: 220,
                                            overflow: "auto"
                                          }
                                        },
                                        e(
                                          "div",
                                          { style: { fontSize: 11, fontWeight: 900, color: "#0f172a" } },
                                          detailsTitle
                                        ),
                                        renderList(paidTitle, paidNotCharged, "paid"),
                                        renderList(paidChargedTitle, paidAlreadyCharged, "paid"),
                                        renderList(chargedTitle, chargedAll, "charged")
                                      );
                                    })()
                                  ),
                                  e(
                                    "div",
                                    { className: "admin-kpi-card" },
                                    e("div", { className: "admin-kpi-title" }, shiftLabels.purchases),
                                    e(
                                      "div",
                                      { className: "admin-kpi-value" },
                                      `-${Number(purchasesCost || 0).toFixed(2)} DHS`
                                    )
                                  ),
                                  e(
                                    "div",
                                    { className: "admin-kpi-card" },
                                    e("div", { className: "admin-kpi-title" }, shiftLabels.expectedRecon),
                                    e(
                                      "div",
                                      { className: "admin-kpi-value" },
                                      `${Number(expectedDiff || 0).toFixed(2)} DHS`
                                    ),
                                    e(
                                      "div",
                                      { className: "admin-kpi-sub" },
                                      "stored: ",
                                      Number(expectedCashNow || 0).toFixed(2),
                                      " DHS · calc: ",
                                      Number(computedExpectedCash || 0).toFixed(2),
                                      " DHS"
                                    )
                                  )
                                );
                              })(),
                              e(
                                "div",
                                { className: "admin-kpi-card" },
                                e("div", { className: "admin-kpi-title" }, "Ventes Quotidiennes"),
                                e(
                                  "div",
                                  { className: "admin-kpi-value" },
                                  `${todaySales.toFixed(2)} DHS`
                                ),
                                e(
                                  "div",
                                  { className: "admin-kpi-sub" },
                                  pctLabel
                                )
                              ),
                              e(
                                "div",
                                { className: "admin-kpi-card" },
                                e("div", { className: "admin-kpi-title" }, "Orders Today"),
                                e(
                                  "div",
                                  { className: "admin-kpi-value" },
                                  String(todaysOrders.length)
                                ),
                                e(
                                  "div",
                                  { style: { fontSize: 12, color: "#2563eb", fontWeight: 700, marginTop: 10 } },
                                  "Active: ",
                                  String(todaysUnpaid.length)
                                )
                              ),
                              e(
                                "div",
                                { className: "admin-kpi-card" },
                                e("div", { className: "admin-kpi-title" }, "Avg Order"),
                                e(
                                  "div",
                                  { className: "admin-kpi-value" },
                                  `${avgOrder.toFixed(2)} DHS`
                                ),
                                e(
                                  "div",
                                  { style: { fontSize: 12, color: "#f97316", fontWeight: 700, marginTop: 10 } },
                                  todaysPaid.length ? "" : ""
                                )
                              )
                            ),
                            e(
                              "div",
                              { className: "admin-chart" },
                              e(
                                "div",
                                { style: { fontWeight: 800, fontSize: 16, color: "#0f172a" } },
                                lang === "ar" ? "مخطط المبيعات" : "Graphique des ventes"
                              ),
                              e(
                                "div",
                                { className: "admin-chart-bars" },
                                days.map((d) =>
                                  e(
                                    "div",
                                    {
                                      key: d.key,
                                      className: "admin-bar" + (d.today ? " today" : ""),
                                      title:
                                        String(d.key) +
                                        " · " +
                                        Number(d.sum || 0).toFixed(2) +
                                        " DHS · " +
                                        String(d.count || 0) +
                                        " " +
                                        (lang === "ar" ? "طلبات" : "cmd"),
                                      style: {
                                        height: Math.max(22, Math.round((d.sum / maxDay) * 100)) + "%",
                                        display: "flex",
                                        alignItems: "flex-end",
                                        justifyContent: "center",
                                        paddingBottom: 6,
                                        color: "rgba(255,255,255,0.95)",
                                        fontWeight: 900,
                                        fontSize: 11,
                                        textShadow: "0 1px 2px rgba(15,23,42,0.35)"
                                      }
                                    },
                                    String(d.count || 0)
                                  )
                                )
                              )
                            ),
                            (() => {
                              const shiftId = adminOverviewShiftId || (activeShift ? activeShift.id : null);
                              const servedOrders = shiftId
                                ? (orders || []).filter(
                                    (o) => o && o.status === "paid" && o.shiftId === shiftId
                                  )
                                : [];
                              const counts = {};
                              function drinkValueLabel(value) {
                                if (value === "tea") return (t && t.drinkTea) || "Thé";
                                if (value === "coffee_milk")
                                  return (t && t.drinkCoffeeMilk) || "Café au lait";
                                return value || "";
                              }
                              function lineModifiersLabel(line) {
                                const mods = (line && line.modifiers) || {};
                                const parts = [];
                                if (mods.milk != null) {
                                  parts.push(`${t.milkInLine}: ${mods.milk ? t.milkYes : t.milkNo}`);
                                }
                                if (mods.sugar) {
                                  parts.push(`${t.sugarInLine}: ${mods.sugar}`);
                                }
                                if (mods.sirop) {
                                  parts.push(`${(t && t.siropInLine) || "sirop"}: ${(t && t.siropWith) || "Avec"}`);
                                }
                                if (mods.water) {
                                  const fee = Number(mods.waterFee) || 0;
                                  parts.push(
                                    `${(t && t.waterInLine) || "eau"}: ${(t && t.waterWith) || "Avec"}${fee ? " +" + fee : ""}`
                                  );
                                }
                                if (mods.waterSize) {
                                  const label =
                                    mods.waterSize === "half"
                                      ? (t && t.waterHalf) || "1/2L"
                                      : (t && t.waterQuarter) || "1/4L";
                                  parts.push(`${(t && t.waterInLine) || "eau"}: ${label}`);
                                }
                                if (mods.herb) {
                                  parts.push(`${t.herbInLine}: ${herbValueLabel(mods.herb, t)}`);
                                }
                                if (mods.drink) {
                                  parts.push(`${t.drinkInLine}: ${drinkValueLabel(mods.drink)}`);
                                }
                                if (mods.eggCount) {
                                  parts.push(`${t.eggsInLine}: ${mods.eggCount}`);
                                }
                                if (mods.sbDrinkId || mods.sbDrinkName || mods.sbDrinkNameFr || mods.sbDrinkNameAr) {
                                  const sbDrinkLabel =
                                    lang === "ar"
                                      ? mods.sbDrinkNameAr || mods.sbDrinkName || mods.sbDrinkNameFr || ""
                                      : mods.sbDrinkNameFr || mods.sbDrinkName || mods.sbDrinkNameAr || "";
                                  if (sbDrinkLabel) {
                                    parts.push((lang === "ar" ? "مشروب" : "Boisson") + ": " + sbDrinkLabel);
                                  }
                                }
                                if (mods.sbEggCount) {
                                  parts.push((lang === "ar" ? "بيض" : "Oeufs") + ": " + String(mods.sbEggCount));
                                }
                                if (mods.sbKashir) parts.push(lang === "ar" ? "كاشير" : "Kashir");
                                if (mods.sbFromage) parts.push(lang === "ar" ? "جبن" : "Fromage");
                                if (mods.sbWater) parts.push(lang === "ar" ? "ماء" : "Eau");
                                if (mods.sbCroissant) parts.push(lang === "ar" ? "كرواسون" : "Croissant");
                                if (mods.sbBreakfastSet) parts.push(lang === "ar" ? "باك الفطور (+5)" : "Breakfast set (+5)");
                                if (mods.sbCheesePieces) {
                                  parts.push(
                                    (lang === "ar" ? "قطع الجبن" : "Fromage pièces") + ": " + String(mods.sbCheesePieces)
                                  );
                                }
                                if (line && (line.containerType || line.cupSize)) {
                                  const typeLabel =
                                    line.containerType === "glass"
                                      ? lang === "ar"
                                        ? "زجاج"
                                        : "Verre"
                                      : lang === "ar"
                                      ? "بلاستيك"
                                      : "Jetable";
                                  const sizeLabel =
                                    line.cupSize === "large"
                                      ? lang === "ar"
                                        ? "كبير"
                                        : "Grand"
                                      : lang === "ar"
                                      ? "صغير"
                                      : "Petit";
                                  parts.push(
                                    (lang === "ar" ? "كأس" : "Gobelet") + ": " + typeLabel + " " + sizeLabel
                                  );
                                }
                                return parts.length ? "(" + parts.join(", ") + ")" : "";
                              }
                              servedOrders.forEach((o) => {
                                (o.items || []).forEach((line) => {
                                  const qty = Number((line && line.qty) || 0) || 0;
                                  if (!qty) return;
                                  const base =
                                    lang === "ar"
                                      ? String((line && (line.nameAr || line.name)) || "")
                                      : String((line && (line.nameFr || line.name)) || "");
                                  const mods = lineModifiersLabel(line);
                                  const key = mods ? base + " " + mods : base;
                                  counts[key] = (counts[key] || 0) + qty;
                                });
                              });
                              const rows = Object.keys(counts)
                                .map((k) => ({ label: k, qty: counts[k] }))
                                .sort((a, b) => b.qty - a.qty);
                              return e(
                                "div",
                                {
                                  className: "admin-chart",
                                  style: { marginTop: 14 }
                                },
                                e(
                                  "div",
                                  { style: { fontWeight: 800, fontSize: 16, color: "#0f172a" } },
                                  (t && t.shiftServedTitle) || "Servi (shift en cours)"
                                ),
                                !shiftId
                                  ? e(
                                      "div",
                                      { style: { fontSize: 12, color: "#64748b", marginTop: 8 } },
                                      (t && t.noShiftOpen) || "Aucun shift ouvert."
                                    )
                                  : rows.length
                                    ? e(
                                        "div",
                                        {
                                          style: {
                                            marginTop: 10,
                                            display: "grid",
                                            gap: 6
                                          }
                                        },
                                        rows.map((r) =>
                                          e(
                                            "div",
                                            {
                                              key: r.label,
                                              style: {
                                                display: "flex",
                                                justifyContent: "space-between",
                                                gap: 10,
                                                fontSize: 12,
                                                padding: "6px 8px",
                                                borderRadius: 10,
                                                border: "1px solid rgba(148,163,184,0.35)",
                                                background: "rgba(255,255,255,0.85)"
                                              }
                                            },
                                            e(
                                              "div",
                                              { style: { fontWeight: 700 } },
                                              r.label
                                            ),
                                            e(
                                              "div",
                                              { style: { whiteSpace: "nowrap", fontWeight: 900 } },
                                              String(r.qty)
                                            )
                                          )
                                        )
                                      )
                                    : e(
                                        "div",
                                        { style: { fontSize: 12, color: "#64748b", marginTop: 8 } },
                                        (t && t.noPaidOrders) || "Aucune commande payée."
                                      )
                              );
                            })()
                          )
                        : adminSection === "menu"
                        ? e(
                            "section",
                            { className: "panel" },
                            e("h3", { style: { marginTop: 0 } }, "Menu (Admin)"),
                            e(AdminMenuEditor, {
                              menu: menu,
                              onUpdateMenuItem: handleUpdateMenuItem,
                              onAddMenuItem: handleAddMenuItem,
                              onSaveMenu: handleSaveMenu,
                              isPhone
                            })
                          )
                        : adminSection === "inventory"
                        ? e(
                            "section",
                            { className: "panel" },
                            e("h3", { style: { marginTop: 0 } }, (labels && labels.inventory) || "Inventaire"),
                            e(AdminInventoryEditor, {
                              inventory,
                              t,
                              isPhone,
                              onAdjust: handleInventoryAdjust,
                              onUpdate: handleInventoryUpdate,
                              lang
                            }),
                            e("div", { style: { marginTop: 14 } }),
                            e(AdminStockCountRequestsPanel, {
                              inventory,
                              users,
                              stockCountRequests,
                              lang,
                              isPhone,
                              onCreateRequest: handleCreateStockCountRequest
                            }),
                            e("div", { style: { marginTop: 14 } }),
                            e(AdminInventoryStockDetails, {
                              inventory,
                              inventoryLogs,
                              shifts,
                              t,
                              lang,
                              isPhone
                            }),
                            e("div", { style: { marginTop: 14 } }),
                            e(AdminInventoryPurchasesLog, {
                              inventory,
                              inventoryLogs,
                              users,
                              t,
                              lang,
                              isPhone
                            }),
                            e("div", { style: { marginTop: 14 } }),
                            e(AdminPurchaseInvoicesLog, {
                              purchaseInvoices,
                              inventory,
                              users,
                              lang,
                              isPhone
                            })
                          )
                        : adminSection === "reports"
                        ? e(
                            "section",
                            { className: "panel" },
                            e("h3", { style: { marginTop: 0 } }, "Rapports"),
                            e(AdminReportsPage, {
                              shifts,
                              orders,
                              inventoryLogs,
                              clientDebts,
                              inventory,
                              t,
                              lang,
                              isPhone
                            })
                          )
                        : adminSection === "staff"
                        ? e(
                            "section",
                            { className: "panel" },
                            e("h3", { style: { marginTop: 0 } }, "Staff"),
                            e(AdminStaffPanel, {
                              users,
                              advances,
                              lang,
                              t,
                              isPhone,
                              onUpsertUser: handleUpsertUser,
                              onDeleteUser: handleDeleteUser,
                              onChangePin: handleChangeUserPin,
                              onApproveAdvance: handleApproveAdvance,
                              onRejectAdvance: handleRejectAdvance,
                            })
                          )
                        : adminSection === "debts"
                        ? e(
                            "section",
                            { className: "panel" },
                            e("h3", { style: { marginTop: 0 } }, labels.debts),
                            (() => {
                              const rows = (clientDebts || [])
                                .slice()
                                .sort((a, b) => String(b.createdAt || "").localeCompare(String(a.createdAt || "")));
                              function fmt(iso) {
                                try {
                                  if (!iso) return "";
                                  const d = new Date(iso);
                                  return d.toLocaleString(lang === "ar" ? "ar-MA" : "fr-FR", {
                                    year: "2-digit",
                                    month: "2-digit",
                                    day: "2-digit",
                                    hour: "2-digit",
                                    minute: "2-digit"
                                  });
                                } catch (e) {
                                  return String(iso || "");
                                }
                              }
                              return rows.length
                                ? e(
                                    "div",
                                    { style: { display: "grid", gap: 10 } },
                                    rows.map((d) =>
                                      e(
                                        "div",
                                        {
                                          key: d.id,
                                          style: {
                                            borderRadius: 14,
                                            border: "1px solid rgba(148,163,184,0.45)",
                                            background: "rgba(255,255,255,0.85)",
                                            padding: 12,
                                            display: "grid",
                                            gap: 6
                                          }
                                        },
                                        e(
                                          "div",
                                          { style: { display: "flex", justifyContent: "space-between", gap: 10 } },
                                          e(
                                            "div",
                                            { style: { fontWeight: 900 } },
                                            String(d.customerName || "")
                                          ),
                                          e(
                                            "div",
                                            { style: { whiteSpace: "nowrap", fontWeight: 900 } },
                                            `${(typeof d.amount === "number" ? d.amount : 0).toFixed(2)} DHS`
                                          )
                                        ),
                                        e(
                                          "div",
                                          { style: { fontSize: 12, color: "#64748b" } },
                                          (t.waiterLabel || "Serveur") +
                                            ": " +
                                            userNameById(d.waiterId) +
                                            " · " +
                                            fmt(d.createdAt) +
                                            (d.chargedAt
                                              ? " · " + ((t && t.clientUnpaidDebtLabel) || "Client unpaid debt")
                                              : "")
                                        ),
                                        d.paidAt
                                          ? e(
                                              "div",
                                              { style: { fontSize: 12, color: "#16a34a", fontWeight: 800 } },
                                              "Paid: " + fmt(d.paidAt)
                                            )
                                          : e(
                                              "button",
                                              {
                                                className: "btn-primary",
                                                type: "button",
                                                onClick: () => handleMarkDebtPaid(d.id)
                                              },
                                              (t && t.markDebtPaid) || "Déclarer dette payée"
                                            )
                                      )
                                    )
                                  )
                                : e(
                                    "div",
                                    { style: { fontSize: 12, color: "#64748b" } },
                                    "Aucune dette."
                                  );
                            })()
                          )
                        : e(
                            "section",
                            { className: "panel" },
                            e(AdminOrdersTickets, {
                              orders,
                              users,
                              lang,
                              t,
                              activeShiftId: activeShift ? activeShift.id : null,
                              shifts,
                              onMarkPaid: handleMarkOrderPaidAnimated,
                              exitingOrderIds
                            })
                          )
                    );
                  })()
            )
        );
      }

      function ProductCard({ product, menu, onAdd, lang, t }) {
        const [milk, setMilk] = React.useState(true); // yes/no for coffee
        const [sugar, setSugar] = React.useState("medium");
        const [herb, setHerb] = React.useState("mint");
        const [drink, setDrink] = React.useState("coffee_milk"); // for breakfast combos
        const [eggCount, setEggCount] = React.useState(2); // for fried eggs
        const [sbDrinkId, setSbDrinkId] = React.useState("");
        const [sbEggCount, setSbEggCount] = React.useState(2);
        const [sbKashir, setSbKashir] = React.useState(false);
        const [sbFromage, setSbFromage] = React.useState(false);
        const [sbWater, setSbWater] = React.useState(false);
        const [sbCroissant, setSbCroissant] = React.useState(false);
        const [sbBreakfastSet, setSbBreakfastSet] = React.useState(false);
        const [sbCheesePieces, setSbCheesePieces] = React.useState(0);
        const [withSirop, setWithSirop] = React.useState(() => {
          try {
            return !!(
              product &&
              (product.id === "other_raib" || product.id === "other_flan")
            );
          } catch (e) {
            return false;
          }
        });
        const [withWater, setWithWater] = React.useState(() => {
          try {
            return (
              (product && product.category === "Breakfast" && product.id !== "breakfast_special_set") ||
              isCoffee(product)
            );
          } catch (e) {
            return false;
          }
        });
        const [waterSize, setWaterSize] = React.useState("quarter");
        const hasMilkModifier = isCoffee(product) && product.id !== "coffee";
        const hasSiropAddon = product && (product.id === "other_raib" || product.id === "other_flan");
        const hasSugarModifier =
          !isSoda(product) &&
          !isWaterItem(product) &&
          !(product && (product.id === "other_muffin" || product.id === "other_raib" || product.id === "other_flan"));
        const isSpecialBreakfast = product && product.id === "breakfast_special_set";
        const hasWaterAddon = !isWaterItem(product) && !isSpecialBreakfast;
        const hasHerbModifier = isHerbalTea(product);
        const isBreakfast = product.category === "Breakfast";
        const isFriedEggs = product.id === "fried_eggs";

        const hotDrinks = React.useMemo(() => {
          return (menu || []).filter((p) => p && p.category === "Hot Drinks");
        }, [menu]);

        React.useEffect(() => {
          if (!isSpecialBreakfast) return;
          if (sbDrinkId) return;
          const def =
            (menu || []).find((p) => p && p.id === "coffee_with_milk") ||
            (hotDrinks && hotDrinks[0]) ||
            null;
          if (def && def.id) setSbDrinkId(def.id);
        }, [isSpecialBreakfast, sbDrinkId, menu, hotDrinks]);

        const sbDrinkItem = React.useMemo(() => {
          if (!isSpecialBreakfast) return null;
          const id = String(sbDrinkId || "");
          if (!id) return null;
          return (menu || []).find((p) => p && p.id === id) || null;
        }, [isSpecialBreakfast, sbDrinkId, menu]);

        const sbDrinkPrice = React.useMemo(() => {
          if (!isSpecialBreakfast) return 0;
          return sbDrinkItem ? Number(sbDrinkItem.price || 0) || 0 : 0;
        }, [isSpecialBreakfast, sbDrinkItem]);

        const waterFee = React.useMemo(() => {
          if (!hasWaterAddon || !withWater) return 0;
          return isBreakfast ? 1.0 : 2.0;
        }, [hasWaterAddon, withWater, isBreakfast]);

        const displayPrice = React.useMemo(() => {
          let p = product.price;
          if (isFriedEggs) p = eggCount === 1 ? 22.0 : 24.0;
          if (product.id === "other_water") p = waterSize === "half" ? 5.0 : 3.0;
          if (isSpecialBreakfast) {
            const eggs = Math.max(1, Math.min(5, Number(sbEggCount) || 1));
            const eggsFee = eggs * 3;
            const togglesFee =
              (sbKashir ? 3 : 0) +
              (sbFromage ? 3 : 0) +
              (sbWater ? 2 : 0) +
              (sbCroissant ? 6 : 0) +
              (sbBreakfastSet ? 5 : 0);
            const piecesA = Math.max(0, Math.floor(Number(sbCheesePieces) || 0));
            const cheeseFee = piecesA * 1;
            p = sbDrinkPrice + eggsFee + togglesFee + cheeseFee;
          }
          if (waterFee) p += waterFee;
          return p;
        }, [
          product,
          isFriedEggs,
          eggCount,
          waterSize,
          waterFee,
          isSpecialBreakfast,
          sbDrinkPrice,
          sbEggCount,
          sbKashir,
          sbFromage,
          sbWater,
          sbCroissant,
          sbBreakfastSet,
          sbCheesePieces
        ]);

        function handleClick() {
          const effectiveProduct = { ...product, price: displayPrice };

          const sbDrinkName = sbDrinkItem ? sbDrinkItem.name : "";
          const sbDrinkNameFr = sbDrinkItem ? sbDrinkItem.nameFr || sbDrinkItem.name : "";
          const sbDrinkNameAr = sbDrinkItem ? sbDrinkItem.nameAr || sbDrinkItem.name : "";

          onAdd(effectiveProduct, {
            milk: hasMilkModifier ? milk : null,
            sugar: hasSugarModifier && !isSpecialBreakfast ? sugar : null,
            sirop: hasSiropAddon && withSirop ? true : null,
            herb: hasHerbModifier ? herb : null,
            drink: isBreakfast && !isSpecialBreakfast ? drink : null,
            eggCount: isFriedEggs ? eggCount : null,
            water: hasWaterAddon && withWater ? true : null,
            waterFee: hasWaterAddon && withWater ? waterFee : null,
            waterSize: product.id === "other_water" ? waterSize : null,
            sbDrinkId: isSpecialBreakfast ? String(sbDrinkId || "") : null,
            sbDrinkName: isSpecialBreakfast ? sbDrinkName : null,
            sbDrinkNameFr: isSpecialBreakfast ? sbDrinkNameFr : null,
            sbDrinkNameAr: isSpecialBreakfast ? sbDrinkNameAr : null,
            sbEggCount: isSpecialBreakfast ? Math.max(1, Math.min(5, Number(sbEggCount) || 1)) : null,
            sbKashir: isSpecialBreakfast && sbKashir ? true : null,
            sbFromage: isSpecialBreakfast && sbFromage ? true : null,
            sbWater: isSpecialBreakfast && sbWater ? true : null,
            sbCroissant: isSpecialBreakfast && sbCroissant ? true : null,
            sbBreakfastSet: isSpecialBreakfast && sbBreakfastSet ? true : null,
            sbCheesePieces:
              isSpecialBreakfast && Number(sbCheesePieces) > 0
                ? Math.max(0, Math.floor(Number(sbCheesePieces) || 0))
                : null
          });
        }

        return React.createElement(
          "div",
          { className: "product-card" },
          React.createElement(
            "div",
            null,
            product.image
              ? React.createElement("img", {
                  src: resolveImageSrc(product.image),
                  alt:
                    lang === "ar"
                      ? product.nameAr || product.name
                      : product.nameFr || product.name,
                  className: "product-image",
                  onLoad: () => console.log("Image loaded:", product.image),
                  onError: () => console.error("Image failed to load:", product.image)
                })
              : null,
            React.createElement(
              "div",
              { className: "product-name" },
              lang === "ar"
                ? product.nameAr || product.name
                : product.nameFr || product.name
            ),
            React.createElement(
              "div",
              { className: "product-price" },
              `${displayPrice.toFixed(2)} DHS`
            ),
            hasMilkModifier &&
              React.createElement(
                "div",
                { style: { marginTop: 6, fontSize: 12 } },
                React.createElement("span", null, t.milkLabel + ": "),
                React.createElement(
                  "select",
                  {
                    className: "milk-select",
                    value: milk ? "yes" : "no",
                    onChange: (ev) => setMilk(ev.target.value === "yes")
                  },
                  React.createElement(
                    "option",
                    { value: "yes" },
                    t.milkYes
                  ),
                  React.createElement(
                    "option",
                    { value: "no" },
                    t.milkNo
                  )
                )
              ),
            hasSugarModifier &&
              !isBreakfast &&
              React.createElement(
                "div",
                { style: { marginTop: 6, fontSize: 12 } },
                React.createElement("span", null, t.sugarLabel + ": "),
                React.createElement(
                  "select",
                  {
                    className: "milk-select",
                    value: sugar,
                    onChange: (ev) => setSugar(ev.target.value)
                  },
                  React.createElement(
                    "option",
                    { value: "none" },
                    t.sugarNone
                  ),
                  React.createElement(
                    "option",
                    { value: "low" },
                    t.sugarLow
                  ),
                  React.createElement(
                    "option",
                    { value: "medium" },
                    t.sugarMedium
                  ),
                  React.createElement(
                    "option",
                    { value: "extra" },
                    t.sugarExtra
                  )
                )
              ),
            product.id === "other_water" &&
              React.createElement(
                "div",
                { style: { marginTop: 6, fontSize: 12 } },
                React.createElement("span", null, (t && t.waterSizeLabel) || "Eau" + ": "),
                React.createElement(
                  "select",
                  {
                    className: "milk-select",
                    value: waterSize,
                    onChange: (ev) => setWaterSize(ev.target.value)
                  },
                  React.createElement(
                    "option",
                    { value: "quarter" },
                    (t && t.waterQuarter) || "1/4L"
                  ),
                  React.createElement(
                    "option",
                    { value: "half" },
                    (t && t.waterHalf) || "1/2L"
                  )
                )
              ),
            hasHerbModifier &&
              React.createElement(
                "div",
                { style: { marginTop: 6, fontSize: 12 } },
                React.createElement("span", null, t.herbLabel + ": "),
                React.createElement(
                  "select",
                  {
                    className: "milk-select",
                    value: herb,
                    onChange: (ev) => setHerb(ev.target.value)
                  },
                  React.createElement("option", { value: "mint" }, t.herbMint),
                  React.createElement(
                    "option",
                    { value: "absinthe" },
                    t.herbAbsinthe
                  ),
                  React.createElement("option", { value: "lemon" }, t.herbLemon)
                )
              ),
            isBreakfast &&
              !isSpecialBreakfast &&
              React.createElement(
                "div",
                { style: { marginTop: 6, fontSize: 12 } },
                React.createElement("span", null, t.drinkLabel + ": "),
                React.createElement(
                  "select",
                  {
                    className: "milk-select",
                    value: drink,
                    onChange: (ev) => setDrink(ev.target.value)
                  },
                  React.createElement(
                    "option",
                    { value: "tea" },
                    t.drinkTea
                  ),
                  React.createElement(
                    "option",
                    { value: "coffee_milk" },
                    t.drinkCoffeeMilk
                  )
                )
              ),
            isSpecialBreakfast &&
              React.createElement(
                "div",
                { style: { marginTop: 6, fontSize: 12, display: "grid", gap: 8 } },
                React.createElement(
                  "div",
                  null,
                  React.createElement(
                    "span",
                    null,
                    lang === "ar" ? "مشروب ساخن" : "Boisson chaude",
                    ": "
                  ),
                  React.createElement(
                    "select",
                    {
                      className: "milk-select",
                      value: String(sbDrinkId || ""),
                      onChange: (ev) => setSbDrinkId(String(ev.target.value || ""))
                    },
                    hotDrinks.map((p) =>
                      React.createElement(
                        "option",
                        { key: p.id, value: p.id },
                        lang === "ar" ? p.nameAr || p.name : p.nameFr || p.name
                      )
                    )
                  )
                ),
                React.createElement(
                  "div",
                  null,
                  React.createElement(
                    "span",
                    null,
                    lang === "ar" ? "عدد البيض" : "Oeufs",
                    ": "
                  ),
                  React.createElement(
                    "select",
                    {
                      className: "milk-select",
                      value: String(sbEggCount),
                      onChange: (ev) => setSbEggCount(Number(ev.target.value))
                    },
                    React.createElement("option", { value: "1" }, "1"),
                    React.createElement("option", { value: "2" }, "2"),
                    React.createElement("option", { value: "3" }, "3"),
                    React.createElement("option", { value: "4" }, "4"),
                    React.createElement("option", { value: "5" }, "5")
                  ),
                  React.createElement(
                    "span",
                    { style: { marginLeft: 8, color: "#64748b" } },
                    "+3 DHS/egg"
                  )
                ),
                React.createElement(
                  "div",
                  { style: { display: "grid", gap: 6 } },
                  React.createElement(
                    "label",
                    { style: { display: "flex", gap: 8, alignItems: "center" } },
                    React.createElement("input", {
                      type: "checkbox",
                      checked: !!sbKashir,
                      onChange: (ev) => setSbKashir(!!(ev && ev.target && ev.target.checked))
                    }),
                    lang === "ar" ? "كاشير (+3)" : "Kashir (+3)"
                  ),
                  React.createElement(
                    "label",
                    { style: { display: "flex", gap: 8, alignItems: "center" } },
                    React.createElement("input", {
                      type: "checkbox",
                      checked: !!sbFromage,
                      onChange: (ev) => setSbFromage(!!(ev && ev.target && ev.target.checked))
                    }),
                    lang === "ar" ? "جبن (+3)" : "Fromage (+3)"
                  ),
                  React.createElement(
                    "label",
                    { style: { display: "flex", gap: 8, alignItems: "center" } },
                    React.createElement("input", {
                      type: "checkbox",
                      checked: !!sbWater,
                      onChange: (ev) => setSbWater(!!(ev && ev.target && ev.target.checked))
                    }),
                    lang === "ar" ? "ماء (+2)" : "Eau (+2)"
                  ),
                  React.createElement(
                    "label",
                    { style: { display: "flex", gap: 8, alignItems: "center" } },
                    React.createElement("input", {
                      type: "checkbox",
                      checked: !!sbCroissant,
                      onChange: (ev) => setSbCroissant(!!(ev && ev.target && ev.target.checked))
                    }),
                    lang === "ar" ? "كرواسون (+6)" : "Croissant (+6)"
                  ),
                  React.createElement(
                    "label",
                    { style: { display: "flex", gap: 8, alignItems: "center" } },
                    React.createElement("input", {
                      type: "checkbox",
                      checked: !!sbBreakfastSet,
                      onChange: (ev) => setSbBreakfastSet(!!(ev && ev.target && ev.target.checked))
                    }),
                    lang === "ar" ? "باك الفطور (+5)" : "Breakfast set (+5)"
                  )
                ),
                React.createElement(
                  "div",
                  { style: { display: "grid", gap: 6 } },
                  React.createElement(
                    "div",
                    { style: { fontWeight: 700 } },
                    lang === "ar" ? "قطع الجبن" : "Fromage (pièces)"
                  ),
                  React.createElement(
                    "div",
                    { style: { display: "grid", gridTemplateColumns: "1fr", gap: 8 } },
                    React.createElement(
                      "label",
                      { style: { display: "grid", gap: 4 } },
                      React.createElement(
                        "span",
                        { style: { color: "#64748b" } },
                        lang === "ar" ? "قطع" : "Pièces"
                      ),
                      React.createElement("input", {
                        type: "number",
                        min: 0,
                        step: 1,
                        value: String(sbCheesePieces),
                        onChange: (ev) => {
                          const n = Number(ev && ev.target ? ev.target.value : 0);
                          setSbCheesePieces(Number.isFinite(n) ? n : 0);
                        },
                        style: { width: "100%", padding: 8, fontSize: 14 }
                      })
                    )
                  ),
                  React.createElement(
                    "div",
                    { style: { fontSize: 11, color: "#64748b" } },
                    "+1 DHS / pièce"
                  )
                )
              ),
            hasSugarModifier &&
              isBreakfast &&
              !isSpecialBreakfast &&
              React.createElement(
                "div",
                { style: { marginTop: 6, fontSize: 12 } },
                React.createElement("span", null, t.sugarLabel + ": "),
                React.createElement(
                  "select",
                  {
                    className: "milk-select",
                    value: sugar,
                    onChange: (ev) => setSugar(ev.target.value)
                  },
                  React.createElement(
                    "option",
                    { value: "none" },
                    t.sugarNone
                  ),
                  React.createElement(
                    "option",
                    { value: "low" },
                    t.sugarLow
                  ),
                  React.createElement(
                    "option",
                    { value: "medium" },
                    t.sugarMedium
                  ),
                  React.createElement(
                    "option",
                    { value: "extra" },
                    t.sugarExtra
                  )
                )
              ),
            hasSiropAddon &&
              React.createElement(
                "label",
                { style: { marginTop: 6, fontSize: 12, display: "block" } },
                React.createElement("input", {
                  type: "checkbox",
                  checked: !!withSirop,
                  onChange: (ev) => setWithSirop(!!(ev && ev.target && ev.target.checked)),
                  style: { marginRight: 8 }
                }),
                `${((t && t.siropLabel) || "Sirop")}: ${withSirop ? (t && t.siropWith) || "Avec" : (t && t.siropWithout) || "Sans"}`
              ),
            hasWaterAddon &&
              React.createElement(
                "label",
                { style: { marginTop: 6, fontSize: 12, display: "block" } },
                React.createElement("input", {
                  type: "checkbox",
                  checked: !!withWater,
                  onChange: (ev) => setWithWater(!!(ev && ev.target && ev.target.checked)),
                  style: { marginRight: 8 }
                }),
                `${((t && t.waterLabel) || "Eau 1/4L")}: ${withWater ? (t && t.waterWith) || "Avec" : (t && t.waterWithout) || "Sans"}${withWater ? ` (+${waterFee.toFixed(0)} DHS)` : ""}`
              ),
            isFriedEggs &&
              React.createElement(
                "div",
                { style: { marginTop: 6, fontSize: 12 } },
                React.createElement("span", null, "Eggs: "),
                React.createElement(
                  "select",
                  {
                    className: "milk-select",
                    value: String(eggCount),
                    onChange: (ev) => setEggCount(Number(ev.target.value))
                  },
                  React.createElement(
                    "option",
                    { value: "1" },
                    "1"
                  ),
                  React.createElement(
                    "option",
                    { value: "2" },
                    "2"
                  )
                )
              )
          ),
          React.createElement(
            "button",
            {
              className: "btn-primary",
              style: { marginTop: 8 },
              onClick: handleClick
            },
            t.addLabel
          )
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(React.createElement(POSApp));
    
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("./sw.js").catch(() => {});
        });
      }</script>
  </body>
</html>
